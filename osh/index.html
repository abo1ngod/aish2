<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>بوابة الاختبارات الذكية - ثانوية عشيرة</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1a5f7a;
            --primary-dark: #134b5f;
            --primary-light: #2d7d9a;
            --secondary: #c49b3f;
            --secondary-light: #d4af5f;
            --accent: #e8c872;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
            --bg-gradient: linear-gradient(135deg, #1a5f7a 0%, #134b5f 50%, #0d3d4d 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            --radius: 16px;
        }

        .dark {
            --primary: #2d7d9a;
            --primary-dark: #1a5f7a;
            --primary-light: #3d9dba;
            --dark: #0a0a14;
            --light: #1a1a2e;
            --card-bg: rgba(30, 30, 50, 0.95);
            --bg-gradient: linear-gradient(135deg, #0d1b2a 0%, #1b263b 50%, #0d1b2a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--dark);
            overflow-x: hidden;
        }

        .dark body {
            color: var(--light);
        }

        /* Animated Background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
            background-image:
                radial-gradient(circle at 20% 80%, var(--secondary) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, var(--secondary) 1px, transparent 1px),
                radial-gradient(circle at 40% 40%, var(--accent) 0.5px, transparent 0.5px);
            background-size: 100px 100px, 150px 150px, 50px 50px;
            animation: floatBg 20s ease-in-out infinite;
        }

        @keyframes floatBg {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(1deg); }
        }

        /* Container */
        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Logo Section */
        .logo-section {
            text-align: center;
            padding: 30px 0;
            animation: fadeInDown 0.8s ease;
        }

        .logo-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--secondary), var(--accent));
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 10px 30px rgba(196, 155, 63, 0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo-icon:hover {
            transform: scale(1.05);
        }

        .logo-icon i {
            font-size: 48px;
            color: white;
        }

        .school-name {
            font-family: 'Amiri', serif;
            font-size: 28px;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .portal-name {
            font-size: 18px;
            color: var(--accent);
            font-weight: 500;
        }

        .dua-text {
            font-family: 'Amiri', serif;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 15px;
            font-style: italic;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            animation: fadeInUp 0.6s ease;
            backdrop-filter: blur(10px);
        }

        .dark .card {
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Login Form */
        .login-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark .login-title {
            color: var(--primary-light);
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-group input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            font-size: 18px;
            font-family: 'Tajawal', sans-serif;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            transition: all 0.3s ease;
            background: white;
            text-align: center;
            letter-spacing: 2px;
        }

        .dark .input-group input {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(26, 95, 122, 0.1);
        }

        .input-group i {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 20px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            font-weight: 700;
            font-family: 'Tajawal', sans-serif;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(26, 95, 122, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 122, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c0392b);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Student Header */
        .student-header {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .student-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .student-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
        }

        .student-details h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .dark .student-details h3 {
            color: var(--primary-light);
        }

        .student-details p {
            font-size: 14px;
            color: var(--gray);
        }

        .student-stats {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .stat-badge {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stat-badge.total {
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary);
        }

        .stat-badge.done {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
        }

        .stat-badge.pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .logout-btn {
            position: absolute;
            left: 20px;
            top: 20px;
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* Exam Cards */
        .exams-section h2 {
            color: white;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .exam-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 5px solid var(--primary);
            position: relative;
            overflow: hidden;
        }

        .exam-card:hover {
            transform: translateX(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .exam-card.new {
            border-right-color: var(--success);
            animation: pulse 2s infinite;
        }

        .exam-card.closed {
            border-right-color: var(--gray);
            opacity: 0.8;
        }

        .exam-card.completed {
            border-right-color: var(--secondary);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
        }

        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .exam-title {
            font-size: 17px;
            font-weight: 700;
            color: var(--dark);
        }

        .dark .exam-title {
            color: var(--light);
        }

        .exam-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .exam-badge.new {
            background: var(--success);
            color: white;
        }

        .exam-badge.closed {
            background: var(--gray);
            color: white;
        }

        .exam-badge.timed {
            background: var(--warning);
            color: white;
        }

        .exam-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: var(--gray);
            flex-wrap: wrap;
        }

        .exam-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .exam-score {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            text-align: center;
        }

        .score-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), #27ae60);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .score-circle.pending {
            background: linear-gradient(135deg, var(--gray), #5a6268);
            font-size: 12px;
        }

        /* Exam View */
        .exam-container {
            display: none;
        }

        .exam-top-bar {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .timer {
            font-size: 24px;
            font-weight: 700;
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .timer.warning {
            animation: timerBlink 0.5s infinite;
        }

        @keyframes timerBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-info {
            font-size: 14px;
            color: var(--gray);
        }

        .back-btn {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
        }

        /* Question Card */
        .question-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 20px;
            animation: fadeInUp 0.4s ease;
        }

        .question-card.unanswered {
            border: 2px solid var(--warning);
        }

        .question-number {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 17px;
            font-weight: 600;
            line-height: 1.8;
            margin-bottom: 20px;
            color: var(--dark);
        }

        .dark .question-text {
            color: var(--light);
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-item {
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
        }

        .dark .option-item {
            border-color: rgba(255, 255, 255, 0.2);
        }

        .option-item:hover {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.05);
        }

        .option-item.selected {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.1);
        }

        .option-item.correct {
            border-color: var(--success);
            background: rgba(46, 204, 113, 0.1);
        }

        .option-item.wrong {
            border-color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }

        .option-radio {
            width: 24px;
            height: 24px;
            border: 2px solid #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .option-item.selected .option-radio {
            border-color: var(--primary);
            background: var(--primary);
        }

        .option-item.selected .option-radio::after {
            content: '✓';
            color: white;
            font-size: 14px;
        }

        .option-item.correct .option-radio {
            border-color: var(--success);
            background: var(--success);
        }

        .option-item.correct .option-radio::after {
            content: '✓';
            color: white;
        }

        .option-item.wrong .option-radio {
            border-color: var(--danger);
            background: var(--danger);
        }

        .option-item.wrong .option-radio::after {
            content: '✗';
            color: white;
        }

        /* Submit Section */
        .submit-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #e0e0e0;
        }

        /* Survey Modal Content */
        .survey-container {
            text-align: right;
        }

        .survey-question {
            margin-bottom: 20px;
        }

        .survey-question label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .rating-stars {
            display: flex;
            gap: 10px;
            justify-content: center;
            direction: ltr;
        }

        .rating-stars i {
            font-size: 28px;
            color: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .rating-stars i.active,
        .rating-stars i:hover {
            color: var(--secondary);
            transform: scale(1.2);
        }

        .survey-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-family: 'Tajawal', sans-serif;
            font-size: 16px;
            resize: none;
            height: 100px;
        }

        .char-counter {
            text-align: left;
            font-size: 12px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Review Mode */
        .review-header {
            background: linear-gradient(135deg, var(--success), #27ae60);
            color: white;
            padding: 30px;
            border-radius: var(--radius);
            text-align: center;
            margin-bottom: 20px;
        }

        .review-header.perfect {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
        }

        .review-score {
            font-size: 48px;
            font-weight: 800;
        }

        /* Celebration */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: var(--secondary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .logo-icon {
                width: 80px;
                height: 80px;
            }

            .logo-icon i {
                font-size: 36px;
            }

            .school-name {
                font-size: 22px;
            }

            .student-info {
                flex-direction: column;
                text-align: center;
            }

            .exam-header {
                flex-direction: column;
                gap: 10px;
            }

            .exam-score {
                position: static;
                transform: none;
                margin-top: 10px;
            }
        }

        /* Violation Warning */
        .violation-badge {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--danger);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Question Navigation */
        .questions-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .q-nav-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .q-nav-btn.answered {
            background: var(--primary);
            color: white;
        }

        .q-nav-btn.current {
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(26, 95, 122, 0.5);
        }

        /* Admin Access */
        .admin-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            opacity: 0.3;
            cursor: pointer;
            z-index: 100;
        }

        /* ============ ADMIN PANEL STYLES ============ */
        .admin-container {
            max-width: 1200px;
            padding: 15px;
        }

        .admin-header {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .admin-title i {
            font-size: 28px;
        }

        .admin-tabs {
            display: flex;
            gap: 10px;
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .admin-tab {
            padding: 12px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            font-size: 14px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .admin-tab:hover {
            background: rgba(26, 95, 122, 0.1);
            color: var(--primary);
        }

        .admin-tab.active {
            background: var(--primary);
            color: white;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .action-btn.primary {
            background: var(--primary);
            color: white;
        }

        .action-btn.secondary {
            background: var(--secondary);
            color: white;
        }

        .action-btn.success {
            background: var(--success);
            color: white;
        }

        .action-btn.danger {
            background: var(--danger);
            color: white;
        }

        .action-btn.warning {
            background: var(--warning);
            color: white;
        }

        .action-btn.outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Data Table */
        .data-table-wrapper {
            background: var(--card-bg);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: right;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark .data-table th,
        .dark .data-table td {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .data-table th {
            background: rgba(26, 95, 122, 0.1);
            font-weight: 700;
            color: var(--primary);
            cursor: pointer;
            user-select: none;
        }

        .data-table th:hover {
            background: rgba(26, 95, 122, 0.2);
        }

        .data-table th i {
            margin-right: 5px;
            font-size: 12px;
        }

        .data-table tr:hover {
            background: rgba(26, 95, 122, 0.05);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .icon-btn.view { background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .icon-btn.edit { background: rgba(243, 156, 18, 0.1); color: #f39c12; }
        .icon-btn.delete { background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .icon-btn.reset { background: rgba(155, 89, 182, 0.1); color: #9b59b6; }

        .icon-btn:hover {
            transform: scale(1.1);
        }

        /* Exam Card Admin */
        .exam-admin-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            border-right: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .exam-admin-card:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .exam-admin-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .exam-admin-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
        }

        .dark .exam-admin-title {
            color: var(--light);
        }

        .exam-status-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-badge.published { background: rgba(46, 204, 113, 0.2); color: #27ae60; }
        .status-badge.draft { background: rgba(108, 117, 125, 0.2); color: #6c757d; }
        .status-badge.open { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        .status-badge.closed { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
        .status-badge.timed { background: rgba(243, 156, 18, 0.2); color: #f39c12; }

        .exam-admin-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 13px;
            color: var(--gray);
            flex-wrap: wrap;
        }

        .exam-admin-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .dark .form-group label {
            color: var(--light);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            transition: all 0.3s ease;
            background: white;
        }

        .dark .form-control {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .form-check input[type="checkbox"],
        .form-check input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
        }

        .search-box i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .filter-select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            min-width: 150px;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Question Builder */
        .question-builder {
            background: rgba(26, 95, 122, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .question-builder-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-type-select {
            display: flex;
            gap: 10px;
        }

        .type-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .type-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .options-builder {
            margin-top: 15px;
        }

        .option-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-row input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: 'Tajawal', sans-serif;
        }

        .option-row input[type="radio"] {
            width: 20px;
            height: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-card i {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-card.primary i { color: var(--primary); }
        .stat-card.success i { color: var(--success); }
        .stat-card.warning i { color: var(--warning); }
        .stat-card.danger i { color: var(--danger); }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark);
        }

        .dark .stat-value {
            color: var(--light);
        }

        .stat-label {
            font-size: 13px;
            color: var(--gray);
            margin-top: 5px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 16px;
            margin-bottom: 20px;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #e0e0e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary);
            background: rgba(26, 95, 122, 0.05);
        }

        .file-upload i {
            font-size: 48px;
            color: var(--gray);
            margin-bottom: 15px;
        }

        .file-upload input {
            display: none;
        }

        /* Responsive Admin */
        @media (max-width: 768px) {
            .admin-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .admin-tab {
                padding: 10px 15px;
                font-size: 13px;
            }

            .data-table {
                font-size: 13px;
            }

            .data-table th,
            .data-table td {
                padding: 10px 8px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>

    <!-- Admin Access Hint -->
    <div class="admin-hint" id="adminHint">
        <div class="logo-icon" style="width: 40px; height: 40px; border-radius: 10px;">
            <i class="fas fa-graduation-cap" style="font-size: 20px;"></i>
        </div>
    </div>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection">
            <div class="logo-section">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1 class="school-name">ثانوية عشيرة</h1>
                <p class="portal-name">بوابة الاختبارات الذكية</p>
                <p class="dua-text">اللهم لا سهل إلا ما جعلته سهلاً</p>
            </div>

            <div class="card">
                <h2 class="login-title">
                    <i class="fas fa-sign-in-alt"></i>
                    دخول الطلاب
                </h2>
                <div class="input-group">
                    <input type="text" id="civilIdInput" placeholder="السجل المدني" maxlength="10" inputmode="numeric" pattern="[0-9]*">
                    <i class="fas fa-id-card"></i>
                </div>
                <button class="btn btn-primary" id="loginBtn" onclick="handleLogin()">
                    <i class="fas fa-arrow-left"></i>
                    دخول
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <button class="logout-btn" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                خروج
            </button>

            <div class="logo-section" style="padding: 15px 0;">
                <div class="logo-icon" style="width: 60px; height: 60px; border-radius: 16px;">
                    <i class="fas fa-graduation-cap" style="font-size: 28px;"></i>
                </div>
            </div>

            <div class="student-header">
                <div class="student-info">
                    <div class="student-avatar" id="studentAvatar">م</div>
                    <div class="student-details">
                        <h3 id="studentName">محمد علي</h3>
                        <p id="studentInfo">أول ثانوي - شعبة 1</p>
                        <p id="studentCivilId" style="font-size: 12px; color: var(--gray);">1234567890</p>
                    </div>
                </div>
                <div class="student-stats">
                    <span class="stat-badge total">
                        <i class="fas fa-file-alt"></i>
                        <span id="totalExams">0</span> اختبار
                    </span>
                    <span class="stat-badge done">
                        <i class="fas fa-check-circle"></i>
                        <span id="completedExams">0</span> مكتمل
                    </span>
                    <span class="stat-badge pending">
                        <i class="fas fa-clock"></i>
                        <span id="pendingExams">0</span> متبقي
                    </span>
                </div>
            </div>

            <div class="exams-section">
                <h2>
                    <i class="fas fa-list-alt"></i>
                    الاختبارات المتاحة
                </h2>
                <div id="examsList"></div>
            </div>
        </div>

        <!-- Exam Section -->
        <div id="examSection" class="hidden">
            <div class="exam-top-bar">
                <button class="back-btn" onclick="exitExam()">
                    <i class="fas fa-arrow-right"></i>
                    رجوع
                </button>
                <div class="progress-info">
                    <span id="answeredCount">0</span> / <span id="totalQuestions">0</span>
                </div>
                <div class="timer hidden" id="examTimer">
                    <i class="fas fa-stopwatch"></i>
                    <span id="timerDisplay">00:00</span>
                </div>
            </div>

            <div class="questions-nav" id="questionsNav"></div>

            <div id="questionsContainer"></div>

            <div class="submit-section">
                <button class="btn btn-success" id="submitExamBtn" onclick="submitExam()">
                    <i class="fas fa-paper-plane"></i>
                    إرسال الإجابات
                </button>
            </div>
        </div>

        <!-- Admin Section -->
        <div id="adminSection" class="hidden">
            <div class="admin-header">
                <div class="admin-title">
                    <i class="fas fa-cogs"></i>
                    <span>لوحة التحكم</span>
                </div>
                <button class="action-btn danger" onclick="exitAdmin()">
                    <i class="fas fa-sign-out-alt"></i>
                    خروج
                </button>
            </div>

            <div class="admin-tabs">
                <button class="admin-tab active" onclick="switchAdminTab('students')">
                    <i class="fas fa-users"></i>
                    الطلاب
                </button>
                <button class="admin-tab" onclick="switchAdminTab('teachers')">
                    <i class="fas fa-chalkboard-teacher"></i>
                    المعلمين
                </button>
                <button class="admin-tab" onclick="switchAdminTab('exams')">
                    <i class="fas fa-file-alt"></i>
                    الاختبارات
                </button>
                <button class="admin-tab" onclick="switchAdminTab('results')">
                    <i class="fas fa-chart-bar"></i>
                    النتائج
                </button>
                <button class="admin-tab" onclick="switchAdminTab('requests')">
                    <i class="fas fa-redo"></i>
                    طلبات الإعادة
                </button>
                <button class="admin-tab" onclick="switchAdminTab('settings')">
                    <i class="fas fa-cog"></i>
                    الإعدادات
                </button>
            </div>

            <!-- Students Panel -->
            <div id="studentsPanel" class="admin-panel active">
                <div class="action-bar">
                    <button class="action-btn primary" onclick="showAddStudentModal()">
                        <i class="fas fa-plus"></i>
                        إضافة طالب
                    </button>
                    <button class="action-btn secondary" onclick="showImportModal()">
                        <i class="fas fa-file-excel"></i>
                        استيراد Excel
                    </button>
                    <button class="action-btn success" onclick="exportStudents()">
                        <i class="fas fa-file-export"></i>
                        تصدير CSV
                    </button>
                    <button class="action-btn danger" onclick="deleteAllStudents()">
                        <i class="fas fa-trash-alt"></i>
                        حذف الجميع
                    </button>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="studentSearch" placeholder="بحث بالاسم أو السجل..." oninput="filterStudents()">
                    </div>
                    <select class="filter-select" id="gradeFilter" onchange="updateStudentsSectionFilter(); filterStudents()">
                        <option value="">كل الصفوف</option>
                        <option value="أول ثانوي">أول ثانوي</option>
                        <option value="ثاني ثانوي">ثاني ثانوي</option>
                        <option value="ثالث ثانوي">ثالث ثانوي</option>
                    </select>
                    <select class="filter-select" id="sectionFilter" onchange="filterStudents()">
                        <option value="">كل الشعب</option>
                        <option value="1">شعبة 1</option>
                        <option value="2">شعبة 2</option>
                        <option value="3">شعبة 3</option>
                        <option value="4">شعبة 4</option>
                        <option value="5">شعبة 5</option>
                        <option value="6">شعبة 6</option>
                        <option value="7">شعبة 7</option>
                        <option value="8">شعبة 8</option>
                        <option value="9">شعبة 9</option>
                        <option value="10">شعبة 10</option>
                        <option value="11">شعبة 11</option>
                        <option value="12">شعبة 12</option>
                    </select>
                </div>

                <div class="data-table-wrapper" style="overflow-x: auto;">
                    <table class="data-table" id="studentsTable">
                        <thead>
                            <tr>
                                <th onclick="sortStudents('civilId')">السجل المدني <i class="fas fa-sort"></i></th>
                                <th onclick="sortStudents('name')">الاسم <i class="fas fa-sort"></i></th>
                                <th onclick="sortStudents('grade')">الصف <i class="fas fa-sort"></i></th>
                                <th onclick="sortStudents('section')">الشعبة <i class="fas fa-sort"></i></th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Teachers Panel -->
            <div id="teachersPanel" class="admin-panel">
                <div class="action-bar">
                    <button class="action-btn primary" onclick="showAddTeacherModal()">
                        <i class="fas fa-plus"></i>
                        إضافة معلم
                    </button>
                    <button class="action-btn secondary" onclick="showImportTeachersModal()">
                        <i class="fas fa-file-excel"></i>
                        استيراد Excel
                    </button>
                    <button class="action-btn success" onclick="exportTeachers()">
                        <i class="fas fa-file-export"></i>
                        تصدير CSV
                    </button>
                    <button class="action-btn danger" onclick="deleteAllTeachers()">
                        <i class="fas fa-trash-alt"></i>
                        حذف الجميع
                    </button>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="teacherSearch" placeholder="بحث بالاسم أو السجل..." oninput="filterTeachers()">
                    </div>
                    <select class="filter-select" id="teacherGradeFilter" onchange="filterTeachers()">
                        <option value="">كل الصفوف</option>
                        <option value="أول ثانوي">أول ثانوي</option>
                        <option value="ثاني ثانوي">ثاني ثانوي</option>
                        <option value="ثالث ثانوي">ثالث ثانوي</option>
                    </select>
                </div>

                <div class="data-table-wrapper" style="overflow-x: auto;">
                    <table class="data-table" id="teachersTable">
                        <thead>
                            <tr>
                                <th onclick="sortTeachers('civilId')">السجل المدني <i class="fas fa-sort"></i></th>
                                <th onclick="sortTeachers('name')">الاسم <i class="fas fa-sort"></i></th>
                                <th>الشعب التي يدرسها</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="teachersTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Exams Panel -->
            <div id="examsPanel" class="admin-panel">
                <div class="action-bar">
                    <button class="action-btn primary" onclick="showCreateExamModal()">
                        <i class="fas fa-plus"></i>
                        إنشاء اختبار جديد
                    </button>
                </div>

                <div id="adminExamsList"></div>
            </div>

            <!-- Results Panel -->
            <div id="resultsPanel" class="admin-panel">
                <div class="form-group">
                    <label>اختر الاختبار:</label>
                    <select class="form-control" id="resultsExamSelect" onchange="loadExamResults()">
                        <option value="">-- اختر اختباراً --</option>
                    </select>
                </div>

                <div id="resultsContent"></div>

                <!-- Statistics Section -->
                <div id="statisticsSection" class="hidden" style="margin-top: 30px;">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">
                        <i class="fas fa-chart-pie"></i> الإحصائيات التفصيلية
                    </h3>

                    <!-- ترتيب حسب أول من اختبر -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--secondary);">
                            <i class="fas fa-trophy"></i> ترتيب الطلاب حسب وقت الاختبار
                        </h4>
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="submissionOrderTable">
                                <thead>
                                    <tr>
                                        <th>الترتيب</th>
                                        <th>الاسم</th>
                                        <th>وقت البدء</th>
                                        <th>وقت التسليم</th>
                                        <th>مدة التنفيذ</th>
                                    </tr>
                                </thead>
                                <tbody id="submissionOrderBody"></tbody>
                            </table>
                            <div id="submissionPagination"></div>
                        </div>
                    </div>

                    <!-- تحليل النزاهة -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--danger);">
                            <i class="fas fa-shield-alt"></i> تحليل النزاهة والسلوك
                        </h4>
                        <div style="overflow-x: auto;">
                            <table class="data-table" id="integrityTable">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>عدد مرات الخروج</th>
                                        <th>زمن التنفيذ</th>
                                        <th>الحالة</th>
                                    </tr>
                                </thead>
                                <tbody id="integrityBody"></tbody>
                            </table>
                            <div id="integrityPagination"></div>
                        </div>
                    </div>

                    <!-- الأسئلة الأصعب -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--warning);">
                            <i class="fas fa-exclamation-triangle"></i> الأسئلة الخمسة الأصعب
                        </h4>
                        <div id="hardestQuestions"></div>
                    </div>

                    <!-- من لم يختبر -->
                    <div class="card" style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; color: var(--gray);">
                            <i class="fas fa-user-clock"></i> حالة الطلاب
                        </h4>
                        <div class="stats-grid" style="margin-bottom: 15px;">
                            <div class="stat-card success">
                                <i class="fas fa-check"></i>
                                <div class="stat-value" id="statTested">0</div>
                                <div class="stat-label">اختبروا</div>
                            </div>
                            <div class="stat-card warning">
                                <i class="fas fa-eye"></i>
                                <div class="stat-value" id="statViewedOnly">0</div>
                                <div class="stat-label">شاهدوا ولم يختبروا</div>
                            </div>
                            <div class="stat-card danger">
                                <i class="fas fa-eye-slash"></i>
                                <div class="stat-value" id="statNotViewed">0</div>
                                <div class="stat-label">لم يشاهدوا</div>
                            </div>
                        </div>
                        <div id="notTestedList"></div>
                    </div>

                    <!-- نتائج الاستبيان -->
                    <div class="card">
                        <h4 style="margin-bottom: 15px; color: var(--primary);">
                            <i class="fas fa-poll"></i> نتائج الاستبيان
                        </h4>
                        <div id="surveyResults"></div>
                    </div>
                </div>
            </div>

            <!-- Requests Panel -->
            <div id="requestsPanel" class="admin-panel">
                <div id="retakeRequestsList"></div>
            </div>

            <!-- Settings Panel -->
            <div id="settingsPanel" class="admin-panel">
                <div class="card">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-lock"></i> تغيير كلمة المرور
                    </h3>
                    <div class="form-group">
                        <label>كلمة المرور الجديدة:</label>
                        <input type="password" class="form-control" id="newPassword" placeholder="أدخل كلمة المرور الجديدة">
                    </div>
                    <button class="action-btn primary" onclick="changePassword()">
                        <i class="fas fa-save"></i>
                        حفظ
                    </button>
                </div>

                <!-- روابط الصفحات الخارجية -->
                <div class="card" style="margin-top: 20px;">
                    <h3 style="margin-bottom: 20px; color: var(--primary);">
                        <i class="fas fa-external-link-alt"></i> روابط الصفحات
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: linear-gradient(135deg, #1a5f7a15, #1a5f7a05); border-radius: 12px; border-right: 4px solid var(--primary);">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: var(--primary);">
                                    <i class="fas fa-chalkboard-teacher"></i> بوابة المعلمين
                                </h4>
                                <p style="margin: 0; font-size: 13px; color: var(--gray);">تسجيل ملاحظات الطلاب</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn outline" onclick="copyToClipboard('teacher-portal.html')" title="نسخ الرابط">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <a href="teacher-portal.html" target="_blank" class="action-btn primary" style="text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i> فتح
                                </a>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; background: linear-gradient(135deg, #c49b3f15, #c49b3f05); border-radius: 12px; border-right: 4px solid var(--secondary);">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: var(--secondary);">
                                    <i class="fas fa-user-tie"></i> بوابة التوجيه والإرشاد
                                </h4>
                                <p style="margin: 0; font-size: 13px; color: var(--gray);">متابعة الملاحظات وتسجيل الإجراءات</p>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="action-btn outline" onclick="copyToClipboard('guidance-portal.html')" title="نسخ الرابط">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <a href="guidance-portal.html" target="_blank" class="action-btn secondary" style="text-decoration: none;">
                                    <i class="fas fa-external-link-alt"></i> فتح
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Section -->
        <div id="reviewSection" class="hidden">
            <div class="exam-top-bar">
                <button class="back-btn" onclick="exitReview()">
                    <i class="fas fa-arrow-right"></i>
                    رجوع للقائمة
                </button>
                <div id="reviewExamTitle" style="font-weight: 600;"></div>
            </div>

            <div id="reviewHeader" class="review-header">
                <div class="review-score" id="reviewScore">100%</div>
                <p id="reviewMessage">أحسنت! نتيجة ممتازة</p>
            </div>

            <div id="reviewQuestionsContainer"></div>

            <div class="submit-section" id="retakeSection">
                <button class="btn btn-secondary" onclick="requestRetake()">
                    <i class="fas fa-redo"></i>
                    طلب إعادة الاختبار
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Violation Badge -->
    <div class="violation-badge hidden" id="violationBadge">
        <i class="fas fa-exclamation-triangle"></i>
        <span>مخالفات: <span id="violationCount">0</span></span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxPO6RKsQ1Cq-mqlCpFTrCuIyxnYdB37U",
            authDomain: "studentsystem-c1ab1.firebaseapp.com",
            databaseURL: "https://studentsystem-c1ab1-default-rtdb.firebaseio.com",
            projectId: "studentsystem-c1ab1",
            storageBucket: "studentsystem-c1ab1.firebasestorage.app",
            messagingSenderId: "112215023848",
            appId: "1:112215023848:web:0adba326a527ee7e37e95d"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.database();
        const rootRef = db.ref('q2026_2');

        // State Management
        let currentStudent = null;
        let currentExam = null;
        let currentAnswers = {};
        let timerInterval = null;
        let remainingTime = 0;
        let violations = 0;
        let examStartTime = null;
        let isInExam = false;

        // === نظام التخزين المؤقت لتحسين الأداء ===
        const dataCache = {
            students: { data: null, timestamp: 0 },
            exams: { data: null, timestamp: 0 },
            responses: { data: null, timestamp: 0 }
        };
        const CACHE_DURATION = 30000; // 30 ثانية

        async function getCachedData(key, fetchFn) {
            const cache = dataCache[key];
            const now = Date.now();
            if (cache.data && (now - cache.timestamp) < CACHE_DURATION) {
                return cache.data;
            }
            const data = await fetchFn();
            dataCache[key] = { data, timestamp: now };
            return data;
        }

        function invalidateCache(key) {
            if (key) {
                dataCache[key] = { data: null, timestamp: 0 };
            } else {
                Object.keys(dataCache).forEach(k => {
                    dataCache[k] = { data: null, timestamp: 0 };
                });
            }
        }

        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Gemini AI Question Generator
        async function generateQuestionsWithGemini(apiKey, topic, count) {
            const prompt = `أنت خبير في إنشاء أسئلة اختبارات تعليمية.
قم بإنشاء ${count} أسئلة اختيار من متعدد عن موضوع: "${topic}"

القواعد:
- كل سؤال له 4 خيارات
- خيار واحد فقط صحيح
- الأسئلة متنوعة وتغطي جوانب مختلفة من الموضوع
- الأسئلة باللغة العربية

الصيغة المطلوبة لكل سؤال (سطر واحد):
نص السؤال|الخيار1|الخيار2|الخيار3|الخيار4|رقم الإجابة الصحيحة

مثال:
ما هي عاصمة المملكة العربية السعودية؟|الرياض|جدة|مكة|الدمام|1

أنشئ ${count} أسئلة فقط بهذه الصيغة، كل سؤال في سطر منفصل، بدون أي نص إضافي:`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 2048
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'فشل الاتصال بـ Gemini API');
            }

            const data = await response.json();
            const generatedText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

            // Clean and validate the output
            const lines = generatedText.split('\n')
                .map(line => line.trim())
                .filter(line => line && line.includes('|') && line.split('|').length >= 5);

            if (lines.length === 0) {
                throw new Error('لم يتم توليد أسئلة صالحة');
            }

            return lines.join('\n');
        }

        // معالجة نص الأسئلة بـ Gemini AI (Parsing)
        async function parseQuestionsWithGemini(apiKey, rawText) {
            const prompt = `مهمتك: تحويل جميع الأسئلة إلى صيغة منظمة.

تحذير هام: يجب معالجة كل الأسئلة الموجودة في النص بدون استثناء أو تخطي أي ��ؤال.

قواعد صارمة:
1. انسخ نص كل سؤال حرفياً كما هو بدون أي تعديل أو تلخيص أو اختصار
2. انسخ نص كل خيار حرفياً كما هو بدون أي تعديل
3. لا تتخطى أي سؤال - يجب تحويل جميع الأسئلة من الأول للأخير
4. إذا كانت الإجابة الصحيحة محددة استخدم رقمها، وإلا اجعلها 1
5. إذا كان السؤال صح/خطأ، الخيارات هي: صح|خطأ

النص المراد تحويله:
${rawText}

الصيغة (سطر لكل سؤال):
نص السؤال حرفياً|الخيار1|الخيار2|...|رقم الإجابة

أخرج جميع الأسئلة المحولة:`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 16384
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'فشل الاتصال بـ Gemini API');
            }

            const data = await response.json();
            const parsedText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

            const lines = parsedText.split('\n')
                .map(line => line.trim())
                .filter(line => line && line.includes('|') && line.split('|').length >= 3);

            if (lines.length === 0) {
                throw new Error('لم يتم العثور على أسئلة صالحة في النص');
            }

            return lines.join('\n');
        }

        // Schedule checker - يتحقق من جدولة الاختبارات كل دقيقة
        async function checkExamSchedules() {
            try {
                // Get server time
                const serverTimeSnap = await db.ref('.info/serverTimeOffset').once('value');
                const serverTimeOffset = serverTimeSnap.val() || 0;
                const serverTime = Date.now() + serverTimeOffset;

                const examsSnap = await rootRef.child('exams').once('value');
                if (!examsSnap.exists()) return;

                examsSnap.forEach(child => {
                    const exam = child.val();
                    const settings = exam.settings;

                    if (!settings?.hasSchedule) return;

                    const examId = child.key;
                    const updates = {};

                    // Check scheduled start
                    if (settings.scheduledStart && serverTime >= settings.scheduledStart && !settings.isPublished) {
                        updates['settings/isPublished'] = true;
                        updates['settings/isOpen'] = true;
                    }

                    // Check scheduled end
                    if (settings.scheduledEnd) {
                        // إذا كان الاختبار بمؤقت، أغلقه قبل النهاية بزمن المؤقت
                        const closeTime = settings.hasTimer
                            ? settings.scheduledEnd - (settings.timerMinutes * 60 * 1000)
                            : settings.scheduledEnd;

                        if (serverTime >= closeTime && settings.isOpen) {
                            updates['settings/isOpen'] = false;
                        }
                    }

                    if (Object.keys(updates).length > 0) {
                        rootRef.child('exams').child(examId).update(updates);
                    }
                });
            } catch (error) {
                console.error('Schedule check error:', error);
            }
        }

        // Run schedule checker every minute
        setInterval(checkExamSchedules, 60000);

        // Initialize default data
        async function initializeDefaultData() {
            try {
                const studentsSnap = await rootRef.child('students').once('value');
                if (!studentsSnap.exists()) {
                    // Add default students
                    await rootRef.child('students').set({
                        '1234567890': {
                            name: 'محمد علي',
                            grade: 'أول ثانوي',
                            section: '1',
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        },
                        '0123456789': {
                            name: 'سعيد أحمد',
                            grade: 'أول ثانوي',
                            section: '1',
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        }
                    });
                }

                const examsSnap = await rootRef.child('exams').once('value');
                if (!examsSnap.exists()) {
                    // Add default exam
                    const examId = 'exam_default_1';
                    await rootRef.child('exams').child(examId).set({
                        title: 'اختبار تجريبي - مادة التفسير',
                        subject: 'التفسير',
                        teacherName: 'أ. عبدالله',
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        settings: {
                            isPublished: true,
                            isOpen: true,
                            hasTimer: false,
                            timerMinutes: 0,
                            showResults: false,
                            targetType: 'all',
                            targetGrade: null,
                            targetSections: [],
                            targetStudents: null,
                            shuffleQuestions: false,
                            showAnswersAfterSubmit: false,
                            hasSchedule: false,
                            scheduledStart: null,
                            scheduledEnd: null
                        },
                        questions: {
                            'q1': {
                                text: 'ما هو أول ما نزل من القرآن الكريم؟',
                                type: 'mcq',
                                options: ['سورة الفاتحة', 'سورة العلق', 'سورة البقرة', 'سورة الإخلاص'],
                                correctAnswer: 1,
                                points: 1
                            },
                            'q2': {
                                text: 'كم عدد سور القرآن الكريم؟',
                                type: 'mcq',
                                options: ['100 سورة', '114 سورة', '120 سورة', '110 سورة'],
                                correctAnswer: 1,
                                points: 1
                            },
                            'q3': {
                                text: 'سورة الفاتحة تسمى أم الكتاب',
                                type: 'truefalse',
                                options: ['صح', 'خطأ'],
                                correctAnswer: 0,
                                points: 1
                            },
                            'q4': {
                                text: 'نزل القرآن الكريم جملة واحدة',
                                type: 'truefalse',
                                options: ['صح', 'خطأ'],
                                correctAnswer: 1,
                                points: 1
                            }
                        }
                    });
                }

                // Initialize config
                const configSnap = await rootRef.child('config').once('value');
                if (!configSnap.exists()) {
                    await rootRef.child('config').set({
                        teacherPassword: 'admin123',
                        welcomeMessage: 'أهلاً بك في بوابة الاختبارات الذكية',
                        schoolName: 'ثانوية عشيرة'
                    });
                }
            } catch (error) {
                console.error('Error initializing data:', error);
            }
        }

        // Storage helpers - يستخدم localStorage خارج بيئة Poe، ويرجع للذاكرة داخلها
        window.tempStorage = window.tempStorage || {};
        const storage = window.localStorage;

        function isLocalStorageAvailable() {
            try {
                const test = '__storage_test__';
                storage.setItem(test, test);
                storage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        const useLocalStorage = isLocalStorageAvailable();

        function saveToStorage(key, value) {
            if (useLocalStorage) {
                try {
                    storage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    window.tempStorage[key] = value;
                }
            } else {
                window.tempStorage[key] = value;
            }
        }

        function getFromStorage(key) {
            if (useLocalStorage) {
                try {
                    const item = storage.getItem(key);
                    return item ? JSON.parse(item) : null;
                } catch (e) {
                    return window.tempStorage[key] || null;
                }
            }
            return window.tempStorage[key] || null;
        }

        function removeFromStorage(key) {
            if (useLocalStorage) {
                try {
                    storage.removeItem(key);
                } catch (e) {}
            }
            delete window.tempStorage[key];
        }

        // Firebase-based session persistence
        async function saveSessionToFirebase(civilId) {
            // Store session indicator in drafts
            await rootRef.child('sessions').child(civilId).set({
                lastActive: firebase.database.ServerValue.TIMESTAMP
            });
        }

        async function loadDraftAnswers(examId, civilId) {
            const snap = await rootRef.child('drafts').child(civilId).child(examId).once('value');
            return snap.val()?.answers || null;
        }

        async function saveDraftAnswers(examId, civilId, answers) {
            await rootRef.child('drafts').child(civilId).child(examId).set({
                answers: answers,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
        }

        async function clearDraftAnswers(examId, civilId) {
            await rootRef.child('drafts').child(civilId).child(examId).remove();
        }

        // Check saved session
        async function checkSavedSession() {
            const savedStudent = getFromStorage('currentStudent');
            if (savedStudent) {
                // Verify student still exists
                const snap = await rootRef.child('students').child(savedStudent.civilId).once('value');
                if (snap.exists()) {
                    currentStudent = { civilId: savedStudent.civilId, ...snap.val() };
                    showDashboard();
                    return true;
                } else {
                    removeFromStorage('currentStudent');
                }
            }
            return false;
        }

        // Login Handler
        async function handleLogin() {
            const civilId = document.getElementById('civilIdInput').value.trim();

            if (!civilId || civilId.length !== 10 || !/^\d+$/.test(civilId)) {
                showAlert('خطأ', 'يرجى إدخال السجل المدني بشكل صحيح (10 أرقام)', 'error');
                return;
            }

            showLoading(true);

            try {
                const snap = await rootRef.child('students').child(civilId).once('value');

                if (!snap.exists()) {
                    showLoading(false);
                    showAlert('غير موجود', 'السجل المدني غير موجود في النظام. راجع معلم المادة.', 'error');
                    return;
                }

                const studentData = snap.val();

                showLoading(false);

                // Confirm identity
                const result = await Swal.fire({
                    title: 'تأكيد الهوية',
                    html: `<p style="font-size: 18px;">هل أنت <strong>${studentData.name}</strong>؟</p>
                           <p style="color: #666; margin-top: 10px;">${studentData.grade} - شعبة ${studentData.section}</p>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، أنا',
                    cancelButtonText: 'لا',
                    confirmButtonColor: '#1a5f7a',
                    cancelButtonColor: '#6c757d'
                });

                if (result.isConfirmed) {
                    currentStudent = { civilId, ...studentData };
                    saveToStorage('currentStudent', { civilId });
                    showDashboard();
                }
            } catch (error) {
                showLoading(false);
                showAlert('خطأ', 'حدث خطأ في الاتصال. حاول مرة أخرى.', 'error');
                console.error(error);
            }
        }

        // Logout Handler
        function handleLogout() {
            Swal.fire({
                title: 'تسجيل الخروج',
                text: 'هل تريد تسجيل الخروج من النظام؟',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'نعم',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c'
            }).then((result) => {
                if (result.isConfirmed) {
                    currentStudent = null;
                    removeFromStorage('currentStudent');
                    document.getElementById('loginSection').classList.remove('hidden');
                    document.getElementById('dashboardSection').classList.add('hidden');
                    document.getElementById('civilIdInput').value = '';
                }
            });
        }

        // Show Dashboard
        async function showDashboard() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');

            // Update student info
            document.getElementById('studentName').textContent = currentStudent.name;
            document.getElementById('studentInfo').textContent = `${currentStudent.grade} - شعبة ${currentStudent.section}`;
            document.getElementById('studentCivilId').textContent = currentStudent.civilId;
            document.getElementById('studentAvatar').textContent = currentStudent.name.charAt(0);

            await loadExams();
        }

        // Store exams data for click handling
        window.loadedExamsData = {};

        // Load Exams
        async function loadExams() {
            showLoading(true);
            const examsList = document.getElementById('examsList');
            examsList.innerHTML = '';
            window.loadedExamsData = {};

            try {
                // تحميل البيانات بالتوازي مع التخزين المؤقت
                const [exams, responses] = await Promise.all([
                    getCachedData('exams', async () => {
                        const snap = await rootRef.child('exams').once('value');
                        return snap.val() || {};
                    }),
                    getCachedData('responses', async () => {
                        const snap = await rootRef.child('responses').once('value');
                        return snap.val() || {};
                    })
                ]);

                let totalExams = 0;
                let completedExams = 0;

                if (Object.keys(exams).length > 0) {

                    for (const [examId, exam] of Object.entries(exams)) {
                        // Check if student is targeted
                        if (!isStudentTargeted(exam.settings)) continue;

                        // Check if published
                        if (!exam.settings?.isPublished) continue;

                        totalExams++;

                        const studentResponse = responses[examId]?.[currentStudent.civilId];
                        const hasCompleted = studentResponse?.submitted;

                        if (hasCompleted) completedExams++;

                        // Store exam data for click handling
                        window.loadedExamsData[examId] = { exam, studentResponse };

                        const examCard = createExamCard(examId, exam, studentResponse);
                        examsList.appendChild(examCard);
                    }
                }

                document.getElementById('totalExams').textContent = totalExams;
                document.getElementById('completedExams').textContent = completedExams;
                document.getElementById('pendingExams').textContent = totalExams - completedExams;

                if (totalExams === 0) {
                    examsList.innerHTML = `
                        <div class="card" style="text-align: center; padding: 40px;">
                            <i class="fas fa-inbox" style="font-size: 48px; color: var(--gray); margin-bottom: 15px;"></i>
                            <p style="color: var(--gray);">لا توجد اختبارات متاحة حالياً</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading exams:', error);
                examsList.innerHTML = `
                    <div class="card" style="text-align: center;">
                        <p style="color: var(--danger);">حدث خطأ في تحميل الاختبارات</p>
                    </div>
                `;
            }

            showLoading(false);
        }

        // Check if student is targeted for exam
        function isStudentTargeted(settings) {
            if (!settings) return true;

            const targetType = settings.targetType || 'all';

            switch (targetType) {
                case 'all':
                    return true;
                case 'grade':
                    return currentStudent.grade === settings.targetGrade;
                case 'section':
                    // دعم الشعب المتعددة (الصيغة الجديدة)
                    const targetSections = settings.targetSections || [];
                    if (targetSections.length > 0) {
                        const studentGradeNum = currentStudent.grade === 'أول ثانوي' ? '1' : currentStudent.grade === 'ثاني ثانوي' ? '2' : '3';
                        return targetSections.some(sec => sec.grade === studentGradeNum && sec.section === currentStudent.section);
                    }
                    // دعم الصيغة القديمة (شعبة واحدة)
                    return currentStudent.grade === settings.targetGrade &&
                           currentStudent.section === settings.targetSection;
                case 'specific':
                    return settings.targetStudents?.includes(currentStudent.civilId);
                default:
                    return true;
            }
        }

        // Create Exam Card
        function createExamCard(examId, exam, studentResponse) {
            const hasCompleted = studentResponse?.submitted;
            const isOpen = exam.settings?.isOpen;
            const hasTimer = exam.settings?.hasTimer;
            const showResults = exam.settings?.showResults;
            const hasSchedule = exam.settings?.hasSchedule;
            const scheduledStart = exam.settings?.scheduledStart;
            const scheduledEnd = exam.settings?.scheduledEnd;

            let cardClass = 'exam-card';
            let badgeHTML = '';
            let scoreHTML = '';

            if (hasCompleted) {
                cardClass += ' completed';
                if (showResults && studentResponse.score !== undefined) {
                    const percentage = Math.round((studentResponse.score / studentResponse.totalPoints) * 100);
                    scoreHTML = `
                        <div class="exam-score">
                            <div class="score-circle">${percentage}%</div>
                        </div>
                    `;
                } else {
                    scoreHTML = `
                        <div class="exam-score">
                            <div class="score-circle pending">قريباً</div>
                        </div>
                    `;
                }
                badgeHTML = '<span class="exam-badge" style="background: var(--secondary);">مكتمل</span>';
            } else if (!isOpen) {
                cardClass += ' closed';
                badgeHTML = '<span class="exam-badge closed">مغلق</span>';
            } else {
                cardClass += ' new';
                badgeHTML = '<span class="exam-badge new">جديد</span>';
                if (hasTimer) {
                    badgeHTML += `<span class="exam-badge timed" style="margin-right: 5px;">
                        <i class="fas fa-clock"></i> ${exam.settings.timerMinutes} دقيقة
                    </span>`;
                }
            }

            const questionsCount = Object.keys(exam.questions || {}).length;

            // تنسيق التاريخ والوقت للجدولة
            const formatDateTime = (ts) => {
                if (!ts) return '';
                const d = new Date(ts);
                return d.toLocaleDateString('ar-SA', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
            };

            const scheduleHTML = hasSchedule && scheduledStart && scheduledEnd
                ? `<div style="font-size: 11px; color: var(--secondary); margin-top: 5px; padding: 5px; background: rgba(196, 155, 63, 0.1); border-radius: 5px;">
                    <i class="fas fa-calendar-alt"></i> من: ${formatDateTime(scheduledStart)} | إلى: ${formatDateTime(scheduledEnd)}
                   </div>`
                : '';

            // Create using innerHTML to ensure onclick works
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `
                <div class="${cardClass}" onclick="handleExamClick('${examId}')">
                    <div class="exam-header">
                        <div class="exam-title">${exam.title}</div>
                        <div>${badgeHTML}</div>
                    </div>
                    ${scheduleHTML}
                    <div class="exam-meta">
                        <span><i class="fas fa-book"></i> ${exam.subject || 'غير محدد'}</span>
                        <span><i class="fas fa-user-tie"></i> ${exam.teacherName || 'غير محدد'}</span>
                        <span><i class="fas fa-question-circle"></i> ${questionsCount} سؤال</span>
                    </div>
                    ${scoreHTML}
                </div>
            `;

            return wrapper.firstElementChild;
        }

        // Handle Exam Click - Global function for onclick
        window.handleExamClick = async function(examId) {
            // جلب البيانات الحديثة من Firebase
            try {
                const [examSnap, responseSnap] = await Promise.all([
                    rootRef.child('exams').child(examId).once('value'),
                    rootRef.child('responses').child(examId).child(currentStudent.civilId).once('value')
                ]);

                const exam = examSnap.val();
                const studentResponse = responseSnap.val();

                if (exam) {
                    // تحديث البيانات المخزنة
                    window.loadedExamsData[examId] = { exam, studentResponse };
                    await openExam(examId, exam, studentResponse);
                } else {
                    showAlert('خطأ', 'الاختبار غير موجود', 'error');
                }
            } catch (error) {
                console.error('Error fetching exam:', error);
                // استخدام البيانات المخزنة كاحتياط
                if (window.loadedExamsData[examId]) {
                    const { exam, studentResponse } = window.loadedExamsData[examId];
                    await openExam(examId, exam, studentResponse);
                }
            }
        };

        // Open Exam
        async function openExam(examId, exam, studentResponse) {
            const hasCompleted = studentResponse?.submitted;
            const isOpen = exam.settings?.isOpen;
            const hasTimer = exam.settings?.hasTimer;
            const timerMinutes = exam.settings?.timerMinutes || 0;
            const showResults = exam.settings?.showResults;

            // If completed, show review
            if (hasCompleted) {
                showReview(examId, exam, studentResponse);
                return;
            }

            // If closed, show message
            if (!isOpen) {
                showAlert('الاختبار مغلق', 'هذا الاختبار مغلق حالياً ولا يمكن الإجابة عليه.', 'info');
                return;
            }

            // If has timer, show confirmation
            if (hasTimer) {
                const result = await Swal.fire({
                    title: 'اختبار موقوت',
                    html: `
                        <p style="margin-bottom: 15px;">هذا الاختبار له مؤقت <strong>${timerMinutes} دقيقة</strong></p>
                        <p style="color: #e74c3c; font-weight: 600;">⚠️ بمجرد البدء لا يمكنك المقاطعة</p>
                        <p style="margin-top: 15px;">هل أنت مستعد للبدء الآن؟</p>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ابدأ الآن',
                    cancelButtonText: 'لاحقاً',
                    confirmButtonColor: '#2ecc71',
                    cancelButtonColor: '#6c757d'
                });

                if (!result.isConfirmed) return;
            }

            startExam(examId, exam, hasTimer, timerMinutes);
        }

        // Start Exam
        async function startExam(examId, exam, hasTimer, timerMinutes) {
            currentExam = { id: examId, ...exam };
            currentAnswers = {};
            violations = 0;
            isInExam = true;

            // Get server time
            const serverTimeSnap = await db.ref('.info/serverTimeOffset').once('value');
            const serverTimeOffset = serverTimeSnap.val() || 0;
            examStartTime = Date.now() + serverTimeOffset;

            // Record exam start
            await rootRef.child('responses').child(examId).child(currentStudent.civilId).update({
                startTime: firebase.database.ServerValue.TIMESTAMP,
                studentName: currentStudent.name,
                grade: currentStudent.grade,
                section: currentStudent.section
            });

            // Load saved answers from Firebase if any
            const savedAnswers = await loadDraftAnswers(examId, currentStudent.civilId);
            if (savedAnswers) {
                currentAnswers = savedAnswers;
            }

            // Setup timer
            if (hasTimer) {
                remainingTime = timerMinutes * 60;
                document.getElementById('examTimer').classList.remove('hidden');
                startTimer();
            } else {
                document.getElementById('examTimer').classList.add('hidden');
            }

            // Show exam
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('examSection').classList.remove('hidden');

            renderQuestions();
            setupVisibilityTracking();

            // الذهاب لأعلى الصفحة وللسؤال الأول
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Shuffle array helper
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Render Questions
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            const nav = document.getElementById('questionsNav');
            container.innerHTML = '';
            nav.innerHTML = '';

            let questions = Object.entries(currentExam.questions || {});

            // Shuffle questions if setting is enabled
            if (currentExam.settings?.shuffleQuestions) {
                questions = shuffleArray(questions);
            }
            document.getElementById('totalQuestions').textContent = questions.length;

            questions.forEach(([qId, question], index) => {
                // Navigation button
                const navBtn = document.createElement('button');
                navBtn.className = 'q-nav-btn' + (currentAnswers[qId] !== undefined ? ' answered' : '');
                navBtn.textContent = index + 1;
                navBtn.onclick = () => scrollToQuestion(qId);
                nav.appendChild(navBtn);

                // Question card
                const card = document.createElement('div');
                card.className = 'question-card' + (currentAnswers[qId] === undefined ? ' unanswered' : '');
                card.id = `question_${qId}`;

                const typeLabel = question.type === 'truefalse' ? 'صح/خطأ' : 'اختيار متعدد';

                card.innerHTML = `
                    <span class="question-number">السؤال ${index + 1} - ${typeLabel}</span>
                    <div class="question-text">${question.text}</div>
                    <div class="options-list">
                        ${question.options.map((opt, optIndex) => `
                            <div class="option-item ${currentAnswers[qId] === optIndex ? 'selected' : ''}"
                                 onclick="selectAnswer('${qId}', ${optIndex}, this)">
                                <div class="option-radio"></div>
                                <span>${opt}</span>
                            </div>
                        `).join('')}
                    </div>
                `;

                container.appendChild(card);
            });

            updateProgress();
        }

        // Select Answer
        function selectAnswer(questionId, optionIndex, element) {
            currentAnswers[questionId] = optionIndex;

            // Save to Firebase drafts
            saveDraftAnswers(currentExam.id, currentStudent.civilId, currentAnswers);

            // Update UI
            const card = element.closest('.question-card');
            card.querySelectorAll('.option-item').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            card.classList.remove('unanswered');

            // Update navigation
            const questions = Object.keys(currentExam.questions);
            const qIndex = questions.indexOf(questionId);
            const navBtns = document.querySelectorAll('.q-nav-btn');
            if (navBtns[qIndex]) navBtns[qIndex].classList.add('answered');

            updateProgress();
        }

        // Scroll to Question
        function scrollToQuestion(qId) {
            const element = document.getElementById(`question_${qId}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // Update Progress
        function updateProgress() {
            const total = Object.keys(currentExam.questions || {}).length;
            const answered = Object.keys(currentAnswers).length;
            document.getElementById('answeredCount').textContent = answered;
        }

        // Timer
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                remainingTime--;
                updateTimerDisplay();

                if (remainingTime <= 60) {
                    document.getElementById('examTimer').classList.add('warning');
                }

                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    autoSubmit();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function autoSubmit() {
            Swal.fire({
                title: 'انتهى الوقت!',
                text: 'تم إرسال إجاباتك تلقائياً',
                icon: 'info',
                confirmButtonText: 'حسناً',
                allowOutsideClick: false
            }).then(() => {
                submitExamData();
            });
        }

        // Visibility Tracking (Anti-cheat)
        function setupVisibilityTracking() {
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function handleVisibilityChange() {
            if (!isInExam) return;

            if (document.hidden) {
                violations++;
                document.getElementById('violationCount').textContent = violations;
                document.getElementById('violationBadge').classList.remove('hidden');

                // Record violation
                rootRef.child('responses').child(currentExam.id).child(currentStudent.civilId)
                    .child('violations').set(violations);
            } else {
                // Show warning
                Swal.fire({
                    title: '⚠️ تحذير',
                    html: `<p>تم تسجيل خروجك من صفحة الاختبار!</p>
                           <p style="color: #e74c3c; font-weight: 600;">عدد المخالفات: ${violations}</p>`,
                    icon: 'warning',
                    confirmButtonText: 'موافق',
                    confirmButtonColor: '#e74c3c'
                });
            }
        }

        // Submit Exam
        async function submitExam() {
            const total = Object.keys(currentExam.questions || {}).length;
            const answered = Object.keys(currentAnswers).length;

            if (answered < total) {
                const unanswered = total - answered;
                // تمييز الأسئلة غير المجابة
                const unansweredCards = document.querySelectorAll('.question-card.unanswered');
                unansweredCards.forEach(card => {
                    card.style.border = '2px solid var(--danger)';
                    card.style.animation = 'shake 0.5s ease';
                });

                // تمييز أزرار التنقل
                document.querySelectorAll('.q-nav-btn:not(.answered)').forEach(btn => {
                    btn.style.background = 'var(--danger)';
                    btn.style.color = 'white';
                });

                await Swal.fire({
                    title: 'يجب إكمال جميع الأسئلة',
                    html: `<p>لديك <strong>${unanswered}</strong> سؤال بدون إجابة</p>
                           <p style="color: var(--danger);">يرجى الإجابة على جميع الأسئلة قبل الإرسال</p>`,
                    icon: 'error',
                    confirmButtonText: 'العودة للأسئلة',
                    confirmButtonColor: '#e74c3c'
                });

                // الانتقال لأول سؤال غير مجاب
                unansweredCards[0]?.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                return;
            }

            // Confirm submission
            const confirmResult = await Swal.fire({
                title: 'تأكيد الإرسال',
                text: 'هل أنت متأكد من إرسال إجاباتك؟ لن تتمكن من التعديل بعد ذلك.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'إرسال',
                cancelButtonText: 'مراجعة',
                confirmButtonColor: '#2ecc71'
            });

            if (confirmResult.isConfirmed) {
                await submitExamData();
            }
        }

        async function submitExamData() {
            showLoading(true);
            clearInterval(timerInterval);

            try {
                // Calculate score
                let score = 0;
                let totalPoints = 0;

                for (const [qId, question] of Object.entries(currentExam.questions)) {
                    totalPoints += question.points || 1;
                    if (currentAnswers[qId] === question.correctAnswer) {
                        score += question.points || 1;
                    }
                }

                // Get submission rank
                const responsesSnap = await rootRef.child('responses').child(currentExam.id).once('value');
                const responses = responsesSnap.val() || {};
                const submittedCount = Object.values(responses).filter(r => r.submitted).length;
                const rank = submittedCount + 1;

                // Save response
                await rootRef.child('responses').child(currentExam.id).child(currentStudent.civilId).update({
                    answers: currentAnswers,
                    score: score,
                    totalPoints: totalPoints,
                    submitted: true,
                    submitTime: firebase.database.ServerValue.TIMESTAMP,
                    violations: violations,
                    rank: rank
                });

                // Clear saved answers from Firebase
                await clearDraftAnswers(currentExam.id, currentStudent.civilId);

                // إبطال التخزين المؤقت للاستجابات
                invalidateCache('responses');

                isInExam = false;
                document.removeEventListener('visibilitychange', handleVisibilityChange);

                showLoading(false);

                // Show correct answers if setting is enabled
                if (currentExam.settings?.showAnswersAfterSubmit) {
                    await showCorrectAnswers(score, totalPoints, rank);
                } else {
                    await showSurvey(rank, score, totalPoints);
                }

            } catch (error) {
                showLoading(false);
                showAlert('خطأ', 'حدث خطأ في إرسال الإجابات. حاول مرة أخرى.', 'error');
                console.error(error);
            }
        }

        // Show Correct Answers after submit
        async function showCorrectAnswers(score, totalPoints, rank) {
            const questions = Object.entries(currentExam.questions || {});
            let answersHtml = questions.map(([qId, q], index) => {
                const userAnswer = currentAnswers[qId];
                const isCorrect = userAnswer === q.correctAnswer;
                const correctOption = q.options[q.correctAnswer];
                const userOption = userAnswer !== undefined ? q.options[userAnswer] : 'لم تتم الإجابة';

                return `
                    <div style="background: ${isCorrect ? '#d4edda' : '#f8d7da'}; padding: 12px; border-radius: 8px; margin-bottom: 10px; text-align: right;">
                        <strong>س${index + 1}: ${q.text}</strong><br>
                        <span style="color: ${isCorrect ? '#155724' : '#721c24'};">
                            إجابتك: ${userOption} ${isCorrect ? '✓' : '✗'}
                        </span>
                        ${!isCorrect ? `<br><span style="color: #155724;">الإجابة الصحيحة: ${correctOption}</span>` : ''}
                    </div>
                `;
            }).join('');

            await Swal.fire({
                title: `📊 نتيجتك: ${score}/${totalPoints}`,
                html: `
                    <div style="text-align: center; margin-bottom: 15px;">
                        <p style="font-size: 18px; color: var(--primary);">ترتيبك: <strong>المختبر رقم ${rank}</strong></p>
                        <p style="color: ${score >= totalPoints * 0.6 ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            النسبة: ${Math.round((score / totalPoints) * 100)}%
                        </p>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${answersHtml}
                    </div>
                `,
                confirmButtonText: 'متابعة للتقييم',
                confirmButtonColor: '#1a5f7a',
                allowOutsideClick: false,
                width: '90%',
                customClass: { popup: 'swal-wide' }
            });

            await showSurvey(rank, score, totalPoints);
        }

        // Survey - النظام الديناميكي للاستبيان
        async function showSurvey(rank, score, totalPoints) {
            const hasSurvey = currentExam.settings?.hasSurvey;
            const surveySettings = currentExam.settings?.surveySettings;
            const showResults = currentExam.settings?.showResults;
            const percentage = totalPoints > 0 ? Math.round((score / totalPoints) * 100) : 0;

            // بناء محتوى النتيجة
            let resultHtml = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <p style="font-size: 18px; color: var(--primary);">ترتيبك: <strong>المختبر رقم ${rank}</strong></p>
                    ${showResults ? `<p style="color: ${percentage >= 60 ? '#28a745' : '#dc3545'}; font-weight: bold; font-size: 20px;">النتيجة: ${score}/${totalPoints} (${percentage}%)</p>` : '<p style="color: #666;">ستظهر النتيجة في وقت لاحق</p>'}
                </div>
            `;

            // إذا لم يكن هناك استبيان
            if (!hasSurvey) {
                await Swal.fire({
                    title: '✅ تم استلام إجاباتك',
                    html: resultHtml,
                    confirmButtonText: 'حسناً',
                    confirmButtonColor: '#1a5f7a',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                });
                exitExam();
                return;
            }

            // بناء محتوى الاستبيان حسب الإعدادات
            let surveyHtml = '<div class="survey-container">';
            const difficultyEnabled = surveySettings?.difficulty?.enabled !== false;
            const clarityEnabled = surveySettings?.clarity?.enabled !== false;
            const feedbackEnabled = surveySettings?.feedback?.enabled !== false;
            const difficultyRequired = surveySettings?.difficulty?.required !== false;
            const clarityRequired = surveySettings?.clarity?.required !== false;
            const feedbackRequired = surveySettings?.feedback?.required === true;

            if (difficultyEnabled) {
                surveyHtml += `
                    <div class="survey-question">
                        <label>مستوى صعوبة الأسئلة:${difficultyRequired ? ' <span style="color: red;">*</span>' : ''}</label>
                        <div class="rating-stars" id="difficultyStars">
                            ${[1,2,3,4,5].map(i => `<i class="far fa-star" data-rating="${i}" onclick="setRating('difficulty', ${i})"></i>`).join('')}
                        </div>
                    </div>
                `;
            }

            if (clarityEnabled) {
                surveyHtml += `
                    <div class="survey-question">
                        <label>وضوح الأسئلة:${clarityRequired ? ' <span style="color: red;">*</span>' : ''}</label>
                        <div class="rating-stars" id="clarityStars">
                            ${[1,2,3,4,5].map(i => `<i class="far fa-star" data-rating="${i}" onclick="setRating('clarity', ${i})"></i>`).join('')}
                        </div>
                    </div>
                `;
            }

            if (feedbackEnabled) {
                surveyHtml += `
                    <div class="survey-question">
                        <label>ملاحظاتك${feedbackRequired ? ' <span style="color: red;">*</span>' : ' (اختياري)'}:</label>
                        <textarea class="survey-textarea" id="surveyFeedback" maxlength="200" placeholder="اكتب ملاحظاتك هنا..."></textarea>
                        <div class="char-counter"><span id="charCount">0</span>/200</div>
                    </div>
                `;
            }

            surveyHtml += '</div>';

            let difficultyRating = 0;
            let clarityRating = 0;
            window.surveyRatings = { difficulty: 0, clarity: 0 };

            const result = await Swal.fire({
                title: '✅ تم استلام إجاباتك',
                html: resultHtml + surveyHtml,
                confirmButtonText: 'إرسال التقييم',
                confirmButtonColor: '#1a5f7a',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: () => {
                    const feedbackEl = document.getElementById('surveyFeedback');
                    if (feedbackEl) {
                        feedbackEl.addEventListener('input', (e) => {
                            document.getElementById('charCount').textContent = e.target.value.length;
                        });
                    }
                },
                preConfirm: () => {
                    difficultyRating = window.surveyRatings?.difficulty || 0;
                    clarityRating = window.surveyRatings?.clarity || 0;
                    const feedback = document.getElementById('surveyFeedback')?.value || '';

                    // التحقق من الحقول الإلزامية
                    if (difficultyEnabled && difficultyRequired && difficultyRating === 0) {
                        Swal.showValidationMessage('يرجى تقييم مستوى صعوبة الأسئلة');
                        return false;
                    }
                    if (clarityEnabled && clarityRequired && clarityRating === 0) {
                        Swal.showValidationMessage('يرجى تقييم وضوح الأسئلة');
                        return false;
                    }
                    if (feedbackEnabled && feedbackRequired && !feedback.trim()) {
                        Swal.showValidationMessage('يرجى كتابة ملاحظاتك');
                        return false;
                    }

                    return {
                        difficulty: difficultyRating,
                        clarity: clarityRating,
                        feedback: feedback
                    };
                }
            });

            if (result.isConfirmed) {
                // Save survey
                await rootRef.child('surveys').child(currentExam.id).child(currentStudent.civilId).set({
                    difficulty: result.value.difficulty,
                    clarity: result.value.clarity,
                    feedback: result.value.feedback,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                exitExam();
            }
        }

        // Rating helper
        window.surveyRatings = { difficulty: 0, clarity: 0 };
        window.setRating = function(type, rating) {
            window.surveyRatings[type] = rating;
            const container = document.getElementById(type === 'difficulty' ? 'difficultyStars' : 'clarityStars');
            container.querySelectorAll('i').forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove('far');
                    star.classList.add('fas', 'active');
                } else {
                    star.classList.remove('fas', 'active');
                    star.classList.add('far');
                }
            });
        };

        // Exit Exam
        async function exitExam() {
            // إذا كان الاختبار بمؤقت، إظهار رسالة تأكيد المخالفة
            if (currentExam && currentExam.settings?.hasTimer && isInExam) {
                const result = await Swal.fire({
                    title: 'تأكيد المغادرة',
                    html: `
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning); margin-bottom: 15px;"></i>
                            <p style="font-size: 16px; color: var(--danger); font-weight: bold;">تحذير: ستُرصد عليك مخالفة!</p>
                            <p style="color: var(--gray);">إذا غادرت الاختبار ودخلت مرة أخرى، ستُسجل مخالفة مرصودة عليك.</p>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: '<i class="fas fa-door-open"></i> مغادرة مع رصد المخالفة',
                    cancelButtonText: '<i class="fas fa-arrow-right"></i> الاستمرار في الاختبار',
                    confirmButtonColor: '#e74c3c',
                    cancelButtonColor: '#27ae60',
                    reverseButtons: true
                });

                if (!result.isConfirmed) {
                    return; // الاستمرار في الاختبار
                }
            }

            clearInterval(timerInterval);
            isInExam = false;
            currentExam = null;
            currentAnswers = {};
            violations = 0;

            document.getElementById('violationBadge').classList.add('hidden');
            document.getElementById('examSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');

            loadExams();
        }

        // Show Review
        function showReview(examId, exam, studentResponse) {
            currentExam = { id: examId, ...exam };

            const showResults = exam.settings?.showResults;
            const score = studentResponse.score || 0;
            const totalPoints = studentResponse.totalPoints || 1;
            const percentage = Math.round((score / totalPoints) * 100);

            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('reviewSection').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById('reviewExamTitle').textContent = exam.title;
            document.getElementById('reviewScore').textContent = showResults ? `${percentage}%` : '---';

            const header = document.getElementById('reviewHeader');

            if (showResults) {
                if (percentage === 100) {
                    header.className = 'review-header perfect';
                    document.getElementById('reviewMessage').textContent = '🎉 ممتاز! درجة كاملة';
                    showCelebration();
                } else if (percentage >= 80) {
                    document.getElementById('reviewMessage').textContent = '👏 أحسنت! نتيجة ممتازة';
                } else if (percentage >= 60) {
                    document.getElementById('reviewMessage').textContent = '👍 جيد، يمكنك التحسن';
                } else {
                    document.getElementById('reviewMessage').textContent = '💪 حاول مرة أخرى';
                    header.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                }
            } else {
                document.getElementById('reviewMessage').textContent = 'النتيجة ستعلن قريباً';
                header.style.background = 'linear-gradient(135deg, #6c757d, #5a6268)';
            }

            // Render questions with answers
            const container = document.getElementById('reviewQuestionsContainer');
            container.innerHTML = '';

            const questions = Object.entries(exam.questions || {});

            questions.forEach(([qId, question], index) => {
                const studentAnswer = studentResponse.answers?.[qId];
                const isCorrect = studentAnswer === question.correctAnswer;
                const isUnanswered = studentAnswer === undefined || studentAnswer === null;

                const card = document.createElement('div');
                card.className = 'question-card';

                // تمييز الأسئلة غير المجاب عليها بلون مختلف
                if (isUnanswered) {
                    card.style.borderRight = '4px solid var(--warning)';
                    card.style.background = 'rgba(243, 156, 18, 0.05)';
                }

                card.innerHTML = `
                    <span class="question-number">السؤال ${index + 1}${isUnanswered ? ' <span style="color: var(--warning); font-size: 12px;">(لم تُجب - انتهى الوقت)</span>' : ''}</span>
                    <div class="question-text">${question.text}</div>
                    <div class="options-list">
                        ${question.options.map((opt, optIndex) => {
                            let optClass = 'option-item';
                            if (showResults) {
                                if (optIndex === question.correctAnswer) {
                                    optClass += ' correct';
                                } else if (optIndex === studentAnswer && !isCorrect) {
                                    optClass += ' wrong';
                                }
                            } else {
                                if (optIndex === studentAnswer) {
                                    optClass += ' selected';
                                }
                            }
                            return `
                                <div class="${optClass}">
                                    <div class="option-radio"></div>
                                    <span>${opt}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                container.appendChild(card);
            });

            // Show/hide retake button
            document.getElementById('retakeSection').style.display = showResults ? 'block' : 'none';
        }

        // Exit Review
        function exitReview() {
            document.getElementById('reviewSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.remove('hidden');
        }

        // Request Retake
        async function requestRetake() {
            // التحقق من وجود طلب سابق لنفس الاختبار
            const existingRequests = await rootRef.child('retakeRequests')
                .orderByChild('studentId')
                .equalTo(currentStudent.civilId)
                .once('value');

            let alreadyRequested = false;
            let wasRejected = false;
            if (existingRequests.exists()) {
                existingRequests.forEach(snap => {
                    const req = snap.val();
                    if (req.examId === currentExam.id) {
                        if (req.status === 'rejected') {
                            wasRejected = true;
                        } else if (req.status === 'pending') {
                            alreadyRequested = true;
                        }
                    }
                });
            }

            // إذا تم الرفض سابقاً
            if (wasRejected) {
                showAlert('تم رفض طلبك', 'تم رفض طلب إعادة الاختبار سابقاً. تواصل مع المعلم مباشرة.', 'error');
                return;
            }

            if (alreadyRequested) {
                showAlert('تم الطلب سابقاً', 'لقد قمت بطلب إعادة هذا الاختبار مسبقاً. يرجى انتظار رد المعلم.', 'info');
                return;
            }

            const { value: reason } = await Swal.fire({
                title: 'طلب إعادة الاختبار',
                input: 'textarea',
                inputLabel: 'سبب طلب الإعادة:',
                inputPlaceholder: 'اكتب السبب هنا...',
                showCancelButton: true,
                confirmButtonText: 'إرسال الطلب',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                inputValidator: (value) => {
                    if (!value) {
                        return 'يرجى كتابة سبب الطلب';
                    }
                }
            });

            if (reason) {
                await rootRef.child('retakeRequests').push({
                    examId: currentExam.id,
                    examTitle: currentExam.title,
                    studentId: currentStudent.civilId,
                    studentName: currentStudent.name,
                    reason: reason,
                    status: 'pending',
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                showAlert('تم الإرسال', 'تم إرسال طلبك للمعلم', 'success');
            }
        }

        // Celebration
        function showCelebration() {
            const colors = ['#f39c12', '#e74c3c', '#2ecc71', '#3498db', '#9b59b6'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.cssText = `
                        position: fixed;
                        top: -10px;
                        left: ${Math.random() * 100}%;
                        width: 10px;
                        height: 10px;
                        background: ${colors[Math.floor(Math.random() * colors.length)]};
                        border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                        pointer-events: none;
                        z-index: 9999;
                        animation: confettiFall ${2 + Math.random() * 2}s linear forwards;
                    `;
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 4000);
                }, i * 50);
            }

            const style = document.createElement('style');
            style.textContent = `
                @keyframes confettiFall {
                    to {
                        transform: translateY(100vh) rotate(720deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        // Helpers
        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showAlert(title, text, icon) {
            return Swal.fire({
                title,
                text,
                icon,
                confirmButtonText: 'حسناً',
                confirmButtonColor: '#1a5f7a'
            });
        }

        // Admin access (double-click on logo)
        let clickCount = 0;
        let clickTimer = null;
        document.getElementById('adminHint').addEventListener('click', () => {
            clickCount++;
            if (clickCount === 2) {
                clickCount = 0;
                clearTimeout(clickTimer);
                showAdminLogin();
            } else {
                clickTimer = setTimeout(() => { clickCount = 0; }, 500);
            }
        });

        async function showAdminLogin() {
            const { value: password } = await Swal.fire({
                title: 'لوحة التحكم',
                input: 'password',
                inputLabel: 'كلمة المرور:',
                inputPlaceholder: 'أدخل كلمة المرور',
                showCancelButton: true,
                confirmButtonText: 'دخول',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a'
            });

            if (password) {
                const configSnap = await rootRef.child('config/teacherPassword').once('value');
                if (password === configSnap.val()) {
                    showAdminPanel();
                } else {
                    showAlert('خطأ', 'كلمة المرور غير صحيحة', 'error');
                }
            }
        }

        // ============ ADMIN PANEL FUNCTIONS ============
        let allStudents = [];
        let filteredStudents = [];
        let allExamsAdmin = [];
        let sortColumn = 'name';
        let sortDirection = 'asc';
        let currentPage = 1;
        const PAGE_SIZE = 45;
        let showAllStudents = false;

        // Teachers variables
        let allTeachers = [];
        let filteredTeachers = [];
        let teacherSortColumn = 'name';
        let teacherSortDirection = 'asc';
        let teacherCurrentPage = 1;
        const TEACHER_PAGE_SIZE = 45;
        let showAllTeachers = false;

        function showAdminPanel() {
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('dashboardSection').classList.add('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.querySelector('.container').classList.add('admin-container');
            loadAdminData();
        }

        function exitAdmin() {
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('loginSection').classList.remove('hidden');
            document.querySelector('.container').classList.remove('admin-container');
        }

        function switchAdminTab(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));

            document.querySelector(`[onclick="switchAdminTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}Panel`).classList.add('active');

            if (tab === 'students') loadStudents();
            if (tab === 'teachers') loadTeachers();
            if (tab === 'exams') loadAdminExams();
            if (tab === 'results') loadResultsExamOptions();
            if (tab === 'requests') loadRetakeRequests();
        }

        async function loadAdminData() {
            await loadStudents();
        }

        // ============ STUDENTS MANAGEMENT ============
        async function loadStudents() {
            showLoading(true);
            try {
                const snap = await rootRef.child('students').once('value');
                allStudents = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        allStudents.push({ civilId: child.key, ...child.val() });
                    });
                }
                renderStudentsTable(allStudents);
            } catch (error) {
                console.error('Error loading students:', error);
            }
            showLoading(false);
        }

        function renderStudentsTable(students) {
            filteredStudents = students;
            const tbody = document.getElementById('studentsTableBody');

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-users" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            لا يوجد طلاب
                        </td>
                    </tr>
                `;
                renderPagination(0);
                return;
            }

            // حساب الصفحات
            const totalPages = Math.ceil(students.length / PAGE_SIZE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            // تحديد الطلاب للعرض
            let displayStudents;
            if (showAllStudents) {
                displayStudents = students;
            } else {
                const start = (currentPage - 1) * PAGE_SIZE;
                const end = start + PAGE_SIZE;
                displayStudents = students.slice(start, end);
            }

            tbody.innerHTML = displayStudents.map(s => `
                <tr>
                    <td>${cleanText(s.civilId)}</td>
                    <td>${cleanText(s.name)}</td>
                    <td>${cleanText(s.grade)}</td>
                    <td>${cleanText(s.section)}</td>
                    <td>
                        <div class="table-actions">
                            <button class="icon-btn view" title="عرض النتائج" onclick="viewStudentResults('${s.civilId}')">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            <button class="icon-btn edit" title="تعديل" onclick="editStudent('${s.civilId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn reset" title="تصفير الاختبارات" onclick="resetStudentExams('${s.civilId}')">
                                <i class="fas fa-undo"></i>
                            </button>
                            <button class="icon-btn delete" title="حذف" onclick="deleteStudent('${s.civilId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            renderPagination(students.length);
        }

        function renderPagination(total) {
            let paginationDiv = document.getElementById('studentsPagination');
            if (!paginationDiv) {
                const table = document.getElementById('studentsTableBody').closest('table');
                paginationDiv = document.createElement('div');
                paginationDiv.id = 'studentsPagination';
                paginationDiv.className = 'pagination-controls';
                table.parentNode.insertBefore(paginationDiv, table.nextSibling);
            }

            if (total === 0) {
                paginationDiv.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(total / PAGE_SIZE);
            const start = showAllStudents ? 1 : (currentPage - 1) * PAGE_SIZE + 1;
            const end = showAllStudents ? total : Math.min(currentPage * PAGE_SIZE, total);

            paginationDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card-bg); border-radius: 0 0 12px 12px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--gray);">عرض ${start} - ${end} من ${total}</span>
                        <button class="action-btn ${showAllStudents ? 'primary' : 'outline'}" onclick="toggleShowAll()" style="padding: 5px 15px; font-size: 12px;">
                            ${showAllStudents ? 'عرض 45' : 'عرض الكل'}
                        </button>
                    </div>
                    ${!showAllStudents && totalPages > 1 ? `
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="action-btn outline" onclick="goToPage(1)" ${currentPage === 1 ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                            <button class="action-btn outline" onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <span style="padding: 5px 15px; background: var(--primary); color: white; border-radius: 5px;">${currentPage} / ${totalPages}</span>
                            <button class="action-btn outline" onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <button class="action-btn outline" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function goToPage(page) {
            currentPage = page;
            renderStudentsTable(filteredStudents);
        }

        function toggleShowAll() {
            showAllStudents = !showAllStudents;
            currentPage = 1;
            renderStudentsTable(filteredStudents);
        }

        // دالة تنظيف النصوص من الأحرف الفاسدة (Unicode replacement character)
        function cleanText(text) {
            if (!text) return '';
            // إزالة الأحرف الفاسدة (U+FFFD) والأحرف غير المطبوعة
            return text.replace(/\uFFFD/g, '').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '').trim();
        }

        // دالة تحديث الشعب حسب الصف المختار في فلتر ��لطلاب
        function updateStudentsSectionFilter() {
            const grade = document.getElementById('gradeFilter').value;
            const sectionFilter = document.getElementById('sectionFilter');
            const sections = getSectionsForGrade(grade);

            sectionFilter.innerHTML = '<option value="">كل الشعب</option>' +
                sections.map(s => `<option value="${s}">شعبة ${s}</option>`).join('');
        }

        function filterStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const grade = document.getElementById('gradeFilter').value;
            const section = document.getElementById('sectionFilter').value;

            currentPage = 1; // Reset to first page on filter

            let filtered = allStudents.filter(s => {
                const matchSearch = s.name.toLowerCase().includes(search) || s.civilId.includes(search);
                const matchGrade = !grade || s.grade === grade;
                const matchSection = !section || s.section === section;
                return matchSearch && matchGrade && matchSection;
            });

            renderStudentsTable(filtered);
        }

        function sortStudents(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            allStudents.sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                if (sortDirection === 'asc') {
                    return valA.localeCompare(valB, 'ar');
                } else {
                    return valB.localeCompare(valA, 'ar');
                }
            });

            filterStudents();
        }

        async function showAddStudentModal() {
            const { value: formValues } = await Swal.fire({
                title: 'إضافة طالب جديد',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>السجل المدني:</label>
                            <input id="swal-civilId" class="swal2-input" placeholder="1234567890" maxlength="10">
                        </div>
                        <div class="form-group">
                            <label>الاسم:</label>
                            <input id="swal-name" class="swal2-input" placeholder="اسم الطالب">
                        </div>
                        <div class="form-group">
                            <label>الصف:</label>
                            <select id="swal-grade" class="swal2-select">
                                <option value="أول ثانوي">أول ثانوي</option>
                                <option value="ثاني ثانوي">ثاني ثانوي</option>
                                <option value="ثالث ثانوي">ثالث ثانوي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الشعبة:</label>
                            <select id="swal-section" class="swal2-select">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    const gradeSelect = document.getElementById('swal-grade');
                    const sectionSelect = document.getElementById('swal-section');
                    gradeSelect.addEventListener('change', () => {
                        const sections = getSectionsForGrade(gradeSelect.value);
                        sectionSelect.innerHTML = sections.map(s => `<option value="${s}">${s}</option>`).join('');
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                preConfirm: () => {
                    const civilId = document.getElementById('swal-civilId').value.trim();
                    const name = document.getElementById('swal-name').value.trim();
                    const grade = document.getElementById('swal-grade').value;
                    const section = document.getElementById('swal-section').value;

                    if (!civilId || civilId.length !== 10) {
                        Swal.showValidationMessage('السجل المدني يجب أن يكون 10 أرقام');
                        return false;
                    }
                    if (!name) {
                        Swal.showValidationMessage('يرجى إدخال اسم الطالب');
                        return false;
                    }
                    return { civilId, name, grade, section };
                }
            });

            if (formValues) {
                try {
                    await rootRef.child('students').child(formValues.civilId).set({
                        name: formValues.name,
                        grade: formValues.grade,
                        section: formValues.section,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    showAlert('تم', 'تمت إضافة الطالب بنجاح', 'success');
                    loadStudents();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الإضافة', 'error');
                }
            }
        }

        async function editStudent(civilId) {
            const student = allStudents.find(s => s.civilId === civilId);
            if (!student) return;

            const currentSections = getSectionsForGrade(student.grade);
            const { value: formValues } = await Swal.fire({
                title: 'تعديل بيانات الطالب',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>السجل المدني:</label>
                            <input id="swal-civilId" class="swal2-input" value="${civilId}" disabled>
                        </div>
                        <div class="form-group">
                            <label>الاسم:</label>
                            <input id="swal-name" class="swal2-input" value="${student.name}">
                        </div>
                        <div class="form-group">
                            <label>الصف:</label>
                            <select id="swal-grade" class="swal2-select">
                                <option value="أول ثانوي" ${student.grade === 'أول ثانوي' ? 'selected' : ''}>أول ثانوي</option>
                                <option value="ثاني ثانوي" ${student.grade === 'ثاني ثانوي' ? 'selected' : ''}>ثاني ثانوي</option>
                                <option value="ثالث ثانوي" ${student.grade === 'ثالث ثانوي' ? 'selected' : ''}>ثالث ثانوي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الشعبة:</label>
                            <select id="swal-section" class="swal2-select">
                                ${currentSections.map(s => `<option value="${s}" ${student.section === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `,
                didOpen: () => {
                    const gradeSelect = document.getElementById('swal-grade');
                    const sectionSelect = document.getElementById('swal-section');
                    gradeSelect.addEventListener('change', () => {
                        const sections = getSectionsForGrade(gradeSelect.value);
                        sectionSelect.innerHTML = sections.map(s => `<option value="${s}">${s}</option>`).join('');
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                preConfirm: () => ({
                    name: document.getElementById('swal-name').value.trim(),
                    grade: document.getElementById('swal-grade').value,
                    section: document.getElementById('swal-section').value
                })
            });

            if (formValues) {
                try {
                    await rootRef.child('students').child(civilId).update(formValues);
                    showAlert('تم', 'تم تحديث البيانات', 'success');
                    loadStudents();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء التحديث', 'error');
                }
            }
        }

        async function deleteStudent(civilId) {
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا الطالب؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    await rootRef.child('students').child(civilId).remove();
                    showAlert('تم', 'تم حذف الطالب', 'success');
                    loadStudents();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الحذف', 'error');
                }
            }
        }

        async function resetStudentExams(civilId) {
            const result = await Swal.fire({
                title: 'تصفير الاختبارات',
                text: 'سيتم حذف جميع إجابات الطالب وسيتمكن من إعادة الاختبارات',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'تصفير',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#9b59b6'
            });

            if (result.isConfirmed) {
                try {
                    const responsesSnap = await rootRef.child('responses').once('value');
                    if (responsesSnap.exists()) {
                        const updates = {};
                        responsesSnap.forEach(examSnap => {
                            if (examSnap.child(civilId).exists()) {
                                updates[`responses/${examSnap.key}/${civilId}`] = null;
                            }
                        });
                        await rootRef.update(updates);
                    }
                    showAlert('تم', 'تم تصفير اختبارات الطالب', 'success');
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ', 'error');
                }
            }
        }

        async function viewStudentResults(civilId) {
            showLoading(true);
            try {
                const student = allStudents.find(s => s.civilId === civilId);
                // تحميل البيانات بالتوازي لتحسين الأداء
                const [examsSnap, responsesSnap] = await Promise.all([
                    rootRef.child('exams').once('value'),
                    rootRef.child('responses').once('value')
                ]);

                let resultsHtml = `<h4 style="margin-bottom: 15px;">${student.name}</h4>`;
                resultsHtml += '<table style="width: 100%; border-collapse: collapse;">';
                resultsHtml += '<tr style="background: #f5f5f5;"><th style="padding: 10px; text-align: right;">الاختبار</th><th style="padding: 10px;">الدرجة</th><th style="padding: 10px;">الحالة</th><th style="padding: 10px;">إجراء</th></tr>';

                if (examsSnap.exists()) {
                    examsSnap.forEach(examSnap => {
                        const exam = examSnap.val();
                        const response = responsesSnap.val()?.[examSnap.key]?.[civilId];

                        let status = 'لم يختبر';
                        let score = '-';
                        let resetBtn = '';

                        if (response?.submitted) {
                            status = 'مكتمل';
                            score = `${response.score || 0}/${response.totalPoints || 0}`;
                            resetBtn = `<button onclick="resetStudentExamResult('${examSnap.key}', '${civilId}', '${exam.title.replace(/'/g, "\\'")}');Swal.close();" style="background: var(--warning); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;"><i class="fas fa-redo"></i> تصفير</button>`;
                        }

                        resultsHtml += `<tr>
                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${exam.title}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${score}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${status}</td>
                            <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">${resetBtn}</td>
                        </tr>`;
                    });
                }
                resultsHtml += '</table>';

                showLoading(false);
                Swal.fire({
                    title: 'نتائج الطالب',
                    html: resultsHtml,
                    width: 650,
                    confirmButtonText: 'إغلاق',
                    confirmButtonColor: '#1a5f7a'
                });
            } catch (error) {
                showLoading(false);
                showAlert('خطأ', 'حدث خطأ في تحميل النتائج', 'error');
            }
        }

        // تصفير اختبار محدد لطالب من نتائجه
        async function resetStudentExamResult(examId, studentId, examTitle) {
            const result = await Swal.fire({
                title: 'تصفير الاختبار',
                html: `<p>هل تريد تصفير اختبار <strong>${examTitle}</strong> لهذا الطالب؟</p>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'تصفير',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#f39c12'
            });

            if (result.isConfirmed) {
                await rootRef.child('responses').child(examId).child(studentId).remove();
                await rootRef.child('surveys').child(examId).child(studentId).remove();
                showAlert('تم', 'تم تصفير الاختبار للطالب', 'success');
            }
        }

        function showImportModal() {
            Swal.fire({
                title: 'استيراد من Excel',
                html: `
                    <div style="text-align: right;">
                        <p style="margin-bottom: 15px; color: #666;">
                            يجب أن يحتوي المل�� على الأعمدة التالية بالترتيب:
                            <br>السجل المدني، الاسم، الصف، الشعبة
                        </p>
                        <div class="file-upload" onclick="document.getElementById('excelFile').click()">
                            <i class="fas fa-file-excel"></i>
                            <p>اضغط لاختيار ملف Excel</p>
                            <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="handleExcelImport(this)">
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء'
            });
        }

        async function handleExcelImport(input) {
            const file = input.files[0];
            if (!file) return;

            showLoading(true);
            Swal.close();

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                const students = [];

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                    if (cols.length >= 4 && cols[0].length === 10) {
                        students.push({
                            civilId: cols[0],
                            name: cols[1],
                            grade: cols[2],
                            section: cols[3]
                        });
                    }
                }

                if (students.length === 0) {
                    showLoading(false);
                    showAlert('خطأ', 'لم يتم العثور على بيانات صالحة', 'error');
                    return;
                }

                const updates = {};
                students.forEach(s => {
                    updates[`students/${s.civilId}`] = {
                        name: s.name,
                        grade: s.grade,
                        section: s.section,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };
                });

                await rootRef.update(updates);
                showLoading(false);
                showAlert('تم', `تم استيراد ${students.length} طالب`, 'success');
                loadStudents();
            } catch (error) {
                showLoading(false);
                showAlert('خطأ', 'حدث خطأ في قراءة الملف', 'error');
                console.error(error);
            }
        }

        function exportStudents() {
            if (allStudents.length === 0) {
                showAlert('تنبيه', 'لا يوجد طلاب للتصدير', 'info');
                return;
            }

            let csv = 'السجل المدني,الاسم,الصف,الشعبة\n';
            allStudents.forEach(s => {
                csv += `${s.civilId},${s.name},${s.grade},${s.section}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'students.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function deleteAllStudents() {
            if (allStudents.length === 0) {
                showAlert('تنبيه', 'لا يوجد طلاب للحذف', 'info');
                return;
            }

            const result = await Swal.fire({
                title: 'حذف جميع الطلاب',
                html: `
                    <p style="color: var(--danger); font-weight: bold;">تحذير! هذا الإجراء لا يمكن التراجع عنه</p>
                    <p>سيتم حذف <strong>${allStudents.length}</strong> طالب مع جميع إجاباتهم وإحصائياتهم</p>
                    <div style="margin-top: 15px;">
                        <input type="text" id="confirmDelete" class="swal2-input" placeholder="اكتب 'حذف' للتأكيد">
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف الجميع',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c',
                preConfirm: () => {
                    const confirm = document.getElementById('confirmDelete').value;
                    if (confirm !== 'حذف') {
                        Swal.showValidationMessage('يرجى كتابة "حذف" للتأكيد');
                        return false;
                    }
                    return true;
                }
            });

            if (result.isConfirmed) {
                showLoading(true);
                try {
                    await rootRef.child('students').remove();
                    await rootRef.child('responses').remove();
                    await rootRef.child('surveys').remove();
                    await rootRef.child('retakeRequests').remove();
                    showLoading(false);
                    showAlert('تم', 'تم حذف جميع الطلاب وبياناتهم', 'success');
                    loadStudents();
                } catch (error) {
                    showLoading(false);
                    showAlert('خطأ', 'حدث خطأ أثناء الحذف', 'error');
                }
            }
        }

        // ============ TEACHERS MANAGEMENT ============
        async function loadTeachers() {
            showLoading(true);
            try {
                const snap = await rootRef.child('teachers').once('value');
                allTeachers = [];
                if (snap.exists()) {
                    snap.forEach(child => {
                        allTeachers.push({ civilId: child.key, ...child.val() });
                    });
                }
                renderTeachersTable(allTeachers);
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
            showLoading(false);
        }

        function renderTeachersTable(teachers) {
            filteredTeachers = teachers;
            const tbody = document.getElementById('teachersTableBody');

            if (teachers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 40px; color: var(--gray);">
                            <i class="fas fa-chalkboard-teacher" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            لا يوجد معلمين
                        </td>
                    </tr>
                `;
                renderTeachersPagination(0);
                return;
            }

            const totalPages = Math.ceil(teachers.length / TEACHER_PAGE_SIZE);
            if (teacherCurrentPage > totalPages) teacherCurrentPage = totalPages;
            if (teacherCurrentPage < 1) teacherCurrentPage = 1;

            let displayTeachers;
            if (showAllTeachers) {
                displayTeachers = teachers;
            } else {
                const start = (teacherCurrentPage - 1) * TEACHER_PAGE_SIZE;
                const end = start + TEACHER_PAGE_SIZE;
                displayTeachers = teachers.slice(start, end);
            }

            tbody.innerHTML = displayTeachers.map(t => {
                const sectionsDisplay = t.sections && t.sections.length > 0
                    ? t.sections.map(s => `${s.grade} - ${s.section}`).join('، ')
                    : 'لم يحدد';
                return `
                <tr>
                    <td>${cleanText(t.civilId)}</td>
                    <td>${cleanText(t.name)}</td>
                    <td style="max-width: 300px; white-space: normal;">${sectionsDisplay}</td>
                    <td>
                        <div class="table-actions">
                            <button class="icon-btn edit" title="تعديل" onclick="editTeacher('${t.civilId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" title="حذف" onclick="deleteTeacher('${t.civilId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');

            renderTeachersPagination(teachers.length);
        }

        function renderTeachersPagination(total) {
            let paginationDiv = document.getElementById('teachersPagination');
            if (!paginationDiv) {
                const table = document.getElementById('teachersTableBody').closest('table');
                paginationDiv = document.createElement('div');
                paginationDiv.id = 'teachersPagination';
                paginationDiv.className = 'pagination-controls';
                table.parentNode.insertBefore(paginationDiv, table.nextSibling);
            }

            if (total === 0) {
                paginationDiv.innerHTML = '';
                return;
            }

            const totalPages = Math.ceil(total / TEACHER_PAGE_SIZE);
            const start = showAllTeachers ? 1 : (teacherCurrentPage - 1) * TEACHER_PAGE_SIZE + 1;
            const end = showAllTeachers ? total : Math.min(teacherCurrentPage * TEACHER_PAGE_SIZE, total);

            paginationDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--card-bg); border-radius: 0 0 12px 12px; flex-wrap: wrap; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--gray);">عرض ${start} - ${end} من ${total}</span>
                        <button class="action-btn ${showAllTeachers ? 'primary' : 'outline'}" onclick="toggleShowAllTeachers()" style="padding: 5px 15px; font-size: 12px;">
                            ${showAllTeachers ? 'عرض 45' : 'عرض الكل'}
                        </button>
                    </div>
                    ${!showAllTeachers && totalPages > 1 ? `
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="action-btn outline" onclick="goToTeacherPage(1)" ${teacherCurrentPage === 1 ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                            <button class="action-btn outline" onclick="goToTeacherPage(${teacherCurrentPage - 1})" ${teacherCurrentPage === 1 ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-right"></i>
                            </button>
                            <span style="padding: 5px 15px; background: var(--primary); color: white; border-radius: 5px;">${teacherCurrentPage} / ${totalPages}</span>
                            <button class="action-btn outline" onclick="goToTeacherPage(${teacherCurrentPage + 1})" ${teacherCurrentPage === totalPages ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-left"></i>
                            </button>
                            <button class="action-btn outline" onclick="goToTeacherPage(${totalPages})" ${teacherCurrentPage === totalPages ? 'disabled' : ''} style="padding: 5px 10px;">
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function goToTeacherPage(page) {
            teacherCurrentPage = page;
            renderTeachersTable(filteredTeachers);
        }

        function toggleShowAllTeachers() {
            showAllTeachers = !showAllTeachers;
            teacherCurrentPage = 1;
            renderTeachersTable(filteredTeachers);
        }

        function filterTeachers() {
            const search = document.getElementById('teacherSearch').value.toLowerCase();
            const grade = document.getElementById('teacherGradeFilter').value;

            teacherCurrentPage = 1;

            let filtered = allTeachers.filter(t => {
                const matchSearch = t.name.toLowerCase().includes(search) || t.civilId.includes(search);
                const matchGrade = !grade || (t.sections && t.sections.some(s => s.grade === grade));
                return matchSearch && matchGrade;
            });

            renderTeachersTable(filtered);
        }

        function sortTeachers(column) {
            if (teacherSortColumn === column) {
                teacherSortDirection = teacherSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                teacherSortColumn = column;
                teacherSortDirection = 'asc';
            }

            filteredTeachers.sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return teacherSortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return teacherSortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            renderTeachersTable(filteredTeachers);
        }

        async function showAddTeacherModal() {
            const allGrades = ['أول ثانوي', 'ثاني ثانوي', 'ثالث ثانوي'];

            const { value: formValues } = await Swal.fire({
                title: 'إضافة معلم جديد',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>السجل المدني:</label>
                            <input id="swal-civilId" class="swal2-input" placeholder="أدخل السجل المدني (10 أرقام)" style="text-align: center;">
                        </div>
                        <div class="form-group">
                            <label>اسم المعلم:</label>
                            <input id="swal-name" class="swal2-input" placeholder="أدخل اسم المعلم">
                        </div>
                        <div class="form-group">
                            <label>الشعب التي يدرسها:</label>
                            <div id="sectionsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                ${allGrades.map(grade => {
                                    const sections = getSectionsForGrade(grade);
                                    return `
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: var(--primary);">${grade}</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                                ${sections.map(sec => `
                                                    <label style="display: flex; align-items: center; gap: 3px; padding: 5px 10px; background: #f5f5f5; border-radius: 5px; cursor: pointer;">
                                                        <input type="checkbox" class="section-checkbox" data-grade="${grade}" data-section="${sec}">
                                                        <span>${sec}</span>
                                                    </label>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                width: '500px',
                preConfirm: () => {
                    const civilId = document.getElementById('swal-civilId').value.trim();
                    const name = document.getElementById('swal-name').value.trim();
                    const checkboxes = document.querySelectorAll('.section-checkbox:checked');
                    const sections = Array.from(checkboxes).map(cb => ({
                        grade: cb.dataset.grade,
                        section: cb.dataset.section
                    }));

                    if (!civilId || civilId.length !== 10) {
                        Swal.showValidationMessage('السجل المدني يجب أن يكون 10 أرقام');
                        return false;
                    }
                    if (!name) {
                        Swal.showValidationMessage('يرجى إدخال اسم المعلم');
                        return false;
                    }
                    if (sections.length === 0) {
                        Swal.showValidationMessage('يرجى اختيار شعبة واحدة على الأقل');
                        return false;
                    }
                    return { civilId, name, sections };
                }
            });

            if (formValues) {
                try {
                    await rootRef.child('teachers').child(formValues.civilId).set({
                        name: formValues.name,
                        password: formValues.civilId,
                        sections: formValues.sections,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    showAlert('تم', 'تمت إضافة المعلم بنجاح', 'success');
                    loadTeachers();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الإضافة', 'error');
                }
            }
        }

        async function editTeacher(civilId) {
            const teacher = allTeachers.find(t => t.civilId === civilId);
            if (!teacher) return;

            const allGrades = ['أول ثانوي', 'ثاني ثانوي', 'ثالث ثانوي'];
            const currentSections = teacher.sections || [];

            const { value: formValues } = await Swal.fire({
                title: 'تعديل بيانات المعلم',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>السجل المدني:</label>
                            <input id="swal-civilId" class="swal2-input" value="${civilId}" disabled style="text-align: center;">
                        </div>
                        <div class="form-group">
                            <label>اسم المعلم:</label>
                            <input id="swal-name" class="swal2-input" value="${teacher.name}">
                        </div>
                        <div class="form-group">
                            <label>الشعب التي يدرسها:</label>
                            <div id="sectionsContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-top: 10px;">
                                ${allGrades.map(grade => {
                                    const sections = getSectionsForGrade(grade);
                                    return `
                                        <div style="margin-bottom: 10px;">
                                            <strong style="color: var(--primary);">${grade}</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                                ${sections.map(sec => {
                                                    const isChecked = currentSections.some(cs => cs.grade === grade && cs.section === sec);
                                                    return `
                                                    <label style="display: flex; align-items: center; gap: 3px; padding: 5px 10px; background: #f5f5f5; border-radius: 5px; cursor: pointer;">
                                                        <input type="checkbox" class="section-checkbox" data-grade="${grade}" data-section="${sec}" ${isChecked ? 'checked' : ''}>
                                                        <span>${sec}</span>
                                                    </label>
                                                `}).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                width: '500px',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value.trim();
                    const checkboxes = document.querySelectorAll('.section-checkbox:checked');
                    const sections = Array.from(checkboxes).map(cb => ({
                        grade: cb.dataset.grade,
                        section: cb.dataset.section
                    }));

                    if (!name) {
                        Swal.showValidationMessage('يرجى إدخال اسم المعلم');
                        return false;
                    }
                    return { name, sections };
                }
            });

            if (formValues) {
                try {
                    await rootRef.child('teachers').child(civilId).update({
                        name: formValues.name,
                        sections: formValues.sections
                    });
                    showAlert('تم', 'تم تحديث البيانات', 'success');
                    loadTeachers();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء التحديث', 'error');
                }
            }
        }

        async function deleteTeacher(civilId) {
            const result = await Swal.fire({
                title: 'تأكيد الحذف',
                text: 'هل أنت متأكد من حذف هذا المعلم؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                try {
                    await rootRef.child('teachers').child(civilId).remove();
                    showAlert('تم', 'تم حذف المعلم', 'success');
                    loadTeachers();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الحذف', 'error');
                }
            }
        }

        function showImportTeachersModal() {
            Swal.fire({
                title: 'استيراد المعلمين من Excel',
                html: `
                    <div style="text-align: right;">
                        <p style="margin-bottom: 15px; color: var(--gray);">
                            يجب أن يكون الملف بصيغة CSV ويحتوي على الأعمدة التالية:
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; font-family: monospace; direction: ltr; text-align: left;">
                            السجل المدني,الاسم,الصف,الشعبة
                        </div>
                        <p style="margin-bottom: 15px; color: var(--warning); font-size: 13px;">
                            <i class="fas fa-info-circle"></i>
                            ملاحظة: إذا كان المعلم يدرس عدة شعب، أضف سطراً لكل شعبة بنفس السجل المدني
                        </p>
                        <div class="form-group">
                            <input type="file" id="teacherFileInput" accept=".csv,.txt" style="width: 100%;" onchange="handleTeachersExcelImport(this)">
                        </div>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: true,
                cancelButtonText: 'إلغاء'
            });
        }

        async function handleTeachersExcelImport(input) {
            const file = input.files[0];
            if (!file) return;

            showLoading(true);
            Swal.close();

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                const teachersMap = {};

                for (let i = 1; i < lines.length; i++) {
                    const cols = lines[i].split(',').map(c => c.trim().replace(/"/g, ''));
                    if (cols.length >= 4 && cols[0].length === 10) {
                        const civilId = cols[0];
                        const name = cols[1];
                        const grade = cols[2];
                        const section = cols[3];

                        if (!teachersMap[civilId]) {
                            teachersMap[civilId] = {
                                name: name,
                                password: civilId,
                                sections: [],
                                createdAt: firebase.database.ServerValue.TIMESTAMP
                            };
                        }
                        teachersMap[civilId].sections.push({ grade, section });
                    }
                }

                const teacherCount = Object.keys(teachersMap).length;
                if (teacherCount === 0) {
                    showLoading(false);
                    showAlert('خطأ', 'لم يتم العثور على بيانات صالحة', 'error');
                    return;
                }

                const updates = {};
                Object.entries(teachersMap).forEach(([civilId, data]) => {
                    updates[`teachers/${civilId}`] = data;
                });

                await rootRef.update(updates);
                showLoading(false);
                showAlert('تم', `تم استيراد ${teacherCount} معلم`, 'success');
                loadTeachers();
            } catch (error) {
                showLoading(false);
                showAlert('خطأ', 'حدث خطأ في قراءة الملف', 'error');
                console.error(error);
            }
        }

        function exportTeachers() {
            if (allTeachers.length === 0) {
                showAlert('تنبيه', 'لا يوجد معلمين للتصدير', 'info');
                return;
            }

            let csv = 'السجل المدني,الاسم,الصف,الشعبة\n';
            allTeachers.forEach(t => {
                if (t.sections && t.sections.length > 0) {
                    t.sections.forEach(s => {
                        csv += `${t.civilId},${t.name},${s.grade},${s.section}\n`;
                    });
                } else {
                    csv += `${t.civilId},${t.name},,\n`;
                }
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'teachers.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        async function deleteAllTeachers() {
            if (allTeachers.length === 0) {
                showAlert('تنبيه', 'لا يوجد معلمين للحذف', 'info');
                return;
            }

            const result = await Swal.fire({
                title: 'حذف جميع المعلمين',
                html: `
                    <p style="color: var(--danger); font-weight: bold;">تحذير! هذا الإجراء لا يمكن التراجع عنه</p>
                    <p>سيتم حذف <strong>${allTeachers.length}</strong> معلم</p>
                    <div style="margin-top: 15px;">
                        <input type="text" id="confirmDelete" class="swal2-input" placeholder="اكتب 'حذف' للتأكيد">
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف الجميع',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c',
                preConfirm: () => {
                    const confirm = document.getElementById('confirmDelete').value;
                    if (confirm !== 'حذف') {
                        Swal.showValidationMessage('يرجى كتابة "حذف" للتأكيد');
                        return false;
                    }
                    return true;
                }
            });

            if (result.isConfirmed) {
                showLoading(true);
                try {
                    await rootRef.child('teachers').remove();
                    showLoading(false);
                    showAlert('تم', 'تم حذف جميع المعلمين', 'success');
                    loadTeachers();
                } catch (error) {
                    showLoading(false);
                    showAlert('خطأ', 'حدث خطأ أثناء الحذف', 'error');
                }
            }
        }

        // ============ EXAMS MANAGEMENT ============
        async function loadAdminExams() {
            showLoading(true);
            const container = document.getElementById('adminExamsList');

            try {
                // جلب الاختبارات والاستجابات والطلاب
                const [examsSnap, responsesSnap, studentsSnap] = await Promise.all([
                    rootRef.child('exams').once('value'),
                    rootRef.child('responses').once('value'),
                    rootRef.child('students').once('value')
                ]);

                const allResponses = responsesSnap.val() || {};
                const allStudentsData = studentsSnap.val() || {};

                allExamsAdmin = [];

                if (!examsSnap.exists()) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-alt"></i>
                            <p>لا توجد اختبارات</p>
                            <button class="action-btn primary" onclick="showCreateExamModal()">
                                <i class="fas fa-plus"></i> إنشاء اختبار
                            </button>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }

                examsSnap.forEach(child => {
                    const examData = child.val();
                    const examId = child.key;

                    // حساب عدد المستهدفين والمختبرين
                    const targetedIds = getTargetedStudentIds({ id: examId, ...examData }, allStudentsData);
                    const examResponses = allResponses[examId] || {};
                    const submittedCount = Object.values(examResponses).filter(r => r.submitted).length;

                    allExamsAdmin.push({
                        id: examId,
                        ...examData,
                        _stats: {
                            targetedCount: targetedIds.length,
                            submittedCount: submittedCount
                        }
                    });
                });

                container.innerHTML = allExamsAdmin.map(exam => {
                    const questionsCount = Object.keys(exam.questions || {}).length;
                    const isPublished = exam.settings?.isPublished;
                    const isOpen = exam.settings?.isOpen;
                    const hasTimer = exam.settings?.hasTimer;
                    const hasSchedule = exam.settings?.hasSchedule;
                    const scheduledStart = exam.settings?.scheduledStart;
                    const scheduledEnd = exam.settings?.scheduledEnd;

                    // تنسيق التاريخ والوقت للعرض
                    const formatDateTime = (ts) => {
                        if (!ts) return '';
                        const d = new Date(ts);
                        return d.toLocaleDateString('ar-SA', { day: 'numeric', month: 'short' }) + ' ' + d.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    };

                    const scheduleInfo = hasSchedule && scheduledStart && scheduledEnd
                        ? `<div style="font-size: 11px; color: var(--secondary); margin-top: 3px;">
                            <i class="fas fa-clock"></i> من: ${formatDateTime(scheduledStart)} | إلى: ${formatDateTime(scheduledEnd)}
                           </div>`
                        : '';

                    return `
                        <div class="exam-admin-card">
                            <div class="exam-admin-header">
                                <div class="exam-admin-title">${exam.title}${scheduleInfo}</div>
                                <div class="exam-status-badges">
                                    ${isPublished ? '<span class="status-badge published">منشور</span>' : '<span class="status-badge draft">مسودة</span>'}
                                    ${isOpen ? '<span class="status-badge open">مفتوح</span>' : '<span class="status-badge closed">مغلق</span>'}
                                    ${hasTimer ? `<span class="status-badge timed">${exam.settings.timerMinutes} دقيقة</span>` : ''}
                                </div>
                            </div>
                            <div class="exam-admin-meta">
                                <span><i class="fas fa-book"></i> ${exam.subject || 'غير محدد'}</span>
                                <span><i class="fas fa-user-tie"></i> ${exam.teacherName || 'غير محدد'}</span>
                                <span><i class="fas fa-question-circle"></i> ${questionsCount} سؤال</span>
                            </div>
                            <div class="exam-admin-actions">
                                <button class="action-btn outline" onclick="editExamSettings('${exam.id}')">
                                    <i class="fas fa-cog"></i> الإعدادات
                                </button>
                                <button class="action-btn outline" onclick="editExamQuestions('${exam.id}')">
                                    <i class="fas fa-edit"></i> الأسئلة
                                </button>
                                <button class="action-btn ${isPublished ? 'secondary' : 'success'}" onclick="togglePublish('${exam.id}', ${!isPublished})">
                                    <i class="fas fa-${isPublished ? 'eye-slash' : 'eye'}"></i> ${isPublished ? 'إخفاء' : 'نشر'}
                                </button>
                                <button class="action-btn ${isOpen ? 'danger' : 'primary'}" onclick="toggleOpen('${exam.id}', ${!isOpen})">
                                    <i class="fas fa-${isOpen ? 'lock' : 'unlock'}"></i> ${isOpen ? 'إغلاق' : 'فتح'}
                                </button>
                                <button class="action-btn ${exam.settings?.showResults ? 'warning' : 'outline'}" onclick="toggleResults('${exam.id}')">
                                    <i class="fas fa-chart-bar"></i> ${exam.settings?.showResults ? 'إخفاء النتائج' : 'نشر النتائج'}
                                </button>
                                <button class="action-btn warning" onclick="showResetExamOptions('${exam.id}', '${exam.title.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-redo"></i> تصفير
                                </button>
                                <button class="action-btn outline" onclick="showExamProgress('${exam.id}')" title="نسبة الإنجاز" style="min-width: 70px;">
                                    <i class="fas fa-tasks"></i> ${exam._stats?.submittedCount || 0}/${exam._stats?.targetedCount || 0}
                                </button>
                                <button class="action-btn danger" onclick="deleteExam('${exam.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading exams:', error);
                container.innerHTML = '<div class="card" style="text-align: center; color: var(--danger);">خطأ في تحميل الاختبارات</div>';
            }
            showLoading(false);
        }

        async function showCreateExamModal() {
            const { value: formValues } = await Swal.fire({
                title: 'إنشاء اختبار جديد',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>عنوان الاختبار:</label>
                            <input id="swal-title" class="swal2-input" placeholder="مثال: اختبار الفصل الأول">
                        </div>
                        <div class="form-group">
                            <label>المادة:</label>
                            <input id="swal-subject" class="swal2-input" placeholder="مثال: التفسير">
                        </div>
                        <div class="form-group">
                            <label>اسم المعلم:</label>
                            <input id="swal-teacher" class="swal2-input" placeholder="مثال: أ. عبدالله">
                        </div>
                        <div class="form-group">
                            <label>الاستهداف:</label>
                            <select id="swal-target" class="swal2-select">
                                <option value="all">جميع الطلاب</option>
                                <option value="grade">صف محدد</option>
                                <option value="section">شعب محددة</option>
                                <option value="specific">طلاب محددون</option>
                            </select>
                        </div>
                        <div class="form-group" id="targetGradeGroup" style="display: none;">
                            <label>الصف:</label>
                            <select id="swal-targetGrade" class="swal2-select">
                                <option value="">اختر الصف</option>
                                <option value="أول ثانوي">أول ثانوي</option>
                                <option value="ثاني ثانوي">ثاني ثانوي</option>
                                <option value="ثالث ثانوي">ثالث ثانوي</option>
                            </select>
                        </div>
                        <div class="form-group" id="targetSectionGroup" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin: 0;">الشعب المحددة: <span id="createSelectedSectionsCount">(0 شعبة)</span></label>
                                <button type="button" onclick="window.createClearAllSections()" style="background: var(--danger); color: white; border: none; border-radius: 5px; padding: 3px 10px; cursor: pointer; font-size: 11px;"><i class="fas fa-times"></i> إلغاء الكل</button>
                            </div>
                            <div id="createSelectedSectionsList" style="max-height: 80px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; background: var(--bg);"></div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">أول ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="createSectionsGrade1"></div>
                                </div>
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">ثاني ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="createSectionsGrade2"></div>
                                </div>
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">ثالث ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="createSectionsGrade3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="targetStudentsGroup" style="display: none;">
                            <label>اختر الطلاب:</label>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                <input type="text" id="targetStudentSearch" class="swal2-input" placeholder="بحث بالاسم أو الرقم..." style="flex: 1; min-width: 150px; margin: 0;">
                                <select id="targetStudentGradeFilter" class="swal2-select" style="width: auto; margin: 0;">
                                    <option value="">كل الصفوف</option>
                                    <option value="أول ثانوي">أول ثانوي</option>
                                    <option value="ثاني ثانوي">ثاني ثانوي</option>
                                    <option value="ثالث ثانوي">ثالث ثانوي</option>
                                </select>
                                <select id="targetStudentSectionFilter" class="swal2-select" style="width: auto; margin: 0;"></select>
                            </div>
                            <div style="margin-bottom: 8px; display: flex; gap: 10px;">
                                <button type="button" id="selectAllStudentsBtn" class="swal2-confirm" style="padding: 5px 15px; font-size: 12px;">تحديد الكل</button>
                                <button type="button" id="deselectAllStudentsBtn" class="swal2-cancel" style="padding: 5px 15px; font-size: 12px;">إلغاء الكل</button>
                                <span id="selectedStudentsCount" style="color: var(--primary); font-weight: bold; align-self: center;">0 محدد</span>
                            </div>
                            <div id="targetStudentsList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f9f9f9;"></div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-shuffle"> خلط الأسئلة عشوائياً</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-showAnswers"> عرض الإجابات الصحيحة بعد التسليم</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-timer"> استخدام مؤقت</label>
                        </div>
                        <div class="form-group" id="timerMinutesGroup" style="display: none;">
                            <label>مدة الاختبار (دقيقة):</label>
                            <input type="number" id="swal-minutes" class="swal2-input" value="30" min="1">
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-schedule"> جدولة النشر والإغلاق</label>
                        </div>
                        <div id="scheduleGroup" style="display: none;">
                            <div class="form-group">
                                <label>وقت بداية النشر:</label>
                                <input type="datetime-local" id="swal-start" class="swal2-input">
                            </div>
                            <div class="form-group">
                                <label>وقت نهاية الاختبار:</label>
                                <input type="datetime-local" id="swal-end" class="swal2-input">
                            </div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-survey"> تفعيل الاستبيان بعد الاختبار</label>
                        </div>
                        <div id="surveySettingsGroup" style="display: none;">
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 15px; margin-top: 10px;">
                                <p style="font-weight: bold; margin-bottom: 10px; color: var(--primary);"><i class="fas fa-poll"></i> بنود الاستبيان:</p>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-survey-difficulty" checked>
                                        <span>تقييم مستوى صعوبة الأسئلة</span>
                                        <select id="swal-survey-difficulty-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="required">إلزامي</option>
                                            <option value="optional">اختياري</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-survey-clarity" checked>
                                        <span>تقييم وضوح الأسئلة</span>
                                        <select id="swal-survey-clarity-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="required">إلزامي</option>
                                            <option value="optional">اختياري</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-survey-feedback" checked>
                                        <span>ملاحظات الطالب</span>
                                        <select id="swal-survey-feedback-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="optional" selected>اختياري</option>
                                            <option value="required">إلزامي</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                // متغيرات لحفظ بيانات الطلاب والمحددين - خارج didOpen لتكون متاحة في preConfirm
                didRender: () => {
                    window._createExamData = { allStudentsData: [], selectedStudentIds: new Set(), selectedSections: [] };
                },
                didOpen: async () => {
                    document.getElementById('swal-timer').addEventListener('change', (e) => {
                        document.getElementById('timerMinutesGroup').style.display = e.target.checked ? 'block' : 'none';
                    });
                    document.getElementById('swal-schedule').addEventListener('change', (e) => {
                        document.getElementById('scheduleGroup').style.display = e.target.checked ? 'block' : 'none';
                    });
                    document.getElementById('swal-survey').addEventListener('change', (e) => {
                        document.getElementById('surveySettingsGroup').style.display = e.target.checked ? 'block' : 'none';
                    });

                    // === دوال الشعب المتعددة ===
                    const renderCreateSelectedSections = () => {
                        const container = document.getElementById('createSelectedSectionsList');
                        const sections = window._createExamData.selectedSections;
                        if (sections.length === 0) {
                            container.innerHTML = '<p style="color: var(--gray); text-align: center; margin: 0;">لم يتم اختيار شعب</p>';
                        } else {
                            container.innerHTML = sections.map(sec => {
                                const gradeName = sec.grade === '1' ? 'أول ثانوي' : sec.grade === '2' ? 'ثاني ثانوي' : 'ثالث ثانوي';
                                return `<div style="display: inline-flex; align-items: center; gap: 5px; background: rgba(26, 95, 122, 0.15); padding: 4px 10px; border-radius: 15px; margin: 3px; font-size: 13px;">
                                    <span>شعبة ${sec.section}</span>
                                    <small style="color: var(--gray);">(${gradeName})</small>
                                    <button type="button" onclick="window.createRemoveSection('${sec.grade}', '${sec.section}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0 3px; font-size: 16px;">&times;</button>
                                </div>`;
                            }).join('');
                        }
                        document.getElementById('createSelectedSectionsCount').textContent = `(${sections.length} شعبة)`;
                    };

                    const renderCreateSectionButtons = () => {
                        const grade1Sections = ['1', '2', '3', '4'];
                        const grade2Sections = ['5', '6', '7', '8'];
                        const grade3Sections = ['9', '10', '11', '12'];
                        const sections = window._createExamData.selectedSections;

                        const renderButtons = (sectionsList, gradeNum) => {
                            return sectionsList.map(s => {
                                const isSelected = sections.some(sec => sec.grade === gradeNum && sec.section === s);
                                return `<button type="button" onclick="window.createToggleSection('${gradeNum}', '${s}')"
                                    style="padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border); cursor: pointer; font-size: 12px;
                                    background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text)'};">${s}</button>`;
                            }).join('');
                        };

                        document.getElementById('createSectionsGrade1').innerHTML = renderButtons(grade1Sections, '1');
                        document.getElementById('createSectionsGrade2').innerHTML = renderButtons(grade2Sections, '2');
                        document.getElementById('createSectionsGrade3').innerHTML = renderButtons(grade3Sections, '3');
                    };

                    window.createToggleSection = (grade, section) => {
                        const sections = window._createExamData.selectedSections;
                        const idx = sections.findIndex(s => s.grade === grade && s.section === section);
                        if (idx >= 0) {
                            sections.splice(idx, 1);
                        } else {
                            sections.push({ grade, section });
                        }
                        renderCreateSelectedSections();
                        renderCreateSectionButtons();
                    };

                    window.createRemoveSection = (grade, section) => {
                        window._createExamData.selectedSections = window._createExamData.selectedSections.filter(s => !(s.grade === grade && s.section === section));
                        renderCreateSelectedSections();
                        renderCreateSectionButtons();
                    };

                    window.createClearAllSections = () => {
                        window._createExamData.selectedSections = [];
                        renderCreateSelectedSections();
                        renderCreateSectionButtons();
                    };

                    // دالة تحديث الشعب حسب الصف
                    const updateSectionOptions = (gradeSelect, sectionSelect) => {
                        const grade = gradeSelect.value;
                        let sections = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
                        if (grade === 'أول ثانوي') sections = ['1', '2', '3', '4'];
                        else if (grade === 'ثاني ثانوي') sections = ['5', '6', '7', '8'];
                        else if (grade === 'ثالث ثانوي') sections = ['9', '10', '11', '12'];
                        sectionSelect.innerHTML = '<option value="">كل الشعب</option>' + sections.map(s => `<option value="${s}">${s}</option>`).join('');
                    };

                    // تحديث العداد
                    const updateSelectedCount = () => {
                        document.getElementById('selectedStudentsCount').textContent = window._createExamData.selectedStudentIds.size + ' محدد';
                    };

                    // دالة عرض قائمة الطلاب مع الفلترة مع حفظ التحديد
                    const renderFilteredStudents = () => {
                        const search = document.getElementById('targetStudentSearch').value.toLowerCase();
                        const gradeFilter = document.getElementById('targetStudentGradeFilter').value;
                        const sectionFilter = document.getElementById('targetStudentSectionFilter').value;

                        const filtered = window._createExamData.allStudentsData.filter(([id, s]) => {
                            const matchSearch = !search || s.name.toLowerCase().includes(search) || id.includes(search);
                            const matchGrade = !gradeFilter || s.grade === gradeFilter;
                            const matchSection = !sectionFilter || s.section === sectionFilter;
                            return matchSearch && matchGrade && matchSection;
                        });

                        const listDiv = document.getElementById('targetStudentsList');
                        listDiv.innerHTML = filtered.map(([id, s]) => `
                            <label style="display: block; margin-bottom: 5px; cursor: pointer;">
                                <input type="checkbox" value="${id}" class="target-student-cb" ${window._createExamData.selectedStudentIds.has(id) ? 'checked' : ''}>
                                ${s.name} (${s.grade} - ${s.section})
                            </label>
                        `).join('') || '<p style="text-align: center; color: #999;">لا يوجد طلاب</p>';

                        // ربط الأحداث للحفاظ على التحديد
                        listDiv.querySelectorAll('.target-student-cb').forEach(cb => {
                            cb.addEventListener('change', (e) => {
                                if (e.target.checked) {
                                    window._createExamData.selectedStudentIds.add(e.target.value);
                                } else {
                                    window._createExamData.selectedStudentIds.delete(e.target.value);
                                }
                                updateSelectedCount();
                            });
                        });
                        updateSelectedCount();
                    };

                    // Handle target type change
                    document.getElementById('swal-target').addEventListener('change', async (e) => {
                        const val = e.target.value;
                        document.getElementById('targetGradeGroup').style.display = val === 'grade' ? 'block' : 'none';
                        document.getElementById('targetSectionGroup').style.display = val === 'section' ? 'block' : 'none';
                        document.getElementById('targetStudentsGroup').style.display = val === 'specific' ? 'block' : 'none';

                        if (val === 'section') {
                            renderCreateSelectedSections();
                            renderCreateSectionButtons();
                        }

                        if (val === 'specific' && window._createExamData.allStudentsData.length === 0) {
                            const studentsSnap = await rootRef.child('students').once('value');
                            const students = studentsSnap.val() || {};
                            window._createExamData.allStudentsData = Object.entries(students).sort((a, b) => a[1].name.localeCompare(b[1].name, 'ar'));
                            renderFilteredStudents();

                            // إعداد الفلاتر
                            document.getElementById('targetStudentSearch').addEventListener('input', renderFilteredStudents);
                            document.getElementById('targetStudentGradeFilter').addEventListener('change', (ev) => {
                                updateSectionOptions(ev.target, document.getElementById('targetStudentSectionFilter'));
                                renderFilteredStudents();
                            });
                            document.getElementById('targetStudentSectionFilter').addEventListener('change', renderFilteredStudents);

                            // أزرار التحديد
                            document.getElementById('selectAllStudentsBtn').addEventListener('click', () => {
                                document.querySelectorAll('.target-student-cb').forEach(cb => {
                                    cb.checked = true;
                                    window._createExamData.selectedStudentIds.add(cb.value);
                                });
                                updateSelectedCount();
                            });
                            document.getElementById('deselectAllStudentsBtn').addEventListener('click', () => {
                                document.querySelectorAll('.target-student-cb').forEach(cb => {
                                    cb.checked = false;
                                    window._createExamData.selectedStudentIds.delete(cb.value);
                                });
                                updateSelectedCount();
                            });
                        } else if (val === 'specific') {
                            renderFilteredStudents();
                        }
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'إنشاء',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                preConfirm: () => {
                    const title = document.getElementById('swal-title').value.trim();
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الاختبار');
                        return false;
                    }
                    const hasSchedule = document.getElementById('swal-schedule').checked;
                    const startTime = document.getElementById('swal-start').value;
                    const endTime = document.getElementById('swal-end').value;

                    const targetType = document.getElementById('swal-target').value;
                    let targetGrade = null, targetSections = [], targetStudents = null;

                    if (targetType === 'grade') {
                        targetGrade = document.getElementById('swal-targetGrade').value;
                    }
                    if (targetType === 'section') {
                        targetSections = window._createExamData.selectedSections;
                        if (targetSections.length === 0) {
                            Swal.showValidationMessage('يرجى اختيار شعبة واحدة على الأقل');
                            return false;
                        }
                    }
                    if (targetType === 'specific') {
                        targetStudents = Array.from(window._createExamData.selectedStudentIds);
                    }

                    const hasSurvey = document.getElementById('swal-survey').checked;
                    const surveySettings = hasSurvey ? {
                        difficulty: {
                            enabled: document.getElementById('swal-survey-difficulty').checked,
                            required: document.getElementById('swal-survey-difficulty-req').value === 'required'
                        },
                        clarity: {
                            enabled: document.getElementById('swal-survey-clarity').checked,
                            required: document.getElementById('swal-survey-clarity-req').value === 'required'
                        },
                        feedback: {
                            enabled: document.getElementById('swal-survey-feedback').checked,
                            required: document.getElementById('swal-survey-feedback-req').value === 'required'
                        }
                    } : null;

                    return {
                        title,
                        subject: document.getElementById('swal-subject').value.trim(),
                        teacherName: document.getElementById('swal-teacher').value.trim(),
                        targetType,
                        targetGrade,
                        targetSections,
                        targetStudents,
                        shuffleQuestions: document.getElementById('swal-shuffle').checked,
                        showAnswersAfterSubmit: document.getElementById('swal-showAnswers').checked,
                        hasTimer: document.getElementById('swal-timer').checked,
                        timerMinutes: parseInt(document.getElementById('swal-minutes').value) || 30,
                        hasSchedule,
                        scheduledStart: hasSchedule && startTime ? new Date(startTime).getTime() : null,
                        scheduledEnd: hasSchedule && endTime ? new Date(endTime).getTime() : null,
                        hasSurvey,
                        surveySettings
                    };
                }
            });

            if (formValues) {
                try {
                    const examId = 'exam_' + Date.now();
                    await rootRef.child('exams').child(examId).set({
                        title: formValues.title,
                        subject: formValues.subject,
                        teacherName: formValues.teacherName,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        settings: {
                            isPublished: false,
                            isOpen: false,
                            hasTimer: formValues.hasTimer,
                            timerMinutes: formValues.timerMinutes,
                            showResults: false,
                            targetType: formValues.targetType,
                            targetGrade: formValues.targetGrade,
                            targetSections: formValues.targetSections,
                            targetStudents: formValues.targetStudents,
                            shuffleQuestions: formValues.shuffleQuestions,
                            showAnswersAfterSubmit: formValues.showAnswersAfterSubmit,
                            hasSchedule: formValues.hasSchedule,
                            scheduledStart: formValues.scheduledStart,
                            scheduledEnd: formValues.scheduledEnd,
                            hasSurvey: formValues.hasSurvey,
                            surveySettings: formValues.surveySettings
                        },
                        questions: {}
                    });

                    showAlert('تم', 'تم إنشاء الاختبار، يمكنك الآن إضافة الأسئلة', 'success');
                    loadAdminExams();
                    editExamQuestions(examId);
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الإنشاء', 'error');
                }
            }
        }

        async function editExamQuestions(examId) {
            const exam = allExamsAdmin.find(e => e.id === examId);
            if (!exam) return;

            const questions = Object.entries(exam.questions || {});

            let questionsHtml = questions.map(([qId, q], index) => `
                <div class="question-builder" data-qid="${qId}">
                    <div class="question-builder-header">
                        <strong>السؤال ${index + 1}</strong>
                        <div style="display: flex; gap: 5px;">
                            <button class="icon-btn" style="background: var(--secondary); color: white;" onclick="editSingleQuestion('${examId}', '${qId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="icon-btn delete" onclick="deleteQuestion('${examId}', '${qId}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p style="margin-bottom: 10px;">${q.text}</p>
                    <small style="color: var(--gray);">
                        النوع: ${q.type === 'truefalse' ? 'صح/خطأ' : 'اختيار متعدد'} |
                        الإجابة الصحيحة: ${q.options[q.correctAnswer]} |
                        الدرجة: ${q.points || 1}
                    </small>
                </div>
            `).join('');

            if (questions.length === 0) {
                questionsHtml = '<p style="text-align: center; color: var(--gray); padding: 20px;">لا توجد أسئلة بعد</p>';
            }

            const { value: action } = await Swal.fire({
                title: `تعديل: ${exam.title}`,
                html: `
                    <div style="text-align: right; max-height: 400px; overflow-y: auto;">
                        ${questionsHtml}
                    </div>
                `,
                width: 700,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: '<i class="fas fa-plus"></i> إضافة سؤال',
                denyButtonText: '<i class="fas fa-file-import"></i> إضافة دفعة',
                cancelButtonText: 'إغلاق',
                confirmButtonColor: '#1a5f7a',
                denyButtonColor: '#c49b3f'
            });

            if (action === true) {
                addSingleQuestion(examId);
            } else if (action === false) {
                addBulkQuestions(examId);
            }
        }

        // تعديل سؤال موجود
        async function editSingleQuestion(examId, qId) {
            const exam = allExamsAdmin.find(e => e.id === examId);
            if (!exam || !exam.questions || !exam.questions[qId]) return;

            const q = exam.questions[qId];
            const isTrueFalse = q.type === 'truefalse';

            const { value: formValues } = await Swal.fire({
                title: 'تعديل السؤال',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>نوع السؤال:</label>
                            <select id="swal-edit-type" class="swal2-select" onchange="updateEditOptionsFields()">
                                <option value="mcq" ${!isTrueFalse ? 'selected' : ''}>اختيار متعدد</option>
                                <option value="truefalse" ${isTrueFalse ? 'selected' : ''}>صح/خطأ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نص السؤال:</label>
                            <textarea id="swal-edit-text" class="swal2-textarea" placeholder="اكتب السؤال هنا...">${q.text || ''}</textarea>
                        </div>
                        <div id="editOptionsContainer">
                            ${isTrueFalse ? `
                                <div class="form-group">
                                    <label>الإجابة الصحيحة:</label>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="0" ${q.correctAnswer === 0 ? 'checked' : ''}> صح
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="1" ${q.correctAnswer === 1 ? 'checked' : ''}> خطأ
                                    </div>
                                </div>
                            ` : `
                                <div class="form-group">
                                    <label>الخيارات:</label>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="0" ${q.correctAnswer === 0 ? 'checked' : ''}>
                                        <input type="text" id="editOpt0" placeholder="الخيار 1" value="${(q.options && q.options[0]) || ''}">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="1" ${q.correctAnswer === 1 ? 'checked' : ''}>
                                        <input type="text" id="editOpt1" placeholder="الخيار 2" value="${(q.options && q.options[1]) || ''}">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="2" ${q.correctAnswer === 2 ? 'checked' : ''}>
                                        <input type="text" id="editOpt2" placeholder="الخيار 3" value="${(q.options && q.options[2]) || ''}">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="3" ${q.correctAnswer === 3 ? 'checked' : ''}>
                                        <input type="text" id="editOpt3" placeholder="الخيار 4" value="${(q.options && q.options[3]) || ''}">
                                    </div>
                                </div>
                            `}
                        </div>
                        <div class="form-group">
                            <label>الدرجة:</label>
                            <input type="number" id="swal-edit-points" class="swal2-input" value="${q.points || 1}" min="1">
                        </div>
                    </div>
                `,
                width: 600,
                showCancelButton: true,
                confirmButtonText: 'حفظ التعديلات',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                didOpen: () => {
                    window.updateEditOptionsFields = function() {
                        const type = document.getElementById('swal-edit-type').value;
                        const container = document.getElementById('editOptionsContainer');
                        if (type === 'truefalse') {
                            container.innerHTML = `
                                <div class="form-group">
                                    <label>الإجابة الصحيحة:</label>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="0" checked> صح
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="1"> خطأ
                                    </div>
                                </div>
                            `;
                        } else {
                            container.innerHTML = `
                                <div class="form-group">
                                    <label>الخيارات:</label>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="0" checked>
                                        <input type="text" id="editOpt0" placeholder="الخيار 1">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="1">
                                        <input type="text" id="editOpt1" placeholder="الخيار 2">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="2">
                                        <input type="text" id="editOpt2" placeholder="الخيار 3">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="editCorrect" value="3">
                                        <input type="text" id="editOpt3" placeholder="الخيار 4">
                                    </div>
                                </div>
                            `;
                        }
                    };
                },
                preConfirm: () => {
                    const type = document.getElementById('swal-edit-type').value;
                    const text = document.getElementById('swal-edit-text').value.trim();
                    const points = parseInt(document.getElementById('swal-edit-points').value) || 1;
                    const correctAnswer = parseInt(document.querySelector('input[name="editCorrect"]:checked')?.value || 0);

                    if (!text) {
                        Swal.showValidationMessage('يرجى إدخال نص السؤال');
                        return false;
                    }

                    let options;
                    if (type === 'truefalse') {
                        options = ['صح', 'خطأ'];
                    } else {
                        options = [
                            document.getElementById('editOpt0')?.value.trim() || '',
                            document.getElementById('editOpt1')?.value.trim() || '',
                            document.getElementById('editOpt2')?.value.trim() || '',
                            document.getElementById('editOpt3')?.value.trim() || ''
                        ].filter(o => o);

                        if (options.length < 2) {
                            Swal.showValidationMessage('يرجى إدخال خيارين على الأقل');
                            return false;
                        }
                    }

                    return { type, text, options, correctAnswer, points };
                }
            });

            if (formValues) {
                try {
                    showLoading(true);
                    await rootRef.child('exams').child(examId).child('questions').child(qId).update({
                        type: formValues.type,
                        text: formValues.text,
                        options: formValues.options,
                        correctAnswer: formValues.correctAnswer,
                        points: formValues.points
                    });
                    showLoading(false);
                    showAlert('تم', 'تم تعديل السؤال بنجاح', 'success');
                    await loadAdminExams();
                    editExamQuestions(examId);
                } catch (error) {
                    showLoading(false);
                    showAlert('خطأ', 'حدث خطأ أثناء التعديل', 'error');
                }
            }
        }

        async function addSingleQuestion(examId) {
            const { value: formValues } = await Swal.fire({
                title: 'إضافة سؤال',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>نوع السؤال:</label>
                            <select id="swal-type" class="swal2-select">
                                <option value="mcq">اختيار متعدد</option>
                                <option value="truefalse">صح/خطأ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نص السؤال:</label>
                            <textarea id="swal-text" class="swal2-textarea" placeholder="اكتب السؤال هنا..."></textarea>
                        </div>
                        <div id="optionsContainer">
                            <div class="form-group">
                                <label>الخيارات:</label>
                                <div class="option-row">
                                    <input type="radio" name="correct" value="0" checked>
                                    <input type="text" id="opt0" placeholder="الخيار 1">
                                </div>
                                <div class="option-row">
                                    <input type="radio" name="correct" value="1">
                                    <input type="text" id="opt1" placeholder="الخيار 2">
                                </div>
                                <div class="option-row">
                                    <input type="radio" name="correct" value="2">
                                    <input type="text" id="opt2" placeholder="الخيار 3">
                                </div>
                                <div class="option-row">
                                    <input type="radio" name="correct" value="3">
                                    <input type="text" id="opt3" placeholder="الخيار 4">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>الدرجة:</label>
                            <input type="number" id="swal-points" class="swal2-input" value="1" min="1">
                        </div>
                    </div>
                `,
                width: 600,
                didOpen: () => {
                    document.getElementById('swal-type').addEventListener('change', (e) => {
                        const container = document.getElementById('optionsContainer');
                        if (e.target.value === 'truefalse') {
                            container.innerHTML = `
                                <div class="form-group">
                                    <label>الخيارات:</label>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="0" checked>
                                        <input type="text" id="opt0" value="صح" readonly style="background: #f0f0f0;">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="1">
                                        <input type="text" id="opt1" value="خطأ" readonly style="background: #f0f0f0;">
                                    </div>
                                </div>
                            `;
                        } else {
                            container.innerHTML = `
                                <div class="form-group">
                                    <label>الخيارات:</label>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="0" checked>
                                        <input type="text" id="opt0" placeholder="الخيار 1">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="1">
                                        <input type="text" id="opt1" placeholder="الخيار 2">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="2">
                                        <input type="text" id="opt2" placeholder="الخيار 3">
                                    </div>
                                    <div class="option-row">
                                        <input type="radio" name="correct" value="3">
                                        <input type="text" id="opt3" placeholder="الخيار 4">
                                    </div>
                                </div>
                            `;
                        }
                    });
                },
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                preConfirm: () => {
                    const type = document.getElementById('swal-type').value;
                    const text = document.getElementById('swal-text').value.trim();

                    if (!text) {
                        Swal.showValidationMessage('يرجى إدخال نص السؤال');
                        return false;
                    }

                    let options = [];
                    if (type === 'truefalse') {
                        options = ['صح', 'خطأ'];
                    } else {
                        for (let i = 0; i < 4; i++) {
                            const opt = document.getElementById(`opt${i}`)?.value.trim();
                            if (opt) options.push(opt);
                        }
                        if (options.length < 2) {
                            Swal.showValidationMessage('يجب إدخال خيارين على الأقل');
                            return false;
                        }
                    }

                    const correctAnswer = parseInt(document.querySelector('input[name="correct"]:checked').value);
                    const points = parseInt(document.getElementById('swal-points').value) || 1;

                    return { type, text, options, correctAnswer, points };
                }
            });

            if (formValues) {
                try {
                    const qId = 'q_' + Date.now();
                    await rootRef.child('exams').child(examId).child('questions').child(qId).set(formValues);
                    showAlert('تم', 'تمت إضافة السؤال', 'success');

                    // Reload and reopen
                    await loadAdminExams();
                    editExamQuestions(examId);
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ', 'error');
                }
            }
        }

        async function addBulkQuestions(examId) {
            const { value: text } = await Swal.fire({
                title: 'إضافة أسئلة دفعة واحدة',
                html: `
                    <div style="text-align: right;">
                        <div style="background: rgba(196, 155, 63, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            <h4 style="color: var(--secondary); margin-bottom: 10px;">
                                <i class="fas fa-magic"></i> معالجة النص بـ Gemini AI
                            </h4>
                            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                                الصق أسئلتك بأي صيغة وسيقوم الذكاء الاصطناعي بتحويلها للهيكلة المطلوبة مع الحفاظ على النص الحرفي
                            </p>
                            <div class="form-group" style="margin-bottom: 10px;">
                                <input id="swal-gemini-key" class="swal2-input" placeholder="Gemini API Key" style="font-size: 14px;">
                            </div>
                            <textarea id="swal-gemini-raw" class="swal2-textarea" style="height: 120px; font-size: 13px;" placeholder="الصق الأسئلة هنا بأي صيغة...&#10;مثال:&#10;1- ما عاصمة السعودية؟&#10;أ) الرياض (صحيح)&#10;ب) جدة&#10;ج) مكة"></textarea>
                            <button type="button" id="parseBtn" class="swal2-confirm" style="padding: 10px 20px; font-size: 14px; width: 100%; margin-top: 10px;">
                                <i class="fas fa-wand-magic-sparkles"></i> معالجة وتحويل
                            </button>
                        </div>
                        <p style="margin-bottom: 10px; color: #666;">
                            أو اكتب بالصيغة المباشرة:<br>
                            <code style="background: #f5f5f5; padding: 5px; display: block; margin: 10px 0; font-size: 12px;">
                            ما عاصمة السعودية؟|الرياض|جدة|مكة|الدمام|1<br>
                            السماء زرقاء|صح|خطأ|1
                            </code>
                        </p>
                        <textarea id="swal-bulk" class="swal2-textarea" style="height: 150px;" placeholder="سؤال|خيار1|خيار2|...|رقم_الإجابة"></textarea>
                        <div class="form-group" style="margin-top: 10px;">
                            <label>درجة موحدة لكل سؤال:</label>
                            <input type="number" id="swal-bulk-points" class="swal2-input" value="1" min="1">
                        </div>
                    </div>
                `,
                width: 700,
                showCancelButton: true,
                confirmButtonText: 'إضافة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                didOpen: () => {
                    document.getElementById('parseBtn').addEventListener('click', async () => {
                        const apiKey = document.getElementById('swal-gemini-key').value.trim();
                        const rawText = document.getElementById('swal-gemini-raw').value.trim();

                        if (!apiKey || !rawText) {
                            Swal.showValidationMessage('يرجى إدخال API Key والنص المراد معالجته');
                            return;
                        }

                        const btn = document.getElementById('parseBtn');
                        btn.disabled = true;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';

                        try {
                            const parsedQuestions = await parseQuestionsWithGemini(apiKey, rawText);
                            document.getElementById('swal-bulk').value = parsedQuestions;
                            btn.innerHTML = '<i class="fas fa-check"></i> تمت المعالجة';
                        } catch (error) {
                            console.error('Gemini error:', error);
                            Swal.showValidationMessage('خطأ في المعالجة: ' + error.message);
                            btn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> معالجة وتحويل';
                            btn.disabled = false;
                        }
                    });
                },
                preConfirm: () => {
                    const bulkText = document.getElementById('swal-bulk').value.trim();
                    const points = parseInt(document.getElementById('swal-bulk-points').value) || 1;

                    if (!bulkText) {
                        Swal.showValidationMessage('يرجى إدخال الأسئلة');
                        return false;
                    }
                    return { bulkText, points };
                }
            });

            if (text) {
                try {
                    const lines = text.bulkText.split('\n').filter(l => l.trim());
                    const updates = {};
                    let count = 0;

                    lines.forEach(line => {
                        const parts = line.split('|').map(p => p.trim());
                        if (parts.length >= 3) {
                            const qText = parts[0];
                            const correctIndex = parseInt(parts[parts.length - 1]) - 1;
                            const options = parts.slice(1, -1);

                            if (options.length >= 2 && correctIndex >= 0 && correctIndex < options.length) {
                                const qId = 'q_' + Date.now() + '_' + count;
                                updates[qId] = {
                                    text: qText,
                                    type: options.length === 2 && (options[0] === 'صح' || options[0] === 'خطأ') ? 'truefalse' : 'mcq',
                                    options: options,
                                    correctAnswer: correctIndex,
                                    points: text.points
                                };
                                count++;
                            }
                        }
                    });

                    if (count === 0) {
                        showAlert('خطأ', 'لم يتم العثور على أسئلة صالحة', 'error');
                        return;
                    }

                    await rootRef.child('exams').child(examId).child('questions').update(updates);
                    showAlert('تم', `تمت إضافة ${count} سؤال`, 'success');

                    await loadAdminExams();
                    editExamQuestions(examId);
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ', 'error');
                }
            }
        }

        async function deleteQuestion(examId, qId) {
            const result = await Swal.fire({
                title: 'حذف السؤال',
                text: 'هل أنت متأكد؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                await rootRef.child('exams').child(examId).child('questions').child(qId).remove();
                showAlert('تم', 'تم حذف السؤال', 'success');
                await loadAdminExams();
                editExamQuestions(examId);
            }
        }

        // تعديل إعدادات الاختبار
        async function editExamSettings(examId) {
            const exam = allExamsAdmin.find(e => e.id === examId);
            if (!exam) return;

            const settings = exam.settings || {};

            // تحميل جميع الطلاب للاختيار منهم
            const studentsSnap = await rootRef.child('students').once('value');
            const allStudentsData = studentsSnap.val() || {};

            // الطلاب المحددون حالياً
            let selectedStudentIds = settings.targetStudents || [];

            // الشعب المحددة حالياً (تحويل من الصيغة القديمة إذا لزم)
            let selectedSections = settings.targetSections || [];
            // دعم الصيغة القديمة (شعبة واحدة)
            if (selectedSections.length === 0 && settings.targetSection && settings.targetGrade) {
                const gradeNum = settings.targetGrade === 'أول ثانوي' ? '1' : settings.targetGrade === 'ثاني ثانوي' ? '2' : '3';
                selectedSections = [{ grade: gradeNum, section: settings.targetSection }];
            }

            const { value: formValues } = await Swal.fire({
                title: 'تعديل إعدادات الاختبار',
                html: `
                    <div style="text-align: right;">
                        <div class="form-group">
                            <label>عنوان الاختبار:</label>
                            <input id="swal-edit-title" class="swal2-input" value="${exam.title || ''}">
                        </div>
                        <div class="form-group">
                            <label>المادة:</label>
                            <input id="swal-edit-subject" class="swal2-input" value="${exam.subject || ''}">
                        </div>
                        <div class="form-group">
                            <label>اسم المعلم:</label>
                            <input id="swal-edit-teacher" class="swal2-input" value="${exam.teacherName || ''}">
                        </div>
                        <div class="form-group">
                            <label>الاستهداف:</label>
                            <select id="swal-edit-target" class="swal2-select">
                                <option value="all" ${settings.targetType === 'all' ? 'selected' : ''}>جميع الطلاب</option>
                                <option value="grade" ${settings.targetType === 'grade' ? 'selected' : ''}>صف محدد</option>
                                <option value="section" ${settings.targetType === 'section' ? 'selected' : ''}>شعب محددة</option>
                                <option value="specific" ${settings.targetType === 'specific' ? 'selected' : ''}>طلاب محددون</option>
                            </select>
                        </div>
                        <div class="form-group" id="editTargetGradeGroup" style="display: ${settings.targetType === 'grade' ? 'block' : 'none'};">
                            <label>الصف:</label>
                            <select id="swal-edit-targetGrade" class="swal2-select">
                                <option value="">اختر الصف</option>
                                <option value="أول ثانوي" ${settings.targetGrade === 'أول ثانوي' ? 'selected' : ''}>أول ثانوي</option>
                                <option value="ثاني ثانوي" ${settings.targetGrade === 'ثاني ثانوي' ? 'selected' : ''}>ثاني ثانوي</option>
                                <option value="ثالث ثانوي" ${settings.targetGrade === 'ثالث ثانوي' ? 'selected' : ''}>ثالث ثانوي</option>
                            </select>
                        </div>
                        <div class="form-group" id="editTargetSectionGroup" style="display: ${settings.targetType === 'section' ? 'block' : 'none'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin: 0;">الشعب المحددة: <span id="editSelectedSectionsCount">(${(settings.targetSections || []).length} شعبة)</span></label>
                                <button type="button" onclick="window.editClearAllSections()" style="background: var(--danger); color: white; border: none; border-radius: 5px; padding: 3px 10px; cursor: pointer; font-size: 11px;"><i class="fas fa-times"></i> إلغاء الكل</button>
                            </div>
                            <div id="editSelectedSectionsList" style="max-height: 80px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; background: var(--bg);"></div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">أول ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="editSectionsGrade1"></div>
                                </div>
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">ثاني ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="editSectionsGrade2"></div>
                                </div>
                                <div style="background: var(--card); padding: 8px; border-radius: 8px;">
                                    <p style="font-size: 12px; color: var(--primary); margin-bottom: 5px; font-weight: bold;">ثالث ثانوي</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 5px;" id="editSectionsGrade3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="editTargetSpecificGroup" style="display: ${settings.targetType === 'specific' ? 'block' : 'none'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="margin: 0;">الطلاب المحددون: <span id="editSelectedCount">(${selectedStudentIds.length} طالب)</span></label>
                                <button type="button" onclick="window.editClearAllStudents()" style="background: var(--danger); color: white; border: none; border-radius: 5px; padding: 3px 10px; cursor: pointer; font-size: 11px;"><i class="fas fa-times"></i> إلغاء الكل</button>
                            </div>
                            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                                <input type="text" id="editStudentSearch" class="swal2-input" placeholder="بحث بالاسم أو السجل..." style="flex: 1; margin: 0; min-width: 150px;">
                                <select id="editFilterGrade" class="swal2-select" style="width: auto;">
                                    <option value="">كل الصفوف</option>
                                    <option value="أول ثانوي">أول ثانوي</option>
                                    <option value="ثاني ثانوي">ثاني ثانوي</option>
                                    <option value="ثالث ثانوي">ثالث ثانوي</option>
                                </select>
                                <select id="editFilterSection" class="swal2-select" style="width: auto;">
                                    <option value="">كل الشعب</option>
                                </select>
                            </div>
                            <div id="editSelectedStudentsList" style="max-height: 120px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; background: var(--bg);"></div>
                            <div id="editAvailableStudentsList" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--card);"></div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-edit-shuffle" ${settings.shuffleQuestions ? 'checked' : ''}> خلط الأسئلة عشوائياً</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-edit-showAnswers" ${settings.showAnswersAfterSubmit ? 'checked' : ''}> عرض الإجابات بعد التسليم</label>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-edit-timer" ${settings.hasTimer ? 'checked' : ''}> استخدام مؤقت</label>
                        </div>
                        <div class="form-group" id="editTimerGroup" style="display: ${settings.hasTimer ? 'block' : 'none'};">
                            <label>مدة الاختبار (دقيقة):</label>
                            <input type="number" id="swal-edit-minutes" class="swal2-input" value="${settings.timerMinutes || 30}" min="1">
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-edit-schedule" ${settings.hasSchedule ? 'checked' : ''}> جدولة النشر والإغلاق</label>
                        </div>
                        <div id="editScheduleGroup" style="display: ${settings.hasSchedule ? 'block' : 'none'};">
                            <div class="form-group">
                                <label>وقت بداية النشر:</label>
                                <input type="datetime-local" id="swal-edit-start" class="swal2-input" value="${settings.scheduledStart ? new Date(settings.scheduledStart).toISOString().slice(0, 16) : ''}">
                            </div>
                            <div class="form-group">
                                <label>وقت نهاية الاختبار:</label>
                                <input type="datetime-local" id="swal-edit-end" class="swal2-input" value="${settings.scheduledEnd ? new Date(settings.scheduledEnd).toISOString().slice(0, 16) : ''}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label><input type="checkbox" id="swal-edit-survey" ${settings.hasSurvey ? 'checked' : ''}> تفعيل الاستبيان بعد الاختبار</label>
                        </div>
                        <div id="editSurveySettingsGroup" style="display: ${settings.hasSurvey ? 'block' : 'none'};">
                            <div style="background: #f9f9f9; border-radius: 8px; padding: 15px; margin-top: 10px;">
                                <p style="font-weight: bold; margin-bottom: 10px; color: var(--primary);"><i class="fas fa-poll"></i> بنود الاستبيان:</p>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-edit-survey-difficulty" ${settings.surveySettings?.difficulty?.enabled !== false ? 'checked' : ''}>
                                        <span>تقييم مستوى صعوبة الأسئلة</span>
                                        <select id="swal-edit-survey-difficulty-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="required" ${settings.surveySettings?.difficulty?.required !== false ? 'selected' : ''}>إلزامي</option>
                                            <option value="optional" ${settings.surveySettings?.difficulty?.required === false ? 'selected' : ''}>اختياري</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-edit-survey-clarity" ${settings.surveySettings?.clarity?.enabled !== false ? 'checked' : ''}>
                                        <span>تقييم وضوح الأسئلة</span>
                                        <select id="swal-edit-survey-clarity-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="required" ${settings.surveySettings?.clarity?.required !== false ? 'selected' : ''}>إلزامي</option>
                                            <option value="optional" ${settings.surveySettings?.clarity?.required === false ? 'selected' : ''}>اختياري</option>
                                        </select>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; gap: 8px;">
                                        <input type="checkbox" id="swal-edit-survey-feedback" ${settings.surveySettings?.feedback?.enabled !== false ? 'checked' : ''}>
                                        <span>ملاحظات الطالب</span>
                                        <select id="swal-edit-survey-feedback-req" class="swal2-select" style="width: auto; padding: 3px 8px; font-size: 12px;">
                                            <option value="optional" ${settings.surveySettings?.feedback?.required !== true ? 'selected' : ''}>اختياري</option>
                                            <option value="required" ${settings.surveySettings?.feedback?.required === true ? 'selected' : ''}>إلزامي</option>
                                        </select>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                width: 650,
                showCancelButton: true,
                confirmButtonText: 'حفظ التعديلات',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#1a5f7a',
                didOpen: () => {
                    // === دوال الشعب المتعددة ===
                    const renderSelectedSections = () => {
                        const container = document.getElementById('editSelectedSectionsList');
                        if (selectedSections.length === 0) {
                            container.innerHTML = '<p style="color: var(--gray); text-align: center; margin: 0;">لم يتم اختيار شعب</p>';
                        } else {
                            container.innerHTML = selectedSections.map(sec => {
                                const gradeName = sec.grade === '1' ? 'أول ثانوي' : sec.grade === '2' ? 'ثاني ثانوي' : 'ثالث ثانوي';
                                return `<div style="display: inline-flex; align-items: center; gap: 5px; background: rgba(26, 95, 122, 0.15); padding: 4px 10px; border-radius: 15px; margin: 3px; font-size: 13px;">
                                    <span>شعبة ${sec.section}</span>
                                    <small style="color: var(--gray);">(${gradeName})</small>
                                    <button type="button" onclick="window.editRemoveSection('${sec.grade}', '${sec.section}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0 3px; font-size: 16px;">&times;</button>
                                </div>`;
                            }).join('');
                        }
                        document.getElementById('editSelectedSectionsCount').textContent = `(${selectedSections.length} شعبة)`;
                    };

                    const renderSectionButtons = () => {
                        const grade1Sections = ['1', '2', '3', '4'];
                        const grade2Sections = ['5', '6', '7', '8'];
                        const grade3Sections = ['9', '10', '11', '12'];

                        const renderButtons = (sections, gradeNum) => {
                            return sections.map(s => {
                                const isSelected = selectedSections.some(sec => sec.grade === gradeNum && sec.section === s);
                                return `<button type="button" onclick="window.editToggleSection('${gradeNum}', '${s}')"
                                    style="padding: 5px 10px; border-radius: 5px; border: 1px solid var(--border); cursor: pointer; font-size: 12px;
                                    background: ${isSelected ? 'var(--primary)' : 'var(--bg)'}; color: ${isSelected ? 'white' : 'var(--text)'};">${s}</button>`;
                            }).join('');
                        };

                        document.getElementById('editSectionsGrade1').innerHTML = renderButtons(grade1Sections, '1');
                        document.getElementById('editSectionsGrade2').innerHTML = renderButtons(grade2Sections, '2');
                        document.getElementById('editSectionsGrade3').innerHTML = renderButtons(grade3Sections, '3');
                    };

                    window.editToggleSection = (grade, section) => {
                        const idx = selectedSections.findIndex(s => s.grade === grade && s.section === section);
                        if (idx >= 0) {
                            selectedSections.splice(idx, 1);
                        } else {
                            selectedSections.push({ grade, section });
                        }
                        renderSelectedSections();
                        renderSectionButtons();
                    };

                    window.editRemoveSection = (grade, section) => {
                        selectedSections = selectedSections.filter(s => !(s.grade === grade && s.section === section));
                        renderSelectedSections();
                        renderSectionButtons();
                    };

                    window.editClearAllSections = () => {
                        selectedSections = [];
                        renderSelectedSections();
                        renderSectionButtons();
                    };

                    // عرض الشعب عند فتح النافذة إذا كان النوع section
                    if (settings.targetType === 'section') {
                        renderSelectedSections();
                        renderSectionButtons();
                    }

                    // === دوال الطلاب المحددين ===
                    // دالة تحديث فلتر الشعب حسب الصف
                    const updateFilterSections = (grade) => {
                        let sections = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
                        if (grade === 'أول ثانوي') sections = ['1', '2', '3', '4'];
                        else if (grade === 'ثاني ثانوي') sections = ['5', '6', '7', '8'];
                        else if (grade === 'ثالث ثانوي') sections = ['9', '10', '11', '12'];
                        const sectionSelect = document.getElementById('editFilterSection');
                        sectionSelect.innerHTML = '<option value="">كل الشعب</option>' + sections.map(s =>
                            `<option value="${s}">شعبة ${s}</option>`
                        ).join('');
                    };
                    updateFilterSections('');

                    // دالة عرض الطلاب المحددين
                    const renderSelectedStudents = () => {
                        const container = document.getElementById('editSelectedStudentsList');
                        if (selectedStudentIds.length === 0) {
                            container.innerHTML = '<p style="color: var(--gray); text-align: center; margin: 0;">لم يتم اختيار طلاب</p>';
                        } else {
                            container.innerHTML = selectedStudentIds.map(id => {
                                const student = allStudentsData[id];
                                const name = student ? student.name : id;
                                const grade = student ? student.grade : '';
                                const section = student ? student.section : '';
                                return `<div style="display: inline-flex; align-items: center; gap: 5px; background: rgba(26, 95, 122, 0.15); padding: 4px 10px; border-radius: 15px; margin: 3px; font-size: 13px;">
                                    <span>${name}</span>
                                    <small style="color: var(--gray);">(${grade} - ${section})</small>
                                    <button type="button" onclick="window.editRemoveStudent('${id}')" style="background: none; border: none; color: var(--danger); cursor: pointer; padding: 0 3px; font-size: 16px;">&times;</button>
                                </div>`;
                            }).join('');
                        }
                        document.getElementById('editSelectedCount').textContent = `(${selectedStudentIds.length} طالب)`;
                    };

                    // دالة عرض الطلاب المتاحين
                    const renderAvailableStudents = () => {
                        const searchTerm = document.getElementById('editStudentSearch').value.toLowerCase();
                        const filterGrade = document.getElementById('editFilterGrade').value;
                        const filterSection = document.getElementById('editFilterSection').value;
                        const container = document.getElementById('editAvailableStudentsList');

                        let filtered = Object.entries(allStudentsData).filter(([id, s]) => {
                            if (selectedStudentIds.includes(id)) return false;
                            if (filterGrade && s.grade !== filterGrade) return false;
                            if (filterSection && s.section !== filterSection) return false;
                            if (searchTerm && !s.name.toLowerCase().includes(searchTerm) && !id.toLowerCase().includes(searchTerm)) return false;
                            return true;
                        });

                        // ترتيب أبجدي
                        filtered.sort((a, b) => (a[1].name || '').localeCompare(b[1].name || '', 'ar'));

                        if (filtered.length === 0) {
                            container.innerHTML = '<p style="color: var(--gray); text-align: center; margin: 0;">لا يوجد طلاب</p>';
                        } else {
                            container.innerHTML = filtered.slice(0, 50).map(([id, s]) => {
                                return `<div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid var(--border);">
                                    <div>
                                        <span>${s.name}</span>
                                        <small style="color: var(--gray); margin-right: 8px;">${s.grade} - شعبة ${s.section}</small>
                                    </div>
                                    <button type="button" onclick="window.editAddStudent('${id}')" style="background: var(--primary); color: white; border: none; border-radius: 5px; padding: 3px 10px; cursor: pointer; font-size: 12px;">إضافة</button>
                                </div>`;
                            }).join('');
                            if (filtered.length > 50) {
                                container.innerHTML += `<p style="color: var(--gray); text-align: center; margin: 8px 0 0;">... و${filtered.length - 50} آخرون (استخدم البحث)</p>`;
                            }
                        }
                    };

                    // دوال الإضافة والإزالة
                    window.editAddStudent = (id) => {
                        if (!selectedStudentIds.includes(id)) {
                            selectedStudentIds.push(id);
                            renderSelectedStudents();
                            renderAvailableStudents();
                        }
                    };
                    window.editRemoveStudent = (id) => {
                        selectedStudentIds = selectedStudentIds.filter(sid => sid !== id);
                        renderSelectedStudents();
                        renderAvailableStudents();
                    };

                    window.editClearAllStudents = () => {
                        selectedStudentIds = [];
                        renderSelectedStudents();
                        renderAvailableStudents();
                    };

                    // أحداث البحث والفلترة
                    document.getElementById('editStudentSearch').addEventListener('input', renderAvailableStudents);
                    document.getElementById('editFilterGrade').addEventListener('change', (e) => {
                        updateFilterSections(e.target.value);
                        renderAvailableStudents();
                    });
                    document.getElementById('editFilterSection').addEventListener('change', renderAvailableStudents);

                    // عرض الطلاب عند فتح النافذة إذا كان النوع specific
                    if (settings.targetType === 'specific') {
                        renderSelectedStudents();
                        renderAvailableStudents();
                    }

                    document.getElementById('swal-edit-target').addEventListener('change', (e) => {
                        const val = e.target.value;
                        document.getElementById('editTargetGradeGroup').style.display = val === 'grade' ? 'block' : 'none';
                        document.getElementById('editTargetSectionGroup').style.display = val === 'section' ? 'block' : 'none';
                        document.getElementById('editTargetSpecificGroup').style.display = val === 'specific' ? 'block' : 'none';
                        if (val === 'section') {
                            renderSelectedSections();
                            renderSectionButtons();
                        }
                        if (val === 'specific') {
                            renderSelectedStudents();
                            renderAvailableStudents();
                        }
                    });
                    document.getElementById('swal-edit-timer').addEventListener('change', (e) => {
                        document.getElementById('editTimerGroup').style.display = e.target.checked ? 'block' : 'none';
                    });
                    document.getElementById('swal-edit-schedule').addEventListener('change', (e) => {
                        document.getElementById('editScheduleGroup').style.display = e.target.checked ? 'block' : 'none';
                    });
                    document.getElementById('swal-edit-survey').addEventListener('change', (e) => {
                        document.getElementById('editSurveySettingsGroup').style.display = e.target.checked ? 'block' : 'none';
                    });
                },
                preConfirm: () => {
                    const title = document.getElementById('swal-edit-title').value.trim();
                    if (!title) {
                        Swal.showValidationMessage('يرجى إدخال عنوان الاختبار');
                        return false;
                    }
                    const targetType = document.getElementById('swal-edit-target').value;
                    if (targetType === 'specific' && selectedStudentIds.length === 0) {
                        Swal.showValidationMessage('يرجى اختيار طالب واحد على الأقل');
                        return false;
                    }
                    if (targetType === 'section' && selectedSections.length === 0) {
                        Swal.showValidationMessage('يرجى اختيار شعبة واحدة على الأقل');
                        return false;
                    }
                    const hasSchedule = document.getElementById('swal-edit-schedule').checked;
                    const startTime = document.getElementById('swal-edit-start').value;
                    const endTime = document.getElementById('swal-edit-end').value;

                    if (hasSchedule && !startTime) {
                        Swal.showValidationMessage('يرجى تحديد وقت بداية النشر');
                        return false;
                    }
                    if (hasSchedule && !endTime) {
                        Swal.showValidationMessage('يرجى تحديد وقت نهاية الاختبار');
                        return false;
                    }

                    const hasSurvey = document.getElementById('swal-edit-survey').checked;
                    const surveySettings = hasSurvey ? {
                        difficulty: {
                            enabled: document.getElementById('swal-edit-survey-difficulty').checked,
                            required: document.getElementById('swal-edit-survey-difficulty-req').value === 'required'
                        },
                        clarity: {
                            enabled: document.getElementById('swal-edit-survey-clarity').checked,
                            required: document.getElementById('swal-edit-survey-clarity-req').value === 'required'
                        },
                        feedback: {
                            enabled: document.getElementById('swal-edit-survey-feedback').checked,
                            required: document.getElementById('swal-edit-survey-feedback-req').value === 'required'
                        }
                    } : null;

                    return {
                        title,
                        subject: document.getElementById('swal-edit-subject').value.trim(),
                        teacherName: document.getElementById('swal-edit-teacher').value.trim(),
                        targetType,
                        targetGrade: document.getElementById('swal-edit-targetGrade').value,
                        targetSections: targetType === 'section' ? selectedSections : [],
                        targetStudents: targetType === 'specific' ? selectedStudentIds : [],
                        shuffleQuestions: document.getElementById('swal-edit-shuffle').checked,
                        showAnswersAfterSubmit: document.getElementById('swal-edit-showAnswers').checked,
                        hasTimer: document.getElementById('swal-edit-timer').checked,
                        timerMinutes: parseInt(document.getElementById('swal-edit-minutes').value) || 30,
                        hasSchedule,
                        scheduledStart: hasSchedule && startTime ? new Date(startTime).getTime() : null,
                        scheduledEnd: hasSchedule && endTime ? new Date(endTime).getTime() : null,
                        hasSurvey,
                        surveySettings
                    };
                }
            });

            if (formValues) {
                try {
                    await rootRef.child('exams').child(examId).update({
                        title: formValues.title,
                        subject: formValues.subject,
                        teacherName: formValues.teacherName
                    });
                    await rootRef.child('exams').child(examId).child('settings').update({
                        targetType: formValues.targetType,
                        targetGrade: formValues.targetGrade,
                        targetSections: formValues.targetSections,
                        targetStudents: formValues.targetStudents,
                        shuffleQuestions: formValues.shuffleQuestions,
                        showAnswersAfterSubmit: formValues.showAnswersAfterSubmit,
                        hasTimer: formValues.hasTimer,
                        timerMinutes: formValues.timerMinutes,
                        hasSchedule: formValues.hasSchedule,
                        scheduledStart: formValues.scheduledStart,
                        scheduledEnd: formValues.scheduledEnd,
                        hasSurvey: formValues.hasSurvey,
                        surveySettings: formValues.surveySettings
                    });
                    showAlert('تم', 'تم حفظ التعديلات', 'success');
                    loadAdminExams();
                } catch (error) {
                    showAlert('خطأ', 'حدث خطأ أثناء الحفظ', 'error');
                }
            }
        }

        async function togglePublish(examId, publish) {
            await rootRef.child('exams').child(examId).child('settings/isPublished').set(publish);
            showAlert('تم', publish ? 'تم نشر الاختبار' : 'تم إخفاء الاختبار', 'success');
            loadAdminExams();
        }

        async function toggleOpen(examId, open) {
            await rootRef.child('exams').child(examId).child('settings/isOpen').set(open);
            showAlert('تم', open ? 'تم فتح الاختبار' : 'تم إغلاق الاختبار', 'success');
            loadAdminExams();
        }

        async function toggleResults(examId) {
            const exam = allExamsAdmin.find(e => e.id === examId);
            const currentState = exam?.settings?.showResults || false;

            await rootRef.child('exams').child(examId).child('settings/showResults').set(!currentState);
            showAlert('تم', !currentState ? 'تم نشر النتائج للطلاب' : 'تم إخفاء النتائج', 'success');
            loadAdminExams();
        }

        // عرض نتائج الاختبار من زر نسبة الإنجاز
        async function showExamProgress(examId) {
            // الانتقال لتبويب النتائج يدوياً بدون استدعاء loadResultsExamOptions
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[onclick="switchAdminTab('results')"]`).classList.add('active');
            document.getElementById('resultsPanel').classList.add('active');

            // تحميل قائمة الاختبارات وانتظار اكتمالها
            await loadResultsExamOptions();

            // اختيار الاختبار وتحميل نتائجه
            const selectEl = document.getElementById('resultsExamSelect');
            if (selectEl) {
                selectEl.value = examId;
                loadExamResults();
            }
        }

        // خيارات تصفير الاختبار
        async function showResetExamOptions(examId, examTitle) {
            const { value: option } = await Swal.fire({
                title: `تصفير اختبار: ${examTitle}`,
                input: 'radio',
                inputOptions: {
                    'all': 'تصفير لجميع الطلاب',
                    'some': 'تصفير لطلاب محددين'
                },
                inputValidator: (value) => {
                    if (!value) {
                        return 'يرجى اختيار نوع التصفير';
                    }
                },
                showCancelButton: true,
                confirmButtonText: 'متابعة',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#f39c12'
            });

            if (option === 'all') {
                const confirm = await Swal.fire({
                    title: 'تأكيد التصفير',
                    html: `<p>سيتم حذف جميع إجابات الطلاب للاختبار:</p><strong>${examTitle}</strong>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'تصفير الكل',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#e74c3c'
                });

                if (confirm.isConfirmed) {
                    await rootRef.child('responses').child(examId).remove();
                    await rootRef.child('surveys').child(examId).remove();
                    showAlert('تم', 'تم تصفير ا��اختبار لجميع الطلاب', 'success');
                }
            } else if (option === 'some') {
                // عرض قائمة الطلاب الذين اختبروا مع بحث واختيار متعدد
                const responsesSnap = await rootRef.child('responses').child(examId).once('value');
                if (!responsesSnap.exists()) {
                    showAlert('تنبيه', 'لا يوجد طلاب اختبروا بعد', 'info');
                    return;
                }

                const studentsData = [];
                responsesSnap.forEach(snap => {
                    const data = snap.val();
                    studentsData.push({ id: snap.key, name: data.studentName || snap.key });
                });

                // Set لحفظ الطلاب المحددين
                const selectedResetIds = new Set();

                const { value: confirmed } = await Swal.fire({
                    title: 'اختر الطلاب للتصفير',
                    html: `
                        <div style="text-align: right;">
                            <input type="text" id="resetStudentSearch" class="swal2-input" placeholder="بحث بالاسم أو الرقم..." style="margin-bottom: 10px;">
                            <div style="margin-bottom: 8px; display: flex; gap: 10px;">
                                <button type="button" id="resetSelectAll" class="swal2-confirm" style="padding: 5px 15px; font-size: 12px;">تحديد الكل</button>
                                <button type="button" id="resetDeselectAll" class="swal2-cancel" style="padding: 5px 15px; font-size: 12px;">إلغاء الكل</button>
                                <span id="resetSelectedCount" style="color: var(--warning); font-weight: bold; align-self: center;">0 محدد</span>
                            </div>
                            <div id="resetStudentsList" style="max-height: 250px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 10px; background: #f9f9f9;"></div>
                        </div>
                    `,
                    width: 500,
                    showCancelButton: true,
                    confirmButtonText: 'تصفير المحددين',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#e74c3c',
                    didOpen: () => {
                        const updateCount = () => {
                            document.getElementById('resetSelectedCount').textContent = selectedResetIds.size + ' محدد';
                        };

                        const renderList = (filter = '') => {
                            const filtered = studentsData.filter(s =>
                                s.name.toLowerCase().includes(filter.toLowerCase()) || s.id.includes(filter)
                            );
                            document.getElementById('resetStudentsList').innerHTML = filtered.map(s => `
                                <label style="display: block; margin-bottom: 5px; cursor: pointer;">
                                    <input type="checkbox" value="${s.id}" class="reset-student-cb" ${selectedResetIds.has(s.id) ? 'checked' : ''}>
                                    ${s.name} (${s.id})
                                </label>
                            `).join('') || '<p style="text-align: center; color: #999;">لا يوجد نتائج</p>';

                            document.querySelectorAll('.reset-student-cb').forEach(cb => {
                                cb.addEventListener('change', (e) => {
                                    if (e.target.checked) {
                                        selectedResetIds.add(e.target.value);
                                    } else {
                                        selectedResetIds.delete(e.target.value);
                                    }
                                    updateCount();
                                });
                            });
                        };

                        renderList();

                        document.getElementById('resetStudentSearch').addEventListener('input', (e) => {
                            renderList(e.target.value);
                        });

                        document.getElementById('resetSelectAll').addEventListener('click', () => {
                            document.querySelectorAll('.reset-student-cb').forEach(cb => {
                                cb.checked = true;
                                selectedResetIds.add(cb.value);
                            });
                            updateCount();
                        });

                        document.getElementById('resetDeselectAll').addEventListener('click', () => {
                            document.querySelectorAll('.reset-student-cb').forEach(cb => {
                                cb.checked = false;
                                selectedResetIds.delete(cb.value);
                            });
                            updateCount();
                        });
                    },
                    preConfirm: () => {
                        if (selectedResetIds.size === 0) {
                            Swal.showValidationMessage('يرجى اختيار طالب واحد على الأقل');
                            return false;
                        }
                        return Array.from(selectedResetIds);
                    }
                });

                if (confirmed && confirmed.length > 0) {
                    for (const studentId of confirmed) {
                        await rootRef.child('responses').child(examId).child(studentId).remove();
                        await rootRef.child('surveys').child(examId).child(studentId).remove();
                    }
                    showAlert('تم', `تم تصفير الاختبار لـ ${confirmed.length} طالب`, 'success');
                }
            }
        }

        async function deleteExam(examId) {
            const result = await Swal.fire({
                title: 'حذف الاختبار',
                text: 'سيتم حذف الاختبار وجميع الإجابات المرتبطة به!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'حذف',
                cancelButtonText: 'إلغاء',
                confirmButtonColor: '#e74c3c'
            });

            if (result.isConfirmed) {
                await rootRef.child('exams').child(examId).remove();
                await rootRef.child('responses').child(examId).remove();
                await rootRef.child('surveys').child(examId).remove();
                showAlert('تم', 'تم حذف الاختبار', 'success');
                loadAdminExams();
            }
        }

        // ============ RESULTS ============
        async function loadResultsExamOptions() {
            const select = document.getElementById('resultsExamSelect');
            select.innerHTML = '<option value="">-- اختر اختباراً --</option>';

            try {
                const snap = await rootRef.child('exams').once('value');
                if (snap.exists()) {
                    snap.forEach(child => {
                        const exam = child.val();
                        select.innerHTML += `<option value="${child.key}">${exam.title}</option>`;
                    });
                }
            } catch (error) {
                console.error(error);
            }
        }

        // متغيرات عامة للنتائج
        let resultsData = { students: [], exam: null, responses: {}, allStudents: {} };
        let resultsSort = { column: 'name', direction: 'asc' };
        let resultsFilter = { grade: '', section: '' };
        let resultsPage = 1;
        const RESULTS_PAGE_SIZE = 45;

        // دالة الحصول على المس��هدفين فقط
        function getTargetedStudentIds(exam, allStudents) {
            const settings = exam.settings || {};
            const targetType = settings.targetType || 'all';
            const allIds = Object.keys(allStudents);

            switch (targetType) {
                case 'all':
                    return allIds;
                case 'grade':
                    return allIds.filter(id => allStudents[id]?.grade === settings.targetGrade);
                case 'section':
                    // دعم الشعب المتعددة (الصيغة الجديدة)
                    const targetSections = settings.targetSections || [];
                    if (targetSections.length > 0) {
                        return allIds.filter(id => {
                            const student = allStudents[id];
                            if (!student) return false;
                            const studentGradeNum = student.grade === 'أول ثانوي' ? '1' : student.grade === 'ثاني ثانوي' ? '2' : '3';
                            return targetSections.some(sec => sec.grade === studentGradeNum && sec.section === student.section);
                        });
                    }
                    // دعم الصيغة القديمة (شعبة واحدة)
                    return allIds.filter(id =>
                        allStudents[id]?.grade === settings.targetGrade &&
                        allStudents[id]?.section === settings.targetSection
                    );
                case 'specific':
                    return settings.targetStudents || [];
                default:
                    return allIds;
            }
        }

        // دالة ربط الشعب بالصفوف
        function getSectionsForGrade(grade) {
            if (grade === 'أول ثانوي') return ['1', '2', '3', '4'];
            if (grade === 'ثاني ثانوي') return ['5', '6', '7', '8'];
            if (grade === 'ثالث ثانوي') return ['9', '10', '11', '12'];
            return ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10', '11', '12'];
        }

        async function loadExamResults() {
            const examId = document.getElementById('resultsExamSelect').value;
            const container = document.getElementById('resultsContent');

            if (!examId) {
                container.innerHTML = '';
                document.getElementById('statisticsSection').classList.add('hidden');
                return;
            }

            showLoading(true);

            try {
                // تحميل البيانات بالتوازي لتحسين الأداء
                const [examSnap, responsesSnap, studentsSnap] = await Promise.all([
                    rootRef.child('exams').child(examId).once('value'),
                    rootRef.child('responses').child(examId).once('value'),
                    rootRef.child('students').once('value')
                ]);

                const exam = examSnap.val();
                const responses = responsesSnap.val() || {};
                const allStudents = studentsSnap.val() || {};

                // الحصول على المستهدفين فقط
                const targetStudentIds = getTargetedStudentIds(exam, allStudents);

                // بناء بيانات الطلاب المستهدفين
                const studentsData = targetStudentIds.map(id => {
                    const student = allStudents[id] || {};
                    const response = responses[id];
                    const totalQ = Object.keys(exam.questions || {}).length;
                    const correct = response?.submitted ? (response.score || 0) : null;
                    const wrong = correct !== null ? totalQ - correct : null;

                    return {
                        id,
                        name: student.name || 'غير معروف',
                        grade: student.grade || '',
                        section: student.section || '',
                        correct,
                        wrong,
                        score: response?.submitted ? response.score : null,
                        totalPoints: response?.submitted ? response.totalPoints : null,
                        violations: response?.violations || 0,
                        submitted: !!response?.submitted
                    };
                });

                resultsData = { students: studentsData, exam, responses, allStudents, examId };
                resultsPage = 1;
                resultsFilter = { grade: '', section: '' };

                renderResultsTable();

                // Load detailed statistics with targeted students
                await loadStatistics(examId, exam, responses, allStudents, targetStudentIds);

            } catch (error) {
                console.error(error);
                container.innerHTML = '<div class="card" style="color: var(--danger);">خطأ في تحميل النتائج</div>';
            }

            showLoading(false);
        }

        function renderResultsTable() {
            const container = document.getElementById('resultsContent');
            let filtered = [...resultsData.students];

            // تطبيق الفلتر
            if (resultsFilter.grade) {
                filtered = filtered.filter(s => s.grade === resultsFilter.grade);
            }
            if (resultsFilter.section) {
                filtered = filtered.filter(s => s.section === resultsFilter.section);
            }

            // تطبيق الترتيب
            filtered.sort((a, b) => {
                let valA = a[resultsSort.column];
                let valB = b[resultsSort.column];

                if (valA === null) valA = resultsSort.direction === 'asc' ? Infinity : -Infinity;
                if (valB === null) valB = resultsSort.direction === 'asc' ? Infinity : -Infinity;

                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();

                if (valA < valB) return resultsSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return resultsSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // إحصائيات
            const testedCount = resultsData.students.filter(s => s.submitted).length;
            const scores = resultsData.students.filter(s => s.submitted).map(s => s.score);
            const maxScore = Math.max(...scores, 0);
            const minScore = scores.length > 0 ? Math.min(...scores) : 0;

            // تحديد الشعب المتاحة حسب الفصل
            const availableSections = resultsFilter.grade ? getSectionsForGrade(resultsFilter.grade) : getSectionsForGrade('');

            // Pagination
            const totalPages = Math.ceil(filtered.length / RESULTS_PAGE_SIZE);
            const startIdx = (resultsPage - 1) * RESULTS_PAGE_SIZE;
            const paged = filtered.slice(startIdx, startIdx + RESULTS_PAGE_SIZE);

            const sortIcon = (col) => {
                if (resultsSort.column !== col) return '<i class="fas fa-sort" style="opacity:0.3;margin-right:5px;"></i>';
                return resultsSort.direction === 'asc'
                    ? '<i class="fas fa-sort-up" style="margin-right:5px;"></i>'
                    : '<i class="fas fa-sort-down" style="margin-right:5px;"></i>';
            };

            let html = `
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <i class="fas fa-users"></i>
                        <div class="stat-value">${resultsData.students.length}</div>
                        <div class="stat-label">المستهدفون</div>
                    </div>
                    <div class="stat-card success">
                        <i class="fas fa-check-circle"></i>
                        <div class="stat-value">${testedCount}</div>
                        <div class="stat-label">اختبروا</div>
                    </div>
                    <div class="stat-card warning">
                        <i class="fas fa-clock"></i>
                        <div class="stat-value">${resultsData.students.length - testedCount}</div>
                        <div class="stat-label">لم يختبروا</div>
                    </div>
                    <div class="stat-card danger">
                        <i class="fas fa-chart-line"></i>
                        <div class="stat-value">${maxScore} / ${minScore}</div>
                        <div class="stat-label">أعلى / أقل</div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary);">
                        <i class="fas fa-table"></i> تقرير الطلاب
                    </h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select class="filter-select" onchange="filterResultsByGrade(this.value)" style="min-width: 120px;">
                            <option value="">كل الصفوف</option>
                            <option value="أول ثانوي" ${resultsFilter.grade === 'أول ثانوي' ? 'selected' : ''}>أول ثانوي</option>
                            <option value="ثاني ثانوي" ${resultsFilter.grade === 'ثاني ثانوي' ? 'selected' : ''}>ثاني ثانوي</option>
                            <option value="ثالث ثانوي" ${resultsFilter.grade === 'ثالث ثانوي' ? 'selected' : ''}>ثالث ثانوي</option>
                        </select>
                        <select class="filter-select" id="resultsSectionFilter" onchange="filterResultsBySection(this.value)" style="min-width: 100px;">
                            <option value="">كل الشعب</option>
                            ${availableSections.map(s => `<option value="${s}" ${resultsFilter.section === s ? 'selected' : ''}>شعبة ${s}</option>`).join('')}
                        </select>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="data-table" id="resultsDataTable">
                            <thead>
                                <tr>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('id')">${sortIcon('id')}السجل</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('name')">${sortIcon('name')}الاسم</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('grade')">${sortIcon('grade')}الصف</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('section')">${sortIcon('section')}الشعبة</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('correct')">${sortIcon('correct')}الصحيحة</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('wrong')">${sortIcon('wrong')}الخاطئة</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('score')">${sortIcon('score')}المجموع</th>
                                    <th style="cursor:pointer;" onclick="sortResultsBy('violations')">${sortIcon('violations')}المخالفات</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            paged.forEach(s => {
                if (s.submitted) {
                    html += `
                        <tr>
                            <td>${cleanText(s.id)}</td>
                            <td>${cleanText(s.name)}</td>
                            <td>${cleanText(s.grade)}</td>
                            <td>${cleanText(s.section)}</td>
                            <td style="color: var(--success);">${s.correct}</td>
                            <td style="color: var(--danger);">${s.wrong}</td>
                            <td><strong>${s.score}/${s.totalPoints}</strong></td>
                            <td>${s.violations}</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr style="opacity: 0.6;">
                            <td>${cleanText(s.id)}</td>
                            <td>${cleanText(s.name)}</td>
                            <td>${cleanText(s.grade)}</td>
                            <td>${cleanText(s.section)}</td>
                            <td>-</td>
                            <td>-</td>
                            <td>لم يختبر</td>
                            <td>-</td>
                        </tr>
                    `;
                }
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                    ${renderResultsPagination(filtered.length, totalPages)}
                </div>

                <button class="action-btn secondary" onclick="exportResults('${resultsData.examId}')">
                    <i class="fas fa-download"></i> تصدير التقرير
                </button>
            `;

            container.innerHTML = html;
        }

        function renderResultsPagination(total, totalPages) {
            if (total <= RESULTS_PAGE_SIZE) return '';

            let paginationHtml = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;">';
            paginationHtml += `<span style="color: var(--gray);">الصفحة ${resultsPage} من ${totalPages} (${total} طالب)</span>`;
            paginationHtml += '<div style="display: flex; gap: 5px;">';

            if (resultsPage > 1) {
                paginationHtml += `<button class="action-btn secondary" onclick="goToResultsPage(1)" style="padding: 5px 10px;"><i class="fas fa-angle-double-right"></i></button>`;
                paginationHtml += `<button class="action-btn secondary" onclick="goToResultsPage(${resultsPage - 1})" style="padding: 5px 10px;"><i class="fas fa-angle-right"></i></button>`;
            }

            const startPage = Math.max(1, resultsPage - 2);
            const endPage = Math.min(totalPages, resultsPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `<button class="action-btn ${i === resultsPage ? 'primary' : 'secondary'}" onclick="goToResultsPage(${i})" style="padding: 5px 12px;">${i}</button>`;
            }

            if (resultsPage < totalPages) {
                paginationHtml += `<button class="action-btn secondary" onclick="goToResultsPage(${resultsPage + 1})" style="padding: 5px 10px;"><i class="fas fa-angle-left"></i></button>`;
                paginationHtml += `<button class="action-btn secondary" onclick="goToResultsPage(${totalPages})" style="padding: 5px 10px;"><i class="fas fa-angle-double-left"></i></button>`;
            }

            paginationHtml += '</div></div>';
            return paginationHtml;
        }

        function sortResultsBy(column) {
            if (resultsSort.column === column) {
                resultsSort.direction = resultsSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                resultsSort.column = column;
                resultsSort.direction = 'asc';
            }
            resultsPage = 1;
            renderResultsTable();
        }

        function filterResultsByGrade(grade) {
            resultsFilter.grade = grade;
            resultsFilter.section = '';
            resultsPage = 1;
            renderResultsTable();
        }

        function filterResultsBySection(section) {
            resultsFilter.section = section;
            resultsPage = 1;
            renderResultsTable();
        }

        function goToResultsPage(page) {
            resultsPage = page;
            renderResultsTable();
            document.getElementById('resultsDataTable')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function exportResults(examId) {
            // Simple CSV export
            const table = document.querySelector('#resultsContent table');
            if (!table) return;

            let csv = '';
            table.querySelectorAll('tr').forEach(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                csv += cells.map(c => c.textContent.trim()).join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `results_${examId}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ STATISTICS ============
        // متغيرات للإحصائيات مع pagination والفرز
        let statsData = { submittedStudents: [], integrityData: [], viewedOnly: [], notViewed: [] };
        let submissionSort = { column: 'order', direction: 'asc' };
        let integritySort = { column: 'violations', direction: 'desc' };
        let submissionPage = 1;
        let integrityPage = 1;
        const STATS_PAGE_SIZE = 45;

        async function loadStatistics(examId, exam, responses, students, targetStudentIds) {
            document.getElementById('statisticsSection').classList.remove('hidden');

            // فلترة المستهدفين فقط
            const targetSet = new Set(targetStudentIds);

            // 1. ترتيب حسب وقت التسليم - للمستهدفين فقط
            const submittedStudents = Object.entries(responses)
                .filter(([id, r]) => targetSet.has(id) && r.submitted && r.submitTime)
                .map(([id, r], idx) => ({
                    id,
                    name: students[id]?.name || 'غير معروف',
                    grade: students[id]?.grade || '',
                    section: students[id]?.section || '',
                    startTime: r.startTime,
                    submitTime: r.submitTime,
                    violations: r.violations || 0,
                    duration: Math.round((r.submitTime - r.startTime) / 60000)
                }))
                .sort((a, b) => a.submitTime - b.submitTime)
                .map((s, i) => ({ ...s, order: i + 1 }));

            // 4. حالة الطلاب - للمستهدفين فقط
            const tested = submittedStudents.map(s => s.id);
            const viewedOnly = Object.entries(responses)
                .filter(([id, r]) => targetSet.has(id) && r.startTime && !r.submitted)
                .map(([id]) => ({ id, name: students[id]?.name || id, grade: students[id]?.grade || '', section: students[id]?.section || '' }));
            const notViewed = targetStudentIds
                .filter(id => !responses[id])
                .map(id => ({ id, name: students[id]?.name || id, grade: students[id]?.grade || '', section: students[id]?.section || '' }));

            statsData = { submittedStudents, integrityData: submittedStudents, viewedOnly, notViewed, students };
            submissionPage = 1;
            integrityPage = 1;

            renderSubmissionTable();
            renderIntegrityTable();
            renderNotTestedSection();

            // 3. الأسئلة الأصعب - للمستهدفين فقط
            const questions = exam.questions || {};
            const questionStats = {};

            Object.keys(questions).forEach(qId => {
                questionStats[qId] = { total: 0, wrong: 0, text: questions[qId].text };
            });

            Object.entries(responses).forEach(([id, r]) => {
                if (targetSet.has(id) && r.submitted && r.answers) {
                    Object.entries(r.answers).forEach(([qId, answer]) => {
                        if (questionStats[qId]) {
                            questionStats[qId].total++;
                            if (answer !== questions[qId]?.correctAnswer) {
                                questionStats[qId].wrong++;
                            }
                        }
                    });
                }
            });

            const hardest = Object.entries(questionStats)
                .map(([qId, stat]) => ({
                    qId,
                    text: stat.text,
                    errorRate: stat.total > 0 ? (stat.wrong / stat.total * 100) : 0,
                    wrong: stat.wrong,
                    total: stat.total
                }))
                .sort((a, b) => b.errorRate - a.errorRate)
                .slice(0, 5);

            const hardestContainer = document.getElementById('hardestQuestions');
            hardestContainer.innerHTML = hardest.map((q, i) => `
                <div style="padding: 15px; background: rgba(243, 156, 18, 0.1); border-radius: 10px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>${i + 1}.</strong> ${q.text.substring(0, 80)}${q.text.length > 80 ? '...' : ''}</span>
                        <span style="color: var(--danger); font-weight: bold;">${q.errorRate.toFixed(0)}% خطأ</span>
                    </div>
                    <small style="color: var(--gray);">${q.wrong} خطأ من ${q.total} إجابة</small>
                </div>
            `).join('') || '<p style="color: var(--gray);">لا توجد بيانات كافية</p>';

            document.getElementById('statTested').textContent = tested.length;
            document.getElementById('statViewedOnly').textContent = viewedOnly.length;
            document.getElementById('statNotViewed').textContent = notViewed.length;

            // 5. نتائج الاستبيان
            const surveysSnap = await rootRef.child('surveys').child(examId).once('value');
            const surveys = surveysSnap.val() || {};
            const surveyCount = Object.keys(surveys).length;

            if (surveyCount > 0) {
                let totalDifficulty = 0;
                let totalClarity = 0;
                const feedbacks = [];

                Object.values(surveys).forEach(s => {
                    totalDifficulty += s.difficulty || 0;
                    totalClarity += s.clarity || 0;
                    if (s.feedback) feedbacks.push(s.feedback);
                });

                const avgDifficulty = (totalDifficulty / surveyCount).toFixed(1);
                const avgClarity = (totalClarity / surveyCount).toFixed(1);

                let surveyHtml = `
                    <div style="display: flex; gap: 30px; margin-bottom: 20px; flex-wrap: wrap;">
                        <div>
                            <span style="color: var(--gray);">متوسط الصعوبة:</span>
                            <strong style="font-size: 24px; margin-right: 10px;">${avgDifficulty}/5</strong>
                            ${renderStars(avgDifficulty)}
                        </div>
                        <div>
                            <span style="color: var(--gray);">متوسط الوضوح:</span>
                            <strong style="font-size: 24px; margin-right: 10px;">${avgClarity}/5</strong>
                            ${renderStars(avgClarity)}
                        </div>
                    </div>
                `;

                if (feedbacks.length > 0) {
                    surveyHtml += '<p style="margin-bottom: 10px;"><strong>ملاحظات الطلاب:</strong></p>';
                    surveyHtml += '<ul style="padding-right: 20px;">';
                    feedbacks.forEach(f => {
                        surveyHtml += `<li style="margin-bottom: 8px; color: var(--gray);">${f}</li>`;
                    });
                    surveyHtml += '</ul>';
                }

                document.getElementById('surveyResults').innerHTML = surveyHtml;
            } else {
                document.getElementById('surveyResults').innerHTML = '<p style="color: var(--gray);">لا توجد تقييمات بعد</p>';
            }
        }

        // دوال عرض جداول الإحصائيات مع الفرز والـ pagination
        function renderSubmissionTable() {
            const data = [...statsData.submittedStudents];
            const tbody = document.getElementById('submissionOrderBody');
            if (!tbody) return;

            // تطبيق الترتيب
            data.sort((a, b) => {
                let valA = a[submissionSort.column];
                let valB = b[submissionSort.column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return submissionSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return submissionSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const totalPages = Math.ceil(data.length / STATS_PAGE_SIZE);
            const startIdx = (submissionPage - 1) * STATS_PAGE_SIZE;
            const paged = data.slice(startIdx, startIdx + STATS_PAGE_SIZE);

            const sortIcon = (col) => {
                if (submissionSort.column !== col) return '<i class="fas fa-sort" style="opacity:0.3;margin-right:5px;"></i>';
                return submissionSort.direction === 'asc'
                    ? '<i class="fas fa-sort-up" style="margin-right:5px;"></i>'
                    : '<i class="fas fa-sort-down" style="margin-right:5px;"></i>';
            };

            // تحديث رؤوس الأعمدة
            const thead = tbody.parentElement.querySelector('thead');
            if (thead) {
                thead.innerHTML = `<tr>
                    <th style="cursor:pointer;" onclick="sortSubmissionBy('order')">${sortIcon('order')}الترتيب</th>
                    <th style="cursor:pointer;" onclick="sortSubmissionBy('name')">${sortIcon('name')}الاسم</th>
                    <th style="cursor:pointer;" onclick="sortSubmissionBy('startTime')">${sortIcon('startTime')}وقت البدء</th>
                    <th style="cursor:pointer;" onclick="sortSubmissionBy('submitTime')">${sortIcon('submitTime')}وقت التسليم</th>
                    <th style="cursor:pointer;" onclick="sortSubmissionBy('duration')">${sortIcon('duration')}المدة</th>
                </tr>`;
            }

            // تحديث محتوى الجدول
            tbody.innerHTML = paged.map(s => {
                const startDate = new Date(s.startTime);
                const submitDate = new Date(s.submitTime);
                return `<tr>
                    <td><strong>${s.order}</strong></td>
                    <td>${cleanText(s.name)}</td>
                    <td>${formatDateTime(startDate)}</td>
                    <td>${formatDateTime(submitDate)}</td>
                    <td>${s.duration} دقيقة</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center;">لا توجد بيانات</td></tr>';

            // تحديث الـ pagination
            const paginationDiv = document.getElementById('submissionPagination');
            if (paginationDiv) {
                paginationDiv.innerHTML = data.length > STATS_PAGE_SIZE
                    ? renderStatsPagination(data.length, totalPages, submissionPage, 'goToSubmissionPage')
                    : '';
            }
        }

        function renderIntegrityTable() {
            const data = [...statsData.integrityData];
            const tbody = document.getElementById('integrityBody');
            if (!tbody) return;

            // تطبيق الترتيب
            data.sort((a, b) => {
                let valA = a[integritySort.column];
                let valB = b[integritySort.column];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                if (valA < valB) return integritySort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return integritySort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            const totalPages = Math.ceil(data.length / STATS_PAGE_SIZE);
            const startIdx = (integrityPage - 1) * STATS_PAGE_SIZE;
            const paged = data.slice(startIdx, startIdx + STATS_PAGE_SIZE);

            const sortIcon = (col) => {
                if (integritySort.column !== col) return '<i class="fas fa-sort" style="opacity:0.3;margin-right:5px;"></i>';
                return integritySort.direction === 'asc'
                    ? '<i class="fas fa-sort-up" style="margin-right:5px;"></i>'
                    : '<i class="fas fa-sort-down" style="margin-right:5px;"></i>';
            };

            // تحديث رؤوس الأعمدة
            const thead = tbody.parentElement.querySelector('thead');
            if (thead) {
                thead.innerHTML = `<tr>
                    <th style="cursor:pointer;" onclick="sortIntegrityBy('name')">${sortIcon('name')}الاسم</th>
                    <th style="cursor:pointer;" onclick="sortIntegrityBy('violations')">${sortIcon('violations')}المخالفات</th>
                    <th style="cursor:pointer;" onclick="sortIntegrityBy('duration')">${sortIcon('duration')}المدة</th>
                    <th>الحالة</th>
                </tr>`;
            }

            // تحديث محتوى الجدول
            tbody.innerHTML = paged.map(s => {
                let status = '<span style="color: var(--success);">✓ سليم</span>';
                if (s.violations > 0) {
                    status = `<span style="color: var(--danger);">⚠ ${s.violations} مخالفة</span>`;
                }
                return `<tr>
                    <td>${cleanText(s.name)}</td>
                    <td style="color: ${s.violations > 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: bold;">${s.violations}</td>
                    <td>${s.duration} دقيقة</td>
                    <td>${status}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="4" style="text-align:center;">لا توجد بيانات</td></tr>';

            // تحديث الـ pagination
            const paginationDiv = document.getElementById('integrityPagination');
            if (paginationDiv) {
                paginationDiv.innerHTML = data.length > STATS_PAGE_SIZE
                    ? renderStatsPagination(data.length, totalPages, integrityPage, 'goToIntegrityPage')
                    : '';
            }
        }

        function renderNotTestedSection() {
            let notTestedHtml = '';
            const { viewedOnly, notViewed, students } = statsData;

            if (viewedOnly.length > 0) {
                notTestedHtml += '<p style="margin-bottom: 10px;"><strong>شاهدوا ولم يختبروا:</strong></p>';
                notTestedHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">';
                const showViewedOnly = viewedOnly.slice(0, 45);
                showViewedOnly.forEach(s => {
                    notTestedHtml += `<span style="background: rgba(243, 156, 18, 0.2); padding: 5px 10px; border-radius: 15px; font-size: 13px;">${s.name}</span>`;
                });
                if (viewedOnly.length > 45) {
                    notTestedHtml += `<span style="background: rgba(243, 156, 18, 0.4); padding: 5px 10px; border-radius: 15px; font-size: 13px;">+${viewedOnly.length - 45} آخرون</span>`;
                }
                notTestedHtml += '</div>';
            }
            if (notViewed.length > 0) {
                notTestedHtml += '<p style="margin-bottom: 10px;"><strong>لم يشاهدوا الاختبار:</strong></p>';
                notTestedHtml += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                const showNotViewed = notViewed.slice(0, 45);
                showNotViewed.forEach(s => {
                    notTestedHtml += `<span style="background: rgba(231, 76, 60, 0.2); padding: 5px 10px; border-radius: 15px; font-size: 13px;">${s.name}</span>`;
                });
                if (notViewed.length > 45) {
                    notTestedHtml += `<span style="background: rgba(231, 76, 60, 0.4); padding: 5px 10px; border-radius: 15px; font-size: 13px;">+${notViewed.length - 45} آخرون</span>`;
                }
                notTestedHtml += '</div>';
            }
            document.getElementById('notTestedList').innerHTML = notTestedHtml || '<p style="color: var(--gray);">جميع الطلاب اختبروا</p>';
        }

        function renderStatsPagination(total, totalPages, currentPage, goToFunc) {
            let html = '<div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; flex-wrap: wrap;">';
            html += `<span style="color: var(--gray);">الصفحة ${currentPage} من ${totalPages}</span>`;
            html += '<div style="display: flex; gap: 5px;">';

            if (currentPage > 1) {
                html += `<button class="action-btn secondary" onclick="${goToFunc}(1)" style="padding: 3px 8px;"><i class="fas fa-angle-double-right"></i></button>`;
                html += `<button class="action-btn secondary" onclick="${goToFunc}(${currentPage - 1})" style="padding: 3px 8px;"><i class="fas fa-angle-right"></i></button>`;
            }

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="action-btn ${i === currentPage ? 'primary' : 'secondary'}" onclick="${goToFunc}(${i})" style="padding: 3px 10px;">${i}</button>`;
            }

            if (currentPage < totalPages) {
                html += `<button class="action-btn secondary" onclick="${goToFunc}(${currentPage + 1})" style="padding: 3px 8px;"><i class="fas fa-angle-left"></i></button>`;
                html += `<button class="action-btn secondary" onclick="${goToFunc}(${totalPages})" style="padding: 3px 8px;"><i class="fas fa-angle-double-left"></i></button>`;
            }

            html += '</div></div>';
            return html;
        }

        function sortSubmissionBy(column) {
            if (submissionSort.column === column) {
                submissionSort.direction = submissionSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                submissionSort.column = column;
                submissionSort.direction = 'asc';
            }
            submissionPage = 1;
            renderSubmissionTable();
        }

        function sortIntegrityBy(column) {
            if (integritySort.column === column) {
                integritySort.direction = integritySort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                integritySort.column = column;
                integritySort.direction = 'asc';
            }
            integrityPage = 1;
            renderIntegrityTable();
        }

        function goToSubmissionPage(page) {
            submissionPage = page;
            renderSubmissionTable();
        }

        function goToIntegrityPage(page) {
            integrityPage = page;
            renderIntegrityTable();
        }

        function formatDateTime(date) {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}/${month} - ${hours}:${minutes}`;
        }

        function renderStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) {
                    stars += '<i class="fas fa-star" style="color: var(--secondary);"></i>';
                } else {
                    stars += '<i class="far fa-star" style="color: #ddd;"></i>';
                }
            }
            return stars;
        }

        // ============ RETAKE REQUESTS ============
        async function loadRetakeRequests() {
            showLoading(true);
            const container = document.getElementById('retakeRequestsList');

            try {
                const snap = await rootRef.child('retakeRequests').once('value');

                if (!snap.exists()) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>لا توجد طلبات إعادة</p>
                        </div>
                    `;
                    showLoading(false);
                    return;
                }

                let html = '';
                snap.forEach(child => {
                    const req = child.val();
                    if (req.status === 'pending') {
                        html += `
                            <div class="card" style="margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <strong>${req.studentName}</strong> (${req.studentId})
                                        <p style="color: var(--primary); margin: 5px 0; font-weight: 600;">
                                            <i class="fas fa-file-alt"></i> الاختبار: ${req.examTitle || req.examId}
                                        </p>
                                        <p style="color: var(--gray); margin: 5px 0;">السبب: ${req.reason}</p>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="action-btn success" onclick="approveRetake('${child.key}', '${req.examId}', '${req.studentId}')">
                                            <i class="fas fa-check"></i> قبول
                                        </button>
                                        <button class="action-btn danger" onclick="rejectRetake('${child.key}')">
                                            <i class="fas fa-times"></i> رفض
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html || `
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>لا توجد طلبات معلقة</p>
                    </div>
                `;
            } catch (error) {
                console.error(error);
            }

            showLoading(false);
        }

        async function approveRetake(requestId, examId, studentId) {
            try {
                // تصفير الاختبار للطالب
                await rootRef.child('responses').child(examId).child(studentId).remove();
                await rootRef.child('surveys').child(examId).child(studentId).remove();
                // حذف طلب الإعادة بدلاً من تحديثه ليتمكن الطالب م�� الطلب مرة أخرى
                await rootRef.child('retakeRequests').child(requestId).remove();
                showAlert('تم', 'تم قبول الطلب وتصفير الاختبار للطالب', 'success');
                loadRetakeRequests();
            } catch (error) {
                showAlert('خطأ', 'حدث خطأ', 'error');
            }
        }

        async function rejectRetake(requestId) {
            await rootRef.child('retakeRequests').child(requestId).update({ status: 'rejected' });
            showAlert('تم', 'تم رفض الطلب', 'info');
            loadRetakeRequests();
        }

        // ============ SETTINGS ============
        function copyToClipboard(text) {
            const fullUrl = window.location.href.replace(/[^/]*$/, '') + text;
            navigator.clipboard.writeText(fullUrl).then(() => {
                showAlert('تم', 'تم نسخ الرابط', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = fullUrl;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showAlert('تم', 'تم نسخ الرابط', 'success');
            });
        }

        async function changePassword() {
            const newPass = document.getElementById('newPassword').value.trim();
            if (!newPass || newPass.length < 4) {
                showAlert('خطأ', 'كلمة المرور يجب أن تكون 4 أحرف على الأقل', 'error');
                return;
            }

            try {
                await rootRef.child('config/teacherPassword').set(newPass);
                showAlert('تم', 'تم تغيير كلمة المرور', 'success');
                document.getElementById('newPassword').value = '';
            } catch (error) {
                showAlert('خطأ', 'حدث خطأ', 'error');
            }
        }

        // Enter key support
        document.getElementById('civilIdInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeDefaultData();
            const hasSession = await checkSavedSession();
            if (!hasSession) {
                document.getElementById('loginSection').classList.remove('hidden');
            }
        });
    </script>
</body>
</html>

