<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªÙØ³ÙŠØ±</title>
    
    <!-- React & Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Firebase Integration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBxPO6RKsQ1Cq-mqlCpFTrCuIyxnYdB37U",
            authDomain: "studentsystem-c1ab1.firebaseapp.com",
            databaseURL: "https://studentsystem-c1ab1-default-rtdb.firebaseio.com",
            projectId: "studentsystem-c1ab1",
            storageBucket: "studentsystem-c1ab1.firebasestorage.app",
            messagingSenderId: "112215023848",
            appId: "1:112215023848:web:0adba326a527ee7e37e95d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Expose to window for React
        window.db = db;
        window.auth = auth;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        // Using window variables for app ID to separate data if needed, though we use a fixed path here
        window.APP_ID = "almanara_lms"; 
    </script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .flip-card { perspective: 1000px; height: 300px; width: 100%; cursor: pointer; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 1.5rem; padding: 20px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .flip-card-front { background-color: white; color: #1e293b; border: 2px solid #f1f5f9; }
        .flip-card-back { transform: rotateY(180deg); background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 5000; overflow-y: auto; padding: 20px 0; }
        
        /* Certificate Specific Styles */
        .cert-pattern {
            background-image: radial-gradient(#fbbf24 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: { colors: { primary: '#2563eb', secondary: '#10b981', gold: '#fbbf24', danger: '#ef4444', dark: '#0f172a' } }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Mock Data (Used for initial seeding if DB is empty) ---
        const defaultLesson = {
            title: "Ù…Ù‚Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠ)",
            content: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ùˆ Ù…Ø­Ø§ÙƒØ§Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¨Ø´Ø±ÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¢Ù„Ø§Øª. ÙŠÙ†Ù‚Ø³Ù… Ø¥Ù„Ù‰ Ù†ÙˆØ¹ÙŠÙ†: Ø¶ÙŠÙ‚ (Ù…Ø­Ø¯Ø¯ Ø§Ù„Ù…Ù‡Ø§Ù…) ÙˆØ¹Ø§Ù… (Ø´Ø§Ù…Ù„).",
            isVisible: true,
            views: 0, attempts: 0,
            questions: [
                {id: 1, type: 'mcq', text: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø§Ø®ØªØµØ§Ø± Ø§Ù„Ø´Ø§Ø¦Ø¹ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ', options: ['AI', 'VR', 'AR', 'IOT'], answer: 'ai', explanation: 'AI Ù‡ÙŠ Ø§Ø®ØªØµØ§Ø± Ù„Ù€ Artificial Intelligence.'},
                {id: 2, type: 'tf', text: 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¹Ø§Ù… Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.', answer: 'false', explanation: 'Ø®Ø·Ø£ØŒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¹Ø§Ù… ÙŠØ­Ø§ÙƒÙŠ Ù‚Ø¯Ø±Ø© Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„Ø©.'},
                {id: 3, type: 'mcq', text: 'Ø£ÙŠ Ù…Ù…Ø§ ÙŠÙ„ÙŠ ÙŠØ¹ØªØ¨Ø± Ù…Ù† Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ', options: ['Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ', 'ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹', 'Ø§Ù„Ø´Ø¨ÙƒØ§Øª'], answer: 'Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ', explanation: 'Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ Ù‡Ùˆ Ø£Ø­Ø¯ Ø§Ù„ÙØ±ÙˆØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.'},
                {id: 4, type: 'tf', text: 'ÙŠÙ…ÙƒÙ† Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±.', answer: 'true', explanation: 'Ù†Ø¹Ù…ØŒ ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ÙŠØ© ØªÙ…ÙƒÙ†Ù‡ Ù…Ù† Ø°Ù„Ùƒ.'}
            ],
            flashcards: [{front: "AI", back: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ"}, {front: "ANI", back: "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø¶ÙŠÙ‚"}]
        };

        // --- Helpers ---
        const getLevelName = (level) => {
            if(level >= 10) return "Ø¹Ø§Ù„Ù… ğŸ‘‘";
            if(level >= 5) return "Ø¨Ø±ÙˆÙÙŠØ³ÙˆØ± ğŸ“";
            if(level >= 3) return "Ø®Ø¨ÙŠØ± ğŸŒŸ";
            return "Ù…Ø¨ØªØ¯Ø¦ ğŸŒ±";
        }

        const normalizeAnswer = (ans) => {
            if (typeof ans === 'boolean') return ans ? "true" : "false";
            if (!ans) return "false";
            const s = String(ans).trim().toLowerCase();
            if (s === 'sah' || s === 'ØµØ­' || s === 'true') return "true";
            if (s === 'khata' || s === 'Ø®Ø·Ø£' || s === 'wrong' || s === 'false') return "false";
            return s;
        };

        const shuffleArray = (array) => {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        };

        const processImage = (file) => {
            return new Promise((resolve, reject) => {
                if (!file) return reject("No file");
                if (!file.type.startsWith('image/')) return reject("Not an image");

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_SIZE = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        };

        // --- Main App ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [lessons, setLessons] = useState([]);
            const [students, setStudents] = useState([]); 
            const [questionBank, setQuestionBank] = useState([]); // This could be derived or stored separate
            
            // Replaces Sticky States with standard state populated by Firebase
            const [adminPassword, setAdminPassword] = useState('1234');
            const [guestMessages, setGuestMessages] = useState([]);
            const [dbReady, setDbReady] = useState(false);

            // Messaging System State
            const [privateMessages, setPrivateMessages] = useState([]);
            const [announcements, setAnnouncements] = useState([]);

            const [currentUser, setCurrentUser] = useState(() => {
                try {
                    const saved = window.localStorage.getItem('currentUser');
                    return saved ? JSON.parse(saved) : null;
                } catch { return null; }
            });
            const [activeLesson, setActiveLesson] = useState(null);
            const [lessonMode, setLessonMode] = useState('take');

            // Persist currentUser to localStorage
            useEffect(() => {
                try {
                    if (currentUser) {
                        window.localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    } else {
                        window.localStorage.removeItem('currentUser');
                    }
                } catch {}
            }, [currentUser]);

            // Admin Access Logic
            const [adminClickCount, setAdminClickCount] = useState(0);
            const [showAdminPassModal, setShowAdminPassModal] = useState(false);
            const [adminPass, setAdminPass] = useState('');
            const clickTimeoutRef = useRef(null);

            // --- Firebase Setup & Listeners ---
            useEffect(() => {
                const initFirebase = async () => {
                    if (window.auth) {
                        await window.signInAnonymously(window.auth);
                    }
                };
                initFirebase();

                if (!window.db) return;

                const appId = window.APP_ID;
                const publicDataPath = ['artifacts', appId, 'public', 'data'];

                // 1. Listen to Lessons
                const qLessons = window.query(window.collection(window.db, ...publicDataPath, 'lessons'));
                const unsubLessons = window.onSnapshot(qLessons, (snapshot) => {
                    const loadedLessons = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    // Initial seed if empty
                    if (loadedLessons.length === 0 && !dbReady) {
                        // Optional: Seed default lesson
                        // addLesson(defaultLesson); 
                        // For now we just set empty array or manual seed
                        setLessons([]); 
                    } else {
                        setLessons(loadedLessons);
                        // Rebuild basic question bank from lessons
                        const allQs = loadedLessons.flatMap(l => (l.questions || []).map(q => ({ ...q, lessonTitle: l.title, lessonId: l.id })));
                        setQuestionBank(allQs);
                    }
                    setDbReady(true);
                }, (err) => console.error("Lessons Sync Error:", err));

                // 2. Listen to Students
                const qStudents = window.query(window.collection(window.db, ...publicDataPath, 'students'));
                const unsubStudents = window.onSnapshot(qStudents, (snapshot) => {
                    const loadedStudents = snapshot.docs.map(d => ({ ...d.data(), nid: d.id })); // use doc ID as nid for uniqueness reference
                    setStudents(loadedStudents);
                }, (err) => console.error("Students Sync Error:", err));

                // 3. Listen to Guest Messages
                const qMsgs = window.query(window.collection(window.db, ...publicDataPath, 'guest_messages'));
                const unsubMsgs = window.onSnapshot(qMsgs, (snapshot) => {
                    setGuestMessages(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                // 4. Listen to Settings (Admin Password)
                const docRef = window.doc(window.db, ...publicDataPath, 'settings', 'admin');
                const unsubSettings = window.onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        setAdminPassword(doc.data().password || '1234');
                    }
                });

                // 5. Listen to Private Messages
                const qPrivateMsgs = window.query(window.collection(window.db, ...publicDataPath, 'private_messages'));
                const unsubPrivateMsgs = window.onSnapshot(qPrivateMsgs, (snapshot) => {
                    setPrivateMessages(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                // 6. Listen to Announcements
                const qAnnouncements = window.query(window.collection(window.db, ...publicDataPath, 'announcements'));
                const unsubAnnouncements = window.onSnapshot(qAnnouncements, (snapshot) => {
                    setAnnouncements(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                return () => {
                    unsubLessons();
                    unsubStudents();
                    unsubMsgs();
                    unsubSettings();
                    unsubPrivateMsgs();
                    unsubAnnouncements();
                };
            }, []);

            // Auto-refresh current user data if it changes in DB
            useEffect(() => {
                if (currentUser && currentUser.role === 'student') {
                    const freshUser = students.find(s => s.nid === currentUser.nid);
                    if (freshUser) {
                        // Deep compare to avoid loops is ideal, but JSON stringify works for simple objects
                        if (JSON.stringify(freshUser) !== JSON.stringify(currentUser)) {
                            setCurrentUser({...freshUser, role: 'student'});
                        }
                    }
                }
            }, [students, currentUser]);

            // --- Firebase Action Wrappers ---

            const fbAddLesson = async (l) => {
                // Use numeric ID as string for doc ID to maintain order if needed, or allow auto-ID
                const lessonId = l.id ? String(l.id) : String(Date.now());
                const newLesson = { ...l, id: lessonId, views: 0, attempts: 0, isVisible: true };
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'lessons', lessonId), newLesson);
            };

            const fbUpdateLesson = async (l) => {
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'lessons', String(l.id)), l, { merge: true });
            };

            const fbDeleteLesson = async (id) => {
                if(confirm("Ø­Ø°Ù Ø§Ù„Ø¯Ø±Ø³ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'lessons', String(id)));
                }
            };

            const fbToggleVisibility = async (id) => {
                const l = lessons.find(x => x.id === id);
                if(l) await fbUpdateLesson({ ...l, isVisible: !l.isVisible });
            };

            const fbAddStudent = async (studentData) => {
                // Check local array first for immediate feedback, though Firestore rules should enforce unique IDs properly
                if(students.some(s => s.nid === studentData.nid)) return alert("Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
                
                const newStudent = { 
                    ...studentData, 
                    xp: 0, level: 1, history: [], mistakes: [], srsQueue: [], lastLogin: null, streak: 0, badges: [],
                    hasCompletedSetup: false,
                    password: studentData.nid, 
                    mobile: '',
                    avatar: ''
                };
                
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'students', String(studentData.nid)), newStudent);
            };

            const fbUpdateStudent = async (nid, newData) => {
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'students', String(nid)), newData, { merge: true });
            };

            const fbDeleteStudent = async (nid) => {
                if(confirm("Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'students', String(nid)));
                }
            };
            
            const fbDeleteAllStudents = async () => {
                if(confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) {
                    if(confirm("ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.")) {
                        // Batch delete is better but for simple loop:
                        for (let s of students) {
                            await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'students', String(s.nid)));
                        }
                    }
                }
            };

            const fbAddGuestMessage = async (msgData) => {
                await window.addDoc(window.collection(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'guest_messages'), {
                    ...msgData,
                    date: new Date().toLocaleDateString(),
                    timestamp: Date.now()
                });
                alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­!");
            };

            const fbDeleteMessage = async (id) => {
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'guest_messages', id));
            };

            const fbSetAdminPassword = async (newPass) => {
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'settings', 'admin'), { password: newPass });
                setAdminPassword(newPass); // Optimistic update
            };

            // --- Messaging System Functions ---
            const fbSendPrivateMessage = async (fromId, toId, text, fromName) => {
                await window.addDoc(window.collection(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'private_messages'), {
                    from: fromId,
                    to: toId,
                    fromName: fromName,
                    text: text,
                    timestamp: Date.now(),
                    read: false
                });
            };

            const fbMarkMessageRead = async (msgId) => {
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'private_messages', msgId), { read: true }, { merge: true });
            };

            const fbDeletePrivateMessage = async (msgId) => {
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'private_messages', msgId));
            };

            const fbDeleteConversation = async (studentNid) => {
                const toDelete = privateMessages.filter(m => m.from === studentNid || m.to === studentNid);
                for (let msg of toDelete) {
                    await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'private_messages', msg.id));
                }
            };

            const fbSendAnnouncement = async (text, targetSection = 'all', isPinned = false, scheduledFor = null) => {
                await window.addDoc(window.collection(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'announcements'), {
                    text: text,
                    targetSection: targetSection,
                    isPinned: isPinned,
                    scheduledFor: scheduledFor,
                    timestamp: Date.now(),
                    readBy: []
                });
            };

            const fbMarkAnnouncementRead = async (annId, studentNid) => {
                const ann = announcements.find(a => a.id === annId);
                if (ann && !ann.readBy?.includes(studentNid)) {
                    const newReadBy = [...(ann.readBy || []), studentNid];
                    await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'announcements', annId), { readBy: newReadBy }, { merge: true });
                }
            };

            const fbToggleAnnouncementPin = async (annId) => {
                const ann = announcements.find(a => a.id === annId);
                if (ann) {
                    await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'announcements', annId), { isPinned: !ann.isPinned }, { merge: true });
                }
            };

            const fbDeleteAnnouncement = async (annId) => {
                await window.deleteDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'announcements', annId));
            };

            const fbUpdateAnnouncement = async (annId, newText) => {
                await window.setDoc(window.doc(window.db, 'artifacts', window.APP_ID, 'public', 'data', 'announcements', annId), { text: newText }, { merge: true });
            };

            // --- Original Logic Adapted ---

            const handleAdminTabClick = () => {
                // Prevent action if modal is already open
                if (showAdminPassModal) return;
                const newCount = adminClickCount + 1;
                setAdminClickCount(newCount);
                if (clickTimeoutRef.current) clearTimeout(clickTimeoutRef.current);
                clickTimeoutRef.current = setTimeout(() => { setAdminClickCount(0); }, 1000);
                if (newCount >= 5) {
                    setAdminClickCount(0);
                    setShowAdminPassModal(true);
                }
            };

            const confirmAdminPass = (pass) => {
                if (pass === adminPassword) {
                    setView('admin');
                    setShowAdminPassModal(false);
                } else {
                    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                }
            };

            const addBulkLessons = async (newLessons) => {
                const processed = newLessons.map((l, i) => {
                    const lessonId = String(Date.now() + (i * 1000) + Math.floor(Math.random() * 900));
                    return {
                        id: lessonId,
                        title: l.title || `Ø¯Ø±Ø³ ${i+1}`,
                        content: l.content || "Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø³...",
                        views: 0, attempts: 0, isVisible: true,
                        questions: (l.questions || []).map((q, qi) => {
                            const qTypeRaw = (q.type || 'mcq').toLowerCase();
                            const isTF = qTypeRaw === 'tf' || qTypeRaw === 'true_false' || qTypeRaw.includes('true');
                            return {
                                id: Date.now() + qi + 100 + Math.random(),
                                type: isTF ? 'tf' : 'mcq',
                                text: q.text || q.question || "Ø³Ø¤Ø§Ù„ Ø¨Ø¯ÙˆÙ† Ù†Øµ",
                                options: q.options || [],
                                answer: normalizeAnswer(q.answer),
                                explanation: q.explanation || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ¨Ø±ÙŠØ± Ù…ØªØ§Ø­."
                            };
                        }),
                        flashcards: (l.flashcards || []).map((f, fi) => ({
                            id: Date.now() + fi + 500 + Math.random(),
                            front: f.front || "Ù…ØµØ·Ù„Ø­",
                            back: f.back || "ØªØ¹Ø±ÙŠÙ"
                        }))
                    };
                });
                
                // Add sequentially to DB
                for(let l of processed) {
                    await fbAddLesson(l);
                }
            };

            const importStudents = async (csvText) => {
                const lines = csvText.split(/\r?\n/);
                let count = 0; 
                for(let line of lines) {
                    const [name, section, nid] = line.split(/[,;\t]/).map(s => s?.trim());
                    if(name && nid && !students.some(s => s.nid === nid)) {
                        await fbAddStudent({ name, section, nid });
                        count++;
                    }
                }
                if(count > 0) alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${count} Ø·Ø§Ù„Ø¨`);
            };

            const resetStudentFull = async (nid) => {
                if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ØŸ")) {
                    await fbUpdateStudent(nid, { xp: 0, level: 1, history: [], mistakes: [], srsQueue: [], streak: 0, badges: [] });
                    return true;
                }
                return false;
            };
            
            const resetStudentLesson = async (nid, lessonId) => {
                if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù ØªÙ‚Ø¯Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ù„ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø¥Ø¹Ø§Ø¯ØªÙ‡ØŸ")) {
                    const s = students.find(st => st.nid === nid);
                    if(s) {
                        const newHistory = s.history.filter(h => h.lessonId !== lessonId);
                        await fbUpdateStudent(nid, { history: newHistory });
                    }
                }
            };

            const performLogin = async (studentObj) => {
                const now = new Date();
                const today = now.toDateString();
                const lastLoginDateOnly = studentObj.lastLoginTimestamp ? new Date(studentObj.lastLoginTimestamp).toDateString() : null;
                let updates = {};

                if(lastLoginDateOnly !== today) {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                    if(lastLoginDateOnly === yesterday.toDateString()) {
                        updates.streak = (studentObj.streak || 0) + 1;
                    } else {
                        updates.streak = 1;
                    }
                }

                // Always update lastLogin with full timestamp
                updates.lastLogin = today;
                updates.lastLoginTimestamp = now.getTime();

                await fbUpdateStudent(studentObj.nid, updates);
                setCurrentUser({ ...studentObj, ...updates, role: 'student' });
                setView('student-dash');
            };

            const loginGuest = () => { setCurrentUser({ name: "Ø²Ø§Ø¦Ø±", role: "guest", xp: 0, level: 1 }); setView('student-dash'); };
            
            const updateUserProgress = async (lessonId, score, newMistakes, passed) => {
                if(currentUser.role === 'guest') return;
                
                const s = students.find(st => st.nid === currentUser.nid);
                if(!s) return;

                let xpGain = score;
                const newTotalXP = (s.xp || 0) + xpGain;
                const newLevel = Math.floor(newTotalXP / 200) + 1;
                const newHistory = [...(s.history||[]), { lessonId, score, date: new Date().toLocaleDateString() }];
                
                let newSrs = [...(s.srsQueue || [])];
                const currentLesson = lessons.find(l => l.id === lessonId);
                const lessonQs = currentLesson?.questions || [];
                
                // Add correct questions to SRS if not present
                const correctQs = lessonQs.filter(q => !newMistakes.find(m => m.text === q.text));
                correctQs.forEach(q => { 
                    if(!newSrs.find(sq => sq.text === q.text)) {
                        newSrs.push({ ...q, nextReview: Date.now() + 86400000, stage: 1 }); 
                    }
                });
                
                // Add unique mistakes
                const currentMistakeTexts = new Set((s.mistakes || []).map(m => m.text));
                const uniqueNewMistakes = newMistakes.filter(m => !currentMistakeTexts.has(m.text));
                const finalMistakes = [...(s.mistakes || []), ...uniqueNewMistakes];

                await fbUpdateStudent(s.nid, { xp: newTotalXP, level: newLevel, history: newHistory, mistakes: finalMistakes, srsQueue: newSrs });
                
                // Update lesson views locally then push (optional, or rely on just student data for analytics)
                if (currentLesson) {
                   await fbUpdateLesson({ ...currentLesson, views: (currentLesson.views||0) + 1 }); 
                }
            };

            const solveMistake = async (id) => {
                if(currentUser.role === 'guest') return;
                const s = students.find(st => st.nid === currentUser.nid);
                if(s) {
                     await fbUpdateStudent(s.nid, { 
                         mistakes: s.mistakes.filter(x => x.id!==id), 
                         xp: s.xp + 15 
                     });
                     confetti();
                }
            };

            const handleSRSReview = async (q, remembered) => {
                if(currentUser.role === 'guest') return;
                const s = students.find(st => st.nid === currentUser.nid);
                if(s) {
                    let newSrs = s.srsQueue.filter(item => item.text !== q.text);
                    let updates = {};
                    if(remembered) {
                        const nextStage = (q.stage || 1) + 1; const days = nextStage === 2 ? 7 : 30;
                        newSrs.push({ ...q, nextReview: Date.now() + (days*86400000), stage: nextStage });
                        updates = { srsQueue: newSrs, xp: s.xp + 15 };
                    } else {
                        newSrs.push({ ...q, nextReview: Date.now() + 86400000, stage: 1 });
                        updates = { srsQueue: newSrs };
                    }
                    await fbUpdateStudent(s.nid, updates);
                }
            };

            const handleLogout = () => { setCurrentUser(null); setView('landing'); };
            const handleLogoClick = () => { if (currentUser) { setView('student-dash'); } else { setView('landing'); } };
            const handleProfileUpdate = async (nid, newData) => { await fbUpdateStudent(nid, newData); };

            // Admin Password Modal - state moved outside to prevent re-creation
            const handleAdminPassClose = () => {
                setShowAdminPassModal(false);
                setAdminPass('');
            };

            // StickyState helper for API key only (keep local)
            const useStickyState = (defaultValue, key) => {
                const [value, setValue] = useState(() => {
                    const stickyValue = window.localStorage.getItem(key);
                    return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
                });
                useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
                return [value, setValue];
            };

            return (
                <div className="min-h-screen flex flex-col text-slate-800 bg-slate-50">
                    <NavBar view={view} setView={setView} user={currentUser} onLogoClick={handleLogoClick} onLogout={handleLogout} onAdminClick={handleAdminTabClick} />
                    {showAdminPassModal && (
                        <div className="modal-overlay">
                            <div className="bg-white p-6 rounded-2xl shadow-xl w-80 text-center">
                                <h3 className="font-bold text-lg mb-4">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…Ø­Ù…ÙŠ</h3>
                                <input type="password" className="w-full p-2 border rounded mb-4 text-center" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={adminPass} onChange={e => setAdminPass(e.target.value)} autoFocus />
                                <div className="flex gap-2">
                                    <button onClick={() => confirmAdminPass(adminPass)} className="flex-1 bg-primary text-white py-2 rounded font-bold">Ø¯Ø®ÙˆÙ„</button>
                                    <button onClick={handleAdminPassClose} className="flex-1 bg-slate-200 text-slate-700 py-2 rounded font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <main className="flex-grow container mx-auto p-4 md:p-6 max-w-7xl">
                        {view === 'landing' && <Landing setView={setView} loginGuest={loginGuest} />}
                        {view === 'admin' && <AdminDashboard lessons={lessons} addLesson={fbAddLesson} updateLesson={fbUpdateLesson} deleteLesson={fbDeleteLesson} toggleVisibility={fbToggleVisibility} addBulkLessons={addBulkLessons} students={students} addStudent={fbAddStudent} updateStudentFull={fbUpdateStudent} deleteStudent={fbDeleteStudent} deleteAllStudents={fbDeleteAllStudents} importStudents={importStudents} exportStudents={() => {/* Export Logic Same */}} questionBank={questionBank} resetStudentFull={resetStudentFull} resetStudentLesson={resetStudentLesson} guestMessages={guestMessages} deleteMessage={fbDeleteMessage} adminPassword={adminPassword} setAdminPassword={fbSetAdminPassword} useStickyState={useStickyState} privateMessages={privateMessages} announcements={announcements} fbSendPrivateMessage={fbSendPrivateMessage} fbMarkMessageRead={fbMarkMessageRead} fbDeletePrivateMessage={fbDeletePrivateMessage} fbDeleteConversation={fbDeleteConversation} fbSendAnnouncement={fbSendAnnouncement} fbToggleAnnouncementPin={fbToggleAnnouncementPin} fbDeleteAnnouncement={fbDeleteAnnouncement} fbUpdateAnnouncement={fbUpdateAnnouncement} />}
                        {view === 'student-login' && <StudentLogin students={students} onLogin={performLogin} updateStudentFull={fbUpdateStudent} />}
                        {view === 'student-dash' && <StudentDashboard user={currentUser} students={students} lessons={lessons} setView={setView} setActiveLesson={setActiveLesson} setLessonMode={setLessonMode} onProfileUpdate={handleProfileUpdate} onSendMessage={fbAddGuestMessage} privateMessages={privateMessages} announcements={announcements} onSendPrivateMessage={fbSendPrivateMessage} onMarkAnnouncementRead={fbMarkAnnouncementRead} onMarkMessageRead={fbMarkMessageRead} />}
                        {view === 'lesson' && <LessonView lesson={activeLesson} user={currentUser} onComplete={updateUserProgress} onBack={() => setView('student-dash')} mode={lessonMode} />}
                        {view === 'flashcards' && <FlashcardsView lesson={activeLesson} onBack={() => setView('student-dash')} />}
                        {view === 'srs' && <SRSView user={currentUser} onReview={handleSRSReview} onBack={() => setView('student-dash')} />}
                        {view === 'mistakes' && <MistakeVault user={currentUser} onSolve={solveMistake} onBack={() => setView('student-dash')} />}
                        {view === 'certificate' && <Certificate user={currentUser} onBack={() => setView('student-dash')} />}
                    </main>
                </div>
            );
        };

        const NavBar = ({ view, setView, user, onLogoClick, onLogout, onAdminClick }) => (
            <nav className="glass sticky top-0 z-50 border-b px-4 py-3 flex justify-between items-center shadow-sm">
                <div className="flex items-center gap-2 cursor-pointer" onClick={onLogoClick}>
                    <div className="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg"><i className="fas fa-lightbulb"></i></div>
                    <div><h1 className="font-bold text-lg">Ù…Ù†ØµØ© Ø§Ù„ØªÙØ³ÙŠØ±</h1><p className="text-[10px] text-slate-500 font-bold">LMS TAFSER</p></div>
                </div>
                {user && user.role === 'student' && (
                    <div className="hidden md:flex items-center gap-3 bg-white px-3 py-1 rounded-full border shadow-sm">
                        {user.avatar ? <img src={user.avatar} className="w-8 h-8 rounded-full border bg-white object-cover" /> : <div className="w-8 h-8 rounded-full bg-slate-200 flex items-center justify-center text-slate-500"><i className="fas fa-user"></i></div>}
                        <span className="font-bold text-sm text-slate-700">{user.name}</span>
                        <span className="text-xs text-gold font-bold"><i className="fas fa-star"></i> {user.xp}</span>
                    </div>
                )}
                <div className="flex gap-2 text-xs md:text-sm items-center">
                    <button onClick={onAdminClick} className="text-primary hover:text-blue-700 font-bold bg-blue-50 px-3 py-1 rounded-lg border border-blue-100 select-none active:scale-95 transition"><i className="fas fa-chalkboard-teacher"></i> Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                    {user && (
                        <button onClick={onLogout} title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬" className="text-red-500 hover:bg-red-50 p-2 rounded-lg transition border border-transparent hover:border-red-100">
                            <i className="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    )}
                </div>
            </nav>
        );

        const Landing = ({ setView, loginGuest }) => (
            <div className="text-center py-24 fade-in flex flex-col items-center justify-center">
                <h1 className="text-6xl font-extrabold mb-6 text-slate-900 tracking-tight">Ø§Ù„ØªØ¹Ù„ÙŠÙ… <span className="text-primary">Ø§Ù„Ø°ÙƒÙŠ</span></h1>
                <p className="text-xl text-slate-500 mb-10 max-w-lg"> Ù…Ù†ØµØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø¯Ø±ÙˆØ³ Ø§Ù„ØªÙØ³ÙŠØ± Ù„Ù„ØµÙ Ø§Ù„Ø§ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ Ø¨Ø«Ø§Ù†ÙˆÙŠØ© Ø¹Ø´ÙŠØ±Ø©</p>
                <div className="flex flex-col gap-4 w-full max-w-xs">
                    <button onClick={() => setView('student-login')} className="bg-primary text-white px-8 py-4 rounded-2xl font-bold shadow-xl hover:scale-105 transition flex items-center justify-center gap-2 w-full"><i className="fas fa-user-graduate"></i> Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨</button>
                    <button onClick={loginGuest} className="bg-white text-slate-700 border-2 border-slate-200 px-8 py-4 rounded-2xl font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2 w-full"><i className="fas fa-eye"></i> ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø±</button>
                </div>
            </div>
        );

        const StudentLogin = ({ students, onLogin, updateStudentFull }) => {
            const [nid, setNid] = useState('');
            const [step, setStep] = useState('check_nid'); 
            const [student, setStudent] = useState(null);
            
            const [newPass, setNewPass] = useState('');
            const [mobile, setMobile] = useState('');
            const [avatarFile, setAvatarFile] = useState(null);
            
            const [password, setPassword] = useState('');
            const [forgotMobile, setForgotMobile] = useState('');
            const [isUploading, setIsUploading] = useState(false);

            const handleCheckNid = () => {
                const s = students.find(s => s.nid === nid);
                if (!s) return alert("Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù….");
                setStudent(s);
                if (!s.hasCompletedSetup) {
                    setStep('setup_profile');
                } else {
                    setStep('password_login');
                }
            };

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsUploading(true);
                try {
                    const compressed = await processImage(file);
                    setAvatarFile(compressed);
                } catch(err) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù.");
                }
                setIsUploading(false);
            };

            const handleSetup = async () => {
                if (!newPass) return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©");
                await updateStudentFull(student.nid, {
                    password: newPass,
                    mobile: mobile,
                    avatar: avatarFile || student.avatar,
                    hasCompletedSetup: true
                });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†.");
                const updatedS = { ...student, password: newPass, mobile, avatar: avatarFile || student.avatar, hasCompletedSetup: true };
                onLogin(updatedS);
            };

            const handlePasswordLogin = () => {
                if (password === student.password) {
                    onLogin(student);
                } else {
                    alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
                }
            };

            const handleForgotCheck = () => {
                if (!student.mobile || student.mobile !== forgotMobile) {
                    alert("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ ØºÙŠØ± Ù…Ø³Ø¬Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨Ùƒ.");
                } else {
                    alert(`ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡ÙŠ: ${student.password}`);
                    setStep('password_login');
                }
            };

            return (
                <div className="flex justify-center items-center min-h-[70vh] fade-in p-4">
                    <div className="bg-white p-8 md:p-10 rounded-3xl shadow-xl w-full max-w-md text-center border border-slate-100">
                        <h2 className="text-3xl font-extrabold mb-8 text-slate-800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
                        
                        {step === 'check_nid' && (
                            <div className="fade-in">
                                <label className="block text-right text-sm font-bold text-slate-500 mb-2">Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
                                <input className="w-full p-4 bg-slate-50 rounded-xl mb-4 text-center border focus:border-primary outline-none font-bold text-lg font-mono" placeholder="1XXXXXXXXX" value={nid} onChange={e => setNid(e.target.value)} />
                                <button onClick={handleCheckNid} className="w-full bg-primary text-white p-4 rounded-xl font-bold hover:shadow-lg transition">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                            </div>
                        )}

                        {step === 'setup_profile' && (
                            <div className="fade-in text-right">
                                <div className="bg-blue-50 p-3 rounded-lg text-xs text-blue-700 mb-4 font-bold text-center">ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ {student.name}! Ø¨Ù…Ø§ Ø£Ù† Ù‡Ø°Ø§ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø£ÙˆÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.</div>
                                <label className="block text-sm font-bold text-slate-500 mb-1">Ø£Ù†Ø´Ø¦ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
                                <input type="password" className="w-full p-3 border rounded-xl mb-3" value={newPass} onChange={e => setNewPass(e.target.value)} placeholder="*****" />
                                
                                <label className="block text-sm font-bold text-slate-500 mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨)</label>
                                <input className="w-full p-3 border rounded-xl mb-3" value={mobile} onChange={e => setMobile(e.target.value)} placeholder="05XXXXXXXX" />
                                
                                <label className="block text-sm font-bold text-slate-500 mb-1">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                                <input type="file" accept="image/*" className="w-full text-sm mb-4" onChange={handleFileChange} />
                                {isUploading && <div className="text-xs text-blue-500 mb-2">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...</div>}
                                {avatarFile && <img src={avatarFile} className="w-16 h-16 rounded-full mx-auto mb-4 border-2 border-primary object-cover" />}
                                
                                <button onClick={handleSetup} disabled={isUploading} className="w-full bg-green-600 text-white p-4 rounded-xl font-bold hover:shadow-lg transition disabled:opacity-50">Ø­ÙØ¸ ÙˆØ¯Ø®ÙˆÙ„</button>
                            </div>
                        )}

                        {step === 'password_login' && (
                            <div className="fade-in">
                                <h3 className="font-bold text-xl mb-4">Ù…Ø±Ø­Ø¨Ø§Ù‹ {student.name}</h3>
                                {student.avatar && <img src={student.avatar} className="w-20 h-20 rounded-full mx-auto mb-6 shadow-md object-cover" />}
                                <input type="password" className="w-full p-4 bg-slate-50 rounded-xl mb-4 text-center border focus:border-primary outline-none font-bold" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value={password} onChange={e => setPassword(e.target.value)} />
                                <button onClick={handlePasswordLogin} className="w-full bg-primary text-white p-4 rounded-xl font-bold hover:shadow-lg transition mb-4">Ø¯Ø®ÙˆÙ„</button>
                                <button onClick={() => setStep('forgot_password')} className="text-sm text-slate-400 hover:text-primary underline">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button>
                            </div>
                        )}

                        {step === 'forgot_password' && (
                            <div className="fade-in text-right">
                                <h3 className="font-bold text-lg mb-2 text-center">Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
                                <p className="text-xs text-slate-500 mb-4 text-center">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨ØªØ³Ø¬ÙŠÙ„Ù‡ Ù…Ø³Ø¨Ù‚Ø§Ù‹.</p>
                                <input className="w-full p-3 border rounded-xl mb-4 text-center" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" value={forgotMobile} onChange={e => setForgotMobile(e.target.value)} />
                                <button onClick={handleForgotCheck} className="w-full bg-slate-800 text-white p-3 rounded-xl font-bold mb-2">ØªØ­Ù‚Ù‚</button>
                                <button onClick={() => setStep('password_login')} className="w-full text-slate-500 p-2">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const StudentDashboard = ({ user, students, lessons, setView, setActiveLesson, setLessonMode, onProfileUpdate, onSendMessage, privateMessages = [], announcements = [], onSendPrivateMessage, onMarkAnnouncementRead, onMarkMessageRead }) => {
            const [showEditProfile, setShowEditProfile] = useState(false);
            const [showContact, setShowContact] = useState(false);
            const [showStats, setShowStats] = useState(false);
            const [showMessaging, setShowMessaging] = useState(false);
            const [messagingTab, setMessagingTab] = useState('announcements');

            // Profile Edit state (moved outside inner component to prevent re-creation)
            const [editData, setEditData] = useState({ password: '', mobile: '', avatar: '' });
            const [newAvatar, setNewAvatar] = useState(null);
            const [editLoading, setEditLoading] = useState(false);

            // Initialize edit data when modal opens
            React.useEffect(() => {
                if (showEditProfile) {
                    setEditData({ password: user.password || '', mobile: user.mobile || '', avatar: user.avatar || '' });
                    setNewAvatar(null);
                    setEditLoading(false);
                }
            }, [showEditProfile]);
            
            const visibleLessons = lessons.filter(l => l.isVisible);
            const reviewCount = user.role === 'student' ? (user.srsQueue?.filter(q => q.nextReview <= Date.now()).length || 0) : 0;
            const mistakesCount = user.role === 'student' ? (user.mistakes?.length || 0) : 0;

            // Messaging calculations
            const myAnnouncements = user.role === 'student' ? announcements.filter(a =>
                a.targetSection === 'all' || a.targetSection === user.section
            ) : [];
            const unreadAnnouncements = myAnnouncements.filter(a => !a.readBy?.includes(user.nid));
            const myMessages = user.role === 'student' ? privateMessages.filter(m =>
                m.from === user.nid || m.to === user.nid
            ) : [];
            const unreadMessages = myMessages.filter(m => m.to === user.nid && !m.read);
            const totalUnread = unreadAnnouncements.length + unreadMessages.length;

            // Format timestamp helper
            const formatMsgTime = (ts) => {
                if (!ts) return '';
                const d = new Date(ts);
                return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} - ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
            };

            const getLessonStatus = (lessonId) => {
                if(user.role === 'guest') return { status: 'new', score: 0 };
                const history = user.history?.filter(h => h.lessonId === lessonId) || [];
                if(history.length === 0) return { status: 'new', score: 0 };
                const bestScore = Math.max(...history.map(h => h.score));
                return { status: bestScore >= 50 ? 'passed' : 'failed', score: bestScore };
            };

            const handleLessonClick = (l) => {
                const { status } = getLessonStatus(l.id);
                if(status === 'passed') { setLessonMode('review'); setActiveLesson(l); setView('lesson'); } 
                else if(status === 'failed') { alert("ğŸ’ª Ù„Ù… ØªØ¬ØªØ² Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ø¹Ø¯. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø¨ØªØ±ÙƒÙŠØ² Ø£ÙƒØ¨Ø±!"); setLessonMode('take'); setActiveLesson(l); setView('lesson'); } 
                else { setLessonMode('take'); setActiveLesson(l); setView('lesson'); }
            };

            // Top 10 Students Stats calculation
            const getTop10Students = () => {
                const totalLessons = lessons.filter(l => l.isVisible).length;
                return students
                    .map(s => {
                        const passedLessons = s.history?.filter(h => h.score >= 50).map(h => h.lessonId).filter((v, i, a) => a.indexOf(v) === i).length || 0;
                        const completionRate = totalLessons > 0 ? Math.round((passedLessons / totalLessons) * 100) : 0;
                        return { ...s, passedLessons, completionRate };
                    })
                    .sort((a, b) => b.completionRate - a.completionRate || b.xp - a.xp)
                    .slice(0, 10);
            };

            // Guest Message Modal
            const ContactModal = () => {
                const [name, setName] = useState('');
                const [msg, setMsg] = useState('');
                const send = () => {
                    if(!name || !msg) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©");
                    onSendMessage({sender: name, text: msg});
                    setShowContact(false);
                };
                return (
                    <div className="modal-overlay">
                        <div className="bg-white p-6 rounded-2xl w-full max-w-sm m-4 shadow-2xl relative">
                            <h3 className="font-bold text-xl mb-4 text-center">Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                            <input className="w-full p-3 border rounded-xl mb-3" placeholder="Ø§Ø³Ù…Ùƒ" value={name} onChange={e=>setName(e.target.value)} />
                            <textarea className="w-full p-3 border rounded-xl mb-3 h-32" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ..." value={msg} onChange={e=>setMsg(e.target.value)}></textarea>
                            <div className="flex gap-2">
                                <button onClick={send} className="flex-1 bg-green-600 text-white py-2 rounded-xl font-bold">Ø¥Ø±Ø³Ø§Ù„</button>
                                <button onClick={()=>setShowContact(false)} className="flex-1 bg-slate-200 text-slate-700 py-2 rounded-xl font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                            </div>
                        </div>
                    </div>
                );
            };

            // Profile Edit Handlers (moved outside to prevent re-creation)
            const handleProfileSave = () => {
                onProfileUpdate(user.nid, { ...editData, avatar: newAvatar || editData.avatar });
                setShowEditProfile(false);
            };

            const handleProfileImg = async (e) => {
                 const file = e.target.files[0];
                 if(!file) return;
                 setEditLoading(true);
                 try {
                     const compressed = await processImage(file);
                     setNewAvatar(compressed);
                 } catch(err) { console.log("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©"); }
                 setEditLoading(false);
            };

            const handleDeleteProfileImg = () => {
                setNewAvatar(null);
                setEditData({...editData, avatar: ''});
            };

            return (
                <div className="grid lg:grid-cols-3 gap-8 fade-in">
                    {showEditProfile && (
                        <div className="modal-overlay">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-sm m-4 shadow-2xl">
                                <h3 className="font-bold text-xl mb-4 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</h3>
                                <div className="space-y-3 mb-6">
                                    <div><label className="text-xs font-bold text-slate-500">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input className="w-full p-2 border rounded" type="password" value={editData.password} onChange={e=>setEditData({...editData, password: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input className="w-full p-2 border rounded" value={editData.mobile} onChange={e=>setEditData({...editData, mobile: e.target.value})} /></div>
                                    <div><label className="text-xs font-bold text-slate-500">Ø§Ù„ØµÙˆØ±Ø©</label><input type="file" accept="image/*" className="text-xs w-full" onChange={handleProfileImg} /></div>
                                    {editLoading && <div className="text-xs text-blue-500">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</div>}
                                    {(newAvatar || editData.avatar) && (
                                        <div className="flex items-center gap-2 mt-2">
                                            <img src={newAvatar || editData.avatar} className="w-12 h-12 rounded-full object-cover border" />
                                            <button onClick={handleDeleteProfileImg} className="text-xs text-red-500 bg-red-50 px-2 py-1 rounded">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={handleProfileSave} disabled={editLoading} className="flex-1 bg-primary text-white py-2 rounded-lg font-bold disabled:opacity-50">Ø­ÙØ¸</button>
                                    <button onClick={()=>setShowEditProfile(false)} className="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showContact && <ContactModal />}
                    {showStats && (
                        <div className="modal-overlay">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-md m-4 shadow-2xl max-h-[80vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-4 border-b pb-2">
                                    <h3 className="font-bold text-xl">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø© - Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h3>
                                    <button onClick={() => setShowStats(false)} className="text-slate-400 hover:text-slate-600"><i className="fas fa-times"></i></button>
                                </div>
                                <div className="space-y-3">
                                    {getTop10Students().map((s, idx) => (
                                        <div key={s.nid} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl border">
                                            <div className="font-bold text-lg text-primary w-6">{idx + 1}</div>
                                            <div className="w-12 h-12 rounded-full bg-slate-200 flex items-center justify-center overflow-hidden border-2 border-white shadow">
                                                {s.avatar ? <img src={s.avatar} className="w-full h-full object-cover" /> : <i className="fas fa-user text-slate-400"></i>}
                                            </div>
                                            <div className="flex-1">
                                                <div className="font-bold text-slate-800">{s.name}</div>
                                                <div className="text-xs text-slate-500">{getLevelName(s.level)}</div>
                                            </div>
                                            <div className="text-center">
                                                <div className="text-sm font-bold text-green-600">{s.passedLessons} Ø¯Ø±Ø³</div>
                                                <div className="text-xs text-slate-400">{s.completionRate}%</div>
                                            </div>
                                        </div>
                                    ))}
                                    {getTop10Students().length === 0 && <div className="text-center text-slate-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>}
                                </div>
                            </div>
                        </div>
                    )}
                    {showMessaging && user.role === 'student' && (
                        <div className="modal-overlay">
                            <div className="bg-white p-6 rounded-2xl w-full max-w-lg m-4 shadow-2xl max-h-[85vh] overflow-hidden flex flex-col">
                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                    <h3 className="font-bold text-xl text-indigo-700"><i className="fas fa-comments ml-2"></i>Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                                    <button onClick={() => setShowMessaging(false)} className="text-slate-400 hover:text-slate-600 text-xl"><i className="fas fa-times"></i></button>
                                </div>
                                {/* Tabs */}
                                <div className="flex gap-2 mb-4">
                                    <button onClick={() => setMessagingTab('announcements')} className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition ${messagingTab === 'announcements' ? 'bg-purple-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                        <i className="fas fa-bullhorn ml-1"></i> Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª {unreadAnnouncements.length > 0 && <span className="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full mr-1">{unreadAnnouncements.length}</span>}
                                    </button>
                                    <button onClick={() => setMessagingTab('private')} className={`flex-1 py-2 px-4 rounded-lg font-bold text-sm transition ${messagingTab === 'private' ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                                        <i className="fas fa-envelope ml-1"></i> Ø±Ø³Ø§Ø¦Ù„ÙŠ {unreadMessages.length > 0 && <span className="bg-red-500 text-white text-xs px-1.5 py-0.5 rounded-full mr-1">{unreadMessages.length}</span>}
                                    </button>
                                </div>
                                {/* Content */}
                                <div className="flex-1 overflow-y-auto">
                                    {messagingTab === 'announcements' && (
                                        <div className="space-y-3">
                                            {myAnnouncements.length === 0 ? <p className="text-slate-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p> :
                                                [...myAnnouncements].sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.timestamp - a.timestamp).map(ann => (
                                                    <div key={ann.id} onClick={() => onMarkAnnouncementRead && onMarkAnnouncementRead(ann.id, user.nid)} className={`p-4 rounded-xl border cursor-pointer transition ${ann.isPinned ? 'bg-yellow-50 border-yellow-300' : 'bg-slate-50'} ${!ann.readBy?.includes(user.nid) ? 'border-r-4 border-r-purple-500' : ''}`}>
                                                        <div className="flex items-center gap-2 mb-2">
                                                            {ann.isPinned && <i className="fas fa-thumbtack text-yellow-600"></i>}
                                                            {!ann.readBy?.includes(user.nid) && <span className="bg-purple-500 text-white text-xs px-2 py-0.5 rounded">Ø¬Ø¯ÙŠØ¯</span>}
                                                            <span className="text-xs text-slate-400">{formatMsgTime(ann.timestamp)}</span>
                                                        </div>
                                                        <p className="text-slate-700 whitespace-pre-wrap">{ann.text}</p>
                                                    </div>
                                                ))
                                            }
                                        </div>
                                    )}
                                    {messagingTab === 'private' && (
                                        <div className="flex flex-col h-full">
                                            <div className="flex-1 overflow-y-auto space-y-3 mb-4 p-2 bg-slate-50 rounded-xl min-h-48">
                                                {myMessages.length === 0 ? <p className="text-slate-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p> :
                                                    [...myMessages].sort((a, b) => a.timestamp - b.timestamp).map(m => {
                                                        if (m.to === user.nid && !m.read && onMarkMessageRead) onMarkMessageRead(m.id);
                                                        return (
                                                            <div key={m.id} className={`flex ${m.from === user.nid ? 'justify-end' : 'justify-start'}`}>
                                                                <div className={`max-w-xs p-3 rounded-xl ${m.from === user.nid ? 'bg-indigo-100 text-indigo-900' : 'bg-white border shadow-sm'}`}>
                                                                    <p className="text-sm whitespace-pre-wrap">{m.text}</p>
                                                                    <div className="text-xs text-slate-400 mt-1">{formatMsgTime(m.timestamp)}</div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })
                                                }
                                            </div>
                                            <div className="flex gap-2 mt-auto">
                                                <input type="text" id="studentMsgInput" className="flex-1 p-3 border rounded-xl text-sm" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…Ø¹Ù„Ù…..." onKeyPress={e => { if(e.key === 'Enter') document.getElementById('studentSendBtn').click(); }} />
                                                <button id="studentSendBtn" onClick={() => {
                                                    const input = document.getElementById('studentMsgInput');
                                                    if (!input.value.trim() || !onSendPrivateMessage) return;
                                                    onSendPrivateMessage(user.nid, 'teacher', input.value, user.name);
                                                    input.value = '';
                                                }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-xl font-bold"><i className="fas fa-paper-plane"></i></button>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="lg:col-span-1 space-y-6">
                        <div className="bg-white p-6 rounded-3xl shadow-sm border h-fit sticky top-24">
                            <div className="text-center mb-8">
                                <div className="w-24 h-24 mx-auto bg-gradient-to-br from-primary to-blue-400 text-white rounded-full flex items-center justify-center text-4xl font-bold mb-4 shadow-xl border-4 border-white overflow-hidden">
                                    {user.avatar ? <img src={user.avatar} className="w-full h-full object-cover" /> : (user.role === 'guest' ? 'G' : user.level)}
                                </div>
                                <h3 className="font-bold text-xl">{user.role === 'guest' ? 'Ø²Ø§Ø¦Ø±' : getLevelName(user.level)}</h3>
                                {user.role === 'student' && (<><p className="text-slate-900 font-bold text-lg mt-2">{user.name}</p><p className="text-slate-400 text-sm">{user.xp} Ù†Ù‚Ø·Ø©</p></>)}
                            </div>
                            {user.role === 'student' && (
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    <button onClick={() => setView('srs')} className="bg-orange-50 text-orange-600 p-4 rounded-2xl font-bold border border-orange-100 relative hover:bg-orange-100 transition flex flex-col items-center gap-1"><i className="fas fa-brain text-xl"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© {reviewCount > 0 && <span className="absolute top-2 right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full animate-bounce">{reviewCount}</span>}</button>
                                    <button onClick={() => setView('mistakes')} className="bg-red-50 text-red-600 p-4 rounded-2xl font-bold border border-red-100 relative hover:bg-red-100 transition flex flex-col items-center gap-1"><i className="fas fa-bug text-xl"></i> Ø£Ø®Ø·Ø§Ø¦ÙŠ {mistakesCount > 0 && <span className="absolute top-2 right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full">{mistakesCount}</span>}</button>
                                    <button onClick={() => setShowStats(true)} className="bg-teal-50 text-teal-600 p-4 rounded-2xl font-bold border border-teal-100 relative hover:bg-teal-100 transition flex flex-col items-center gap-1 col-span-2"><i className="fas fa-chart-bar text-xl"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</button>
                                    <button onClick={() => setShowMessaging(true)} className="bg-indigo-50 text-indigo-600 p-4 rounded-2xl font-bold border border-indigo-100 relative hover:bg-indigo-100 transition flex flex-col items-center gap-1 col-span-2"><i className="fas fa-comments text-xl"></i> Ø§Ù„ØªÙˆØ§ØµÙ„ {totalUnread > 0 && <span className="absolute top-2 right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center animate-pulse">{totalUnread}</span>}</button>
                                    <button onClick={() => setView('certificate')} className="col-span-2 bg-slate-800 text-white p-3 rounded-xl font-bold hover:bg-black transition flex items-center justify-center gap-2"><i className="fas fa-certificate"></i> Ø´Ù‡Ø§Ø¯ØªÙŠ</button>
                                    <button onClick={() => setShowEditProfile(true)} className="col-span-2 bg-white text-slate-600 border border-slate-200 p-2 rounded-xl font-bold hover:bg-slate-50 transition flex items-center justify-center gap-2 text-sm"><i className="fas fa-user-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
                                </div>
                            )}
                            {user.role === 'guest' && (
                                <div className="space-y-3">
                                    <div className="bg-yellow-50 p-4 rounded text-center text-sm text-yellow-800">ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±: Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·</div>
                                    <button onClick={() => setShowContact(true)} className="w-full bg-white border border-blue-200 text-blue-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-50 transition"><i className="fas fa-envelope"></i> Ø±Ø§Ø³Ù„ Ø§Ù„Ù…Ø¹Ù„Ù…</button>
                                    <button onClick={() => setShowStats(true)} className="w-full bg-white border border-teal-200 text-teal-600 py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-teal-50 transition"><i className="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ø§Ù…Ø©</button>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="lg:col-span-2 space-y-4">
                        <div className="flex items-center gap-2 mb-4">
                            <h2 className="text-2xl font-bold text-slate-800">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                        </div>
                        {visibleLessons.length === 0 && <div className="text-center p-8 bg-white rounded-2xl text-slate-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ø­Ø§Ù„ÙŠØ§Ù‹...</div>}
                        {visibleLessons.map(l => {
                            const { status, score } = getLessonStatus(l.id);
                            return (
                                <div key={l.id} className="bg-white p-6 rounded-2xl shadow-sm border hover:shadow-lg transition flex justify-between items-center group">
                                    <div className="w-full">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="font-bold text-lg text-slate-800">{l.title}</h3>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={() => handleLessonClick(l)} className="text-xs bg-primary text-white px-4 py-2.5 rounded-full font-bold hover:bg-blue-700 transition flex-1 md:flex-none justify-center">{status === 'passed' ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³' : 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¯Ø±Ø³'}</button>
                                            <button onClick={() => {setActiveLesson(l); setView('flashcards')}} className="text-xs bg-purple-50 text-purple-600 px-4 py-2.5 rounded-full font-bold border border-purple-100 hover:bg-purple-100 transition flex-1 md:flex-none justify-center">Ø¨Ø·Ø§Ù‚Ø§Øª</button>
                                            {user.role !== 'guest' && (
                                                <div className={`text-xs px-4 py-2.5 rounded-full font-bold border flex items-center justify-center flex-1 md:flex-none ${status==='passed'?'bg-green-100 text-green-700 border-green-200':status==='failed'?'bg-red-100 text-red-700 border-red-200':'bg-blue-50 text-blue-700 border-blue-100'}`}>
                                                    {status === 'passed' ? `âœ… ${score}%` : status === 'failed' ? 'âš ï¸ Ø¥Ø¹Ø§Ø¯Ø©' : 'ğŸ†• Ø¬Ø¯ÙŠØ¯'}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ lessons, addLesson, updateLesson, deleteLesson, toggleVisibility, addBulkLessons, students, addStudent, updateStudentFull, deleteStudent, deleteAllStudents, importStudents, exportStudents, questionBank, resetStudentFull, resetStudentLesson, guestMessages, deleteMessage, adminPassword, setAdminPassword, useStickyState, privateMessages = [], announcements = [], fbSendPrivateMessage, fbMarkMessageRead, fbDeletePrivateMessage, fbDeleteConversation, fbSendAnnouncement, fbToggleAnnouncementPin, fbDeleteAnnouncement, fbUpdateAnnouncement }) => {
            const [tab, setTab] = useState('manage'); 
            const [lesson, setLesson] = useState({ title: '', content: '', questions: [], flashcards: [] });
            const [bulkText, setBulkText] = useState('');
            const [apiKey, setApiKey] = useStickyState('', 'gemini_api_key');
            const [loading, setLoading] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [newStd, setNewStd] = useState({name: '', section: '', nid: ''});
            const [genConfig, setGenConfig] = useState({ mcq: 4, tf: 2, cards: 3 });
            
            const [studentSearch, setStudentSearch] = useState('');
            const [studentSort, setStudentSort] = useState('name-asc');
            const [studentSectionFilter, setStudentSectionFilter] = useState('all');
            const [studentPage, setStudentPage] = useState(1);
            const [editingStudent, setEditingStudent] = useState(null);
            const [viewingStudent, setViewingStudent] = useState(null);
            const [enlargedImg, setEnlargedImg] = useState(null);
            const [chatStudent, setChatStudent] = useState(null);
            const [editingAnnouncement, setEditingAnnouncement] = useState(null);

            const STUDENTS_PER_PAGE = 40;

            const callGemini = async (prompt) => {
                if(!apiKey) throw new Error("Ù…ÙØªØ§Ø­ API Ù…ÙÙ‚ÙˆØ¯");
                const modelsResp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                if(!modelsResp.ok) throw new Error("Ù…ÙØªØ§Ø­ Ø®Ø·Ø£ Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
                const modelsData = await modelsResp.json();
                const validModels = modelsData.models?.filter(m => m.supportedGenerationMethods?.includes("generateContent")) || [];
                if(validModels.length === 0) throw new Error("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¯ÙŠÙ„");
                let selectedModel = validModels.find(m => m.name.includes("gemini-1.5-flash")) || validModels[0];
                const modelName = selectedModel.name.startsWith('models/') ? selectedModel.name.split('/')[1] : selectedModel.name;
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await resp.json();
                if(!data.candidates) throw new Error("ÙØ´Ù„ Ø§Ù„ØªÙˆÙ„ÙŠØ¯");
                return data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            };

            const generateSingle = async () => {
                if(!lesson.content) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰");
                setLoading(true);
                try {
                    const prompt = `Analyze content: "${lesson.content}". Output STRICT JSON: { "questions": Array of ${genConfig.mcq} MCQs and ${genConfig.tf} True/False questions (total ${parseInt(genConfig.mcq)+parseInt(genConfig.tf)} questions). For MCQ keys: type="mcq", text, options[], answer (lowercase), explanation(Arabic). For TF keys: type="tf", text, answer ("true" or "false" string), explanation. "flashcards": Array of ${genConfig.cards} objects {front, back} }`;
                    const json = JSON.parse(await callGemini(prompt));
                    const qs = json.questions.map((q, i) => ({ ...q, id: Date.now()+i, answer: normalizeAnswer(q.answer) }));
                    const fs = json.flashcards.map((f, i) => ({...f, id: Date.now()+i+100}));
                    setLesson(prev => ({...prev, questions: qs, flashcards: fs}));
                    alert("âœ… ØªÙ… Ø§Ù„ØªÙˆÙ„ÙŠØ¯");
                } catch(e) { alert("Error: "+e.message); }
                setLoading(false);
            };

            const generateBulk = async () => {
                if(!bulkText) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ");
                setLoading(true);
                try {
                    const prompt = `Split text into separate logical lessons. Text: "${bulkText}". Output JSON Array: [{ title, content, questions: [Array of ${genConfig.mcq} MCQs and ${genConfig.tf} TF questions. CRITICAL - Each question MUST use these exact keys: "type" (must be "mcq" or "tf"), "text" (question content), "options" (array for mcq), "answer" (correct answer), "explanation" (reasoning in Arabic)], flashcards: [Array of ${genConfig.cards} objects {front, back}] }]. Ensure JSON validity.`;
                    const lessonsArray = JSON.parse(await callGemini(prompt));
                    await addBulkLessons(lessonsArray);
                    setBulkText('');
                    alert(`âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${lessonsArray.length} Ø¯Ø±ÙˆØ³!`);
                    setTab('manage');
                } catch(e) { alert("Error: "+e.message); }
                setLoading(false);
            };

            const handleSaveLesson = () => {
                if(editingId) { updateLesson(lesson); setEditingId(null); alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); } 
                else { addLesson(lesson); alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±"); }
                setLesson({ title: '', content: '', questions: [], flashcards: [] }); setTab('manage');
            };

            const startEdit = (l) => { setLesson(l); setEditingId(l.id); setTab('create'); };
            const updateQ = (idx, field, val) => { const newQs = [...lesson.questions]; newQs[idx][field] = val; setLesson({...lesson, questions: newQs}); };
            const updateOption = (qIdx, optIdx, val) => { const newQs = [...lesson.questions]; newQs[qIdx].options[optIdx] = val; setLesson({...lesson, questions: newQs}); };
            const addQuestion = () => { setLesson({...lesson, questions: [...lesson.questions, {id: Date.now(), type: 'mcq', text: 'Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯', options: ['Ø®ÙŠØ§Ø± 1', 'Ø®ÙŠØ§Ø± 2'], answer: 'Ø®ÙŠØ§Ø± 1', explanation: ''}]}); };
            const removeQuestion = (idx) => { setLesson({...lesson, questions: lesson.questions.filter((_, i) => i !== idx)}); };

            // Get unique sections for filter dropdown
            const uniqueSections = [...new Set(students.map(s => s.section).filter(Boolean))].sort();

            // Filtering and Sorting
            let filteredStudents = students.filter(s => s.name.includes(studentSearch) || s.nid.includes(studentSearch));

            // Apply section filter
            if (studentSectionFilter !== 'all') {
                filteredStudents = filteredStudents.filter(s => s.section === studentSectionFilter);
            }

            filteredStudents.sort((a, b) => {
                if (studentSort === 'name-asc') return a.name.localeCompare(b.name);
                if (studentSort === 'xp-desc') return b.xp - a.xp;
                return 0;
            });

            // Statistics calculations for reports
            const today = new Date().toDateString();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const activeToday = students.filter(s => s.lastLogin === today);
            const activeThisWeek = students.filter(s => {
                if (!s.lastLogin) return false;
                const loginDate = new Date(s.lastLogin);
                return loginDate >= oneWeekAgo;
            });
            const absentStudents = students.filter(s => {
                if (!s.lastLogin) return true;
                const loginDate = new Date(s.lastLogin);
                return loginDate < oneWeekAgo;
            });
            // Students who never logged in OR logged in but didn't complete setup
            const notUpdatedProfile = students.filter(s => !s.hasCompletedSetup);

            // Last 10 students who logged in (sorted by timestamp)
            // Support both new lastLoginTimestamp and old lastLogin for backward compatibility
            const last10LoggedIn = [...students]
                .filter(s => s.lastLoginTimestamp || s.lastLogin)
                .sort((a, b) => {
                    const tsA = a.lastLoginTimestamp || (a.lastLogin ? new Date(a.lastLogin).getTime() : 0);
                    const tsB = b.lastLoginTimestamp || (b.lastLogin ? new Date(b.lastLogin).getTime() : 0);
                    return tsB - tsA;
                })
                .slice(0, 10);

            // Format timestamp helper
            const formatDateTime = (timestamp) => {
                if (!timestamp) return '-';
                const d = new Date(timestamp);
                if (isNaN(d.getTime())) return '-';
                const date = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
                const time = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                return `${date} - ${time}`;
            };
            // Get login time from student (handles both lastLoginTimestamp and lastLogin)
            const getLoginTime = (s) => s.lastLoginTimestamp || (s.lastLogin ? new Date(s.lastLogin).getTime() : null);

            // Section distribution
            const sectionDistribution = {};
            students.forEach(s => {
                const sec = s.section || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                sectionDistribution[sec] = (sectionDistribution[sec] || 0) + 1;
            });

            const totalPages = Math.ceil(filteredStudents.length / STUDENTS_PER_PAGE);
            const displayedStudents = filteredStudents.slice((studentPage - 1) * STUDENTS_PER_PAGE, studentPage * STUDENTS_PER_PAGE);

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => { importStudents(evt.target.result); };
                reader.readAsText(file);
            };

            const saveStudentEdit = () => {
                if(editingStudent) { updateStudentFull(editingStudent.originalNid, editingStudent); setEditingStudent(null); }
            };
            
            const handleResetLesson = (lessonId) => {
                 resetStudentLesson(viewingStudent.nid, lessonId);
                 setViewingStudent(prev => ({
                     ...prev,
                     history: prev.history.filter(h => h.lessonId !== lessonId)
                 }));
            };

            const handleFullReset = async () => {
                const success = await resetStudentFull(viewingStudent.nid);
                if(success) {
                    setViewingStudent(prev => ({...prev, xp: 0, level: 1, history: [], mistakes: [], srsQueue: [], streak: 0, badges: []}));
                }
            };

            const handleAdminImg = async (e) => {
                 const file = e.target.files[0];
                 if(!file) return;
                 try {
                     const compressed = await processImage(file);
                     setEditingStudent({...editingStudent, avatar: compressed});
                 } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©"); }
            };
            
            const exportDataAsCsv = () => {
                if(students.length === 0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù„ØªØµØ¯ÙŠØ±");
                const bom = "\uFEFF"; 
                const headers = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø´Ø¹Ø¨Ø©,Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ,ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±,Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„,Ø§Ù„Ù†Ù‚Ø§Ø· (XP),Ø§Ù„Ù…Ø³ØªÙˆÙ‰\n";
                const rows = students.map(s => `${s.name},${s.section||''},${s.nid},${s.password},${s.mobile||''},${s.xp},${s.level}`).join("\n");
                const csvContent = bom + headers + rows;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", `students_export_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            return (
                <div className="grid lg:grid-cols-4 gap-6 fade-in">
                    <div className="bg-white p-6 rounded-2xl shadow-sm h-fit">
                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} className="w-full p-2 border rounded mb-4 text-xs" placeholder="API Key" />
                        <button onClick={() => setTab('manage')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='manage'?'bg-blue-50 text-blue-600':''}`}><i className="fas fa-tasks"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø±ÙˆØ³</button>
                        <button onClick={() => {setTab('create'); setLesson({title:'',content:'',questions:[],flashcards:[]}); setEditingId(null);}} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='create'?'bg-blue-50 text-blue-600':''}`}><i className="fas fa-plus-circle"></i> Ø¯Ø±Ø³ (Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„)</button>
                        <button onClick={() => setTab('bulk')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='bulk'?'bg-purple-50 text-purple-600':''}`}><i className="fas fa-layer-group"></i> Ø§Ù„Ù…Ù‚Ø³Ù… Ø§Ù„Ø°ÙƒÙŠ</button>
                        <button onClick={() => setTab('students')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='students'?'bg-green-50 text-green-600':''}`}><i className="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                        <button onClick={() => setTab('reports')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='reports'?'bg-teal-50 text-teal-600':''}`}><i className="fas fa-chart-pie"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
                        <button onClick={() => setTab('communication')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='communication'?'bg-indigo-50 text-indigo-600':''}`}><i className="fas fa-comments"></i> Ø§Ù„ØªÙˆØ§ØµÙ„ {privateMessages.filter(m => m.to === 'teacher' && !m.read).length > 0 && <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full mr-1">{privateMessages.filter(m => m.to === 'teacher' && !m.read).length}</span>}</button>
                        <button onClick={() => setTab('messages')} className={`w-full text-right p-3 rounded font-bold mb-1 ${tab==='messages'?'bg-orange-50 text-orange-600':''}`}><i className="fas fa-envelope"></i> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                    </div>

                    <div className="lg:col-span-3 bg-white p-8 rounded-2xl shadow-sm border">
                        {tab === 'manage' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-6">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ({lessons.length})</h2>
                                <div className="space-y-3">
                                    {lessons.map(l => (
                                        <div key={l.id} className={`p-4 border rounded-xl flex justify-between items-center ${!l.isVisible ? 'opacity-60 bg-slate-50' : 'bg-white'}`}>
                                            <div><div className="font-bold text-lg">{l.title}</div><div className="text-xs text-slate-400">{l.questions?.length || 0} Ø³Ø¤Ø§Ù„ â€¢ {l.views} Ù…Ø´Ø§Ù‡Ø¯Ø©</div></div>
                                            <div className="flex gap-2"><button onClick={() => toggleVisibility(l.id)} className="p-2 text-slate-500 hover:bg-slate-100 rounded-lg"><i className={`fas ${l.isVisible ? 'fa-eye' : 'fa-eye-slash'}`}></i></button><button onClick={() => startEdit(l)} className="p-2 text-blue-500 hover:bg-blue-100 rounded-lg"><i className="fas fa-edit"></i></button><button onClick={() => deleteLesson(l.id)} className="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i className="fas fa-trash"></i></button></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {tab === 'create' && (
                            <>
                                <h2 className="text-2xl font-bold mb-4">{editingId ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø±Ø³' : 'Ø¯Ø±Ø³ Ø¬Ø¯ÙŠØ¯'}</h2>
                                <input className="w-full p-4 border rounded-xl mb-4" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" value={lesson.title} onChange={e => setLesson({...lesson, title: e.target.value})} />
                                <textarea className="w-full p-4 bg-slate-50 rounded-xl mb-4 h-48" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰..." value={lesson.content} onChange={e => setLesson({...lesson, content: e.target.value})}></textarea>
                                <div className="bg-slate-50 p-4 rounded-xl border mb-4">
                                    <h4 className="font-bold text-sm mb-3 text-slate-600">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø°ÙƒÙŠ:</h4>
                                    <div className="flex gap-4">
                                        <div><label className="text-xs">Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯</label><input type="number" value={genConfig.mcq} onChange={e=>setGenConfig({...genConfig, mcq: e.target.value})} className="w-full p-2 border rounded" /></div>
                                        <div><label className="text-xs">ØµØ­/Ø®Ø·Ø£</label><input type="number" value={genConfig.tf} onChange={e=>setGenConfig({...genConfig, tf: e.target.value})} className="w-full p-2 border rounded" /></div>
                                        <div><label className="text-xs">Ø¨Ø·Ø§Ù‚Ø§Øª</label><input type="number" value={genConfig.cards} onChange={e=>setGenConfig({...genConfig, cards: e.target.value})} className="w-full p-2 border rounded" /></div>
                                    </div>
                                </div>
                                <div className="flex gap-3 mb-8">
                                    <button onClick={generateSingle} disabled={loading} className="bg-purple-600 text-white px-6 py-3 rounded-xl font-bold flex-1">{loading ? '...' : 'ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©'}</button>
                                    <button onClick={handleSaveLesson} className="bg-primary text-white px-6 py-3 rounded-xl font-bold flex-1">{editingId ? 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª' : 'Ù†Ø´Ø± Ø§Ù„Ø¯Ø±Ø³'}</button>
                                </div>
                                {lesson.questions.length > 0 && (
                                    <div className="border-t pt-6">
                                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ({lesson.questions.length})</h3><button onClick={addQuestion} className="text-sm bg-green-50 text-green-600 px-3 py-1 rounded-lg border border-green-200">+ Ø³Ø¤Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button></div>
                                        <div className="space-y-4">
                                            {lesson.questions.map((q, i) => (
                                                <div key={i} className="p-4 border rounded-xl bg-slate-50 relative group">
                                                    <button onClick={() => removeQuestion(i)} className="absolute left-4 top-4 text-red-400 hover:text-red-600"><i className="fas fa-times"></i></button>
                                                    <div className="mb-3 w-11/12"><label className="block text-xs font-bold text-slate-400 mb-1">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label><input className="w-full p-2 border rounded bg-white" value={q.text} onChange={e => updateQ(i, 'text', e.target.value)} /></div>
                                                    {q.type === 'mcq' && ( <div className="mb-3 grid grid-cols-2 gap-2">{q.options.map((opt, optIdx) => (<input key={optIdx} className="p-2 border rounded bg-white text-sm" value={opt} onChange={e => updateOption(i, optIdx, e.target.value)} placeholder={`Ø®ÙŠØ§Ø± ${optIdx+1}`} />))}</div> )}
                                                    <div className="grid grid-cols-2 gap-4">
                                                        <div><label className="block text-xs font-bold text-slate-400 mb-1">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>{q.type === 'tf' ? (<select className="w-full p-2 border rounded bg-white" value={q.answer} onChange={e => updateQ(i, 'answer', e.target.value)}><option value="true">ØµØ­</option><option value="false">Ø®Ø·Ø£</option></select>) : (<select className="w-full p-2 border rounded bg-white" value={q.answer} onChange={e => updateQ(i, 'answer', e.target.value)}>{q.options.map(o => <option key={o} value={o}>{o}</option>)}</select>)}</div>
                                                        <div><label className="block text-xs font-bold text-slate-400 mb-1">Ø§Ù„ØªØ¨Ø±ÙŠØ± (Ø§Ù„Ø´Ø±Ø­)</label><input className="w-full p-2 border rounded bg-white" value={q.explanation} onChange={e => updateQ(i, 'explanation', e.target.value)} /></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {tab === 'bulk' && (
                            <>
                                <h2 className="text-2xl font-bold mb-2 text-purple-700">Ø§Ù„Ù…Ù‚Ø³Ù… Ø§Ù„Ø°ÙƒÙŠ</h2>
                                <div className="bg-purple-50 p-4 rounded-xl border border-purple-100 mb-4">
                                    <h4 className="font-bold text-sm mb-3 text-purple-800">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ÙƒÙ„ Ø¯Ø±Ø³ Ù†Ø§ØªØ¬:</h4>
                                    <div className="flex gap-4">
                                        <div><label className="text-xs font-bold">Ø¹Ø¯Ø¯ MCQ</label><input type="number" value={genConfig.mcq} onChange={e=>setGenConfig({...genConfig, mcq: e.target.value})} className="w-full p-2 bg-white border rounded" /></div>
                                        <div><label className="text-xs font-bold">Ø¹Ø¯Ø¯ ØµØ­/Ø®Ø·Ø£</label><input type="number" value={genConfig.tf} onChange={e=>setGenConfig({...genConfig, tf: e.target.value})} className="w-full p-2 bg-white border rounded" /></div>
                                        <div><label className="text-xs font-bold">Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª</label><input type="number" value={genConfig.cards} onChange={e=>setGenConfig({...genConfig, cards: e.target.value})} className="w-full p-2 bg-white border rounded" /></div>
                                    </div>
                                </div>
                                <textarea className="w-full p-4 bg-slate-50 rounded-xl mb-4 h-64 border" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..." value={bulkText} onChange={e => setBulkText(e.target.value)}></textarea>
                                <button onClick={generateBulk} disabled={loading} className="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">{loading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„...' : 'ØªÙ‚Ø³ÙŠÙ… ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙ„'}</button>
                            </>
                        )}
                        
                        {tab === 'students' && (
                             <div>
                                <h2 className="text-2xl font-bold mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ ({students.length})</h2>
                                
                                <div className="flex flex-wrap gap-2 mb-6">
                                     <button onClick={exportDataAsCsv} className="flex-1 bg-green-600 text-white p-3 rounded-xl font-bold hover:bg-green-700 shadow flex items-center justify-center gap-2"><i className="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± CSV</button>
                                     <button onClick={deleteAllStudents} className="flex-1 bg-red-600 text-white p-3 rounded-xl font-bold hover:bg-red-700 shadow flex items-center justify-center gap-2"><i className="fas fa-trash-alt"></i> Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
                                </div>

                                <div className="grid md:grid-cols-2 gap-6 mb-8">
                                    <div className="bg-slate-50 p-4 rounded-xl">
                                        <h3 className="font-bold mb-2">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h3>
                                        <input className="w-full p-2 mb-2 rounded border" placeholder="Ø§Ù„Ø§Ø³Ù…" value={newStd.name} onChange={e => setNewStd({...newStd, name: e.target.value})} />
                                        <input className="w-full p-2 mb-2 rounded border" placeholder="Ø§Ù„Ø´Ø¹Ø¨Ø©" value={newStd.section} onChange={e => setNewStd({...newStd, section: e.target.value})} />
                                        <input className="w-full p-2 mb-2 rounded border" placeholder="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ" value={newStd.nid} onChange={e => setNewStd({...newStd, nid: e.target.value})} />
                                        <button onClick={() => {if(!newStd.name || !newStd.nid) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); addStudent(newStd); setNewStd({name: '', section: '', nid: ''});}} className="w-full bg-blue-600 text-white p-2 rounded font-bold">Ø¥Ø¶Ø§ÙØ©</button>
                                    </div>
                                    <div className="bg-blue-50 p-4 rounded-xl">
                                        <h3 className="font-bold mb-2">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel (CSV)</h3>
                                        <div className="flex flex-col gap-2">
                                            <input type="file" accept=".csv,.txt" onChange={handleFileImport} className="w-full text-sm mb-1 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200"/>
                                            <p className="text-xs text-slate-500">ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ù„ØµÙ‚ Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø¶ØºØ·.</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                    <input className="p-2 border rounded-lg w-full md:w-64" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø³Ø¬Ù„..." value={studentSearch} onChange={e => {setStudentSearch(e.target.value); setStudentPage(1);}} />
                                    <div className="flex gap-2 w-full md:w-auto flex-wrap">
                                        <select value={studentSort} onChange={(e) => setStudentSort(e.target.value)} className="p-2 border rounded-lg bg-white flex-grow md:flex-grow-0">
                                            <option value="name-asc">Ø§Ù„Ø£Ø³Ù… (Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹)</option>
                                            <option value="xp-desc">Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
                                        </select>
                                        <select value={studentSectionFilter} onChange={(e) => {setStudentSectionFilter(e.target.value); setStudentPage(1);}} className="p-2 border rounded-lg bg-white flex-grow md:flex-grow-0">
                                            <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</option>
                                            {uniqueSections.map(sec => (
                                                <option key={sec} value={sec}>{sec}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setStudentPage(Math.max(1, studentPage-1))} disabled={studentPage===1} className="px-3 py-1 bg-slate-200 rounded disabled:opacity-50"><i className="fas fa-chevron-right"></i></button>
                                        <span className="font-bold px-2">{studentPage} / {totalPages || 1}</span>
                                        <button onClick={() => setStudentPage(Math.min(totalPages, studentPage+1))} disabled={studentPage===totalPages || totalPages===0} className="px-3 py-1 bg-slate-200 rounded disabled:opacity-50"><i className="fas fa-chevron-left"></i></button>
                                    </div>
                                </div>

                                <div className="hidden md:block overflow-x-auto border rounded-xl bg-white">
                                    <table className="w-full text-right text-sm">
                                        <thead className="bg-slate-100 text-slate-600"><tr><th className="p-4">Ø§Ù„Ø§Ø³Ù…</th><th className="p-4">Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th className="p-4">Ø§Ù„Ø³Ø¬Ù„</th><th className="p-4">XP</th><th className="p-4">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                                        <tbody className="divide-y">
                                            {displayedStudents.map((s, i) => (
                                                <tr key={i} className="hover:bg-slate-50 transition">
                                                    <td className="p-4 font-bold text-slate-800 cursor-pointer hover:text-primary underline" onClick={()=>setViewingStudent(s)}>{s.name}</td>
                                                    <td className="p-4 text-slate-600">{s.section || '-'}</td>
                                                    <td className="p-4 font-mono text-slate-500">{s.nid}</td>
                                                    <td className="p-4 font-bold text-gold">{s.xp}</td>
                                                    <td className="p-4 flex gap-2">
                                                        <button onClick={()=>setViewingStudent(s)} className="text-purple-600 hover:bg-purple-100 p-2 rounded transition" title="Ø§Ù„ØªÙØ§ØµÙŠÙ„"><i className="fas fa-chart-bar"></i></button>
                                                        <button onClick={()=>setEditingStudent({...s, originalNid: s.nid})} className="text-blue-500 hover:bg-blue-100 p-2 rounded transition" title="ØªØ¹Ø¯ÙŠÙ„"><i className="fas fa-edit"></i></button>
                                                        <button onClick={()=>deleteStudent(s.nid)} className="text-red-500 hover:bg-red-100 p-2 rounded transition" title="Ø­Ø°Ù"><i className="fas fa-trash"></i></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                <div className="md:hidden grid grid-cols-1 gap-4">
                                    {displayedStudents.map((s, i) => (
                                        <div key={i} className="bg-white border rounded-xl p-5 shadow-sm">
                                            <div className="flex justify-between items-start mb-3">
                                                <div onClick={()=>setViewingStudent(s)} className="cursor-pointer"><h3 className="font-bold text-lg text-slate-800 underline decoration-dotted">{s.name}</h3><span className="text-xs text-slate-400 font-mono">#{s.nid}</span></div>
                                                <div className="bg-yellow-50 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">{s.xp} XP <i className="fas fa-star text-yellow-500 ml-1"></i></div>
                                            </div>
                                            <div className="flex items-center gap-2 mb-4 text-sm text-slate-600 bg-slate-50 p-2 rounded-lg"><i className="fas fa-users text-slate-400"></i><span>Ø§Ù„Ø´Ø¹Ø¨Ø©: <strong>{s.section || 'Ø¹Ø§Ù…'}</strong></span></div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <button onClick={()=>setViewingStudent(s)} className="flex items-center justify-center gap-2 bg-purple-50 text-purple-600 py-2.5 rounded-lg font-bold hover:bg-purple-100 transition border border-purple-100 text-sm"><i className="fas fa-info-circle"></i></button>
                                                <button onClick={()=>setEditingStudent({...s, originalNid: s.nid})} className="flex items-center justify-center gap-2 bg-blue-50 text-blue-600 py-2.5 rounded-lg font-bold hover:bg-blue-100 transition border border-blue-100 text-sm"><i className="fas fa-edit"></i></button>
                                                <button onClick={()=>deleteStudent(s.nid)} className="flex items-center justify-center gap-2 bg-red-50 text-red-600 py-2.5 rounded-lg font-bold hover:bg-red-100 transition border border-red-100 text-sm"><i className="fas fa-trash"></i></button>
                                            </div>
                                        </div>
                                    ))}
                                    {displayedStudents.length === 0 && <div className="text-center text-slate-400 py-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø·Ø§Ø¨Ù‚ÙŠÙ† Ù„Ù„Ø¨Ø­Ø«</div>}
                                </div>
                            </div>
                        )}

                        {tab === 'reports' && (
                            <div className="overflow-x-hidden">
                                <h2 className="text-xl md:text-2xl font-bold mb-6"><i className="fas fa-chart-pie text-teal-600 ml-2"></i>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>

                                {/* Quick Stats Cards */}
                                <div className="grid grid-cols-2 gap-3 md:gap-4 mb-6">
                                    <div className="bg-green-50 border border-green-200 p-3 md:p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-green-600">{activeToday.length}</div>
                                        <div className="text-xs text-green-700 font-bold">Ù†Ø´Ø·ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</div>
                                    </div>
                                    <div className="bg-blue-50 border border-blue-200 p-3 md:p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-blue-600">{activeThisWeek.length}</div>
                                        <div className="text-xs text-blue-700 font-bold">Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
                                    </div>
                                    <div className="bg-red-50 border border-red-200 p-3 md:p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-red-600">{absentStudents.length}</div>
                                        <div className="text-xs text-red-700 font-bold">ØºØ§Ø¦Ø¨ÙˆÙ† (Ø£Ø³Ø¨ÙˆØ¹+)</div>
                                    </div>
                                    <div className="bg-orange-50 border border-orange-200 p-3 md:p-4 rounded-xl text-center">
                                        <div className="text-2xl md:text-3xl font-bold text-orange-600">{notUpdatedProfile.length}</div>
                                        <div className="text-xs text-orange-700 font-bold">Ù„Ù… ÙŠØ­Ø¯Ù‘Ø«ÙˆØ§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…</div>
                                    </div>
                                </div>

                                {/* Section Distribution */}
                                <div className="bg-white border rounded-xl p-4 md:p-6 mb-6">
                                    <h3 className="font-bold text-base md:text-lg mb-4 border-b pb-2"><i className="fas fa-users text-teal-500 ml-2"></i>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3">
                                        {Object.entries(sectionDistribution).map(([sec, count]) => (
                                            <div key={sec} className="bg-slate-50 p-2 md:p-3 rounded-lg text-center border">
                                                <div className="text-xl md:text-2xl font-bold text-slate-700">{count}</div>
                                                <div className="text-xs md:text-sm text-slate-500 font-bold truncate">{sec}</div>
                                            </div>
                                        ))}
                                    </div>
                                    {Object.keys(sectionDistribution).length === 0 && <p className="text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>}
                                </div>

                                {/* Detailed Reports */}
                                <div className="grid md:grid-cols-2 gap-4 md:gap-6 mb-6">
                                    {/* Active Today */}
                                    <div className="bg-white border rounded-xl p-4 md:p-6">
                                        <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4 border-b pb-2 text-green-700"><i className="fas fa-check-circle ml-2"></i>Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„ÙŠÙˆÙ… ({activeToday.length})</h3>
                                        <div className="max-h-48 md:max-h-64 overflow-y-auto space-y-2">
                                            {activeToday.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</p> : activeToday.map(s => (
                                                <div key={s.nid} className="flex justify-between items-center p-2 bg-green-50 rounded-lg border border-green-100">
                                                    <span className="font-bold text-xs md:text-sm truncate flex-1">{s.name}</span>
                                                    <span className="text-xs text-slate-500 mr-2">{s.section || '-'}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Active This Week */}
                                    <div className="bg-white border rounded-xl p-4 md:p-6">
                                        <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4 border-b pb-2 text-blue-700"><i className="fas fa-calendar-week ml-2"></i>Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ({activeThisWeek.length})</h3>
                                        <div className="max-h-48 md:max-h-64 overflow-y-auto space-y-2">
                                            {activeThisWeek.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù†Ø´Ø·ÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</p> : activeThisWeek.map(s => (
                                                <div key={s.nid} className="p-2 bg-blue-50 rounded-lg border border-blue-100">
                                                    <div className="flex justify-between items-center">
                                                        <span className="font-bold text-xs md:text-sm truncate flex-1">{s.name}</span>
                                                        <span className="text-xs text-slate-500 font-mono mr-2 hidden md:inline">{formatDateTime(getLoginTime(s))}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1 md:hidden">{formatDateTime(getLoginTime(s))}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Absent Students */}
                                    <div className="bg-white border rounded-xl p-4 md:p-6">
                                        <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4 border-b pb-2 text-red-700"><i className="fas fa-user-clock ml-2"></i>Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ† ({absentStudents.length})</h3>
                                        <div className="max-h-48 md:max-h-64 overflow-y-auto space-y-2">
                                            {absentStudents.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ØºØ§Ø¦Ø¨ÙˆÙ†</p> : absentStudents.map(s => (
                                                <div key={s.nid} className="p-2 bg-red-50 rounded-lg border border-red-100">
                                                    <div className="flex justify-between items-center">
                                                        <span className="font-bold text-xs md:text-sm truncate flex-1">{s.name}</span>
                                                        <span className="text-xs text-slate-500 mr-2 hidden md:inline">{getLoginTime(s) ? formatDateTime(getLoginTime(s)) : 'Ù„Ù… ÙŠØ³Ø¬Ù„'}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-500 mt-1 md:hidden">{getLoginTime(s) ? formatDateTime(getLoginTime(s)) : 'Ù„Ù… ÙŠØ³Ø¬Ù„'}</div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Not Updated Profile */}
                                    <div className="bg-white border rounded-xl p-4 md:p-6">
                                        <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4 border-b pb-2 text-orange-700"><i className="fas fa-user-edit ml-2"></i>Ù„Ù… ÙŠØ­Ø¯Ù‘Ø«ÙˆØ§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù… ({notUpdatedProfile.length})</h3>
                                        <div className="max-h-48 md:max-h-64 overflow-y-auto space-y-2">
                                            {notUpdatedProfile.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø¯Ù‘Ø«ÙˆØ§ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ù…</p> : notUpdatedProfile.map(s => (
                                                <div key={s.nid} className="flex justify-between items-center p-2 bg-orange-50 rounded-lg border border-orange-100">
                                                    <span className="font-bold text-xs md:text-sm truncate flex-1">{s.name}</span>
                                                    <span className="text-xs text-slate-500 mr-2">{s.lastLogin ? 'Ø³Ø¬Ù‘Ù„' : 'Ù„Ù… ÙŠØ³Ø¬Ù„'}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Last 10 Logged In */}
                                <div className="bg-white border rounded-xl p-3 md:p-6 mb-6">
                                    <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4 border-b pb-2 text-indigo-700"><i className="fas fa-clock ml-2"></i>Ø¢Ø®Ø± 10 Ø·Ù„Ø§Ø¨ Ø¯Ø®Ù„ÙˆØ§</h3>
                                    <div className="space-y-2 md:hidden">
                                        {last10LoggedIn.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„</p> : last10LoggedIn.map((s, idx) => (
                                            <div key={s.nid} className="flex items-center gap-2 p-2 bg-indigo-50 rounded-lg border border-indigo-100">
                                                <span className="font-bold text-indigo-600 w-6">{idx + 1}</span>
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-bold text-slate-800 text-xs truncate">{s.name}</div>
                                                    <div className="text-xs text-slate-500">{formatDateTime(getLoginTime(s))}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="overflow-x-auto hidden md:block">
                                        {last10LoggedIn.length === 0 ? <p className="text-slate-400 text-sm text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¯Ø®ÙˆÙ„</p> : (
                                            <table className="w-full text-right text-sm">
                                                <thead className="bg-indigo-50 text-indigo-700">
                                                    <tr>
                                                        <th className="p-3 rounded-tr-lg">#</th>
                                                        <th className="p-3">Ø§Ù„Ø§Ø³Ù…</th>
                                                        <th className="p-3">Ø§Ù„Ø´Ø¹Ø¨Ø©</th>
                                                        <th className="p-3 rounded-tl-lg">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {last10LoggedIn.map((s, idx) => (
                                                        <tr key={s.nid} className="hover:bg-indigo-50 transition">
                                                            <td className="p-3 font-bold text-indigo-600">{idx + 1}</td>
                                                            <td className="p-3 font-bold text-slate-800">{s.name}</td>
                                                            <td className="p-3 text-slate-600">{s.section || '-'}</td>
                                                            <td className="p-3 text-slate-500 font-mono text-xs">{formatDateTime(getLoginTime(s))}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                </div>

                                {/* Export Section */}
                                <div className="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 md:p-6 rounded-xl">
                                    <h3 className="font-bold text-sm md:text-lg mb-3 md:mb-4"><i className="fas fa-file-export ml-2"></i>Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h3>
                                    <p className="text-slate-300 text-xs md:text-sm mb-3 md:mb-4">ØªØµØ¯ÙŠØ± ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ£Ø¯Ø§Ø¦Ù‡Ù… Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡ Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</p>
                                    <div className="grid grid-cols-2 md:flex md:flex-wrap gap-2 md:gap-3">
                                        <button onClick={() => {
                                            const bom = "\uFEFF";
                                            const headers = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø´Ø¹Ø¨Ø©,Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ,Ø§Ù„Ù†Ù‚Ø§Ø·,Ø§Ù„Ù…Ø³ØªÙˆÙ‰,Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„,Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª\n";
                                            const rows = students.map(s =>
                                                `${s.name},${s.section||''},${s.nid},${s.xp},${s.level},${formatDateTime(s.lastLoginTimestamp)},${s.hasCompletedSetup?'Ù…Ø­Ø¯Ù‘Ø«Ø©':'ØºÙŠØ± Ù…Ø­Ø¯Ù‘Ø«Ø©'}`
                                            ).join("\n");
                                            const blob = new Blob([bom + headers + rows], { type: 'text/csv;charset=utf-8;' });
                                            const link = document.createElement("a");
                                            link.href = URL.createObjectURL(blob);
                                            link.download = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø·Ù„Ø§Ø¨_${new Date().toLocaleDateString('ar-SA')}.csv`;
                                            link.click();
                                        }} className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold flex items-center justify-center gap-1 md:gap-2 transition text-xs md:text-base">
                                            <i className="fas fa-file-csv"></i> <span className="hidden sm:inline">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</span><span className="sm:hidden">Ø´Ø§Ù…Ù„</span>
                                        </button>
                                        <button onClick={() => {
                                            const bom = "\uFEFF";
                                            const headers = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø´Ø¹Ø¨Ø©,Ø§Ù„Ø³Ø¬Ù„,ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„\n";
                                            const rows = activeToday.map(s => `${s.name},${s.section||''},${s.nid},${formatDateTime(s.lastLoginTimestamp)}`).join("\n");
                                            const blob = new Blob([bom + headers + rows], { type: 'text/csv;charset=utf-8;' });
                                            const link = document.createElement("a");
                                            link.href = URL.createObjectURL(blob);
                                            link.download = `Ø§Ù„Ù†Ø´Ø·ÙˆÙ†_Ø§Ù„ÙŠÙˆÙ…_${new Date().toLocaleDateString('ar-SA')}.csv`;
                                            link.click();
                                        }} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold flex items-center justify-center gap-1 md:gap-2 transition text-xs md:text-base">
                                            <i className="fas fa-calendar-day"></i> <span className="hidden sm:inline">Ø§Ù„Ù†Ø´Ø·ÙˆÙ† Ø§Ù„ÙŠÙˆÙ…</span><span className="sm:hidden">Ù†Ø´Ø·ÙˆÙ†</span>
                                        </button>
                                        <button onClick={() => {
                                            const bom = "\uFEFF";
                                            const headers = "Ø§Ù„Ø§Ø³Ù…,Ø§Ù„Ø´Ø¹Ø¨Ø©,Ø§Ù„Ø³Ø¬Ù„,Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„\n";
                                            const rows = absentStudents.map(s => `${s.name},${s.section||''},${s.nid},${s.lastLoginTimestamp ? formatDateTime(s.lastLoginTimestamp) : 'Ù„Ù… ÙŠØ³Ø¬Ù„'}`).join("\n");
                                            const blob = new Blob([bom + headers + rows], { type: 'text/csv;charset=utf-8;' });
                                            const link = document.createElement("a");
                                            link.href = URL.createObjectURL(blob);
                                            link.download = `Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†_${new Date().toLocaleDateString('ar-SA')}.csv`;
                                            link.click();
                                        }} className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold flex items-center justify-center gap-1 md:gap-2 transition text-xs md:text-base">
                                            <i className="fas fa-user-times"></i> <span>Ø§Ù„ØºØ§Ø¦Ø¨ÙˆÙ†</span>
                                        </button>
                                        <button onClick={() => {
                                            const bom = "\uFEFF";
                                            let content = "ØªÙ‚Ø±ÙŠØ± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨\n\n";
                                            Object.entries(sectionDistribution).forEach(([sec, count]) => {
                                                content += `${sec}: ${count} Ø·Ø§Ù„Ø¨\n`;
                                            });
                                            content += `\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${students.length} Ø·Ø§Ù„Ø¨`;
                                            const blob = new Blob([bom + content], { type: 'text/plain;charset=utf-8;' });
                                            const link = document.createElement("a");
                                            link.href = URL.createObjectURL(blob);
                                            link.download = `ØªÙˆØ²ÙŠØ¹_Ø§Ù„Ø´Ø¹Ø¨_${new Date().toLocaleDateString('ar-SA')}.txt`;
                                            link.click();
                                        }} className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 md:px-6 md:py-3 rounded-lg font-bold flex items-center justify-center gap-1 md:gap-2 transition text-xs md:text-base">
                                            <i className="fas fa-users"></i> <span className="hidden sm:inline">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø´Ø¹Ø¨</span><span className="sm:hidden">Ø§Ù„Ø´Ø¹Ø¨</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'communication' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-6"><i className="fas fa-comments text-indigo-600 ml-2"></i>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙˆØ§ØµÙ„</h2>

                                {/* Announcements Section */}
                                <div className="bg-white border rounded-xl p-6 mb-6">
                                    <h3 className="font-bold text-lg mb-4 border-b pb-2 text-purple-700"><i className="fas fa-bullhorn ml-2"></i>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù†</h3>
                                    <div className="space-y-4">
                                        <textarea id="announcementText" className="w-full p-4 border rounded-xl h-24 resize-none" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù‡Ù†Ø§..."></textarea>
                                        <div className="flex flex-wrap gap-4 items-center">
                                            <div className="flex items-center gap-2">
                                                <label className="text-sm font-bold">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰:</label>
                                                <select id="announcementTarget" className="p-2 border rounded-lg bg-white">
                                                    <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</option>
                                                    {uniqueSections.map(sec => <option key={sec} value={sec}>Ø´Ø¹Ø¨Ø© {sec}</option>)}
                                                </select>
                                            </div>
                                            <label className="flex items-center gap-2 text-sm">
                                                <input type="checkbox" id="announcementPinned" className="w-4 h-4" />
                                                <span>ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</span>
                                            </label>
                                            <button onClick={() => {
                                                const text = document.getElementById('announcementText').value;
                                                const target = document.getElementById('announcementTarget').value;
                                                const pinned = document.getElementById('announcementPinned').checked;
                                                if (!text.trim()) return;
                                                fbSendAnnouncement(text, target, pinned);
                                                document.getElementById('announcementText').value = '';
                                                document.getElementById('announcementPinned').checked = false;
                                            }} className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold transition">
                                                <i className="fas fa-paper-plane ml-1"></i> Ø¥Ø±Ø³Ø§Ù„
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* Edit Announcement Modal */}
                                {editingAnnouncement && (
                                    <div className="modal-overlay" onClick={e => { if(e.target.className.includes('modal-overlay')) setEditingAnnouncement(null); }}>
                                        <div className="bg-white p-6 rounded-2xl w-full max-w-md m-4 shadow-2xl">
                                            <h3 className="font-bold text-xl mb-4 border-b pb-2 text-purple-700"><i className="fas fa-edit ml-2"></i>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</h3>
                                            <textarea id="editAnnText" defaultValue={editingAnnouncement.text} className="w-full p-4 border rounded-xl h-32 resize-none mb-4" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..."></textarea>
                                            <div className="flex gap-2">
                                                <button onClick={() => { const newText = document.getElementById('editAnnText').value; if(newText.trim()) { fbUpdateAnnouncement(editingAnnouncement.id, newText); setEditingAnnouncement(null); } }} className="flex-1 bg-purple-600 text-white py-2 rounded-lg font-bold">Ø­ÙØ¸</button>
                                                <button onClick={() => setEditingAnnouncement(null)} className="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* Existing Announcements */}
                                <div className="bg-white border rounded-xl p-6 mb-6">
                                    <h3 className="font-bold text-lg mb-4 border-b pb-2 text-purple-700"><i className="fas fa-list ml-2"></i>Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ({announcements.length})</h3>
                                    <div className="space-y-3 max-h-64 overflow-y-auto">
                                        {announcements.length === 0 ? <p className="text-slate-400 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</p> :
                                            [...announcements].sort((a, b) => (b.isPinned ? 1 : 0) - (a.isPinned ? 1 : 0) || b.timestamp - a.timestamp).map(ann => (
                                                <div key={ann.id} className={`p-4 rounded-xl border ${ann.isPinned ? 'bg-yellow-50 border-yellow-300' : 'bg-slate-50'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-2 flex-wrap">
                                                            {ann.isPinned && <i className="fas fa-thumbtack text-yellow-600"></i>}
                                                            <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">{ann.targetSection === 'all' ? 'Ø§Ù„Ø¬Ù…ÙŠØ¹' : `Ø´Ø¹Ø¨Ø© ${ann.targetSection}`}</span>
                                                            <span className="text-xs text-slate-400">{formatDateTime(ann.timestamp)}</span>
                                                        </div>
                                                        <div className="flex gap-1">
                                                            <button onClick={() => setEditingAnnouncement(ann)} className="p-1 text-blue-400 hover:text-blue-600" title="ØªØ¹Ø¯ÙŠÙ„"><i className="fas fa-edit"></i></button>
                                                            <button onClick={() => fbToggleAnnouncementPin(ann.id)} className={`p-1 rounded ${ann.isPinned ? 'text-yellow-600' : 'text-slate-400 hover:text-yellow-600'}`} title="ØªØ«Ø¨ÙŠØª"><i className="fas fa-thumbtack"></i></button>
                                                            <button onClick={() => fbDeleteAnnouncement(ann.id)} className="p-1 text-red-400 hover:text-red-600" title="Ø­Ø°Ù"><i className="fas fa-trash"></i></button>
                                                        </div>
                                                    </div>
                                                    <p className="text-slate-700 whitespace-pre-wrap">{ann.text}</p>
                                                    <div className="text-xs text-slate-400 mt-2">Ù‚Ø±Ø£Ù‡ {ann.readBy?.length || 0} Ù…Ù† {students.length} Ø·Ø§Ù„Ø¨</div>
                                                </div>
                                            ))
                                        }
                                    </div>
                                </div>

                                {/* Private Messages */}
                                <div className="grid lg:grid-cols-3 gap-6">
                                    {/* Conversations List */}
                                    <div className="bg-white border rounded-xl p-6">
                                        <h3 className="font-bold text-lg mb-4 border-b pb-2 text-indigo-700"><i className="fas fa-inbox ml-2"></i>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3>
                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                            {(() => {
                                                const conversations = {};
                                                privateMessages.forEach(m => {
                                                    const otherParty = m.from === 'teacher' ? m.to : m.from;
                                                    if (!conversations[otherParty]) conversations[otherParty] = { messages: [], unread: 0, lastTime: 0, name: '' };
                                                    conversations[otherParty].messages.push(m);
                                                    if (m.to === 'teacher' && !m.read) conversations[otherParty].unread++;
                                                    if (m.timestamp > conversations[otherParty].lastTime) {
                                                        conversations[otherParty].lastTime = m.timestamp;
                                                        conversations[otherParty].name = m.from === 'teacher' ? (students.find(s => s.nid === m.to)?.name || m.to) : m.fromName;
                                                    }
                                                });
                                                const sorted = Object.entries(conversations).sort((a, b) => b[1].lastTime - a[1].lastTime);
                                                return sorted.length === 0 ? <p className="text-slate-400 text-center py-4 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</p> :
                                                    sorted.map(([nid, conv]) => (
                                                        <button key={nid} onClick={() => {
                                                            setChatStudent(students.find(s => s.nid === nid) || { nid, name: conv.name });
                                                            conv.messages.filter(m => m.to === 'teacher' && !m.read).forEach(m => fbMarkMessageRead(m.id));
                                                        }} className={`w-full text-right p-3 rounded-lg border transition flex justify-between items-center ${chatStudent?.nid === nid ? 'bg-indigo-50 border-indigo-300' : 'hover:bg-slate-50'}`}>
                                                            <div>
                                                                <div className="font-bold text-sm">{conv.name}</div>
                                                                <div className="text-xs text-slate-400">{formatDateTime(conv.lastTime)}</div>
                                                            </div>
                                                            {conv.unread > 0 && <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full">{conv.unread}</span>}
                                                        </button>
                                                    ));
                                            })()}
                                        </div>
                                    </div>

                                    {/* Chat Window */}
                                    <div className="lg:col-span-2 bg-white border rounded-xl p-6">
                                        {chatStudent ? (
                                            <>
                                                <div className="flex justify-between items-center mb-4 border-b pb-3">
                                                    <div>
                                                        <h3 className="font-bold text-lg text-indigo-700"><i className="fas fa-user ml-2"></i>{chatStudent.name}</h3>
                                                        <span className="text-xs text-slate-400">Ø´Ø¹Ø¨Ø© {chatStudent.section || '-'}</span>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => setChatStudent(null)} className="text-slate-400 hover:text-slate-600 text-sm"><i className="fas fa-times ml-1"></i>Ø¥ØºÙ„Ø§Ù‚</button>
                                                        <button onClick={() => { fbDeleteConversation(chatStudent.nid); setChatStudent(null); }} className="text-red-400 hover:text-red-600 text-sm"><i className="fas fa-trash ml-1"></i>Ø­Ø°Ù</button>
                                                    </div>
                                                </div>
                                                <div className="h-64 overflow-y-auto mb-4 space-y-3 p-2 bg-slate-50 rounded-xl">
                                                    {privateMessages
                                                        .filter(m => m.from === chatStudent.nid || m.to === chatStudent.nid)
                                                        .sort((a, b) => a.timestamp - b.timestamp)
                                                        .map(m => (
                                                            <div key={m.id} className={`flex ${m.from === 'teacher' ? 'justify-start' : 'justify-end'}`}>
                                                                <div className={`max-w-xs p-3 rounded-xl ${m.from === 'teacher' ? 'bg-indigo-100 text-indigo-900' : 'bg-white border'}`}>
                                                                    <p className="text-sm whitespace-pre-wrap">{m.text}</p>
                                                                    <div className="flex justify-between items-center mt-1">
                                                                        <span className="text-xs text-slate-400">{formatDateTime(m.timestamp)}</span>
                                                                        <button onClick={() => fbDeletePrivateMessage(m.id)} className="text-red-300 hover:text-red-500 text-xs mr-2"><i className="fas fa-trash"></i></button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))
                                                    }
                                                    {privateMessages.filter(m => m.from === chatStudent.nid || m.to === chatStudent.nid).length === 0 && <p className="text-slate-400 text-center py-8 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø³Ø§Ø¨Ù‚Ø© - Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>}
                                                </div>
                                                <div className="flex gap-2">
                                                    <input type="text" id="teacherReplyInput" className="flex-1 p-3 border rounded-xl" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onKeyPress={e => { if(e.key === 'Enter') document.getElementById('teacherSendBtn').click(); }} />
                                                    <button id="teacherSendBtn" onClick={() => {
                                                        const input = document.getElementById('teacherReplyInput');
                                                        if (!input.value.trim()) return;
                                                        fbSendPrivateMessage('teacher', chatStudent.nid, input.value, 'Ø§Ù„Ù…Ø¹Ù„Ù…');
                                                        input.value = '';
                                                    }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-xl font-bold"><i className="fas fa-paper-plane"></i></button>
                                                </div>
                                            </>
                                        ) : (
                                            <div className="h-full flex flex-col">
                                                <div className="mb-4">
                                                    <label className="text-sm font-bold text-slate-600 mb-2 block">Ù…Ø±Ø§Ø³Ù„Ø© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:</label>
                                                    <input type="text" id="studentSearchInput" className="w-full p-3 border rounded-xl bg-white mb-2" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." onChange={e => {
                                                        const search = e.target.value.toLowerCase();
                                                        const options = document.querySelectorAll('#newChatStudent option');
                                                        options.forEach(opt => { if(opt.value) opt.style.display = opt.textContent.toLowerCase().includes(search) ? '' : 'none'; });
                                                    }} />
                                                    <select id="newChatStudent" className="w-full p-3 border rounded-xl bg-white" onChange={e => { if(e.target.value) setChatStudent(students.find(s => s.nid === e.target.value)); }}>
                                                        <option value="">-- Ø§Ø®ØªØ± Ø·Ø§Ù„Ø¨ --</option>
                                                        {[...students].sort((a,b) => a.name.localeCompare(b.name, 'ar')).map(s => <option key={s.nid} value={s.nid}>{s.name} ({s.section || '-'})</option>)}
                                                    </select>
                                                </div>
                                                <div className="flex-1 flex items-center justify-center text-slate-400">
                                                    <div className="text-center">
                                                        <i className="fas fa-comments text-6xl mb-4 opacity-30"></i>
                                                        <p>Ø§Ø®ØªØ± Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</p>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Stats */}
                                <div className="mt-6 bg-slate-100 rounded-xl p-4">
                                    <h4 className="font-bold text-sm mb-2 text-slate-600"><i className="fas fa-chart-bar ml-1"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                        <div className="bg-white p-3 rounded-lg"><div className="text-2xl font-bold text-purple-600">{announcements.length}</div><div className="text-xs text-slate-500">Ø¥Ø¹Ù„Ø§Ù†</div></div>
                                        <div className="bg-white p-3 rounded-lg"><div className="text-2xl font-bold text-indigo-600">{privateMessages.length}</div><div className="text-xs text-slate-500">Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©</div></div>
                                        <div className="bg-white p-3 rounded-lg"><div className="text-2xl font-bold text-red-500">{privateMessages.filter(m => m.to === 'teacher' && !m.read).length}</div><div className="text-xs text-slate-500">ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©</div></div>
                                        <div className="bg-white p-3 rounded-lg"><div className="text-2xl font-bold text-green-600">{new Set(privateMessages.map(m => m.from === 'teacher' ? m.to : m.from)).size}</div><div className="text-xs text-slate-500">Ø·Ø§Ù„Ø¨ ØªÙˆØ§ØµÙ„</div></div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {tab === 'messages' && (
                            <div>
                                <h2 className="text-2xl font-bold mb-6">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
                                <div className="grid lg:grid-cols-2 gap-6">
                                    <div className="bg-white border rounded-xl p-6">
                                        <h3 className="font-bold text-lg mb-4 border-b pb-2">ØµÙ†Ø¯ÙˆÙ‚ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø²ÙˆØ§Ø±</h3>
                                        {guestMessages.length === 0 ? (
                                            <p className="text-slate-400 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©</p>
                                        ) : (
                                            <div className="space-y-3 max-h-96 overflow-y-auto">
                                                {guestMessages.map((msg) => (
                                                    <div key={msg.id} className="bg-slate-50 p-4 rounded-lg relative">
                                                        <button onClick={()=>deleteMessage(msg.id)} className="absolute top-2 left-2 text-slate-400 hover:text-red-500"><i className="fas fa-trash"></i></button>
                                                        <div className="font-bold text-primary mb-1">{msg.sender} <span className="text-xs text-slate-400 font-normal">({msg.date})</span></div>
                                                        <p className="text-sm text-slate-700 whitespace-pre-wrap">{msg.text}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                    <div className="bg-white border rounded-xl p-6 h-fit">
                                        <h3 className="font-bold text-lg mb-4 border-b pb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†</h3>
                                        <label className="block text-sm font-bold mb-1">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¹Ù„Ù…</label>
                                        <input className="w-full p-2 border rounded mb-2" value={adminPassword} onChange={e => setAdminPassword(e.target.value)} />
                                        <button onClick={() => setAdminPassword(adminPassword)} className="w-full bg-slate-900 text-white py-2 rounded font-bold mt-2">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                                        <p className="text-xs text-slate-500 mt-2">Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø© Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø¹Ø¯ 5 Ù†Ù‚Ø±Ø§Øª.</p>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {/* Edit Modal (Admin) */}
                        {editingStudent && (
                            <div className="modal-overlay" onClick={(e) => {if(e.target.className.includes('modal-overlay')) setEditingStudent(null)}}>
                                <div className="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl m-4">
                                    <h3 className="text-xl font-bold mb-4 border-b pb-2">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
                                    <div className="space-y-3">
                                        <div><label className="block text-sm font-bold mb-1">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input className="w-full p-2 border rounded" value={editingStudent.name} onChange={e => setEditingStudent({...editingStudent, name: e.target.value})} /></div>
                                        <div><label className="block text-sm font-bold mb-1">Ø§Ù„Ø´Ø¹Ø¨Ø© / Ø§Ù„ØµÙ</label><input className="w-full p-2 border rounded" value={editingStudent.section} onChange={e => setEditingStudent({...editingStudent, section: e.target.value})} /></div>
                                        <div><label className="block text-sm font-bold mb-1">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</label><input className="w-full p-2 border rounded bg-slate-50" value={editingStudent.nid} disabled /></div>
                                        <div><label className="block text-sm font-bold mb-1 text-red-500">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input className="w-full p-2 border rounded border-red-200" value={editingStudent.password || ''} onChange={e => setEditingStudent({...editingStudent, password: e.target.value})} placeholder="ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" /></div>
                                        <div><label className="block text-sm font-bold mb-1">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input className="w-full p-2 border rounded" value={editingStudent.mobile || ''} onChange={e => setEditingStudent({...editingStudent, mobile: e.target.value})} /></div>
                                        
                                        {/* Image Management in Admin */}
                                        <div>
                                            <label className="block text-sm font-bold mb-2">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
                                            <div className="flex items-center gap-4 bg-slate-50 p-3 rounded-lg border">
                                                <div className="relative">
                                                    {editingStudent.avatar ? (
                                                        <>
                                                            <img src={editingStudent.avatar} className="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm" />
                                                            <button 
                                                                onClick={()=>setEditingStudent({...editingStudent, avatar: ''})} 
                                                                className="absolute -top-1 -left-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px] shadow-sm hover:bg-red-600 transition"
                                                                title="Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©"
                                                            >
                                                                <i className="fas fa-times"></i>
                                                            </button>
                                                        </>
                                                    ) : (
                                                        <div className="w-14 h-14 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 text-xl"><i className="fas fa-user"></i></div>
                                                    )}
                                                </div>
                                                <div className="flex-1">
                                                    <input type="file" accept="image/*" className="text-xs w-full file:mr-2 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" onChange={handleAdminImg} />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mt-6">
                                        <button onClick={saveStudentEdit} className="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                                        <button onClick={() => setEditingStudent(null)} className="flex-1 bg-slate-200 text-slate-700 py-2 rounded-lg font-bold hover:bg-slate-300">Ø¥Ù„ØºØ§Ø¡</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Student Details Modal (Teacher View) */}
                        {viewingStudent && (
                            <div className="modal-overlay" onClick={(e) => {if(e.target.className.includes('modal-overlay')) setViewingStudent(null)}}>
                                <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl m-4 overflow-hidden flex flex-col max-h-[90vh]">
                                    <div className="p-6 border-b bg-slate-50 flex justify-between items-center">
                                        <div className="flex items-center gap-4">
                                            {/* Clickable Image for Enlargement */}
                                            {viewingStudent.avatar ? 
                                                <img 
                                                    src={viewingStudent.avatar} 
                                                    className="w-16 h-16 rounded-full object-cover border-2 border-white shadow-lg cursor-pointer hover:opacity-80 transition" 
                                                    onClick={() => setEnlargedImg(viewingStudent.avatar)}
                                                    title="Ø§Ø¶ØºØ· Ù„Ù„ØªÙƒØ¨ÙŠØ±"
                                                /> 
                                                : <div className="w-16 h-16 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 text-2xl"><i className="fas fa-user"></i></div>
                                            }
                                            <div>
                                                <h3 className="text-2xl font-bold text-slate-800">{viewingStudent.name}</h3>
                                                <p className="text-sm text-slate-500">Ø³Ø¬Ù„: {viewingStudent.nid} | Ø§Ù„Ø´Ø¹Ø¨Ø©: {viewingStudent.section}</p>
                                                {viewingStudent.mobile && <p className="text-sm text-blue-600 font-bold mt-1"><i className="fas fa-phone-alt ml-1"></i> {viewingStudent.mobile}</p>}
                                            </div>
                                        </div>
                                        <button onClick={() => setViewingStudent(null)} className="text-slate-400 hover:text-slate-600"><i className="fas fa-times text-xl"></i></button>
                                    </div>
                                    <div className="p-6 overflow-y-auto">
                                        {/* Stats */}
                                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                                            <div className="bg-blue-50 p-4 rounded-xl text-center">
                                                <div className="text-2xl font-bold text-blue-600">{viewingStudent.xp}</div>
                                                <div className="text-xs text-blue-400 font-bold">Ù†Ù‚Ø§Ø· XP</div>
                                            </div>
                                            <div className="bg-purple-50 p-4 rounded-xl text-center">
                                                <div className="text-2xl font-bold text-purple-600">{getLevelName(viewingStudent.level)}</div>
                                                <div className="text-xs text-purple-400 font-bold">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
                                            </div>
                                            <div className="bg-green-50 p-4 rounded-xl text-center">
                                                <div className="text-2xl font-bold text-green-600">
                                                    {lessons.filter(l => {
                                                        const h = viewingStudent.history?.find(hi => hi.lessonId === l.id);
                                                        return h && Math.max(h.score) >= 50;
                                                    }).length} / {lessons.length}
                                                </div>
                                                <div className="text-xs text-green-400 font-bold">Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</div>
                                            </div>
                                            <div className="bg-orange-50 p-4 rounded-xl text-center">
                                                <div className="text-2xl font-bold text-orange-600">
                                                    {Math.round((lessons.filter(l => {
                                                        const h = viewingStudent.history?.find(hi => hi.lessonId === l.id);
                                                        return h && Math.max(h.score) >= 50;
                                                    }).length / Math.max(lessons.length, 1)) * 100)}%
                                                </div>
                                                <div className="text-xs text-orange-400 font-bold">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</div>
                                            </div>
                                        </div>

                                        {/* Lessons List */}
                                        <h4 className="font-bold text-lg mb-4 border-b pb-2">Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø±ÙˆØ³</h4>
                                        <div className="space-y-3">
                                            {lessons.map(l => {
                                                const historyItem = viewingStudent.history?.filter(h => h.lessonId === l.id) || [];
                                                const isDone = historyItem.some(h => h.score >= 50);
                                                const maxScore = historyItem.length > 0 ? Math.max(...historyItem.map(h => h.score)) : 0;
                                                
                                                return (
                                                    <div key={l.id} className="flex justify-between items-center p-3 border rounded-lg hover:bg-slate-50">
                                                        <div>
                                                            <div className="font-bold text-sm">{l.title}</div>
                                                            <div className="text-xs text-slate-400">
                                                                {isDone ? <span className="text-green-600">Ù…Ù†Ø¬Ø² ({maxScore}%)</span> : <span className="text-slate-400">ØºÙŠØ± Ù…Ù†Ø¬Ø²</span>}
                                                            </div>
                                                        </div>
                                                        <div>
                                                            {historyItem.length > 0 ? (
                                                                <button onClick={() => handleResetLesson(l.id)} className="text-xs bg-red-50 text-red-600 px-3 py-1 rounded-full border border-red-100 hover:bg-red-100 transition">
                                                                    <i className="fas fa-undo ml-1"></i> ØªØµÙÙŠØ± Ø§Ù„Ø¯Ø±Ø³
                                                                </button>
                                                            ) : (
                                                                <span className="text-xs text-slate-300 italic">Ù„Ù… ÙŠØ¨Ø¯Ø£</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    <div className="p-4 bg-slate-50 border-t flex justify-between items-center">
                                        <button onClick={handleFullReset} className="text-red-600 font-bold text-sm hover:underline"><i className="fas fa-trash-alt ml-1"></i> ØªØµÙÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨ (Reset All)</button>
                                        <button onClick={() => setViewingStudent(null)} className="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold">Ø¥ØºÙ„Ø§Ù‚</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Enlarged Image Modal */}
                        {enlargedImg && (
                            <div className="modal-overlay" onClick={() => setEnlargedImg(null)}>
                                <div className="bg-white p-2 rounded-xl shadow-2xl relative max-w-3xl max-h-[90vh] flex flex-col items-center">
                                    <button className="absolute top-2 right-2 text-white bg-black/50 rounded-full w-8 h-8 flex items-center justify-center hover:bg-black/80" onClick={() => setEnlargedImg(null)}>
                                        <i className="fas fa-times"></i>
                                    </button>
                                    <img src={enlargedImg} className="max-w-full max-h-[80vh] rounded-lg object-contain" />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const LessonView = ({ lesson, user, onComplete, onBack, mode }) => {
            if (!lesson) return <div className="p-8 text-center">Ø§Ù„Ø¯Ø±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯<br/><button onClick={onBack}>Ø¹ÙˆØ¯Ø©</button></div>;
            const [answers, setAnswers] = useState({});
            const [result, setResult] = useState(null);
            const [randomizedQuestions, setRandomizedQuestions] = useState([]);
            const [unansweredIds, setUnansweredIds] = useState([]);
            const isReview = mode === 'review';
            
            useEffect(() => {
                window.scrollTo(0, 0);
                if(lesson && lesson.questions) {
                    const qs = [...lesson.questions];
                    const shuffledQs = shuffleArray(qs).map(q => {
                        if(q.type === 'mcq') {
                             return { ...q, options: shuffleArray([...q.options]) };
                        }
                        return q;
                    });
                    setRandomizedQuestions(shuffledQs);
                }
            }, [lesson, mode]);

            let reviewScore = 0;
            if (isReview && user.role === 'student' && user.history) {
                 const historyItems = user.history.filter(h => h.lessonId === lesson.id);
                 if (historyItems.length > 0) {
                     reviewScore = Math.max(...historyItems.map(h => h.score));
                 }
            }

            const submit = () => {
                if(user.role === 'guest') return;
                if(isReview) return;
                const unanswered = randomizedQuestions.filter(q => !answers[q.id] || String(answers[q.id]).trim() === '');
                if(unanswered.length > 0) {
                    setUnansweredIds(unanswered.map(q => q.id));
                    return;
                }
                setUnansweredIds([]);
                let correct = 0; let mistakes = [];
                randomizedQuestions.forEach(q => { 
                    const userAns = String(answers[q.id]).trim().toLowerCase();
                    const correctAns = String(q.answer).trim().toLowerCase();
                    if(userAns === correctAns) correct++; else mistakes.push(q); 
                });
                const score = Math.round((correct/randomizedQuestions.length)*100);
                const passed = score >= 50;
                setResult({score, mistakes, passed});
                onComplete(lesson.id, score, mistakes, passed);
                if(passed) confetti();
            };

            return (
                <div className="max-w-3xl mx-auto bg-white p-8 rounded-3xl shadow-xl fade-in">
                    {isReview && (
                        <div className="bg-green-50 text-green-800 p-4 rounded-xl mb-6 text-center border border-green-200 shadow-sm">
                            <div className="font-bold text-lg mb-1">ğŸ‰ Ø±Ø§Ø¦Ø¹ Ø¬Ø¯Ø§Ù‹! Ù„Ù‚Ø¯ Ø£ØªÙ…Ù…Øª Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.</div>
                            <div className="text-sm">ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© â€¢ Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: <span className="font-bold text-xl">{reviewScore}%</span></div>
                        </div>
                    )}
                    
                    {!result ? (
                        <>
                            <div className="border-b pb-6 mb-6"><button onClick={onBack} className="text-slate-400 font-bold mb-4 block hover:text-slate-600 transition"><i className="fas fa-arrow-right ml-1"></i> Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø±ÙˆØ³</button><h2 className="text-3xl font-extrabold mb-4 text-slate-800">{lesson.title}</h2><div className="bg-slate-50 p-6 rounded-2xl text-lg text-slate-700 leading-loose border border-slate-100">{lesson.content}</div></div>
                            <div className="space-y-8 mb-10">
                                {randomizedQuestions.map((q, i) => (
                                    <div key={q.id} className={`p-6 border rounded-2xl hover:border-blue-200 transition bg-white shadow-sm ${unansweredIds.includes(q.id) ? 'border-red-500 border-2 bg-red-50' : ''}`}>
                                        <div className="flex flex-col gap-3 mb-4"><div className="flex justify-between items-center w-full"><span className="bg-blue-100 text-primary text-sm px-3 py-1 rounded-full font-bold">Ø³Ø¤Ø§Ù„ {i+1}</span><span className="text-xs text-slate-400 font-bold uppercase tracking-wider">{q.type === 'tf' ? 'ØµØ­/Ø®Ø·Ø£' : 'Ø§Ø®ØªÙŠØ§Ø±'}</span></div><p className="font-bold text-xl text-slate-800 leading-relaxed break-words whitespace-normal">{q.text}</p></div>
                                        {q.type === 'mcq' && q.options.map(opt => {
                                            const isCorrect = String(opt).toLowerCase() === String(q.answer).toLowerCase();
                                            return (
                                                <label key={opt} className={`flex items-start gap-3 p-4 border rounded-xl mb-2 cursor-pointer transition w-full ${isReview && isCorrect ? 'bg-green-100 border-green-500' : ''} ${!isReview && answers[q.id]===opt ? 'bg-blue-50 border-primary' : 'hover:bg-slate-50'}`}>
                                                    <input type="radio" name={q.id} className="mt-1.5 w-5 h-5 text-primary shrink-0 accent-primary" onChange={()=>setAnswers({...answers, [q.id]:opt})} disabled={user.role==='guest' || isReview} checked={isReview ? isCorrect : undefined} />
                                                    <span className="text-slate-700 font-medium break-words w-full text-lg">{opt} {isReview && isCorrect && "âœ…"}</span>
                                                </label>
                                            );
                                        })}
                                        {q.type === 'tf' && (<div className="flex gap-4"><button onClick={()=>setAnswers({...answers, [q.id]:'true'})} disabled={user.role==='guest' || isReview} className={`flex-1 p-4 rounded-xl border font-bold text-lg transition ${isReview && String(q.answer)==='true' ? 'bg-green-100 border-green-500 text-green-700' : ''} ${!isReview && answers[q.id]==='true' ? 'bg-green-100 text-green-700 border-green-500' : 'hover:bg-slate-50'}`}>ØµØ­</button><button onClick={()=>setAnswers({...answers, [q.id]:'false'})} disabled={user.role==='guest' || isReview} className={`flex-1 p-4 rounded-xl border font-bold text-lg transition ${isReview && String(q.answer)==='false' ? 'bg-green-100 border-green-500 text-green-700' : ''} ${!isReview && answers[q.id]==='false' ? 'bg-red-100 text-red-700 border-red-500' : 'hover:bg-slate-50'}`}>Ø®Ø·Ø£</button></div>)}
                                        {isReview && <p className="text-sm text-slate-600 mt-2 bg-slate-50 p-3 rounded border-r-4 border-yellow-400">ğŸ’¡ {q.explanation}</p>}
                                    </div>
                                ))}
                            </div>
                            {!isReview && unansweredIds.length > 0 && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl mb-4 text-center font-bold"><i className="fas fa-exclamation-triangle ml-2"></i>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ({unansweredIds.length} Ø³Ø¤Ø§Ù„ Ù…ØªØ±ÙˆÙƒ)</div>}
                            {!isReview && (user.role !== 'guest' ? <button onClick={submit} className="w-full bg-slate-900 text-white py-5 rounded-2xl font-bold text-xl hover:shadow-xl transition">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button> : <div className="text-center text-slate-500 bg-slate-100 p-4 rounded-xl">ÙˆØ¶Ø¹ Ø§Ù„Ø²Ø§Ø¦Ø±</div>)}
                        </>
                    ) : (
                        <div className="text-center py-12 flex flex-col items-center">
                            {result.passed ? (
                                <div className="animate-bounce mb-6 text-6xl">ğŸ‰</div>
                            ) : (
                                <div className="mb-6 text-6xl text-slate-300"><i className="fas fa-running"></i></div>
                            )}
                            
                            <h2 className="text-4xl font-extrabold mb-2 text-slate-800">{result.passed ? 'Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„!' : 'Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!'}</h2>
                            <h3 className={`text-6xl font-black mb-6 ${result.passed ? 'text-green-500' : 'text-red-500'}`}>{result.score}%</h3>
                            
                            <p className="text-xl text-slate-500 mb-8 max-w-md leading-relaxed">
                                {result.passed 
                                    ? 'Ù„Ù‚Ø¯ Ø£Ø«Ø¨Øª Ø¬Ø¯Ø§Ø±ØªÙƒ ÙˆØ§Ø¬ØªØ²Øª Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù…!' 
                                    : 'Ù„Ø§ ØªÙŠØ£Ø³ØŒ Ø§Ù„ÙØ´Ù„ Ù‡Ùˆ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù†Ø­Ùˆ Ø§Ù„Ù†Ø¬Ø§Ø­. Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„ØªØ­Ù‚ÙŠÙ‚ Ù†Ø³Ø¨Ø© 50% Ø£Ùˆ Ø£Ø¹Ù„Ù‰.'}
                            </p>
                            
                            <button onClick={onBack} className={`px-12 py-4 rounded-2xl font-bold text-white shadow-xl hover:scale-105 transition ${result.passed ? 'bg-green-600' : 'bg-slate-800'}`}>
                                {result.passed ? 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©' : 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©'}
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        const FlashcardsView = ({ lesson, onBack }) => {
            if (!lesson) return <div className="p-8 text-center">Ø§Ù„Ø¯Ø±Ø³ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯<br/><button onClick={onBack}>Ø¹ÙˆØ¯Ø©</button></div>;
            const [index, setIndex] = useState(0);
            const [flipped, setFlipped] = useState(false);
            const cards = lesson.flashcards || [];
            if(cards.length===0) return <div className="text-center p-20"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ø·Ø§Ù‚Ø§Øª.</p><button onClick={onBack} className="mt-4 text-primary font-bold">Ø¹ÙˆØ¯Ø©</button></div>;
            return (
                <div className="max-w-md mx-auto fade-in text-center pt-10">
                    <button onClick={onBack} className="mb-6 text-slate-400 font-bold hover:text-slate-600"> Ø¹ÙˆØ¯Ø©</button>
                    <div className="h-72 w-full cursor-pointer perspective-1000 mb-10" onClick={() => setFlipped(!flipped)}>
                        <div className={`flip-card w-full h-full ${flipped ? 'flipped' : ''}`}>
                            <div className="flip-card-inner shadow-2xl rounded-3xl">
                                <div className="flip-card-front text-3xl font-bold text-slate-800"><p>{cards[index].front}</p><span className="text-xs text-slate-400 mt-4">(Ø§Ù‚Ù„Ø¨)</span></div>
                                <div className="flip-card-back text-2xl font-medium px-6"><p>{cards[index].back}</p></div>
                            </div>
                        </div>
                    </div>
                    <div className="flex justify-between items-center px-8"><button onClick={() => {setFlipped(false); setIndex(Math.max(0, index-1))}} disabled={index===0} className="p-5 bg-white rounded-full shadow-lg disabled:opacity-50"><i className="fas fa-arrow-right"></i></button><span className="font-bold text-slate-400">{index+1} / {cards.length}</span><button onClick={() => {setFlipped(false); setIndex(Math.min(cards.length-1, index+1))}} disabled={index===cards.length-1} className="p-5 bg-white rounded-full shadow-lg disabled:opacity-50"><i className="fas fa-arrow-left"></i></button></div>
                </div>
            );
        };

        const SRSView = ({ user, onReview, onBack }) => {
            const due = user.srsQueue?.filter(q => q.nextReview <= Date.now()) || [];
            const [curr, setCurr] = useState(0);
            const [show, setShow] = useState(false);
            if(due.length === 0) return <div className="text-center py-24 bg-white rounded-3xl shadow-sm"><h2 className="text-2xl font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø¬Ø¹Ø§Øª</h2><button onClick={onBack} className="mt-4 bg-slate-800 text-white px-6 py-2 rounded-xl">Ø¹ÙˆØ¯Ø©</button></div>;
            const q = due[curr];
            return (
                <div className="max-w-xl mx-auto bg-white p-10 rounded-3xl shadow-xl text-center fade-in">
                    <h2 className="text-2xl font-bold mb-12 text-slate-800 break-words leading-loose whitespace-normal">{q.text}</h2>
                    {!show ? <button onClick={() => setShow(true)} className="bg-blue-50 text-primary px-12 py-4 rounded-2xl font-bold">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button> : <div className="fade-in"><p className="text-xl font-bold text-green-600 mb-6 break-words">{q.answer}</p><div className="grid grid-cols-2 gap-4"><button onClick={() => { onReview(q, false); setCurr(0); setShow(false); }} className="bg-red-50 text-red-600 py-4 rounded-2xl font-bold">Ù†Ø³ÙŠØª</button><button onClick={() => { onReview(q, true); setCurr(0); setShow(false); }} className="bg-green-50 text-green-600 py-4 rounded-2xl font-bold">ØªØ°ÙƒØ±Øª</button></div></div>}
                </div>
            );
        };

        const MistakeVault = ({ user, onSolve, onBack }) => {
            const m = user.mistakes?.[0];
            return (
                <div className="max-w-xl mx-auto bg-white p-8 rounded-3xl shadow-lg text-center fade-in">
                    <button onClick={onBack} className="mb-4 text-slate-400 font-bold">Ø¹ÙˆØ¯Ø©</button>
                    <h2 className="text-2xl font-bold mb-8 text-red-600">Ø¨Ù†Ùƒ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡</h2>
                    {!m ? <p className="text-slate-500 font-bold">Ø³Ø¬Ù„Ùƒ Ù†Ø¸ÙŠÙ!</p> : <div><div className="bg-slate-50 p-8 rounded-2xl mb-6 w-full text-right"><p className="font-bold text-xl text-slate-800 leading-loose break-words whitespace-normal">{m.text}</p></div><button onClick={() => onSolve(m.id)} className="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold">Ù„Ù‚Ø¯ ÙÙ‡Ù…ØªÙ‡Ø§</button><div className="mt-4 bg-yellow-50 p-4 rounded text-sm text-right break-words">{m.explanation}</div></div>}
                </div>
            );
        };

        const Certificate = ({ user, onBack }) => {
            const saveAsImage = async () => {
                const element = document.getElementById('certificate-area');
                try {
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                    const link = document.createElement('a');
                    link.download = `Certificate_${user.name}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    confetti();
                } catch (err) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸"); }
            };

            return (
                <div className="max-w-xl mx-auto fade-in text-center pt-5 pb-10">
                    <div className="flex justify-between items-center mb-6 px-4">
                        <button onClick={onBack} className="text-slate-500 font-bold">Ø¹ÙˆØ¯Ø©</button>
                        <button onClick={saveAsImage} className="bg-slate-900 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:scale-105 transition text-sm"><i className="fas fa-download mr-2"></i> Ø­ÙØ¸ ÙƒØµÙˆØ±Ø©</button>
                    </div>
                    {/* Portrait Certificate Container */}
                    <div id="certificate-area" className="bg-white relative overflow-hidden text-center shadow-2xl mx-auto cert-pattern" 
                         style={{ width: '100%', maxWidth: '400px', aspectRatio: '1/1.414', padding: '2rem' }}>
                        
                        <div className="absolute inset-2 border-[6px] border-double border-slate-800 rounded-sm pointer-events-none"></div>
                        <div className="absolute inset-4 border-[1px] border-gold rounded-sm pointer-events-none"></div>
                        
                        <div className="absolute top-4 left-4 text-gold text-2xl"><i className="fas fa-certificate"></i></div>
                        <div className="absolute top-4 right-4 text-gold text-2xl"><i className="fas fa-certificate"></i></div>
                        <div className="absolute bottom-4 left-4 text-gold text-2xl"><i className="fas fa-certificate"></i></div>
                        <div className="absolute bottom-4 right-4 text-gold text-2xl"><i className="fas fa-certificate"></i></div>

                        <div className="h-full flex flex-col justify-between items-center relative z-10 py-8">
                            <div>
                                <div className="w-16 h-16 bg-slate-900 text-white rounded-full flex items-center justify-center text-2xl font-bold shadow-lg mx-auto mb-4"><i className="fas fa-graduation-cap"></i></div>
                                <h1 className="text-3xl font-extrabold text-slate-800 mb-2" style={{fontFamily: 'Amiri'}}>Ø´Ù‡Ø§Ø¯Ø© Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±</h1>
                                <p className="text-sm text-slate-500">Ù…Ù†ØµØ© Ø§Ù„ØªÙØ³ÙŠØ± Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</p>
                            </div>

                            <div className="w-full">
                                <p className="text-base text-slate-600 mb-4">ØªØªØ´Ø±Ù Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù…Ù†Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ù„Ø·Ø§Ù„Ø¨:</p>
                                <h2 className="text-2xl font-extrabold text-primary border-b-2 border-gold inline-block pb-2 px-4 mb-6" style={{fontFamily: 'Amiri'}}>{user.name}</h2>
                                <p className="text-base text-slate-700 leading-relaxed px-2">
                                    ÙˆØ°Ù„Ùƒ Ù„Ø§Ø¬ØªÙŠØ§Ø²Ù‡ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªÙÙˆÙ‚ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙ‰<br/>
                                    <span className="font-bold text-xl text-slate-900 mt-2 block">{getLevelName(user.level)}</span>
                                </p>
                            </div>

                            <div className="w-full mt-4">
                                <div className="w-20 h-20 bg-gold rounded-full opacity-10 flex items-center justify-center mx-auto mb-2">
                                    <i className="fas fa-star text-4xl text-yellow-600"></i>
                                </div>
                                <div className="flex justify-around items-end w-full px-4">
                                    <div className="text-center">
                                        <p className="text-xs text-slate-400 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
                                        <p className="font-bold text-sm">{new Date().toLocaleDateString('ar-SA')}</p>
                                    </div>
                                    <div className="text-center">
                                        <div className="w-16 h-px bg-slate-800 mb-2 mx-auto"></div>
                                        <p className="font-bold text-sm text-slate-800" style={{fontFamily: 'Amiri'}}>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ù†ØµØ©</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
