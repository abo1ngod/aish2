<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة البيانات الشامل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background-color: #f0f2f5; }
        .tab-content { display: none; opacity: 0; transform: translateY(10px); transition: all 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; transform: translateY(0); }
        .field-card { transition: all 0.2s ease; border: 1px solid #e5e7eb; }
        .field-card:hover { border-color: #6366f1; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .loader { border-top-color: #6366f1; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .stat-card { border-right: 4px solid #6366f1; }
    </style>
</head>
<body class="antialiased text-slate-900">

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-50 flex flex-col gap-2"></div>

    <div class="max-w-6xl mx-auto px-4 py-6 md:py-10">
        <!-- Header -->
        <div class="bg-white rounded-3xl p-6 mb-8 shadow-sm border border-slate-100 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-200">
                    <i data-lucide="database" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">إدارة قاعدة البيانات</h1>
                    <p class="text-slate-500 text-sm">نظام ذكي للإدخال والإحصاء والمعالجة اللحظية</p>
                </div>
            </div>
            <nav class="flex bg-slate-100 p-1.5 rounded-2xl w-full md:w-auto">
                <button onclick="switchTab('input')" id="tab-input-btn" class="flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600">
                    <i data-lucide="user-plus" class="w-4 h-4 inline-block ml-2"></i>الإدخال
                </button>
                <button onclick="switchTab('view')" id="tab-view-btn" class="flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-700">
                    <i data-lucide="list" class="w-4 h-4 inline-block ml-2"></i>السجلات
                </button>
            </nav>
        </div>

        <!-- Main Sections -->
        <div id="content">
            
            <!-- SECTION: INPUT FORM -->
            <section id="input-section" class="tab-content active">
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                    <div class="bg-indigo-600 px-8 py-4 text-white">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <i data-lucide="form-input" class="w-5 h-5"></i>
                            <span id="form-title">إضافة سجل جديد</span>
                        </h2>
                    </div>
                    <form id="dataForm" onsubmit="handleSubmit(event)" class="p-8">
                        <input type="hidden" id="edit-id">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">الاسم الكامل</label>
                                <input type="text" id="name" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">العمر</label>
                                <input type="number" id="age" required class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">الجنس</label>
                                <select id="gender" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all appearance-none">
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">رقم الهاتف</label>
                                <input type="tel" id="phone" required dir="ltr" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-right">
                            </div>
                            <div class="md:col-span-2 space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">البريد الإلكتروني</label>
                                <input type="email" id="email" required dir="ltr" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-right">
                            </div>
                            <div class="md:col-span-3 space-y-2">
                                <label class="text-sm font-semibold text-slate-600 mr-1">الرسالة</label>
                                <textarea id="message" rows="4" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all resize-none"></textarea>
                            </div>
                        </div>
                        <div class="mt-8 flex gap-4">
                            <button type="submit" id="submit-btn" class="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100 flex items-center justify-center gap-2">
                                <i data-lucide="save" class="w-5 h-5"></i>
                                <span id="submit-btn-text">حفظ السجل</span>
                            </button>
                            <button type="button" onclick="resetForm()" class="px-6 py-4 bg-slate-100 text-slate-500 rounded-2xl hover:bg-slate-200 transition-all">
                                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- SECTION: VIEW LIST -->
            <section id="view-section" class="tab-content">
                <!-- Statistics Dashboard -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 stat-card">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">إجمالي السجلات</p>
                        <p id="stat-total" class="text-2xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 stat-card" style="border-right-color: #10b981;">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">متوسط الأعمار</p>
                        <p id="stat-avg-age" class="text-2xl font-bold text-emerald-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 stat-card" style="border-right-color: #3b82f6;">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">عدد الذكور</p>
                        <p id="stat-males" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 stat-card" style="border-right-color: #f43f5e;">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">عدد الإناث</p>
                        <p id="stat-females" class="text-2xl font-bold text-rose-600">0</p>
                    </div>
                </div>

                <div class="flex flex-col gap-6">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                            <input type="text" id="search-input" oninput="filterData()" placeholder="ابحث بالاسم، الهاتف، المعرف، أو الرسالة..." class="w-full pr-10 pl-4 py-2 bg-slate-50 border border-slate-100 rounded-xl outline-none focus:border-indigo-500 text-sm">
                        </div>
                        <button onclick="fetchData()" class="w-full md:w-auto flex items-center justify-center gap-2 px-6 py-2 bg-indigo-50 text-indigo-600 rounded-xl font-bold text-sm hover:bg-indigo-100 transition-all">
                            <i data-lucide="refresh-cw" id="refresh-icon" class="w-4 h-4"></i>
                            تحديث البيانات
                        </button>
                    </div>

                    <!-- Records List -->
                    <div id="records-list" class="grid grid-cols-1 gap-4">
                        <!-- Cards will be injected here -->
                    </div>

                    <!-- Empty State -->
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center py-20 text-slate-400">
                        <i data-lucide="inbox" class="w-16 h-16 mb-4 opacity-20"></i>
                        <p>لا توجد سجلات حالية</p>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <!-- Full Screen Loader Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] z-[100] hidden flex-col items-center justify-center text-white">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-14 w-14 mb-4"></div>
        <p class="font-bold tracking-wide">جاري الاتصال بقاعدة البيانات...</p>
    </div>

    <script>
        // --- الإعدادات ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz7jlpkO09TE5IC-hoAW6cGtA7lDBMMzLfsBDtw_k8muiPnkmou3V9a1g9eqFxAzhan/exec";
        const apiKey = ""; // API Key للذكاء الاصطناعي

        let cacheData = [];
        let genderAnomalies = {}; // لتخزين أخطاء الجنس المكتشفة بالذكاء الاصطناعي
        lucide.createIcons();

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');
            
            const btnInput = document.getElementById('tab-input-btn');
            const btnView = document.getElementById('tab-view-btn');

            if (tab === 'input') {
                btnInput.className = "flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600";
                btnView.className = "flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
            } else {
                btnView.className = "flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all bg-white shadow-sm text-indigo-600";
                btnInput.className = "flex-1 md:flex-none px-6 py-2.5 rounded-xl text-sm font-bold transition-all text-slate-500 hover:text-slate-700";
                fetchData();
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            if(!WEB_APP_URL) return showToast("الرابط غير صالح", "error");

            const id = document.getElementById('edit-id').value;
            const data = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                message: document.getElementById('message').value
            };

            const action = id ? "update" : "add";
            if(id) data.id = id;

            toggleLoader(true);
            try {
                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action, data })
                });
                
                showToast(id ? "تم التحديث بنجاح" : "تمت الإضافة بنجاح");
                resetForm();
                if(id) switchTab('view');
            } catch (err) {
                showToast("حدث خطأ في الاتصال", "error");
            } finally {
                toggleLoader(false);
            }
        }

        async function fetchData() {
            if(!WEB_APP_URL) return;
            document.getElementById('refresh-icon').classList.add('animate-spin');
            
            try {
                const response = await fetch(WEB_APP_URL);
                const rawData = await response.json();
                
                const processed = rawData.map(item => {
                    if (Array.isArray(item)) return item;
                    let cleanItem = {};
                    for (let key in item) {
                        cleanItem[key.trim().toLowerCase()] = item[key];
                    }
                    return cleanItem;
                });

                cacheData = processed.reverse();

                updateStatistics(cacheData);
                renderData(cacheData);
                
                // تشغيل تحليل الذكاء الاصطناعي للجنس بعد تحميل البيانات
                analyzeGendersWithAI(cacheData);
            } catch (err) {
                showToast("فشل جلب البيانات", "error");
            } finally {
                document.getElementById('refresh-icon').classList.remove('animate-spin');
            }
        }

        async function analyzeGendersWithAI(data) {
            if (!data.length) return;
            
            const payload = data.map(i => `ID:${i.id}, Name:${i.name}, Gender:${i.gender}`).join('\n');
            const systemPrompt = "أنت خبير في الأسماء العربية والأجنبية. قم بفحص القائمة التالية وتحديد السجلات التي يبدو فيها الجنس المحدد مخالفاً للاسم (مثلاً اسم مذكر وجنس أنثى). أرجع النتيجة فقط بصيغة JSON حيث المفاتيح هي الـ ID والقيم هي سبب الخطأ باختصار شديد باللغة العربية. إذا كان السجل صحيحاً لا تضمنه في النتيجة.";
            
            try {
                const response = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `افحص هذه السجلات:\n${payload}` }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                const result = await response.json();
                const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (textResponse) {
                    genderAnomalies = JSON.parse(textResponse);
                    renderData(cacheData); // إعادة رندرة البيانات لعرض التنبيهات
                }
            } catch (e) {
                // فشل صامت للذكاء الاصطناعي لعدم تعطيل التطبيق
            }
        }

        async function fetchWithRetry(url, options, retries = 5, backoff = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const res = await fetch(url, options);
                    if (res.ok) return res;
                } catch (err) {}
                await new Promise(r => setTimeout(r, backoff));
                backoff *= 2;
            }
            throw new Error("API failed after retries");
        }

        function updateStatistics(data) {
            const total = data.length;
            const avgAge = total > 0 ? (data.reduce((sum, item) => sum + (parseInt(item.age) || 0), 0) / total).toFixed(1) : 0;
            const males = data.filter(item => (item.gender || '').includes('ذكر')).length;
            const females = data.filter(item => (item.gender || '').includes('أنثى')).length;

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avg-age').innerText = avgAge;
            document.getElementById('stat-males').innerText = males;
            document.getElementById('stat-females').innerText = females;
        }

        function renderData(data) {
            const list = document.getElementById('records-list');
            const empty = document.getElementById('empty-state');
            list.innerHTML = '';

            if(data.length === 0) {
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            data.forEach(item => {
                const msg = item.message || item['message '] || item['الرسالة'] || (Array.isArray(item) ? item[6] : '');
                const anomaly = genderAnomalies[item.id];
                
                const card = document.createElement('div');
                card.className = "field-card bg-white p-6 rounded-3xl transition-all mb-4";
                card.innerHTML = `
                    <div class="flex flex-col gap-4">
                        <div class="flex justify-between items-start border-b border-slate-50 pb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center font-bold text-xl">
                                    ${(item.name || '?').charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 text-lg">${item.name || 'بدون اسم'}</h3>
                                    <span class="text-[10px] text-slate-400 font-mono">ID: ${item.id || '-'}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick='initEdit(${JSON.stringify(item)})' class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                                <button onclick="deleteRecord('${item.id}')" class="p-2 text-red-500 hover:bg-red-50 rounded-xl transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>

                        ${anomaly ? `
                        <div class="flex items-center gap-2 bg-amber-50 border border-amber-200 p-3 rounded-2xl text-amber-700 text-xs font-bold">
                            <i data-lucide="alert-triangle" class="w-4 h-4 shrink-0"></i>
                            <span>تنبيه ذكي: ${anomaly}</span>
                        </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="flex items-center gap-2 text-slate-600">
                                <i data-lucide="calendar" class="w-4 h-4 text-slate-400"></i>
                                <span>العمر: <b>${item.age || '-'}</b></span>
                            </div>
                            <div class="flex items-center gap-2 text-slate-600">
                                <i data-lucide="users" class="w-4 h-4 text-slate-400"></i>
                                <span>الجنس: <b>${item.gender || '-'}</b></span>
                            </div>
                            <div class="flex items-center gap-2 text-slate-600">
                                <i data-lucide="phone" class="w-4 h-4 text-slate-400"></i>
                                <span dir="ltr"><b>${item.phone || '-'}</b></span>
                            </div>
                            <div class="flex items-center gap-2 text-slate-600 overflow-hidden">
                                <i data-lucide="mail" class="w-4 h-4 text-slate-400"></i>
                                <span dir="ltr" class="truncate"><b>${item.email || '-'}</b></span>
                            </div>
                        </div>

                        <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100/50">
                            <div class="text-[10px] font-bold text-indigo-400 mb-1 uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="message-square" class="w-3 h-3"></i> محتوى الرسالة
                            </div>
                            <p class="text-sm text-slate-700 leading-relaxed italic">
                                ${msg && msg.toString().trim() !== "" ? `"${msg}"` : '<span class="text-slate-400">لا يوجد نص رسالة مسجل</span>'}
                            </p>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
            lucide.createIcons();
        }

        function filterData() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            const filtered = cacheData.filter(i => {
                const name = (i.name || '').toLowerCase();
                const phone = (i.phone || '').toString();
                const email = (i.email || '').toLowerCase();
                const id = (i.id || '').toString().toLowerCase();
                const message = (i.message || i['الرسالة'] || '').toLowerCase();

                return name.includes(query) || 
                       phone.includes(query) || 
                       email.includes(query) || 
                       id.includes(query) ||
                       message.includes(query);
            });
            renderData(filtered);
        }

        function initEdit(item) {
            document.getElementById('edit-id').value = item.id;
            document.getElementById('name').value = item.name;
            document.getElementById('age').value = item.age;
            document.getElementById('gender').value = item.gender;
            document.getElementById('phone').value = item.phone;
            document.getElementById('email').value = item.email;
            document.getElementById('message').value = item.message || item['message '] || '';

            document.getElementById('form-title').innerText = "تعديل بيانات السجل";
            document.getElementById('submit-btn-text').innerText = "تحديث البيانات الآن";
            document.getElementById('submit-btn').classList.replace('bg-indigo-600', 'bg-emerald-600');
            switchTab('input');
        }

        async function deleteRecord(id) {
            if(!confirm("هل أنت متأكد من الحذف؟")) return;
            toggleLoader(true);
            try {
                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', data: { id } }) });
                showToast("تم الحذف بنجاح");
                fetchData();
            } catch (e) { showToast("خطأ في الحذف", "error"); }
            finally { toggleLoader(false); }
        }

        function resetForm() {
            document.getElementById('dataForm').reset();
            document.getElementById('edit-id').value = "";
            document.getElementById('form-title').innerText = "إضافة سجل جديد";
            document.getElementById('submit-btn-text').innerText = "حفظ السجل";
            document.getElementById('submit-btn').className = "flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center gap-2";
        }

        function toggleLoader(show) {
            document.getElementById('global-loader').classList.toggle('hidden', !show);
            document.getElementById('global-loader').classList.toggle('flex', show);
        }

        function showToast(msg, type = "success") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === "success" ? "bg-indigo-600" : "bg-red-500";
            toast.className = `${color} text-white px-6 py-3 rounded-2xl shadow-xl flex items-center gap-3 animate-bounce`;
            toast.innerHTML = `<i data-lucide="${type === 'success' ? 'check' : 'x'}" class="w-4 h-4"></i> <span class="text-sm font-bold">${msg}</span>`;
            container.appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = "0"; setTimeout(() => toast.remove(), 500); }, 3000);
        }
    </script>
</body>
</html>