<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØªÙŠ - Ù†Ø³Ø®Ø© Ø°ÙƒÙŠØ©</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --focus-color: #27ae60;
            --bg-color: #f4f6f9;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            padding-bottom: 80px; 
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª --- */
        .header-area {
            text-align: center;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        h1 {
            margin: 0 0 10px 0;
            color: var(--primary);
            font-size: 1.8rem;
        }

        .live-transcript {
            background: #ecf0f1;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 5px;
            border: 1px solid #bdc3c7;
            min-width: 200px;
        }
        .live-transcript span {
            color: #d35400;
            font-weight: bold;
        }

        /* --- Ø´Ø¨ÙƒØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            width: 100%; 
            max-width: 280px; 
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            border: 4px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .card.active-target {
            border-color: var(--focus-color);
            background-color: #eafaf1;
            transform: scale(1.02);
            box-shadow: 0 8px 15px rgba(39, 174, 96, 0.2);
        }

        .card.dimmed {
            opacity: 0.6;
            filter: grayscale(100%);
        }

        .card .name { font-size: 2rem; font-weight: bold; color: var(--primary); }
        .card .count { font-size: 4rem; font-weight: 800; color: var(--accent); line-height: 1.1; }
        .card .status-icon { font-size: 1.5rem; margin-bottom: 5px; opacity: 0; }
        .card.active-target .status-icon { opacity: 1; }

        /* --- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª --- */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #ffffff;
            border-top: 1px solid #ddd;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            height: 70px; 
        }

        .status-text { font-weight: bold; font-size: 0.9rem; }
        .status-idle { color: #e74c3c; }
        .status-listening { color: #27ae60; }

        .admin-btn {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© --- */
        #admin-panel {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center;
        }
        .panel-content {
            background: white; width: 90%; max-width: 500px; border-radius: 10px; padding: 20px;
            max-height: 80vh; overflow-y: auto; position: relative;
        }
        .close-btn { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; border: none; background: none; cursor: pointer; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        td, th { padding: 8px; border-bottom: 1px solid #eee; text-align: right; }
        input[type="text"] { width: 100%; padding: 5px; }
        .btn-action { padding: 5px 10px; border-radius: 4px; border: none; color: white; cursor: pointer; margin: 2px; }
        .btn-red { background: #c0392b; }
        .btn-blue { background: #2980b9; }

    </style>
</head>
<body>

    <div class="header-area">
        <h1>ğŸ™ï¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
        <div class="live-transcript">
            Ø³Ù…Ø¹Øª: <span id="debug-text">...</span>
        </div>
        <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 5px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ù„Ù‡</p>
    </div>

    <div class="cards-container" id="cards-wrapper">
        <!-- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
    </div>

    <div class="fixed-footer">
        <div id="footer-status" class="status-text status-idle">ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯</div>
        <button class="admin-btn" onclick="openAdmin()">ğŸ”’ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </div>

    <div id="admin-panel">
        <div class="panel-content">
            <button class="close-btn" onclick="closeAdmin()">âœ–</button>
            <h3>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
            
            <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                <input type="text" id="new-name-input" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯..." style="width: 70%; padding: 8px;">
                <button onclick="addNewPerson()" class="btn-action btn-blue" style="padding: 8px;">Ø¥Ø¶Ø§ÙØ©</button>
            </div>

            <table id="admin-table">
                <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            </table>

            <button onclick="resetAll()" class="btn-action btn-red" style="width: 100%; margin-top: 15px; padding: 10px;">ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„ âš ï¸</button>
        </div>
    </div>

    <script>
        let people = [];
        let activeId = null; 

        // Ø¯Ø§Ù„Ø© ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø±ÙˆÙ (Ø§Ù„Ù‡Ù…Ø²Ø§Øª ÙˆØ§Ù„ØªØ§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©)
        function normalizeArabic(text) {
            if (!text) return "";
            text = text.trim();
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø£ Ø¥ Ø¢ Ø¨Ù€ Ø§
            text = text.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§');
            // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø© Ø¨Ù€ Ù‡
            text = text.replace(/Ø©/g, 'Ù‡');
            return text;
        }

        function init() {
            const saved = localStorage.getItem('voiceApp_v3');
            if (saved) {
                people = JSON.parse(saved);
            } else {
                people = [
                    { id: 1, name: "Ø£Ø­Ù…Ø¯", count: 0 },
                    { id: 2, name: "Ù…Ø­Ù…Ø¯", count: 0 },
                    { id: 3, name: "ÙØ§Ø·Ù…Ø©", count: 0 }
                ];
            }
            renderUI();
        }

        function saveData() {
            localStorage.setItem('voiceApp_v3', JSON.stringify(people));
            renderUI();
        }

        function renderUI() {
            const wrapper = document.getElementById('cards-wrapper');
            const adminTable = document.getElementById('admin-table');
            
            wrapper.innerHTML = '';
            adminTable.innerHTML = '';

            people.forEach((p, index) => {
                let cardClass = "card";
                if (activeId !== null) {
                    if (p.id === activeId) cardClass += " active-target"; 
                    else cardClass += " dimmed"; 
                }

                wrapper.innerHTML += `
                    <div class="${cardClass}" onclick="toggleSelect(${p.id})">
                        <div class="status-icon">ğŸ™ï¸ ÙŠØ³ØªÙ…Ø¹...</div>
                        <div class="name">${p.name}</div>
                        <div class="count">${p.count}</div>
                    </div>
                `;

                adminTable.innerHTML += `
                    <tr>
                        <td><input type="text" value="${p.name}" onchange="editName(${index}, this.value)"></td>
                        <td><b>${p.count}</b></td>
                        <td>
                            <button class="btn-action btn-red" onclick="deletePerson(${index})">Ø­Ø°Ù</button>
                        </td>
                    </tr>
                `;
            });
        }

        function toggleSelect(id) {
            const statusDiv = document.getElementById('footer-status');
            
            if (activeId === id) {
                activeId = null;
                stopMic();
                statusDiv.innerText = "ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯";
                statusDiv.className = "status-text status-idle";
            } else {
                activeId = id;
                const person = people.find(p => p.id === id);
                startMic();
                statusDiv.innerText = `ğŸŸ¢ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù€: ${person.name}`;
                statusDiv.className = "status-text status-listening";
            }
            renderUI();
        }

        let recognition;
        let isRecRunning = false;

        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.lang = 'ar-SA';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onstart = function() { isRecRunning = true; };
            
            recognition.onend = function() { 
                isRecRunning = false;
                if (activeId !== null) {
                    try { recognition.start(); } catch(e) {}
                }
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                
                document.getElementById('debug-text').innerText = transcript;

                processVoiceCommand(transcript);
            };

            recognition.onerror = function(event) {
                console.log("Mic Error:", event.error);
                if(event.error === 'not-allowed') {
                    document.getElementById('debug-text').innerText = "âŒ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù…Ø­Ø¸ÙˆØ±";
                }
            };
        } else {
            alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Google Chrome");
        }

        function startMic() {
            if (recognition && !isRecRunning) {
                try { recognition.start(); } catch(e) {}
            }
        }

        function stopMic() {
            if (recognition) recognition.stop();
        }

        // --- Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù‡Ù†Ø§: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠØ¹ ---
        function processVoiceCommand(text) {
            if (activeId === null) return;

            const target = people.find(p => p.id === activeId);
            
            if (target) {
                // 1. ØªÙ†Ø¸ÙŠÙ ÙˆØªÙˆØ­ÙŠØ¯ Ù…Ø§ Ù‚Ø§Ù„Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const spokenNormalized = normalizeArabic(text);
                // 2. ØªÙ†Ø¸ÙŠÙ ÙˆØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
                const targetNameNormalized = normalizeArabic(target.name);
                
                // 3. Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
                if (spokenNormalized.includes(targetNameNormalized)) {
                    target.count++;
                    saveData();
                    
                    document.getElementById('debug-text').style.color = "green";
                    setTimeout(() => document.getElementById('debug-text').style.color = "#d35400", 500);
                }
            }
        }

        function openAdmin() {
            if(prompt("Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± (1234)") === "1234") {
                document.getElementById('admin-panel').style.display = 'flex';
            }
        }
        function closeAdmin() { document.getElementById('admin-panel').style.display = 'none'; }
        
        function addNewPerson() {
            const name = document.getElementById('new-name-input').value;
            if(name) {
                people.push({ id: Date.now(), name: name, count: 0 });
                saveData();
                document.getElementById('new-name-input').value = '';
            }
        }
        
        function editName(idx, val) { people[idx].name = val; saveData(); }
        function deletePerson(idx) { if(confirm("Ø­Ø°ÙØŸ")) { people.splice(idx, 1); saveData(); } }
        function resetAll() { if(confirm("ØªØµÙÙŠØ± Ø§Ù„ÙƒÙ„ØŸ")) { people.forEach(p => p.count=0); saveData(); } }

        init();

    </script>
</body>
</html>

