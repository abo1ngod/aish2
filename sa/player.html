<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ© - ÿßŸÑŸÖÿ™ÿ≥ÿßÿ®ŸÇ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1e1b4b;
            --darker: #0f0a2e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #1a1333 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: white;
            overflow-x: hidden;
        }

        html {
            height: -webkit-fill-available;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.2); opacity: 0.3; }
        }

        .container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 20px;
            justify-content: center;
            align-items: center;
        }

        .screen.active {
            display: flex;
        }

        /* Login Screen */
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px 25px;
            width: 100%;
            max-width: 350px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-box .icon {
            font-size: 4rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-box h1 {
            font-size: 1.6rem;
            margin-bottom: 8px;
        }

        .login-box p {
            color: rgba(255,255,255,0.6);
            margin-bottom: 25px;
            font-size: 14px;
        }

        .code-input input {
            width: 120px;
            padding: 20px;
            font-size: 32px;
            text-align: center;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            font-family: monospace;
            font-weight: 700;
            letter-spacing: 8px;
        }

        .code-input input:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 200px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            color: var(--danger);
            margin-top: 15px;
            display: none;
            font-size: 14px;
        }

        /* Waiting Screen */
        .player-info {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px 25px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 15px;
        }

        .player-name {
            font-size: 1.8rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .player-team {
            display: inline-block;
            padding: 6px 18px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 25px;
            background: var(--primary);
        }

        .waiting-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: rgba(255,255,255,0.6);
            font-size: 1rem;
        }

        .waiting-indicator .dots {
            display: flex;
            gap: 5px;
        }

        .waiting-indicator .dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            animation: dotPulse 1.4s infinite;
        }

        .waiting-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .waiting-indicator .dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes dotPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.5); opacity: 0.5; }
        }

        /* Question Screen */
        .question-screen {
            padding: 0;
            justify-content: flex-start;
        }

        .question-header {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .score-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .score-display i {
            color: var(--warning);
        }

        .team-badge {
            padding: 4px 12px;
            background: var(--primary);
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }

        .question-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }

        .question-text {
            text-align: center;
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
        }

        .option-btn {
            padding: 18px 20px;
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 15px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: right;
            width: 100%;
        }

        .option-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .option-btn .option-letter {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            border-radius: 10px;
            font-weight: 800;
            flex-shrink: 0;
        }

        .option-btn.correct {
            background: rgba(16, 185, 129, 0.3);
            border-color: var(--success);
        }

        .option-btn.correct .option-letter {
            background: var(--success);
        }

        .option-btn.wrong {
            background: rgba(239, 68, 68, 0.3);
            border-color: var(--danger);
        }

        .option-btn.wrong .option-letter {
            background: var(--danger);
        }

        /* Result Overlay */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            flex-direction: column;
            text-align: center;
            padding: 20px;
        }

        .result-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .result-icon.success { color: var(--success); }
        .result-icon.danger { color: var(--danger); }
        .result-icon.warning { color: var(--warning); }

        .result-title {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .result-subtitle {
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .result-points {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 20px;
        }

        .result-points.positive { color: var(--success); }
        .result-points.negative { color: var(--danger); }

        .second-chance-timer {
            font-size: 5rem;
            font-weight: 900;
            color: var(--warning);
            margin: 20px 0;
            animation: timerPulse 1s infinite;
        }

        @keyframes timerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .countdown-text {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.7);
        }

        /* Scores Screen */
        .scores-screen .scores-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 30px 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .scores-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .scores-list {
            text-align: right;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .score-item.my-team {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid var(--primary);
        }

        .score-item .rank {
            font-size: 1.2rem;
            margin-left: 10px;
        }

        .score-item .team-name {
            flex: 1;
            font-weight: 600;
        }

        .score-item .team-score {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--primary);
        }

        .waiting-next {
            margin-top: 25px;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Final Results */
        .final-screen .final-box {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 40px 25px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .trophy-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .final-title {
            font-size: 1.8rem;
            font-weight: 900;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .your-score {
            font-size: 3rem;
            font-weight: 900;
            color: var(--primary);
            margin: 20px 0;
        }

        /* Kicked Screen */
        .kicked-box {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger);
            border-radius: 24px;
            padding: 40px 25px;
            max-width: 350px;
            width: 100%;
            text-align: center;
        }

        .kicked-box .icon {
            font-size: 4rem;
            color: var(--danger);
            margin-bottom: 20px;
        }

        .kicked-box h2 {
            color: var(--danger);
            margin-bottom: 10px;
        }

        .kicked-box p {
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <div class="container">
        <!-- Login Screen -->
        <div class="screen active" id="loginScreen">
            <div class="login-box">
                <div class="icon"><i class="fas fa-gamepad"></i></div>
                <h1>ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©</h1>
                <p>ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿØÿÆŸàŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ</p>
                <form id="loginForm">
                    <div class="code-input">
                        <input type="tel" id="playerCode" placeholder="00" maxlength="2" autocomplete="off" inputmode="numeric" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="loginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        ÿØÿÆŸàŸÑ
                    </button>
                </form>
                <p class="error-message" id="loginError">
                    <i class="fas fa-exclamation-circle"></i>
                    ÿ±ŸÇŸÖ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠
                </p>
            </div>
        </div>

        <!-- Waiting Screen -->
        <div class="screen" id="waitingScreen">
            <div class="player-info">
                <div class="player-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="player-name" id="playerName">-</div>
                <div class="player-team" id="playerTeam">-</div>
                <div class="waiting-indicator">
                    <span>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑŸÖÿ¥ÿ±ŸÅ</span>
                    <div class="dots">
                        <span class="dot"></span>
                        <span class="dot"></span>
                        <span class="dot"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div class="screen question-screen" id="questionScreen">
            <div class="question-header">
                <div class="score-display">
                    <i class="fas fa-star"></i>
                    <span id="currentScore">0</span>
                </div>
                <div class="team-badge" id="teamBadge">-</div>
            </div>
            <div class="question-content">
                <div class="question-text" id="questionText">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ§ÿßŸÑ...</div>
                <div class="options-container" id="optionsContainer"></div>
            </div>
        </div>

        <!-- Scores Screen -->
        <div class="screen scores-screen" id="scoresScreen">
            <div class="scores-box">
                <div class="scores-title">
                    <i class="fas fa-chart-bar"></i>
                    <span>ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ≠ÿßŸÑŸäÿ©</span>
                </div>
                <div class="scores-list" id="scoresList"></div>
                <div class="waiting-next">
                    <i class="fas fa-hourglass-half"></i>
                    <span>ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä...</span>
                </div>
            </div>
        </div>

        <!-- Final Screen -->
        <div class="screen final-screen" id="finalScreen">
            <div class="final-box">
                <div class="trophy-icon">üèÜ</div>
                <div class="final-title" id="finalTitle">ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ¨ŸàŸÑÿ©!</div>
                <div class="your-score" id="yourFinalScore">0</div>
                <p style="color: rgba(255,255,255,0.6);">ŸÜŸÇÿßÿ∑ŸÉ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©</p>
                <div class="scores-list" id="finalScoresList" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Kicked Screen -->
        <div class="screen" id="kickedScreen">
            <div class="kicked-box">
                <div class="icon"><i class="fas fa-ban"></i></div>
                <h2>ÿ™ŸÖ ŸÇÿ∑ÿπ ÿßŸÑÿßÿ™ÿµÿßŸÑ</h2>
                <p>ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÜ ÿ¨Ÿáÿßÿ≤ ÿ¢ÿÆÿ± ÿ£Ÿà ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ™ŸÉ ŸÖŸÜ ÿßŸÑÿ¨ŸàŸÑÿ©</p>
            </div>
        </div>

        <!-- Result Overlay -->
        <div class="result-overlay" id="resultOverlay">
            <div class="result-icon" id="resultIcon"><i class="fas fa-check-circle"></i></div>
            <div class="result-title" id="resultTitle">ŸÜÿ™Ÿäÿ¨ÿ©</div>
            <div class="result-subtitle" id="resultSubtitle">-</div>
            <div class="result-points" id="resultPoints">+10</div>
            <div class="second-chance-timer" id="secondChanceTimer" style="display: none;">10</div>
            <div class="countdown-text" id="countdownText" style="display: none;">ÿ´ÿßŸÜŸäÿ©</div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBxPO6RKsQ1Cq-mqlCpFTrCuIyxnYdB37U",
            authDomain: "studentsystem-c1ab1.firebaseapp.com",
            databaseURL: "https://studentsystem-c1ab1-default-rtdb.firebaseio.com",
            projectId: "studentsystem-c1ab1",
            storageBucket: "studentsystem-c1ab1.firebasestorage.app",
            messagingSenderId: "112215023848",
            appId: "1:112215023848:web:0adba326a527ee7e37e95d"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        const rootRef = db.ref('quiz_competition');

        // App State
        let roundId = null;
        let playerCode = null;
        let playerData = null;
        let sessionId = null;
        let currentQuestion = null;
        let hasAnswered = false;
        let teamsData = {};
        let secondChanceInterval = null;

        // Sound Effects
        const sounds = {};

        function initSounds() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;

            const audioCtx = new AudioContext();
            sounds.audioCtx = audioCtx;

            sounds.playCorrect = () => {
                if (!sounds.audioCtx) return;
                const ctx = sounds.audioCtx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(523.25, ctx.currentTime);
                osc.frequency.setValueAtTime(659.25, ctx.currentTime + 0.1);
                osc.frequency.setValueAtTime(783.99, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.4);
            };

            sounds.playWrong = () => {
                if (!sounds.audioCtx) return;
                const ctx = sounds.audioCtx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(200, ctx.currentTime);
                osc.frequency.setValueAtTime(150, ctx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.4);
            };

            sounds.playBuzzer = () => {
                if (!sounds.audioCtx) return;
                const ctx = sounds.audioCtx;
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.15);
                osc.start(ctx.currentTime);
                osc.stop(ctx.currentTime + 0.15);
            };
        }

        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Login Form
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const code = document.getElementById('playerCode').value.trim();
            const loginBtn = document.getElementById('loginBtn');
            const errorEl = document.getElementById('loginError');

            if (!code || code.length !== 2) {
                errorEl.style.display = 'block';
                errorEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸäŸÜ';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const roundsSnapshot = await rootRef.child('rounds').orderByChild('status').equalTo('active').once('value');
                const rounds = roundsSnapshot.val() || {};

                let foundRound = null;
                let foundPlayer = null;

                for (const [rId, round] of Object.entries(rounds)) {
                    if (round.players && round.players[code]) {
                        foundRound = rId;
                        foundPlayer = round.players[code];
                        break;
                    }
                }

                if (!foundPlayer) {
                    errorEl.style.display = 'block';
                    errorEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ÿ±ŸÇŸÖ ÿßŸÑÿØÿÆŸàŸÑ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠';
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ÿØÿÆŸàŸÑ';
                    return;
                }

                roundId = foundRound;
                playerCode = code;
                playerData = foundPlayer;
                sessionId = generateSessionId();

                await rootRef.child(`rounds/${roundId}/players/${playerCode}`).update({
                    sessionId: sessionId,
                    online: true,
                    lastSeen: Date.now()
                });

                showScreen('waitingScreen');
                updatePlayerInfo();
                listenToRound();
                setupPresence();
                initSounds();

            } catch (error) {
                console.error('Login error:', error);
                errorEl.style.display = 'block';
                errorEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£';
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ÿØÿÆŸàŸÑ';
            }
        });

        function setupPresence() {
            const playerRef = rootRef.child(`rounds/${roundId}/players/${playerCode}`);

            playerRef.onDisconnect().update({
                online: false
            });

            setInterval(() => {
                playerRef.update({
                    lastSeen: Date.now()
                });
            }, 30000);

            playerRef.child('sessionId').on('value', (snapshot) => {
                const currentSessionId = snapshot.val();
                if (currentSessionId && currentSessionId !== sessionId) {
                    showScreen('kickedScreen');
                    if (sounds.playWrong) sounds.playWrong();
                }
            });
        }

        function updatePlayerInfo() {
            document.getElementById('playerName').textContent = playerData.name;
            document.getElementById('playerTeam').textContent = playerData.teamName;
            document.getElementById('teamBadge').textContent = playerData.teamName;
        }

        function listenToRound() {
            // Listen to player data
            rootRef.child(`rounds/${roundId}/players/${playerCode}`).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    playerData = data;
                    document.getElementById('currentScore').textContent = playerData.score || 0;
                }
            });

            // Listen to teams
            rootRef.child(`rounds/${roundId}/teams`).on('value', (snapshot) => {
                teamsData = snapshot.val() || {};
            });

            // Listen to current question
            rootRef.child(`rounds/${roundId}/currentQuestion`).on('value', (snapshot) => {
                const question = snapshot.val();
                handleQuestionUpdate(question);
            });

            // Listen to round status
            rootRef.child(`rounds/${roundId}/status`).on('value', (snapshot) => {
                const status = snapshot.val();
                if (status === 'finished') {
                    showFinalResults();
                }
            });
        }

        function handleQuestionUpdate(question) {
            if (!question) {
                // No question - show scores
                showScreen('scoresScreen');
                renderScores();
                hideResultOverlay();
                return;
            }

            currentQuestion = question;

            if (question.status === 'open') {
                hasAnswered = false;
                showScreen('questionScreen');
                renderQuestion(question);
                hideResultOverlay();
                if (sounds.playBuzzer) sounds.playBuzzer();

            } else if (question.status === 'locked') {
                if (question.lockedBy === playerCode) {
                    // I answered - waiting for result
                } else if (!hasAnswered) {
                    // Someone else answered first
                    showResultOverlay(
                        'warning',
                        `${question.lockedByTeamName} ÿ£ÿ¨ÿßÿ® ÿ£ŸàŸÑÿßŸã!`,
                        'ÿßŸÜÿ™ÿ∏ÿ± ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©...',
                        ''
                    );
                    disableOptions();
                }

            } else if (question.status === 'secondChance') {
                if (question.excludedPlayer === playerCode) {
                    // I'm excluded - show my wrong result
                    showResultOverlay(
                        'danger',
                        'ÿ•ÿ¨ÿßÿ®ÿ™ŸÉ ÿÆÿßÿ∑ÿ¶ÿ©!',
                        'ÿ™ŸÖ ÿÆÿµŸÖ 10 ŸÜŸÇÿßÿ∑',
                        '-10',
                        true
                    );
                } else if (!hasAnswered) {
                    // Second chance for me!
                    showResultOverlay(
                        'warning',
                        `${question.lockedByTeamName} ÿ£ÿ¨ÿßÿ® ÿÆÿ∑ÿ£!`,
                        'ŸÅÿ±ÿµÿ™ŸÉ ÿßŸÑÿ¢ŸÜ! ÿ£ÿ¨ÿ® ÿ®ÿ≥ÿ±ÿπÿ©',
                        '',
                        false,
                        question.secondChanceEndsAt
                    );
                    setTimeout(() => {
                        hideResultOverlay();
                        showScreen('questionScreen');
                        enableOptions();
                    }, 1500);
                }

            } else if (question.status === 'revealed' || question.status === 'answered') {
                // Show correct answer and go to scores
                if (question.lastAnswerCorrect && question.lastAnswerBy) {
                    showResultOverlay(
                        'success',
                        `${question.lastAnswerTeamName} ÿ£ÿ¨ÿßÿ® ÿµÿ≠Ÿäÿ≠ÿßŸã!`,
                        'ÿ≠ÿµŸÑ ÿπŸÑŸâ 10 ŸÜŸÇÿßÿ∑',
                        '+10'
                    );
                }
                setTimeout(() => {
                    hideResultOverlay();
                    showScreen('scoresScreen');
                    renderScores();
                }, 2500);
            }
        }

        function renderQuestion(question) {
            document.getElementById('questionText').textContent = question.text;

            const letters = { a: 'ÿ£', b: 'ÿ®', c: 'ÿ¨', d: 'ÿØ' };
            document.getElementById('optionsContainer').innerHTML = ['a', 'b', 'c', 'd'].map(key => `
                <button class="option-btn" data-answer="${key}" onclick="selectAnswer('${key}')">
                    <span class="option-letter">${letters[key]}</span>
                    <span>${question.options[key]}</span>
                </button>
            `).join('');
        }

        async function selectAnswer(answer) {
            if (hasAnswered) return;

            hasAnswered = true;

            document.querySelectorAll('.option-btn').forEach(btn => {
                if (btn.dataset.answer === answer) {
                    btn.style.background = 'rgba(99, 102, 241, 0.3)';
                    btn.style.borderColor = 'var(--primary)';
                }
            });

            disableOptions();

            const questionRef = rootRef.child(`rounds/${roundId}/currentQuestion`);

            try {
                const result = await questionRef.transaction((current) => {
                    if (current && (current.status === 'open' || current.status === 'secondChance')) {
                        if (current.status === 'open') {
                            current.status = 'locked';
                            current.lockedBy = playerCode;
                            current.lockedByName = playerData.name;
                            current.lockedByTeamName = playerData.teamName;
                            current.lockedByTeamId = playerData.teamId;
                        }
                        return current;
                    }
                    return;
                });

                if (result.committed) {
                    const isCorrect = currentQuestion.correct === answer;
                    const isSecondChance = currentQuestion.status === 'secondChance';

                    await rootRef.child(`rounds/${roundId}/answers/${playerCode}`).set({
                        playerCode: playerCode,
                        playerName: playerData.name,
                        teamId: playerData.teamId,
                        teamName: playerData.teamName,
                        answer: answer,
                        isCorrect: isCorrect,
                        isSecondChance: isSecondChance,
                        timestamp: Date.now()
                    });

                    let points = 0;
                    if (isCorrect) {
                        points = 10;
                        if (sounds.playCorrect) sounds.playCorrect();
                    } else {
                        if (!isSecondChance) {
                            points = -10;
                        }
                        if (sounds.playWrong) sounds.playWrong();
                    }

                    // Update player score
                    const newScore = (playerData.score || 0) + points;
                    await rootRef.child(`rounds/${roundId}/players/${playerCode}/score`).set(newScore);

                    // Update team score
                    await rootRef.child(`rounds/${roundId}/teams/${playerData.teamId}/score`).transaction(current => (current || 0) + points);

                    // Mark the answer
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        if (btn.dataset.answer === answer) {
                            btn.classList.add(isCorrect ? 'correct' : 'wrong');
                        }
                    });

                    if (isCorrect) {
                        // Correct answer - update question status
                        await questionRef.update({
                            status: 'answered',
                            lastAnswerCorrect: true,
                            lastAnswerBy: playerCode,
                            lastAnswerTeamName: playerData.teamName
                        });

                        showResultOverlay(
                            'success',
                            'ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©!',
                            'ÿ£ÿ≠ÿ≥ŸÜÿ™! ÿ≠ÿµŸÑÿ™ ÿπŸÑŸâ 10 ŸÜŸÇÿßÿ∑',
                            '+10'
                        );
                    } else {
                        if (isSecondChance) {
                            // Wrong in second chance - no deduction
                            showResultOverlay(
                                'danger',
                                'ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©!',
                                'ŸÑÿß ŸäŸàÿ¨ÿØ ÿÆÿµŸÖ ŸÅŸä ÿßŸÑŸÅÿ±ÿµÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©',
                                '0'
                            );
                        } else {
                            // Wrong first answer - start second chance
                            await questionRef.update({
                                status: 'secondChance',
                                excludedPlayer: playerCode,
                                secondChanceEndsAt: Date.now() + 10000,
                                lastAnswerCorrect: false,
                                lastAnswerBy: playerCode,
                                lastAnswerTeamName: playerData.teamName
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Answer error:', error);
                hasAnswered = false;
                enableOptions();
            }
        }

        function showResultOverlay(type, title, subtitle, points, showAsDeducted = false, countdownTo = null) {
            const overlay = document.getElementById('resultOverlay');
            const iconEl = document.getElementById('resultIcon');
            const titleEl = document.getElementById('resultTitle');
            const subtitleEl = document.getElementById('resultSubtitle');
            const pointsEl = document.getElementById('resultPoints');
            const timerEl = document.getElementById('secondChanceTimer');
            const countdownTextEl = document.getElementById('countdownText');

            const icons = {
                success: '<i class="fas fa-check-circle"></i>',
                danger: '<i class="fas fa-times-circle"></i>',
                warning: '<i class="fas fa-exclamation-circle"></i>'
            };

            iconEl.className = 'result-icon ' + type;
            iconEl.innerHTML = icons[type];
            titleEl.textContent = title;
            subtitleEl.textContent = subtitle;

            if (points) {
                pointsEl.textContent = points;
                pointsEl.className = 'result-points ' + (points.startsWith('+') ? 'positive' : points.startsWith('-') ? 'negative' : '');
                pointsEl.style.display = 'block';
            } else {
                pointsEl.style.display = 'none';
            }

            if (countdownTo) {
                timerEl.style.display = 'block';
                countdownTextEl.style.display = 'block';
                startCountdown(countdownTo);
            } else {
                timerEl.style.display = 'none';
                countdownTextEl.style.display = 'none';
                if (secondChanceInterval) clearInterval(secondChanceInterval);
            }

            overlay.classList.add('active');
        }

        function hideResultOverlay() {
            document.getElementById('resultOverlay').classList.remove('active');
            if (secondChanceInterval) clearInterval(secondChanceInterval);
        }

        function startCountdown(endsAt) {
            const timerEl = document.getElementById('secondChanceTimer');

            if (secondChanceInterval) clearInterval(secondChanceInterval);

            secondChanceInterval = setInterval(() => {
                const remaining = Math.max(0, Math.ceil((endsAt - Date.now()) / 1000));
                timerEl.textContent = remaining;

                if (remaining <= 0) {
                    clearInterval(secondChanceInterval);
                }
            }, 100);
        }

        function disableOptions() {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = true;
            });
        }

        function enableOptions() {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.disabled = false;
            });
        }

        function renderScores() {
            const container = document.getElementById('scoresList');
            const teamsArray = Object.entries(teamsData).sort((a, b) => (b[1].score || 0) - (a[1].score || 0));

            const ranks = ['ü•á', 'ü•à', 'ü•â'];

            container.innerHTML = teamsArray.map(([id, team], index) => `
                <div class="score-item ${id === playerData.teamId ? 'my-team' : ''}">
                    <span class="rank">${ranks[index] || (index + 1)}</span>
                    <span class="team-name">${team.name}</span>
                    <span class="team-score">${team.score || 0}</span>
                </div>
            `).join('');
        }

        function showFinalResults() {
            showScreen('finalScreen');

            document.getElementById('yourFinalScore').textContent = playerData.score || 0;

            const teamsArray = Object.entries(teamsData).sort((a, b) => (b[1].score || 0) - (a[1].score || 0));
            const winner = teamsArray.length > 0 ? teamsArray[0][1].name : '';
            const isWinner = teamsArray.length > 0 && teamsArray[0][0] === playerData.teamId;

            document.getElementById('finalTitle').textContent = isWinner ? 'üéâ ŸÅÿ±ŸäŸÇŸÉ ŸÅÿßÿ≤!' : 'ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ¨ŸàŸÑÿ©!';

            const ranks = ['ü•á', 'ü•à', 'ü•â'];
            document.getElementById('finalScoresList').innerHTML = teamsArray.map(([id, team], index) => `
                <div class="score-item ${id === playerData.teamId ? 'my-team' : ''}">
                    <span class="rank">${ranks[index] || (index + 1)}</span>
                    <span class="team-name">${team.name}</span>
                    <span class="team-score">${team.score || 0}</span>
                </div>
            `).join('');
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Auto-focus code input
        document.getElementById('playerCode').addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
        });
    </script>
</body>
</html>
