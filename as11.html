<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الكيمياء التفاعلي</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 24px;
            /* منع التظليل والتكبير */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: default;
        }

        .student-info {
            background-color: #e0f2fe;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #bae6fd;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .section-title {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-top: 30px;
            margin-bottom: 20px;
        }

        .question-card {
            background-color: #fff;
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .question-card:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .question-text {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .options label {
            display: block;
            margin: 5px 0;
            font-weight: normal;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        .options label:hover {
            background-color: #f9fafb;
        }

        input[type="radio"] {
            margin-left: 10px;
        }

        button.submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }

        button.submit-btn:hover {
            background-color: var(--secondary-color);
        }

        button.submit-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        #result-area {
            display: none;
            margin-top: 20px;
            padding: 40px;
            background-color: #dcfce7;
            border: 1px solid #86efac;
            border-radius: 8px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #166534;
        }

        .error-msg {
            color: red;
            font-size: 14px;
            display: none;
            margin-top: 5px;
        }

        /* تنسيق النافذة المنبثقة للنتائج */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
        }

        .close {
            color: #aaa;
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        table.results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table.results-table th, table.results-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }

        table.results-table th {
            background-color: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <!-- تمت إضافة خاصية النقر المزدوج ومنع التحديد -->
        <h1 ondblclick="showResults()" title="انقر نقراً مزدوجاً لعرض النتائج">اختبار كيمياء تفاعلي</h1>
        <p>الرجاء تعبئة البيانات والإجابة على جميع الأسئلة بدقة</p>
    </header>

    <div class="student-info">
        <h3>بيانات الطالب</h3>
        <div class="form-group">
            <label for="studentName">اسم الطالب:</label>
            <input type="text" id="studentName" placeholder="اكتب اسمك الثلاثي" required>
        </div>
        <div class="form-group">
            <label for="studentClass">الصف:</label>
            <input type="text" id="studentClass" placeholder="مثال: الثالث ثانوي - أ" required>
        </div>
        <div class="form-group">
            <label for="studentId">رقم السجل:</label>
            <input type="number" id="studentId" placeholder="اكتب رقم السجل" required>
        </div>
    </div>

    <form id="quizForm" onsubmit="return false;">
        <!-- سيتم توليد الأسئلة هنا بواسطة JavaScript -->
        <div id="questions-container"></div>

        <div id="error-message" class="error-msg" style="text-align: center; font-size: 16px; margin-bottom: 10px;">
            الرجاء الإجابة على جميع الأسئلة وتعبئة البيانات قبل الإرسال.
        </div>

        <button type="button" class="submit-btn" onclick="submitQuiz()" id="submitBtn">إرسال الإجابة</button>
    </form>

    <div id="result-area"></div>
</div>

<!-- Modal لعرض النتائج -->
<div id="resultsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeResults()">&times;</span>
    <h2 style="color: var(--primary-color); margin-top: 0;">نتائج الطلاب</h2>
    <div id="resultsList">جاري التحميل...</div>
  </div>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
    // 1. Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBxPO6RKsQ1Cq-mqlCpFTrCuIyxnYdB37U",
        authDomain: "studentsystem-c1ab1.firebaseapp.com",
        databaseURL: "https://studentsystem-c1ab1-default-rtdb.firebaseio.com",
        projectId: "studentsystem-c1ab1",
        storageBucket: "studentsystem-c1ab1.firebasestorage.app",
        messagingSenderId: "112215023848",
        appId: "1:112215023848:web:0adba326a527ee7e37e95d"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const rootRef = db.ref('q1');

    // 2. Data: Questions and Answers
    const trueFalseQuestions = [
        { id: "tf1", q: "العدد الأقصى من الإلكترونات الذي يستوعبها مستوى الطاقة الثانوي s هي 6 إلكترونات.", a: "false" },
        { id: "tf2", q: "تزداد طاقة التأين غالباً من اليسار إلى اليمين عبر الدورات في الجدول الدوري.", a: "true" },
        { id: "tf3", q: "يتغير عدد البروتونات في النواة في أثناء عملية تكوين الأيون.", a: "false" },
        { id: "tf4", q: "للفلور أكبر قيمة كهروسالبية في حين أن عنصر الفرانسيوم أقل قيمة.", a: "true" },
        { id: "tf5", q: "من مشاكل التجارب العملية قد تلتصق المواد المتفاعلة والناتجة في الحالة السائلة على سطوح الأوعية أو تتبخر.", a: "true" },
        { id: "tf6", q: "يُستخدم قانون جراهام للمقارنة بين معدل انتشار غازين.", a: "true" },
        { id: "tf7", q: "تتفق السوائل مع الغازات في أنها غير قابلة للانضغاط.", a: "false" },
        { id: "tf8", q: "يربط قانون الغاز المثالي كمية الغاز مع ضغطه ودرجة حرارته وحجمه.", a: "true" },
        { id: "tf9", q: "الأملاح المائية مركبات أيونية سائلة فيها جزيئات ماء محتجزة.", a: "false" },
        { id: "tf10", q: "يتطلب حل مسألة في الحسابات الكيميائية كتابة معادلة كيميائية موزونة.", a: "true" }
    ];

    const mcqQuestions = [
        { id: "mc1", q: "يُسمى النموذج المستخدم في تحديد شكل الجزيء نموذج:", options: ["VSEPR", "لويس", "بور", "مندليف"], a: 0 },
        { id: "mc2", q: "حالة تحدث عندما يكون هناك احتمال لرسم أكثر من تركيب لويس لشكل الجزيء أو الأيون:", options: ["الرنين", "التهجين", "القطبية", "التساهم الكلي"], a: 0 },
        { id: "mc3", q: "تُسمى الروابط التساهمية الأحادية بروابط:", options: ["الثنائية", "العديدة", "باي", "سيجما"], a: 3 },
        { id: "mc4", q: "يُسمى المركب الأيوني الذي يوصل محلوله التيار الكهربائي باسم:", options: ["الإلكتروليت", "غير القطبي", "الأيون المتفرج", "البلوري"], a: 0 },
        { id: "mc5", q: "تمثل الأرقام في ........... أصغر نسبة عددية صحيحة لمولات العناصر في المركب:", options: ["الصيغة الجزيئية", "الصيغة الأولية", "الكتلة المولية", "النسبة المئوية"], a: 1 },
        { id: "mc6", q: "هو جسيم لا كتلة له يحمل كماً من الطاقة:", options: ["البروتون", "الفوتون", "الإلكترون", "النيترون"], a: 1 },
        { id: "mc7", q: "تصف ........... سلوك المادة بالاعتماد على حركة جسيماتها:", options: ["القاعدة الثمانية", "نظرية الحركة الجزيئية", "نظرية بور", "نظرية دالتون"], a: 1 },
        { id: "mc8", q: "عدد مولات CO2 التي تنتج عن احتراق 10 مول من C3H8 في كمية وافرة من الأكسجين هي:", options: ["19", "30", "20", "25"], a: 1 },
        { id: "mc9", q: "هي المادة التي تُستهلك تماماً في التفاعل الكيميائي وتحدد كمية المادة الناتجة:", options: ["المادة الفائضة", "المادة المحددة للتفاعل", "المحفز", "المذيب"], a: 1 },
        { id: "mc10", q: "تُسمى دراسة العلاقات الكمية بين المواد المتفاعلة والمواد الناتجة في التفاعل الكيميائي:", options: ["الحسابات الكيميائية", "المعادلة الموزونة", "قانون حفظ الطاقة", "الكتلة المولية"], a: 0 },
        { id: "mc11", q: "مقياس مقاومة السائل للتدفق والانسياب يسمى:", options: ["الخاصية الشعرية", "التوتر السطحي", "الزوجة", "الترسب"], a: 2 },
        { id: "mc12", q: "يُعرف الحمض الذي يتألف من الهيدروجين وأيون أكسجيني باسم:", options: ["حمض عضوي", "حمض ثنائي", "حمض أكسجيني", "ملح قاعدي"], a: 2 },
        { id: "mc13", q: "تتألف المجموعة 17 في الجدول الدوري من عناصر شديدة التفاعل وتُعرف باسم:", options: ["الغازات النبيلة", "الفلزات القلوية", "الهالوجينات", "القلوية الأرضية"], a: 2 },
        { id: "mc14", q: "عملية تحول المادة من الحالة الغازية إلى الحالة الصلبة دون المرور بالحالة السائلة تسمى:", options: ["التسامي", "التبخر", "الترسب", "التجمد"], a: 2 },
        { id: "mc15", q: "يتكون الأيون الموجب عندما تفقد الذرة إلكتروناً واحداً أو أكثر ويسمى:", options: ["الأنيون", "الفوتون", "الكاتيون", "الأيون المتفرج"], a: 2 },
        { id: "mc16", q: "المقياس الذي يعبر عن قابلية الذرة على استقبال الإلكترون هو:", options: ["الرابطة الأيونية", "الميل الإلكتروني", "العدد الذري", "الكهروسالبية"], a: 1 },
        { id: "mc17", q: "جهاز قياس الضغط الذي يُستخدم لقياس الضغط المحصور هو:", options: ["البارومتر", "الترمومتر", "تورشلي", "المانومتر"], a: 3 },
        { id: "mc18", q: "يتناسب حجم مقدار محدد من الغاز عكسياً مع الضغط الواقع عليه عند ثبوت درجة حرارته:", options: ["قانون شارل", "قانون جاي لوساك", "القانون العام للغازات", "قانون بويل"], a: 3 },
        { id: "mc19", q: "من القوى التالية تحدث بين الجزيئات القطبية:", options: ["قوى التشتت", "الرابطة الفلزية", "الرابطة التساهمية", "ثنائية القطبية"], a: 3 },
        { id: "mc20", q: "تعرف أكبر كمية من المادة الناتجة يمكن الحصول عليها من كميات معينة من المواد المتفاعلة بـ:", options: ["المردود الفعلي", "نسبة المردود المئوية", "الكتلة المولية", "المردود النظري"], a: 3 },
        { id: "mc21", q: "الوحدة العالمية لقياس الضغط هي:", options: ["باسكال", "الجول", "المتر", "الجرام"], a: 0 },
        { id: "mc22", q: "ما هو المصطلح الذي يصف الموقع المحتمل لوجود الإلكترون:", options: ["المجال", "النواة", "العدد الكمي", "الفراغ"], a: 0 },
        { id: "mc23", q: "الصيغة الكيميائية للمركب الأيوني أكسيد البوتاسيوم هي:", options: ["K2O", "KO", "K2O2", "HKO2"], a: 0 },
        { id: "mc24", q: "المادة المحددة للتفاعل والتي تُستهلك كلياً في تفاعل احتراق الخشب هي:", options: ["الأكسجين", "الخشب", "الهيدروجين", "لا شيء مما ذكر"], a: 1 },
        { id: "mc25", q: "العلاقة التي يدرسها قانون شارل تكون بين:", options: ["الحرارة والضغط", "الحجم والحرارة", "الحجم والضغط", "الحرارة فقط"], a: 1 },
        { id: "mc26", q: "إذا كان ضغط عينة من غاز الهيليوم في إناء حجمه 1L هو 0.988atm فما مقدار ضغط هذه العينة إذا نُقلت إلى وعاء حجمه 2L:", options: ["0.11", "0.494", "0.909", "0.550"], a: 1 },
        { id: "mc27", q: "هو أقل كمية من الطاقة يمكن أن تكتسبها الذرة أو تفقدها:", options: ["الشحنة", "الكم", "طاقة الفوتون", "لا شيء مما ذكر"], a: 1 },
        { id: "mc28", q: "يُعرف تكرار الخواص الكيميائية والفيزيائية عند ترتيب العناصر تصاعدياً وفق أعدادها الذرية بـ:", options: ["تدرج الخواص", "الكتلة الذرية", "العدد الذري", "عدد البروتونات"], a: 0 },
        { id: "mc29", q: "عندما ترتبط ذرتان أو أكثر برابطة تساهمية يتكون:", options: ["الجزيء", "الأيون", "رابطة هيدروجينية", "البروتون"], a: 0 },
        { id: "mc30", q: "احسب عدد مولات غاز الأمونيا NH3 الموجودة في وعاء حجمه 3L عند درجة حرارة 300K وضغط 1.5atm:", options: ["0.18", "0.5", "0.11", "0.90"], a: 0 }
    ];

    // 3. Render Questions
    const container = document.getElementById('questions-container');

    // Render True/False
    const tfTitle = document.createElement('h2');
    tfTitle.className = 'section-title';
    tfTitle.innerText = 'السؤال الأول: ضع علامة (✓) أو (✗)';
    container.appendChild(tfTitle);

    trueFalseQuestions.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
            <div class="question-text">${index + 1}. ${item.q}</div>
            <div class="options">
                <label><input type="radio" name="${item.id}" value="true"> صح (✓)</label>
                <label><input type="radio" name="${item.id}" value="false"> خطأ (✗)</label>
            </div>
        `;
        container.appendChild(card);
    });

    // Render MCQ
    const mcqTitle = document.createElement('h2');
    mcqTitle.className = 'section-title';
    mcqTitle.innerText = 'السؤال الثاني: اختر الإجابة الصحيحة';
    container.appendChild(mcqTitle);

    mcqQuestions.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        let optionsHtml = '';
        const letters = ['أ', 'ب', 'ج', 'د'];
        item.options.forEach((opt, idx) => {
            optionsHtml += `<label><input type="radio" name="${item.id}" value="${idx}"> ${letters[idx]}) ${opt}</label>`;
        });
        
        card.innerHTML = `
            <div class="question-text">${index + 1}. ${item.q}</div>
            <div class="options">
                ${optionsHtml}
            </div>
        `;
        container.appendChild(card);
    });

    // 4. Submission & Grading Logic
    function submitQuiz() {
        const submitBtn = document.getElementById('submitBtn');
        const errorMsg = document.getElementById('error-message');
        const name = document.getElementById('studentName').value.trim();
        const sClass = document.getElementById('studentClass').value.trim();
        const sId = document.getElementById('studentId').value.trim();

        // Validation
        if (!name || !sClass || !sId) {
            errorMsg.style.display = 'block';
            errorMsg.innerText = "الرجاء تعبئة جميع بيانات الطالب.";
            window.scrollTo(0, 0);
            return;
        }

        let score = 0;
        let totalQuestions = trueFalseQuestions.length + mcqQuestions.length;
        let allAnswered = true;

        // Calculate TF Score
        trueFalseQuestions.forEach(q => {
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            if (!selected) allAnswered = false;
            else if (selected.value === q.a) score++;
        });

        // Calculate MCQ Score
        mcqQuestions.forEach(q => {
            const selected = document.querySelector(`input[name="${q.id}"]:checked`);
            if (!selected) allAnswered = false;
            else if (parseInt(selected.value) === q.a) score++;
        });

        if (!allAnswered) {
            errorMsg.style.display = 'block';
            errorMsg.innerText = "الرجاء الإجابة على جميع الأسئلة قبل الإرسال.";
            return;
        }

        errorMsg.style.display = 'none';
        submitBtn.disabled = true;
        submitBtn.innerText = "جاري الإرسال...";

        // Prepare Data
        const studentData = {
            name: name,
            class: sClass,
            registryId: sId,
            score: score,
            total: totalQuestions,
            timestamp: new Date().toLocaleString('ar-SA')
        };

        // Send to Firebase
        rootRef.push(studentData)
            .then(() => {
                const resultArea = document.getElementById('result-area');
                document.getElementById('quizForm').style.display = 'none';
                document.querySelector('.student-info').style.display = 'none';
                
                resultArea.style.display = 'block';
                // تم تعديل الرسالة وإضافة زر العودة
                resultArea.innerHTML = `
                    <p style="font-size: 24px;">تم استلام الإجابة</p>
                    <button class="submit-btn" style="width: auto; padding: 10px 20px; background-color: #059669;" onclick="location.reload()">الرجوع للأسئلة</button>
                `;
                window.scrollTo(0, 0);
            })
            .catch((error) => {
                console.error("Error writing to database: ", error);
                errorMsg.style.display = 'block';
                errorMsg.innerText = "حدث خطأ أثناء الإرسال، تأكد من الاتصال بالإنترنت وحاول مرة أخرى.";
                submitBtn.disabled = false;
                submitBtn.innerText = "إرسال الإجابة";
            });
    }

    // دوال النافذة المنبثقة للنتائج
    function showResults() {
        const modal = document.getElementById('resultsModal');
        const list = document.getElementById('resultsList');
        
        modal.style.display = 'block';
        list.innerHTML = '<div style="text-align:center; padding: 20px;">جاري تحميل البيانات...</div>';

        // جلب البيانات من فايربيس
        rootRef.once('value')
            .then((snapshot) => {
                list.innerHTML = '';
                if(snapshot.exists()){
                    const data = snapshot.val();
                    let html = '<table class="results-table"><thead><tr><th>الاسم</th><th>الصف</th><th>الدرجة</th></tr></thead><tbody>';
                    
                    // تحويل الكائن إلى مصفوفة للترتيب والعرض
                    Object.values(data).forEach(student => {
                        html += `<tr>
                            <td>${student.name}</td>
                            <td>${student.class}</td>
                            <td>${student.score} / ${student.total}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                    list.innerHTML = html;
                } else {
                    list.innerHTML = '<div style="text-align:center; padding: 20px;">لا توجد نتائج مسجلة حتى الآن.</div>';
                }
            })
            .catch((error) => {
                list.innerHTML = '<div style="color:red; text-align:center; padding: 20px;">حدث خطأ أثناء جلب البيانات. تأكد من الأذونات.</div>';
                console.error(error);
            });
    }

    function closeResults() {
        document.getElementById('resultsModal').style.display = 'none';
    }

    // إغلاق النافذة عند النقر خارجها
    window.onclick = function(event) {
        const modal = document.getElementById('resultsModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

</body>
</html>