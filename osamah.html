<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯ (ØµÙˆØªÙŠØŒ Ø³Ø±Ø¹Ø©ØŒ Ø·Ù„Ø§Ù‚Ø©)</title>
    <style>
        /* --- Ù…ØªØºÙŠØ±Ø§Øª CSS Ù…ÙˆØ­Ø¯Ø© --- */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --focus-color: #27ae60;
            --success: #27ae60;
            --danger: #c0392b;
            --bg-color: #f0f3f6;
            --card-bg: #ffffff;
            --gold: #f1c40f;
            --silver: #bdc3c7;
            --bronze: #cd7f32;
            --highlight: #f1c40f;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ø§Ù… --- */
        .header-area {
            width: 100%;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            position: sticky;
            top: 0;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* --- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª (ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ†) --- */
        .app-tabs {
            display: flex;
            width: 100%;
            max-width: 800px;
            margin-top: 15px;
            padding: 0 20px;
            border-bottom: 2px solid #ddd;
        }
        .app-tab-btn {
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            color: #95a5a6;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .app-tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--accent);
        }
        .app-content {
            width: 100%;
            max-width: 800px;
            padding-bottom: 80px;
        }

        /* --- Ù…ÙƒÙˆÙ†Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª) --- */
        .dashboard-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .player-card, .vc-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .player-card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .player-rank {
            position: absolute; top: 5px; right: 5px; font-size: 0.8rem; font-weight: bold;
            width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; background: #95a5a6;
        }
        .rank-1 { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .rank-2 { background: var(--silver); }
        .rank-3 { background: var(--bronze); }

        .player-name, .vc-card .name { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin: 10px 0 5px 0; }
        .player-score { font-size: 1.8rem; font-weight: 800; color: var(--accent); }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØªÙŠØ© (VoiceComp) --- */
        .vc-header-area {
            text-align: center;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin: 20px;
            border-radius: 15px;
        }
        .vc-live-transcript {
            background: #ecf0f1;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 5px;
            border: 1px solid #bdc3c7;
            min-width: 200px;
        }
        .vc-live-transcript span { color: #d35400; font-weight: bold; }
        .vc-cards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            width: 100%;
        }
        .vc-card .count { font-size: 4rem; font-weight: 800; color: var(--accent); line-height: 1.1; }
        .vc-card.active-target { border-color: var(--focus-color); background-color: #eafaf1; transform: scale(1.02); box-shadow: 0 8px 15px rgba(39, 174, 96, 0.2); }
        .vc-card.dimmed { opacity: 0.6; filter: grayscale(100%); }
        .vc-fixed-footer {
            position: fixed; bottom: 0; left: 0; width: 100%; background: #ffffff; border-top: 1px solid #ddd;
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1); height: 70px;
        }
        .vc-status-text { font-weight: bold; font-size: 0.9rem; }
        .vc-status-idle { color: #e74c3c; }
        .vc-status-listening { color: var(--focus-color); }
        .admin-btn { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; font-size: 0.9rem; cursor: pointer; }


        /* --- Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© (Ù…Ø´ØªØ±ÙƒØ©) --- */
        .game-section {
            display: none; /* Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
            width: 100%; height: 100vh; position: fixed; top: 0; left: 0;
            background: var(--bg-color); z-index: 200; flex-direction: column; align-items: center;
        }
        .game-header {
            width: 100%; padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .back-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .mic-status { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; opacity: 0.2; }
        .mic-active { opacity: 1; color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .mode-selection {
            background: white; padding: 30px; border-radius: 20px; text-align: center; margin-top: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 400px;
        }
        .start-btn-big {
            background: var(--primary); color: white; font-size: 1.5rem; padding: 15px 40px;
            border-radius: 50px; border: none; margin-top: 20px; width: 100%; cursor: pointer;
        }

        /* SpeedRead Specific */
        .sr-target-word {
            font-size: 5.5rem; font-weight: 800; color: var(--primary); margin-top: 40px; opacity: 0;
            transform: scale(0.5); transition: all 0.3s; min-height: 140px; display: flex;
            align-items: center; justify-content: center;
        }
        .sr-target-word.visible { opacity: 1; transform: scale(1); }
        .sr-target-word.correct { color: var(--success); animation: pop 0.3s; }
        .sr-target-word.wrong { color: var(--danger); animation: shake 0.4s; }
        @keyframes pop { 50% { transform: scale(1.2); } }
        @keyframes shake { 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }

        /* Fluency Challenge Specific */
        .fc-text-display-area {
            width: 90%; max-width: 700px; background: white; padding: 30px; border-radius: 15px; margin-top: 20px;
            font-size: 1.8rem; line-height: 2; text-align: justify; direction: rtl; box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: 50vh; overflow-y: auto; position: relative;
        }
        .fc-word-span { padding: 2px 5px; border-radius: 4px; transition: all 0.2s; display: inline-block; }
        .fc-word-span.current { background-color: var(--highlight); transform: scale(1.1); font-weight: bold; }
        .fc-word-span.correct { color: var(--success); }
        .fc-countdown-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.95);
            display: none; justify-content: center; align-items: center; z-index: 300;
        }
        .fc-countdown-number { font-size: 8rem; color: var(--accent); font-weight: bold; animation: zoomIn 0.5s ease-out; }
        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }


        /* --- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø´ØªØ±Ùƒ) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 650px; border-radius: 15px; padding: 20px;
            max-height: 90vh; overflow-y: auto;
        }

        /* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .admin-tabs-nav { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .admin-tab-btn { flex: 1; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; }
        .admin-tab-btn.active { background: var(--primary); color: white; }

        .admin-tab-content { display: none; padding: 10px; border: 1px solid #eee; border-radius: 8px; }
        .admin-tab-content.active { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 8px; border-bottom: 1px solid #eee; text-align: right; }
        input[type="text"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px;}
        .btn-action { padding: 5px 10px; border-radius: 4px; border: none; color: white; cursor: pointer; margin: 2px; }
        .btn-red { background: var(--danger); }
        .btn-blue { background: #2980b9; }

    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div class="header-area">
        <div class="app-title">ğŸŒŸ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯</div>
        <button id="admin-gear" onclick="openAdmin()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">ğŸ”’ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
    </div>

    <div class="app-tabs" id="app-tabs-nav">
        <button class="app-tab-btn active" onclick="switchAppTab('voice-comp', this)">ğŸ™ï¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØªÙŠØ©</button>
        <button class="app-tab-btn" onclick="switchAppTab('speed-read', this)">ğŸ† Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</button>
        <button class="app-tab-btn" onclick="switchAppTab('fluency', this)">â±ï¸ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠØ©</button>
    </div>

    <div id="app-content-container" class="app-content">

        <div id="tab-content-voice" class="app-tab-content active">
            <div class="vc-header-area">
                <h1>ğŸ™ï¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
                <div class="vc-live-transcript"> Ø³Ù…Ø¹Øª: <span id="vc-debug-text">...</span> </div>
                <p style="font-size: 0.8rem; color: #7f8c8d; margin-top: 5px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ø¯ Ù„Ù‡</p>
            </div>
            <div class="vc-cards-container" id="vc-cards-wrapper"> </div>
            <div class="vc-fixed-footer">
                <div id="vc-footer-status" class="vc-status-text vc-status-idle">ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯</div>
            </div>
        </div>

        <div id="tab-content-speed" class="app-tab-content" style="display:none;">
            <div class="sr-dashboard-container" id="sr-dashboard">
                <div style="background: #e8f6f3; padding: 15px; border-radius: 10px; border: 1px solid #d1f2eb; color: #0e6655; font-size: 0.9rem; margin-bottom: 10px;">
                    â„¹ï¸ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©. Ø§Ù„Ù†Ù‚Ø§Ø· ØªØªØ±Ø§ÙƒÙ… Ù…Ø¹ ÙƒÙ„ Ø¬ÙˆÙ„Ø©!
                </div>
                <div class="players-grid" id="sr-players-grid"> </div>
            </div>
        </div>

        <div id="tab-content-fluency" class="app-tab-content" style="display:none;">
            <div class="fc-dashboard-container" id="fc-dashboard">
                <div style="background: #e8f6f3; padding: 15px; border-radius: 10px; border: 1px solid #d1f2eb; color: #0e6655; margin-bottom: 10px;">
                    â„¹ï¸ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±Ø¹Ø©. Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©.
                </div>
                <div class="players-grid" id="fc-players-grid"></div>
            </div>
        </div>

    </div>

    <div class="game-section" id="sr-game-section">
        <div class="game-header">
            <button class="back-btn" onclick="SpeedRead.exitGame()">âœ•</button>
            <div style="font-weight: bold; font-size: 1.2rem;">Ø§Ù„Ù„Ø§Ø¹Ø¨: <span id="sr-active-player-name" style="color:var(--accent);">...</span></div>
            <div style="font-weight: bold;">Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="sr-round-score" style="color:var(--success);">0</span></div>
        </div>
        <div id="sr-mic-icon" class="mic-status">ğŸ™ï¸</div>
        <div id="sr-mode-selector" class="mode-selection">
            <h3>Ø§Ø®ØªØ± Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­Ø¯ÙŠ</h3>
            <button class="mode-btn mode-rocket" onclick="SpeedRead.selectMode(3000, 3, this)">
                <span>ğŸš€ ØµØ§Ø±ÙˆØ® (3 Ø«ÙˆØ§Ù†)</span> <small>3 Ù†Ù‚Ø§Ø·</small>
            </button>
            <button class="mode-btn mode-fast" onclick="SpeedRead.selectMode(5000, 2, this)">
                <span>ğŸ‡ Ø³Ø±ÙŠØ¹ (5 Ø«ÙˆØ§Ù†)</span> <small>2 Ù†Ù‚Ø·Ø©</small>
            </button>
            <button class="mode-btn mode-normal selected active" onclick="SpeedRead.selectMode(7000, 1, this)">
                <span>ğŸ¢ Ø¹Ø§Ø¯ÙŠ (7 Ø«ÙˆØ§Ù†)</span> <small>1 Ù†Ù‚Ø·Ø©</small>
            </button>
            <button class="start-btn-big" onclick="SpeedRead.startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
        </div>
        <div id="sr-active-game-area" style="display: none; width: 100%; flex-direction: column; align-items: center;">
            <div id="sr-word-display" class="sr-target-word">...</div>
            <div class="timer-container" id="sr-timer-container" style="width: 80%; max-width: 400px; height: 12px; background: #ddd; border-radius: 6px; margin: 20px 0; overflow: hidden; display: none;">
                <div class="timer-bar" id="sr-timer-bar"></div>
            </div>
            <div id="sr-feedback-text" style="font-size: 1.5rem; font-weight: bold; height: 40px; margin-top: 20px;"></div>
            <div style="margin-top: 30px; color: #95a5a6; font-size: 0.9rem; border: 1px solid #ddd; padding: 5px 15px; border-radius: 20px;">
                Ø³Ù…Ø¹Øª: <span id="sr-debug-text">...</span>
            </div>
        </div>
    </div>

    <div class="game-section" id="fc-game-section">
        <div class="game-header">
            <button class="back-btn" onclick="Fluency.exitGame()">âœ•</button>
            <div style="font-weight: bold;">Ø§Ù„Ù‚Ø§Ø±Ø¦: <span id="fc-active-player-name" style="color:var(--accent);">...</span></div>
            <div style="font-weight: bold;">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: <span id="fc-current-wpm" style="color:var(--success);">0</span></div>
        </div>
        <div id="fc-mic-icon" class="mic-status">ğŸ™ï¸</div>
        <div id="fc-countdown-layer" class="fc-countdown-overlay">
            <div id="fc-countdown-num" class="fc-countdown-number">3</div>
        </div>
        <div id="fc-mode-selector" class="mode-selection">
            <h3>Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <button class="mode-btn active" onclick="Fluency.selectTime(60, this)">
                <span>â±ï¸ Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø© (Ù‚ÙŠØ§Ø³ÙŠ)</span> <small>60 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            <button class="mode-btn" onclick="Fluency.selectTime(45, this)">
                <span>âš¡ Ø³Ø±ÙŠØ¹</span> <small>45 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            <button class="mode-btn" onclick="Fluency.selectTime(30, this)">
                <span>ğŸ”¥ ØªØ­Ø¯ÙŠ</span> <small>30 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            <button class="start-btn-big" onclick="Fluency.initGameSequence()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
        </div>
        <div id="fc-active-game-area" style="display: none; width: 100%; flex-direction: column; align-items: center;">
            <div class="fc-text-display-area" id="fc-text-container">
                </div>
            <div class="timer-container" style="width: 90%; max-width: 700px; height: 10px; background: #ddd; border-radius: 6px; margin: 20px 0; overflow: hidden;">
                <div class="timer-bar" id="fc-timer-bar"></div>
            </div>
            <div id="fc-timer-text" class="timer-text">0:00</div>
            <div style="margin-top: 20px; color: #95a5a6; font-size: 0.9rem; border: 1px solid #ddd; padding: 5px 15px; border-radius: 20px;">
                Ø³Ù…Ø¹Øª: <span id="fc-debug-text">...</span>
            </div>
        </div>
    </div>

    <div id="fc-end-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h3>
            <p style="font-size: 1.2rem;">Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø© (WPM): <span id="fc-final-wpm" style="color:var(--accent); font-weight:bold; font-size:2rem;">0</span></p>
            <p style="font-size: 0.9rem; color: var(--success);">ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ù„Ùƒ.</p>
            <button onclick="Fluency.finishSession()" style="background:var(--success); color:white; padding:10px 20px; border:none; border-radius:8px; margin-top:15px;">Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø©</button>
        </div>
    </div>


    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</h3>
                <button onclick="document.getElementById('admin-modal').style.display='none'" style="background:var(--danger); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">âœ•</button>
            </div>

            <div class="admin-tabs-nav">
                <button class="admin-tab-btn active" onclick="switchAdminTab('admin-tab-content-voice', this)">ğŸ™ï¸ Ù…Ø³Ø§Ø¨Ù‚Ø© ØµÙˆØªÙŠØ©</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('admin-tab-content-speed', this)">ğŸ† Ù‚Ø±Ø§Ø¡Ø© Ø³Ø±ÙŠØ¹Ø©</button>
                <button class="admin-tab-btn" onclick="switchAdminTab('admin-tab-content-fluency', this)">â±ï¸ Ø·Ù„Ø§Ù‚Ø© Ù‚Ø±Ø§Ø¦ÙŠØ©</button>
            </div>

            <div id="admin-tab-content-voice" class="admin-tab-content active">
                <h4>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† (ØµÙˆØªÙŠ)</h4>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="vc-new-name-input" placeholder="Ø§Ø³Ù… Ù…ØªØ³Ø§Ø¨Ù‚ Ø¬Ø¯ÙŠØ¯..." style="flex:1;">
                    <button onclick="VoiceComp.addNewPerson()" class="btn-action btn-blue">Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <button onclick="VoiceComp.resetAll()" class="btn-action btn-red" style="width:100%; margin-bottom: 10px;">âš ï¸ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
                <div style="max-height: 250px; overflow-y: auto;">
                    <table id="vc-admin-table"> </table>
                </div>
            </div>

            <div id="admin-tab-content-speed" class="admin-tab-content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="SpeedRead.switchAdminSubTab('sr-sub-tab-players', event)">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</button>
                    <button class="tab-btn" onclick="SpeedRead.switchAdminSubTab('sr-sub-tab-words', event)">Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                </div>
                <div id="sr-sub-tab-players">
                    <button onclick="SpeedRead.resetAllScores()" style="width:100%; padding:10px; background:var(--danger); color:white; border:none; border-radius:8px; margin-bottom:10px;">âš ï¸ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹</button>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table id="sr-admin-players-table"> </table>
                    </div>
                </div>
                <div id="sr-sub-tab-words" style="display:none;">
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input type="text" id="sr-new-word-in" placeholder="ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." style="flex:1;">
                        <button onclick="SpeedRead.addWord()" class="btn-action btn-success" style="background:var(--success);">Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table id="sr-admin-words-table"></table>
                    </div>
                    <button onclick="SpeedRead.resetWords()" class="btn-action" style="margin-top:10px; width:100%; background:#95a5a6;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                </div>
            </div>

            <div id="admin-tab-content-fluency" class="admin-tab-content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="Fluency.switchAdminSubTab('fc-sub-tab-players', event)">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</button>
                    <button class="tab-btn" onclick="Fluency.switchAdminSubTab('fc-sub-tab-texts', event)">Ø§Ù„Ù†ØµÙˆØµ</button>
                </div>
                <div id="fc-sub-tab-players">
                    <button onclick="Fluency.resetAllScores()" style="width:100%; padding:10px; background:var(--danger); color:white; border:none; border-radius:8px; margin-bottom:10px;">âš ï¸ ØªØµÙÙŠØ± Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
                    <div style="max-height: 250px; overflow-y: auto;">
                        <table id="fc-admin-players-table"></table>
                    </div>
                </div>
                <div id="fc-sub-tab-texts" style="display:none;">
                    <h4>Ø¥Ø¶Ø§ÙØ© Ù†Øµ Ø¬Ø¯ÙŠØ¯</h4>
                    <textarea id="fc-new-text-in" placeholder="Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù‡Ù†Ø§..."></textarea>
                    <button onclick="Fluency.addText()" class="btn-action btn-success" style="width:100%; background:var(--success);">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ</button>
                    <div style="max-height: 200px; overflow-y: auto; margin-top:15px;">
                        <table id="fc-admin-texts-table"></table>
                    </div>
                    <button onclick="Fluency.resetTexts()" class="btn-action" style="margin-top:10px; width:100%; background:#95a5a6;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                </div>
            </div>

        </div>
    </div>

    <div id="pass-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:300px;">
            <h3>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
            <input type="password" id="admin-pass-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (1234)">
            <button onclick="checkAdminPass()" style="width:100%; padding:10px; margin-top:10px; background:var(--primary); color:white; border:none; border-radius:8px;">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="document.getElementById('pass-modal').style.display='none'" style="margin-top: 10px; background: none; border: none; color: #7f8c8d; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>


<script>
    // **********************************************
    // *** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ÙˆÙ…Ø´ØªØ±ÙƒØ© ***
    // **********************************************

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        // ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø¨Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    let rootRef;
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        rootRef = firebase.database().ref();
    } catch(e) {
        console.warn("Firebase not initialized. Data saving will be local only.", e);
    }
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ (Ù…Ø´ØªØ±Ùƒ Ø¨ÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª)
    let recognition;
    let isRecRunning = false;
    let activeAppName = 'voice-comp'; // Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ø´Ø· Ø§Ù„Ø°ÙŠ Ø³ÙŠØ³ØªÙ‚Ø¨Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ¹Ø±Ù

    function setupSpeech() {
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechAPI();
            recognition.lang = 'ar-SA';
            recognition.continuous = true; // Ù†Ø¬Ø¹Ù„Ù‡ Ù…Ø³ØªÙ…Ø± Ù„Ù„VoiceComp
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecRunning = true;
                // ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ØªÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡
                document.querySelectorAll('.mic-status').forEach(el => el.classList.add('mic-active'));
                console.log("Recognition started. App:", activeAppName);
            };

            recognition.onend = () => {
                isRecRunning = false;
                document.querySelectorAll('.mic-status').forEach(el => el.classList.remove('mic-active'));
                console.log("Recognition ended. Restarting...");
                if (VoiceComp.activeId || SpeedRead.isGameRunning || Fluency.isGameRunning) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ­Ø¯ÙŠ Ù†Ø´Ø·ØŒ Ø£Ø¹Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
                    try { recognition.start(); } catch(e) {}
                }
            };

            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø·Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ù…ØªØµÙØ­.');
                    stopMic();
                }
            };

            recognition.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    }
                }
                if (finalTranscript) {
                    console.log("Final spoken:", finalTranscript);
                    // ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ø´Ø·
                    if (activeAppName === 'voice-comp') {
                        VoiceComp.handleSpeech(finalTranscript);
                    } else if (activeAppName === 'speed-read' && SpeedRead.isGameRunning) {
                        SpeedRead.handleSpeech(finalTranscript);
                    } else if (activeAppName === 'fluency' && Fluency.isGameRunning) {
                        Fluency.handleSpeech(finalTranscript);
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø³Ù…Ø§Ø¹ Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØªØ¨Ø¹ (Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª)
                const currentTranscript = event.results[event.results.length - 1][0].transcript;
                document.getElementById('vc-debug-text').innerText = currentTranscript || '...';
                const srDebug = document.getElementById('sr-debug-text'); if(srDebug) srDebug.innerText = currentTranscript || '...';
                const fcDebug = document.getElementById('fc-debug-text'); if(fcDebug) fcDebug.innerText = currentTranscript || '...';
            };

        } else {
            alert('Ù„Ù„Ø£Ø³ÙØŒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ØªØµÙØ­Ùƒ Ø®Ø§ØµÙŠØ© Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ.');
            stopMic = () => {};
            startMic = () => {};
        }
    }

    function startMic() {
        if (!isRecRunning) {
            try {
                recognition.start();
                recognition.continuous = (activeAppName === 'voice-comp'); // Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØªÙŠØ©
            } catch (e) {
                // Ù‚Ø¯ ÙŠÙØ´Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø§Ù„ÙØ¹Ù„
                console.warn("Recognition already started or failed to start:", e);
            }
        } else if (recognition.continuous !== (activeAppName === 'voice-comp')) {
             // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø®Ø§Ø·Ø¦ØŒ Ø£Ø¹Ø¯ ØªØ´ØºÙŠÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­
            recognition.stop();
            setTimeout(() => startMic(), 100);
        }
    }

    function stopMic() {
        if (isRecRunning) {
            recognition.stop();
        }
    }

    // Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø£Ù„ÙØ§Ø¸ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØµÙˆØªÙŠØ©)
    function normalizeArabic(text) {
        return text.trim().toLowerCase()
            .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
            .replace(/Ø©/g, 'Ù‡')
            .replace(/Ù‰/g, 'ÙŠ')
            .replace(/ÙŠ/g, 'Ù‰');
    }

    // **********************************************
    // *** Ù…Ù†Ø·Ù‚ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ***
    // **********************************************
    function switchAppTab(appName, button) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª ÙˆØ¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.app-tab-content').forEach(c => c.style.display = 'none');
        document.querySelectorAll('.app-tab-btn').forEach(b => b.classList.remove('active'));

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø· ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        document.getElementById(`tab-content-${appName}`).style.display = 'block';
        button.classList.add('active');
        
        activeAppName = appName;

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
        if (appName === 'voice-comp') {
            if (VoiceComp.activeId) startMic(); else stopMic();
        } else if (appName === 'speed-read') {
            if (SpeedRead.isGameRunning) startMic(); else stopMic();
        } else if (appName === 'fluency') {
            if (Fluency.isGameRunning) startMic(); else stopMic();
        } else {
            stopMic();
        }
    }


    // **********************************************
    // *** Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ***
    // **********************************************

    function switchAdminTab(tabId, button) {
        // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª ÙˆØ¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø´Ø· ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        document.getElementById(tabId).classList.add('active');
        button.classList.add('active');
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        if (tabId === 'admin-tab-content-voice') {
            VoiceComp.renderAdminUI();
        } else if (tabId === 'admin-tab-content-speed') {
            SpeedRead.renderAdminPlayers();
            SpeedRead.renderAdminWords();
        } else if (tabId === 'admin-tab-content-fluency') {
            Fluency.renderAdminPlayers();
            Fluency.renderAdminTexts();
        }
    }

    function openAdmin() {
        // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹
        document.getElementById('admin-pass-input').value = '';
        document.getElementById('pass-modal').style.display = 'flex';
    }

    function checkAdminPass() {
        const pass = document.getElementById('admin-pass-input').value;
        if (pass === "1234") { // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            document.getElementById('pass-modal').style.display = 'none';
            document.getElementById('admin-modal').style.display = 'flex';
            // Ø§ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆØ§Ù‡
            switchAdminTab('admin-tab-content-voice', document.querySelector('.admin-tabs-nav .admin-tab-btn:first-child'));
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        }
    }


    // **********************************************
    // *** 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„ØµÙˆØªÙŠØ© (VoiceComp) ***
    // **********************************************
    const VoiceComp = {
        people: [],
        activeId: null,

        DEFAULT_PEOPLE: ["ÙŠØ§Ø³Ø±", "Ø£Ù†Ø³", "Ù…Ø§Ø¬Ø¯", "Ø®Ø§Ù„Ø¯", "Ø¹Ù…Ø±", "Ø¹Ù„ÙŠ"],
        STORAGE_KEY: 'voiceComp_people_v1',
        FIREBASE_PATH: 'voiceComp/people',

        init() {
            this.loadData();
        },

        loadData() {
            const savedData = localStorage.getItem(this.STORAGE_KEY);
            if (savedData) {
                this.people = JSON.parse(savedData);
            } else {
                this.people = this.DEFAULT_PEOPLE.map((name, index) => ({ id: index + 1, name: name, count: 0 }));
                this.saveDataToLocalOnly();
            }

            // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ù…Ù† Firebase Ø¥Ù† Ø£Ù…ÙƒÙ†
            try {
                rootRef.child(this.FIREBASE_PATH).once('value').then(snap => {
                    const val = snap.val();
                    if (val) {
                        this.people = Array.isArray(val) ? val : Object.values(val);
                        this.saveDataToLocalOnly();
                        this.renderUI();
                    }
                }).catch(() => {});
            } catch(e) {}
            this.renderUI();
        },

        saveData() {
            this.saveDataToLocalOnly();
            try {
                rootRef.child(this.FIREBASE_PATH).set(this.people);
            } catch(e) {}
            this.renderUI();
        },

        saveDataToLocalOnly() {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.people));
        },

        renderUI() {
            const wrapper = document.getElementById('vc-cards-wrapper');
            wrapper.innerHTML = "";
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¹Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹
            const sortedPeople = [...this.people].sort((a, b) => b.count - a.count);

            sortedPeople.forEach(p => {
                const isActive = p.id === this.activeId;
                const card = document.createElement('div');
                card.className = `vc-card ${isActive ? 'active-target' : ''} ${this.activeId !== null && !isActive ? 'dimmed' : ''}`;
                card.setAttribute('onclick', `VoiceComp.toggleSelect(${p.id})`);
                
                card.innerHTML = `
                    <div class="name">${p.name}</div>
                    <div class="count">${p.count}</div>
                `;
                wrapper.appendChild(card);
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ
            const statusDiv = document.getElementById('vc-footer-status');
            if (this.activeId) {
                const person = this.people.find(p => p.id === this.activeId);
                statusDiv.innerText = `ğŸŸ¢ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù€: ${person.name}`;
                statusDiv.className = "vc-status-text vc-status-listening";
            } else {
                statusDiv.innerText = "ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯";
                statusDiv.className = "vc-status-text vc-status-idle";
            }
        },

        toggleSelect(id) {
            const statusDiv = document.getElementById('vc-footer-status');
            if (this.activeId === id) {
                this.activeId = null;
                stopMic();
                statusDiv.innerText = "ğŸ”´ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø£Ø­Ø¯";
                statusDiv.className = "vc-status-text vc-status-idle";
            } else {
                this.activeId = id;
                const person = this.people.find(p => p.id === id);
                // ÙÙ‚Ø· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡Ùˆ Ø§Ù„Ù†Ø´Ø·
                if (activeAppName === 'voice-comp') startMic();
                statusDiv.innerText = `ğŸŸ¢ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù€: ${person.name}`;
                statusDiv.className = "vc-status-text vc-status-listening";
            }
            this.renderUI();
        },

        handleSpeech(transcript) {
            if (!this.activeId) return;

            const target = this.people.find(p => p.id === this.activeId);
            if (!target) return;

            // 1. ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ù†Ø·ÙˆÙ‚
            const spokenNormalized = normalizeArabic(transcript);
            // 2. ØªÙˆØ­ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…
            const targetNameNormalized = normalizeArabic(target.name);

            // 3. Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙŠÙ† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
            if (spokenNormalized.includes(targetNameNormalized)) {
                target.count++;
                this.saveData();
                
                const debugText = document.getElementById('vc-debug-text');
                debugText.style.color = "green";
                setTimeout(() => debugText.style.color = "#d35400", 500);
            }
        },

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        renderAdminUI() {
            const tbl = document.getElementById('vc-admin-table');
            tbl.innerHTML = `<tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ø¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>`;

            this.people.forEach((p, idx) => {
                tbl.innerHTML += `
                    <tr>
                        <td><input value="${p.name}" onchange="VoiceComp.editName(${idx}, this.value)"></td>
                        <td>${p.count}</td>
                        <td>
                            <button onclick="VoiceComp.deletePerson(${idx})" class="btn-action btn-red">Ø­Ø°Ù</button>
                            <button onclick="VoiceComp.resetPersonCount(${idx})" class="btn-action btn-blue">ØªØµÙÙŠØ±</button>
                        </td>
                    </tr>
                `;
            });
        },
        addNewPerson() {
            const nameInput = document.getElementById('vc-new-name-input');
            const name = nameInput.value;
            if(name) {
                this.people.push({ id: Date.now(), name: name, count: 0 });
                this.saveData();
                nameInput.value = '';
                this.renderAdminUI();
            }
        },
        editName(idx, val) { 
            this.people[idx].name = val; 
            this.saveData(); 
            this.renderAdminUI();
        },
        deletePerson(idx) { 
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…ØªØ³Ø§Ø¨Ù‚ØŸ")) { 
                this.people.splice(idx, 1); 
                this.saveData(); 
                this.renderAdminUI();
            } 
        },
        resetPersonCount(idx) {
            this.people[idx].count = 0;
            this.saveData();
            this.renderAdminUI();
        },
        resetAll() { 
            if(confirm("ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ")) { 
                this.people.forEach(p => p.count = 0); 
                this.saveData();
                this.renderAdminUI();
            } 
        }
    };


    // **********************************************
    // *** 2. Ù…Ù†Ø·Ù‚ Ø¯ÙˆØ±ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (SpeedRead) ***
    // **********************************************
    const SpeedRead = {
        players: [],
        wordBank: [],
        roundQueue: [],

        activePlayerIndex: null,
        currentTargetWord: "",
        currentWordIndex: 0,
        currentRoundScore: 0,
        selectedTimeMs: 7000,
        pointsPerWord: 1,
        isGameRunning: false,
        timerInterval: null,

        STORAGE_KEY_PLAYERS: 'speedRead_players_v1',
        STORAGE_KEY_WORDS: 'speedRead_words_v1',
        FIREBASE_PATH_PLAYERS: 'speedRead/players',
        FIREBASE_PATH_WORDS: 'speedRead/words',

        DEFAULT_PLAYERS: ["Ù†ÙˆØ±Ø©", "Ø³Ø§Ø±Ø©", "ÙÙ‡Ø¯", "Ù…Ø­Ù…Ø¯"],
        DEFAULT_WORDS: ["Ø£Ø³Ø¯", "Ù†Ù…Ø±", "Ø°Ø¦Ø¨", "ÙƒÙ„Ø¨", "Ù‚Ø·", "Ù‚Ø±Ø¯", "ÙÙŠÙ„", "Ø¬Ù…Ù„", "Ø¨Ù‚Ø±", "ØºÙ†Ù…", "Ø·ÙŠØ±", "Ø¯Ø¬Ø§Ø¬", "Ø³Ù…Ùƒ", "Ù…Ø§Ø¡", "Ù†Ø§Ø±", "Ù‡ÙˆØ§Ø¡", "Ø£Ø±Ø¶", "Ø³Ù…Ø§Ø¡", "Ù†Ø¬Ù…", "Ù‚Ù…Ø±", "Ø´Ù…Ø³", "Ù„ÙŠÙ„", "Ù†Ù‡Ø§Ø±", "ÙˆÙ‚Øª", "Ø³Ø§Ø¹Ø©", "Ø¯Ù‚ÙŠÙ‚Ø©", "Ø«Ø§Ù†ÙŠØ©", "ÙØ±Ø­", "Ø­Ø²Ù†", "Ø­Ø¨", "Ø®ÙŠØ±", "Ø´Ø±"],


        init() {
            this.loadData();
        },

        loadData() {
            const savedPlayers = localStorage.getItem(this.STORAGE_KEY_PLAYERS);
            if (savedPlayers) {
                this.players = JSON.parse(savedPlayers);
            } else {
                this.players = this.DEFAULT_PLAYERS.map((name, index) => ({ id: index, name: name, totalScore: 0 }));
                this.savePlayersToLocalOnly();
            }

            const savedWords = localStorage.getItem(this.STORAGE_KEY_WORDS);
            if (savedWords) this.wordBank = JSON.parse(savedWords);
            else this.generateDefaultWords();

            // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ù…Ù† Firebase Ø¥Ù† Ø£Ù…ÙƒÙ†
            try {
                rootRef.child(this.FIREBASE_PATH_PLAYERS).once('value').then(snap => {
                    const val = snap.val();
                    if (val) {
                        this.players = Array.isArray(val) ? val : Object.values(val);
                        this.savePlayersToLocalOnly();
                        this.renderDashboard();
                    }
                }).catch(() => {});
                rootRef.child(this.FIREBASE_PATH_WORDS).once('value').then(snap => {
                    const val = snap.val();
                    if (val) {
                        this.wordBank = Array.isArray(val) ? val : Object.values(val);
                        this.saveWordsToLocalOnly();
                    }
                }).catch(() => {});
            } catch(e) {}
            this.renderDashboard();
        },

        savePlayers() {
            this.savePlayersToLocalOnly();
            try { rootRef.child(this.FIREBASE_PATH_PLAYERS).set(this.players); } catch(e) {}
            this.renderDashboard();
        },
        savePlayersToLocalOnly() {
            localStorage.setItem(this.STORAGE_KEY_PLAYERS, JSON.stringify(this.players));
        },
        saveWords() {
            this.saveWordsToLocalOnly();
            try { rootRef.child(this.FIREBASE_PATH_WORDS).set(this.wordBank); } catch(e) {}
        },
        saveWordsToLocalOnly() {
            localStorage.setItem(this.STORAGE_KEY_WORDS, JSON.stringify(this.wordBank));
        },
        generateDefaultWords() {
            this.wordBank = [...new Set(this.DEFAULT_WORDS)].filter(w => w.length >= 3 && w.length <= 5);
            this.saveWordsToLocalOnly();
        },

        renderDashboard() {
            const grid = document.getElementById('sr-players-grid');
            if (!grid) return;
            grid.innerHTML = "";

            // Ø§Ù„ØªØ±ØªÙŠØ¨: Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ†Ø§Ø²Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
            const sortedPlayers = [...this.players].sort((a, b) => b.totalScore - a.totalScore);

            sortedPlayers.forEach((p, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const card = document.createElement('div');
                card.className = 'player-card';
                card.setAttribute('onclick', `SpeedRead.selectPlayer(${p.id}, ${index})`);

                card.innerHTML = `
                    <div class="player-rank ${rankClass}">${rank}</div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-score">${p.totalScore}</div>
                    <button class="play-btn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨</button>
                `;
                grid.appendChild(card);
            });
        },

        selectPlayer(id, index) {
            this.activePlayerIndex = index;
            document.getElementById('sr-active-player-name').innerText = this.players[index].name;
            document.getElementById('sr-game-section').style.display = 'flex';
            document.getElementById('sr-dashboard').style.display = 'none';
        },
        
        selectMode(timeMs, points, button) {
            this.selectedTimeMs = timeMs;
            this.pointsPerWord = points;
            document.querySelectorAll('#sr-mode-selector .mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        },

        startGame() {
            if (this.wordBank.length < 10) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª ÙƒØ§ÙÙŠØ©!");
                return;
            }
            document.getElementById('sr-mode-selector').style.display = 'none';
            document.getElementById('sr-active-game-area').style.display = 'flex';
            document.getElementById('sr-timer-container').style.display = 'block';
            document.getElementById('sr-round-score').innerText = '0';
            this.currentRoundScore = 0;
            this.currentWordIndex = 0;

            const shuffled = [...this.wordBank].sort(() => 0.5 - Math.random());
            this.roundQueue = shuffled.slice(0, 10);
            this.isGameRunning = true;
            if (activeAppName === 'speed-read') startMic();
            this.nextRound();
        },

        nextRound() {
            if (this.currentWordIndex >= 10) {
                this.endGame();
                return;
            }
            const wordEl = document.getElementById('sr-word-display');
            wordEl.className = "sr-target-word";
            wordEl.classList.remove('visible');
            wordEl.innerText = "";
            document.getElementById('sr-feedback-text').innerText = "";

            setTimeout(() => {
                this.currentTargetWord = this.roundQueue[this.currentWordIndex];
                wordEl.innerText = this.currentTargetWord;
                wordEl.classList.add('visible');
                this.startTimer();
            }, 500);
        },

        startTimer() {
            const bar = document.getElementById('sr-timer-bar');
            bar.style.transition = 'none';
            bar.style.width = '100%';
            void bar.offsetWidth;
            bar.style.transition = `width ${this.selectedTimeMs}ms linear`;
            bar.style.width = '0%';
            clearTimeout(this.timerInterval);
            this.timerInterval = setTimeout(() => {
                this.handleResult(false); // Time's up
            }, this.selectedTimeMs);
        },

        handleResult(isCorrect) {
            clearTimeout(this.timerInterval);
            this.isGameRunning = false;
            const wordEl = document.getElementById('sr-word-display');
            const feedback = document.getElementById('sr-feedback-text');

            if (isCorrect) {
                this.currentRoundScore += this.pointsPerWord;
                wordEl.classList.add('correct');
                feedback.innerText = `ØµØ­! (+${this.pointsPerWord})`;
                feedback.style.color = varToHex('--success');
            } else {
                wordEl.classList.add('wrong');
                feedback.innerText = `Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª / Ø®Ø·Ø£. Ø§Ù„ÙƒÙ„Ù…Ø©: ${this.currentTargetWord}`;
                feedback.style.color = varToHex('--danger');
            }
            
            document.getElementById('sr-round-score').innerText = this.currentRoundScore;

            // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø©
            this.currentWordIndex++;
            setTimeout(() => {
                if (activeAppName === 'speed-read') this.isGameRunning = true; // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                this.nextRound();
            }, 1500);
        },

        endGame() {
            this.isGameRunning = false;
            stopMic();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ù„Ø§Ø¹Ø¨
            if(this.activePlayerIndex !== null) {
                this.players[this.activePlayerIndex].totalScore += this.currentRoundScore;
                this.savePlayers();
            }

            alert(`Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬ÙˆÙ„Ø©! Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù†Ù‚Ø§Ø·: ${this.currentRoundScore}. Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ù…Ø¬Ù…ÙˆØ¹Ùƒ Ø§Ù„ÙƒÙ„ÙŠ.`);
            this.exitGame();
        },

        exitGame() {
            this.isGameRunning = false;
            clearTimeout(this.timerInterval);
            stopMic();
            this.activePlayerIndex = null;
            document.getElementById('sr-game-section').style.display = 'none';
            document.getElementById('sr-dashboard').style.display = 'flex';
            document.getElementById('sr-mode-selector').style.display = 'block';
            document.getElementById('sr-active-game-area').style.display = 'none';
            document.getElementById('sr-timer-container').style.display = 'none';
            this.renderDashboard();
        },
        
        handleSpeech(transcript) {
            if (!this.isGameRunning || this.currentWordIndex >= 10) return;

            const spokenNormalized = normalizeArabic(transcript);
            const targetNormalized = normalizeArabic(this.currentTargetWord);

            if (spokenNormalized.includes(targetNormalized)) {
                this.handleResult(true);
            }
        },

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        switchAdminSubTab(tabId, event) {
            document.querySelectorAll('#admin-tab-content-speed > div[id^="sr-sub-tab-"]').forEach(c => c.style.display = 'none');
            document.querySelectorAll('#admin-tab-content-speed .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
        },
        renderAdminPlayers() {
            const tbl = document.getElementById('sr-admin-players-table'); tbl.innerHTML = "";
            this.players.forEach((p, i) => {
                tbl.innerHTML += `
                    <tr>
                        <td><input value="${p.name}" onchange="SpeedRead.updatePlayerName(${i}, this.value)" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;"></td>
                        <td>${p.totalScore}</td>
                        <td><button onclick="SpeedRead.resetPlayerScore(${i})" class="btn-action btn-red" style="padding: 5px 10px;">ØªØµÙÙŠØ±</button></td>
                    </tr>`;
            });
        },
        updatePlayerName(idx, val) { if(val) { this.players[idx].name = val; this.savePlayers(); this.renderAdminPlayers(); this.renderDashboard(); } },
        resetPlayerScore(idx) { this.players[idx].totalScore = 0; this.savePlayers(); this.renderAdminPlayers(); this.renderDashboard(); },
        resetAllScores() { 
            if(confirm("ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙƒÙ„ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŸ")) { 
                this.players.forEach(p => p.totalScore = 0); 
                this.savePlayers(); 
                this.renderAdminPlayers(); 
                this.renderDashboard(); 
            } 
        },

        renderAdminWords() {
            const tbl = document.getElementById('sr-admin-words-table'); tbl.innerHTML = "";
            this.wordBank.forEach((w, i) => {
                tbl.innerHTML += `<tr><td><input value="${w}" onchange="SpeedRead.editWord(${i}, this.value)" style="width:100%; padding:6px; border:1px solid #ddd; border-radius:4px;"></td><td><button onclick="SpeedRead.delWord(${i})" class="btn-action btn-red" style="padding: 5px 10px;">âœ•</button></td></tr>`;
            });
        },
        editWord(i, val) { if(val) { this.wordBank[i] = val; this.saveWords(); this.renderAdminWords(); } },
        addWord() {
            const v = document.getElementById('sr-new-word-in').value;
            if(v) { this.wordBank.unshift(v); this.saveWords(); this.renderAdminWords(); document.getElementById('sr-new-word-in').value = ""; }
        },
        delWord(i) { this.wordBank.splice(i, 1); this.saveWords(); this.renderAdminWords(); },
        resetWords() { if(confirm("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ")) { this.generateDefaultWords(); this.renderAdminWords(); } }
    };


    // **********************************************
    // *** 3. Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠØ© (Fluency) ***
    // **********************************************
    const Fluency = {
        players: [],
        textBank: [],
        
        activePlayerIndex: null,
        selectedTimeSec: 60,
        timeRemaining: 60,
        correctWordsCount: 0,
        currentTextWords: [],
        currentWordIndex: 0,
        timerInterval: null,
        isGameRunning: false,
        
        STORAGE_KEY_PLAYERS: 'fluency_players_v1',
        STORAGE_KEY_TEXTS: 'fluency_texts_v1',
        FIREBASE_PATH_PLAYERS: 'fluency/players',
        FIREBASE_PATH_TEXTS: 'fluency/texts',

        DEFAULT_PLAYERS: ["Ø¨Ø¯Ø±ÙŠØ©", "Ù†Ø¬ÙˆØ¯", "Ø£Ù…Ø¬Ø§Ø¯", "Ø£Ù†Ø³"],
        DEFAULT_TEXTS: [
            "ÙƒØ§Ù†Øª Ø§Ù„Ø³Ù…Ø§Ø¡ ØµØ§ÙÙŠØ© ÙˆØ§Ù„Ù†Ø¬ÙˆÙ… ØªÙ„Ù…Ø¹ ÙƒØ§Ù„Ø£Ù„Ù…Ø§Ø³. Ø¬Ù„Ø³ Ø£Ø­Ù…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø·Ø¦ ÙŠØªØ£Ù…Ù„ Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ù‡Ø§Ø¯Ø¦ ÙˆÙŠÙÙƒØ± ÙÙŠ Ù…ØºØ§Ù…Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…. Ø´Ø¹Ø± Ø¨Ø§Ù„Ø³Ù„Ø§Ù… ÙŠØºÙ…Ø±Ù‡ ÙˆØªÙ…Ù†Ù‰ Ø£Ù† ØªØ¯ÙˆÙ… Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø­Ø¸Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¨Ø¯. ÙØ¬Ø£Ø©ØŒ Ø³Ù…Ø¹ ØµÙˆØªÙ‹Ø§ ØºØ±ÙŠØ¨Ø§Ù‹ Ù‚Ø§Ø¯Ù…Ø§Ù‹ Ù…Ù† Ø¨Ø¹ÙŠØ¯ØŒ ÙÙ†Ù‡Ø¶ Ø¨Ø³Ø±Ø¹Ø© Ù„ÙŠØ±Ù‰ Ù…ØµØ¯Ø± Ù‡Ø°Ø§ Ø§Ù„ØµÙˆØª.",
            "Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù‡Ùˆ Ù…ÙØªØ§Ø­ Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹ØµØ± Ø§Ù„Ù…ØªØºÙŠØ±. ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø£Ù† ÙŠØ·ÙˆØ± Ù…Ù‡Ø§Ø±Ø§ØªÙ‡ Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆØ£Ù† ÙŠÙˆØ§ÙƒØ¨ Ø§Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ Ø§Ù„Ø­Ø¯ÙŠØ«Ø©. Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¨Ø­Ø« Ù‡Ù…Ø§ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø£Ù…Ø«Ù„ Ù„Ø§ÙƒØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø±ÙØ© ÙˆØªØ­Ù‚ÙŠÙ‚ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø·Ù…ÙˆØ­Ø© ÙÙŠ Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©."
        ],

        init() {
            this.loadData();
        },

        loadData() {
            const savedPlayers = localStorage.getItem(this.STORAGE_KEY_PLAYERS);
            this.players = savedPlayers ? JSON.parse(savedPlayers) : this.DEFAULT_PLAYERS.map((n, i) => ({ id: i, name: n, topScore: 0 }));
            if(!savedPlayers) this.savePlayersToLocalOnly();

            const savedTexts = localStorage.getItem(this.STORAGE_KEY_TEXTS);
            this.textBank = savedTexts ? JSON.parse(savedTexts) : this.generateDefaultTexts();
            if(!savedTexts) this.saveTextsToLocalOnly();

             // Ø­Ø§ÙˆÙ„ Ø¬Ù„Ø¨ Ù…Ù† Firebase Ø¥Ù† Ø£Ù…ÙƒÙ†
            try {
                rootRef.child(this.FIREBASE_PATH_PLAYERS).once('value').then(snap => {
                    const val = snap.val();
                    if (val) {
                        this.players = Array.isArray(val) ? val : Object.values(val);
                        this.savePlayersToLocalOnly();
                        this.renderDashboard();
                    }
                }).catch(() => {});
                rootRef.child(this.FIREBASE_PATH_TEXTS).once('value').then(snap => {
                    const val = snap.val();
                    if (val) {
                        this.textBank = Array.isArray(val) ? val : Object.values(val);
                        this.saveTextsToLocalOnly();
                    }
                }).catch(() => {});
            } catch(e) {}
            this.renderDashboard();
        },

        savePlayers() {
            this.savePlayersToLocalOnly();
            try { rootRef.child(this.FIREBASE_PATH_PLAYERS).set(this.players); } catch(e) {}
            this.renderDashboard();
        },
        savePlayersToLocalOnly() {
            localStorage.setItem(this.STORAGE_KEY_PLAYERS, JSON.stringify(this.players));
        },
        saveTexts() {
            this.saveTextsToLocalOnly();
            try { rootRef.child(this.FIREBASE_PATH_TEXTS).set(this.textBank); } catch(e) {}
        },
        saveTextsToLocalOnly() {
            localStorage.setItem(this.STORAGE_KEY_TEXTS, JSON.stringify(this.textBank));
        },
        generateDefaultTexts() {
            this.textBank = [...this.DEFAULT_TEXTS];
            this.saveTextsToLocalOnly();
            return this.textBank;
        },

        renderDashboard() {
            const grid = document.getElementById('fc-players-grid');
            if (!grid) return;
            grid.innerHTML = "";

            const sortedPlayers = [...this.players].sort((a, b) => b.topScore - a.topScore);

            sortedPlayers.forEach((p, index) => {
                const rank = index + 1;
                let rankClass = '';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const card = document.createElement('div');
                card.className = 'player-card';
                card.setAttribute('onclick', `Fluency.selectPlayer(${p.id}, ${index})`);

                card.innerHTML = `
                    <div class="player-rank ${rankClass}">${rank}</div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-score">${p.topScore} WPM</div>
                `;
                grid.appendChild(card);
            });
        },

        selectPlayer(id, index) {
            this.activePlayerIndex = index;
            document.getElementById('fc-active-player-name').innerText = this.players[index].name;
            document.getElementById('fc-game-section').style.display = 'flex';
            document.getElementById('fc-dashboard').style.display = 'none';
        },

        selectTime(seconds, button) {
            this.selectedTimeSec = seconds;
            this.timeRemaining = seconds;
            document.querySelectorAll('#fc-mode-selector .mode-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        },

        initGameSequence() {
            if(this.textBank.length === 0) {
                alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©!");
                return;
            }
            document.getElementById('fc-mode-selector').style.display = 'none';
            document.getElementById('fc-active-game-area').style.display = 'flex';

            const randomText = this.textBank[Math.floor(Math.random() * this.textBank.length)];
            this.prepareText(randomText);

            // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            const layer = document.getElementById('fc-countdown-layer');
            const num = document.getElementById('fc-countdown-num');
            layer.style.display = 'flex';
            let count = 3;
            num.innerText = count;
            const iv = setInterval(() => {
                count--;
                if(count > 0) {
                    num.innerText = count;
                    num.style.animation = 'none';
                    num.offsetHeight;
                    num.style.animation = 'zoomIn 0.5s ease-out';
                } else {
                    clearInterval(iv);
                    layer.style.display = 'none';
                    this.startGame();
                }
            }, 1000);
        },

        prepareText(text) {
            const container = document.getElementById('fc-text-container');
            container.innerHTML = "";
            this.currentTextWords = text.trim().split(/\s+/);
            this.currentTextWords.forEach((word, index) => {
                const span = document.createElement('span');
                span.id = `fc-word-${index}`;
                span.className = 'fc-word-span';
                span.innerText = word + " ";
                container.appendChild(span);
            });
            this.currentWordIndex = 0;
            this.correctWordsCount = 0;
            this.updateWordHighlight();
        },

        updateWordHighlight() {
            document.querySelectorAll('.fc-word-span').forEach(el => el.classList.remove('current'));
            const currEl = document.getElementById(`fc-word-${this.currentWordIndex}`);
            if(currEl) {
                currEl.classList.add('current');
                // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ
                const container = document.getElementById('fc-text-container');
                const offset = currEl.offsetTop - container.offsetTop;
                if(offset > container.clientHeight - 100) {
                    container.scrollTop = offset - container.clientHeight / 2;
                }
            }
        },

        startGame() {
            this.isGameRunning = true;
            if (activeAppName === 'fluency') startMic();
            this.timeRemaining = this.selectedTimeSec;
            document.getElementById('fc-current-wpm').innerText = '0';
            this.startTimer();
        },

        startTimer() {
            const bar = document.getElementById('fc-timer-bar');
            bar.style.transition = 'none';
            bar.style.width = '100%';
            void bar.offsetWidth; // Reflow
            bar.style.transition = `width ${this.timeRemaining}s linear`;
            bar.style.width = '0%';
            
            clearInterval(this.timerInterval);
            this.timerInterval = setInterval(() => {
                this.timeRemaining--;
                document.getElementById('fc-timer-text').innerText = `0:${String(this.timeRemaining).padStart(2, '0')}`;
                
                if (this.timeRemaining <= 0) {
                    clearInterval(this.timerInterval);
                    this.endGame();
                }
            }, 1000);
        },

        handleSpeech(transcript) {
            if (!this.isGameRunning || this.currentWordIndex >= this.currentTextWords.length) return;

            const spokenNormalized = normalizeArabic(transcript).replace(/\s+/g, ' ');
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø­ØªÙ‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            for(let i = this.currentWordIndex; i < this.currentTextWords.length; i++) {
                const targetWord = this.currentTextWords[i];
                const targetNormalized = normalizeArabic(targetWord).replace(/\s+/g, ' ');

                if (spokenNormalized.includes(targetNormalized)) {
                    // ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (ÙˆÙƒÙ„ Ù…Ø§ Ù‚Ø¨Ù„Ù‡Ø§ ÙŠÙØªØ±Ø¶ Ø£Ù†Ù‡ ØµØ­ÙŠØ­ Ù„ØºØ±Ø¶ Ø§Ù„ØªÙ…Ø±ÙŠØ±)
                    for(let j = this.currentWordIndex; j <= i; j++) {
                        if (j < this.currentTextWords.length) {
                            const wordEl = document.getElementById(`fc-word-${j}`);
                            if(wordEl && !wordEl.classList.contains('correct')) {
                                wordEl.classList.add('correct');
                                this.correctWordsCount++;
                                document.getElementById('fc-current-wpm').innerText = this.correctWordsCount;
                            }
                        }
                    }
                    this.currentWordIndex = i + 1;
                    this.updateWordHighlight();
                    if (this.currentWordIndex >= this.currentTextWords.length) {
                        clearInterval(this.timerInterval);
                        this.endGame();
                    }
                    return;
                }
            }
        },

        endGame() {
            this.isGameRunning = false;
            stopMic();
            
            let wpm = 0;
            if (this.selectedTimeSec === 60) {
                wpm = this.correctWordsCount;
            } else {
                wpm = Math.round(this.correctWordsCount / (this.selectedTimeSec / 60));
            }
            
            document.getElementById('fc-final-wpm').innerText = wpm;

            // ØªØ­Ø¯ÙŠØ« Ø£ÙØ¶Ù„ Ø±Ù‚Ù… Ù„Ù„Ø§Ø¹Ø¨
            if(this.activePlayerIndex !== null && wpm > this.players[this.activePlayerIndex].topScore) {
                this.players[this.activePlayerIndex].topScore = wpm;
                this.savePlayers();
            }
            document.getElementById('fc-end-modal').style.display = 'flex';
        },

        finishSession() {
            document.getElementById('fc-end-modal').style.display = 'none';
            this.exitGame();
        },
        
        exitGame() {
            this.isGameRunning = false;
            clearInterval(this.timerInterval);
            stopMic();
            this.activePlayerIndex = null;
            document.getElementById('fc-game-section').style.display = 'none';
            document.getElementById('fc-dashboard').style.display = 'flex';
            document.getElementById('fc-mode-selector').style.display = 'block';
            document.getElementById('fc-active-game-area').style.display = 'none';
            this.renderDashboard();
        },

        // --- ÙˆØ¸Ø§Ø¦Ù Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        switchAdminSubTab(tabId, event) {
            document.querySelectorAll('#admin-tab-content-fluency > div[id^="fc-sub-tab-"]').forEach(c => c.style.display = 'none');
            document.querySelectorAll('#admin-tab-content-fluency .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            event.target.classList.add('active');
        },
        renderAdminPlayers() {
            const t = document.getElementById('fc-admin-players-table'); t.innerHTML = "";
            this.players.forEach((p, i) => {
                t.innerHTML += `<tr><td><input value="${p.name}" onchange="Fluency.players[${i}].name=this.value; Fluency.savePlayers()"></td><td>${p.topScore} WPM</td></tr>`;
            });
        },
        renderAdminTexts() {
            const t = document.getElementById('fc-admin-texts-table'); t.innerHTML = "";
            this.textBank.forEach((txt, i) => {
                t.innerHTML += `<tr><td style="font-size:0.8rem">${txt.substring(0,50)}...</td><td><button onclick="Fluency.textBank.splice(${i},1); Fluency.saveTexts(); Fluency.renderAdminTexts()" class="btn-action btn-red" style="padding: 5px 10px;">âœ•</button></td></tr>`;
            });
        },
        addText() {
            const v = document.getElementById('fc-new-text-in').value;
            if(v) { this.textBank.push(v); this.saveTexts(); this.renderAdminTexts(); document.getElementById('fc-new-text-in').value = ""; }
        },
        resetAllScores() { 
            if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ')) { 
                this.players.forEach(p => p.topScore=0); 
                this.savePlayers(); 
                this.renderAdminPlayers(); 
            } 
        },
        resetTexts() { 
            if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£ØµÙ„ÙŠØ©ØŸ')) { 
                this.textBank = this.generateDefaultTexts(); 
                this.renderAdminTexts(); 
            } 
        }
    };

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª CSS Ø¥Ù„Ù‰ Ù‚ÙŠÙ… (Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙÙŠ JS)
    function varToHex(variable) {
        return getComputedStyle(document.documentElement).getPropertyValue(variable).trim();
    }


    // **********************************************
    // *** ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ***
    // **********************************************
    function initAll() {
        setupSpeech();
        VoiceComp.init();
        SpeedRead.init();
        Fluency.init();
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„Ù†Ø´Ø· ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        switchAppTab('voice-comp', document.querySelector('#app-tabs-nav .app-tab-btn:first-child'));
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = initAll;

</script>
</body>
</html>