<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #c0392b;
            --bg-color: #f4f6f9;
            --warning: #f39c12;
            --streak-color: #e67e22;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow: hidden;
            user-select: none; /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ø¨Ø§Ù„Ø®Ø·Ø£ */
        }

        /* --- Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© --- */
        .header-area {
            width: 100%;
            padding: 10px 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .stats-box {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .score-pill {
            font-size: 1rem;
            font-weight: bold;
            color: var(--primary);
            background: #ecf0f1;
            padding: 5px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .high-score-label { font-size: 0.8rem; color: #7f8c8d; }
        .current-score-val { color: var(--accent); font-size: 1.4rem; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ù„Ø³Ù„Ø© (Streak) */
        .streak-icon {
            font-size: 1.5rem;
            opacity: 0.3;
            transition: all 0.3s;
            filter: grayscale(100%);
        }
        .streak-active {
            opacity: 1;
            filter: grayscale(0%);
            transform: scale(1.2);
            animation: burn 0.5s infinite alternate;
            text-shadow: 0 0 10px rgba(230, 126, 34, 0.8);
        }
        @keyframes burn { from { transform: scale(1.1); } to { transform: scale(1.3); } }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… --- */
        .rounds-progress-container {
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            position: absolute;
            top: 60px; 
            left: 0;
            z-index: 9;
        }
        .rounds-progress-bar {
            height: 100%;
            background: var(--success);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ --- */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: relative;
            padding-top: 20px;
        }

        /* Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© */
        .target-word {
            font-size: 5.5rem;
            font-weight: 800;
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
            opacity: 0;
            transform: scale(0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s;
            min-height: 140px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.05);
        }

        .target-word.visible { opacity: 1; transform: scale(1); }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© */
        .target-word.correct-anim { animation: popSuccess 0.4s ease-out; }
        .target-word.wrong-anim { animation: shakeError 0.4s ease-in-out; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙ„Ø§Ø´ÙŠ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹Ø¨ */
        .target-word.fading-mode { animation: fadeOutText 2.8s forwards; }

        @keyframes popSuccess { 0% {transform: scale(1);} 50% {transform: scale(1.3); color: var(--success);} 100% {transform: scale(1);} }
        @keyframes shakeError { 0%, 100% {transform: translateX(0);} 20% {transform: translateX(-15px);} 40% {transform: translateX(15px);} 60% {transform: translateX(-10px);} 80% {transform: translateX(10px);} }
        @keyframes fadeOutText { 0% { opacity: 1; } 70% { opacity: 0.3; filter: blur(2px); } 100% { opacity: 0; filter: blur(5px); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙˆÙ‚ÙŠØª */
        .timer-bar-container {
            width: 80%;
            max-width: 400px;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            display: none; 
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .timer-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #2980b9);
            width: 100%;
            transform-origin: left;
            border-radius: 6px;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­ÙÙŠØ² */
        .feedback-msg {
            font-size: 1.8rem;
            height: 50px;
            margin-top: 5px;
            font-weight: bold;
            text-align: center;
        }
        .feedback-success { color: var(--success); text-shadow: 0 2px 10px rgba(39, 174, 96, 0.3); }
        .feedback-error { color: var(--danger); }

        /* --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© --- */
        .start-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            background: white;
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 400px;
            border: 1px solid white;
        }

        .speed-options {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        .speed-btn {
            flex: 1;
            padding: 15px 5px;
            border: 2px solid #ecf0f1;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .speed-btn small { font-size: 0.75rem; margin-top: 3px; font-weight: normal; }

        .speed-btn.selected {
            border-color: var(--accent);
            background: #ebf5fb;
            color: var(--accent);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }

        .start-btn {
            background: linear-gradient(135deg, var(--accent), #2980b9);
            color: white;
            font-size: 1.6rem;
            padding: 15px 50px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .start-btn:active { transform: scale(0.96); box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }

        /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 480px;
            border-radius: 25px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            border: 4px solid #ecf0f1;
        }

        .title-badge {
            background: var(--warning);
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
        }

        .final-score { font-size: 5rem; color: var(--accent); font-weight: 800; line-height: 1; margin: 10px 0; }
        .final-msg { font-size: 1.6rem; color: var(--primary); margin-bottom: 20px; font-weight: bold; }
        
        .missed-words-section {
            background: #fff5f5;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            border: 1px dashed #fab1a0;
        }
        .missed-words-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }
        .missed-tag {
            background: white;
            color: var(--danger);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 1rem;
            border: 1px solid #ffcccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-weight: bold;
        }

        /* --- Ø¹Ù†Ø§ØµØ± ØªØ­ÙƒÙ… Ø£Ø®Ø±Ù‰ --- */
        .footer-controls { position: fixed; bottom: 20px; left: 20px; z-index: 100; }
        .admin-btn {
            background: rgba(255, 255, 255, 0.9);
            color: var(--primary);
            border: 1px solid #bdc3c7;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .mic-status {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            opacity: 0.2;
            transition: opacity 0.3s;
        }
        .mic-active { opacity: 1; color: var(--danger); animation: pulseMic 1.5s infinite; }
        @keyframes pulseMic { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        table { width: 100%; border-collapse: collapse; }
        td, th { padding: 8px; border-bottom: 1px solid #eee; text-align: right; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-mini { padding: 5px 10px; border-radius: 6px; border: none; cursor: pointer; color: white; font-size: 0.8rem; }
        .bg-red { background: var(--danger); }
        .bg-green { background: var(--success); }
        .admin-table-container { max-height: 250px; overflow-y: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 8px; }

    </style>
</head>
<body>

    <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
    <div class="header-area">
        <div style="font-weight: bold; color: var(--primary); display:flex; align-items:center; gap:5px;">
            <span>ğŸš€</span> Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
        </div>
        
        <div class="stats-box">
            <!-- Ø£ÙØ¶Ù„ Ø±Ù‚Ù… -->
            <div style="text-align: center; line-height: 1;">
                <div class="high-score-label">Ø§Ù„Ø£ÙØ¶Ù„</div>
                <div id="best-score-display" style="font-weight:bold; color:var(--primary);">0</div>
            </div>

            <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
            <div class="score-pill">
                <span>â­</span>
                <span id="score-display" class="current-score-val">0</span>
            </div>

            <!-- Ø§Ù„Ø´Ø¹Ù„Ø© (Streak) -->
            <div id="streak-indicator" class="streak-icon">ğŸ”¥</div>
        </div>
    </div>
    
    <!-- Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„ÙƒÙ„Ù…Ø§Øª -->
    <div class="rounds-progress-container">
        <div id="rounds-progress" class="rounds-progress-bar"></div>
    </div>

    <!-- Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† -->
    <div id="mic-icon" class="mic-status">ğŸ™ï¸</div>

    <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div class="game-container">
        
        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
        <div id="start-panel" class="start-area">
            <h2 style="margin:0 0 5px 0; color:var(--primary)">Ø§Ø®ØªØ± Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
            <p style="margin:0 0 20px 0; color:#7f8c8d; font-size:0.9rem">ÙƒÙ„Ù…Ø§ ÙƒÙ†Øª Ø£Ø³Ø±Ø¹ØŒ Ø²Ø§Ø¯ Ø§Ù„Ù„Ù‚Ø¨!</p>
            
            <div class="speed-options">
                <button class="speed-btn" onclick="selectSpeed(7000, this)" id="btn-slow">
                    <span>ğŸ¢</span> Ø¹Ø§Ø¯ÙŠ<small>7 Ø«ÙˆØ§Ù†</small>
                </button>
                <button class="speed-btn selected" onclick="selectSpeed(5000, this)" id="btn-normal">
                    <span>ğŸ‡</span> Ø³Ø±ÙŠØ¹<small>5 Ø«ÙˆØ§Ù†</small>
                </button>
                <button class="speed-btn" onclick="selectSpeed(3000, this)" id="btn-fast">
                    <span>ğŸš€</span> ØµØ§Ø±ÙˆØ®<small>3 Ø«ÙˆØ§Ù†</small>
                </button>
            </div>
            <button class="start-btn" onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        </div>

        <!-- Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù„Ø¹Ø¨ -->
        <div id="game-elements" style="display: none; width: 100%; flex-direction: column; align-items: center;">
            <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø© -->
            <div id="word-display" class="target-word"></div>

            <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª -->
            <div class="timer-bar-container" id="timer-container">
                <div class="timer-bar" id="timer-bar"></div>
            </div>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© -->
            <div id="feedback" class="feedback-msg"></div>

            <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³Ù…ÙˆØ¹ -->
            <div style="margin-top: 30px; color: #bdc3c7; font-size: 0.85rem; border: 1px solid #ecf0f1; padding: 5px 15px; border-radius: 20px;">
                Ø³Ù…Ø¹Øª: <span id="heard-text">...</span>
            </div>
        </div>

    </div>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="footer-controls">
        <button class="admin-btn" onclick="openAdmin()">âš™ï¸ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ø§Ù„Ù†ØªÙŠØ¬Ø©) -->
    <div id="end-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="title-badge" class="title-badge">Ù…ØªØ¯Ø±Ø¨</div>
            
            <h2 style="margin:0; color:var(--primary);">Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©</h2>
            <div class="final-score" id="final-score-val">0</div>
            <div class="final-msg" id="final-motivation">Ø¨Ø¯Ø§ÙŠØ© Ø¬ÙŠØ¯Ø©!</div>
            
            <!-- ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© -->
            <div id="missed-words-section" class="missed-words-section" style="display:none;">
                <p style="margin: 0; font-size: 0.9rem; color: #c0392b; font-weight:bold;">ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø§Ù‚Ø±Ø£Ù‡Ø§ Ø¨Ù‡Ø¯ÙˆØ¡):</p>
                <div class="missed-words-container" id="missed-words-list"></div>
            </div>

            <button class="start-btn" style="font-size: 1.1rem; padding: 12px 30px; width:auto; margin-top:10px;" onclick="closeEndModal()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ â†º</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div id="password-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 320px; padding: 20px;">
            <h3 style="margin-top:0">ğŸ”’ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <p style="margin-bottom: 5px; color: #7f8c8d;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² (1234)</p>
            <input type="password" id="admin-pass-input" placeholder="****" style="text-align:center; letter-spacing: 5px; font-size: 1.5rem; width: 100%; margin-bottom:10px;">
            <div id="pass-error" style="color: var(--danger); font-size: 0.9rem; min-height: 20px;"></div>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="start-btn" style="font-size: 1rem; padding: 8px; margin:0; flex:1;" onclick="checkAdminPassword()">Ø¯Ø®ÙˆÙ„</button>
                <button class="btn-mini bg-red" style="font-size: 1rem; flex:1;" onclick="closePasswordModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>ğŸ”  Ø¨Ù†Ùƒ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</h3>
                <button onclick="closeAdmin()" class="btn-mini bg-red" style="width: 30px; height: 30px;">âœ•</button>
            </div>
            
            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                <input type="text" id="new-word-input" placeholder="ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." maxlength="5">
                <button onclick="addWord()" class="btn-mini bg-green" style="width: 70px;">Ø¥Ø¶Ø§ÙØ©</button>
            </div>

            <div class="admin-table-container">
                <table id="words-table"></table>
            </div>
            <div style="margin-top: 10px; font-size: 0.8rem; color: #7f8c8d; text-align: right;">
                * 3-5 Ø£Ø­Ø±Ù Ù„Ù„Ø£Ø¹Ù…Ø§Ø± 7-12 Ø³Ù†Ø©.
            </div>
            <button onclick="resetDefaultWords()" class="btn-mini bg-red" style="margin-top: 15px; padding: 8px; width:100%;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
        let wordBank = [];
        const TOTAL_ROUNDS = 10;
        let selectedTimeMs = 5000; 
        
        // --- Ø£Ù„ÙˆØ§Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© ---
        const wordColors = ["#2c3e50", "#c0392b", "#2980b9", "#8e44ad", "#d35400", "#16a085", "#27ae60"];

        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ---
        let currentScore = 0;
        let bestScore = 0;
        let currentStreak = 0; // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø³Ù„Ø©
        let roundQueue = [];
        let currentRoundIndex = 0;
        let isGameRunning = false;
        let timerInterval = null;
        let recognition;
        let isListening = false;
        let currentTargetWord = "";
        let missedWords = [];

        function init() {
            loadWords();
            loadBestScore(); // ØªØ­Ù…ÙŠÙ„ Ø£ÙØ¶Ù„ Ø±Ù‚Ù…
            setupSpeechRecognition();
        }

        function loadBestScore() {
            const savedBest = localStorage.getItem('speedRead_bestScore');
            if (savedBest) {
                bestScore = parseInt(savedBest);
                document.getElementById('best-score-display').innerText = bestScore;
            }
        }

        function updateBestScore() {
            if (currentScore > bestScore) {
                bestScore = currentScore;
                localStorage.setItem('speedRead_bestScore', bestScore);
                document.getElementById('best-score-display').innerText = bestScore;
            }
        }

        function selectSpeed(ms, btn) {
            selectedTimeMs = ms;
            document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function loadWords() {
            const saved = localStorage.getItem('speedRead_words_v4');
            if (saved) wordBank = JSON.parse(saved);
            else generateDefaultWords();
        }

        function saveWords() {
            localStorage.setItem('speedRead_words_v4', JSON.stringify(wordBank));
            renderAdminTable();
        }

        function generateDefaultWords() {
            const defaults = [
                "Ø£Ø³Ø¯", "Ù†Ù…Ø±", "ÙÙ‡Ø¯", "Ø°Ø¦Ø¨", "Ø¯Ø¨", "Ø«Ø¹Ù„Ø¨", "ÙƒÙ„Ø¨", "Ù‚Ø·Ø©", "ÙØ£Ø±", "Ù‚Ø±Ø¯",
                "ÙÙŠÙ„", "Ø¬Ù…Ù„", "Ø¨Ù‚Ø±", "ØºÙ†Ù…", "Ù…Ø§Ø¹Ø²", "Ø®ÙŠÙ„", "Ø­ØµØ§Ù†", "Ø­Ù…Ø§Ø±", "Ø£Ø±Ù†Ø¨", "Ø¸Ø¨ÙŠ",
                "ØºØ²Ø§Ù„", "Ø¨Ø·Ø©", "ÙˆØ²Ø©", "Ø¯ÙŠÙƒ", "Ø¯Ø¬Ø§Ø¬", "ØµÙ‚Ø±", "Ù†Ø³Ø±", "Ø¨ÙˆÙ…Ø©", "ØºØ±Ø§Ø¨", "Ù‡Ø¯Ù‡Ø¯",
                "Ø¹ØµÙÙˆØ±", "Ø¨Ù„Ø¨Ù„", "Ø­Ù…Ø§Ù…Ø©", "ÙŠÙ…Ø§Ù…Ø©", "Ø³Ù…Ùƒ", "Ø­ÙˆØª", "Ù‚Ø±Ø´", "Ø¶ÙØ¯Ø¹", "Ø³Ù„Ø­ÙØ§Ø©", "Ù†Ù…Ù„Ø©",
                "Ø´Ù…Ø³", "Ù‚Ù…Ø±", "Ù†Ø¬Ù…", "Ø³Ù…Ø§Ø¡", "Ø£Ø±Ø¶", "Ø¨Ø­Ø±", "Ù†Ù‡Ø±", "Ø¬Ø¨Ù„", "ØªÙ„", "ÙˆØ§Ø¯ÙŠ",
                "ØµØ®Ø±", "Ø­Ø¬Ø±", "Ø±Ù…Ù„", "ØªØ±Ø§Ø¨", "ØºÙŠÙ…", "Ø³Ø­Ø§Ø¨", "Ù…Ø·Ø±", "Ø«Ù„Ø¬", "Ø¨Ø±Ø¯", "Ø±ÙŠØ­",
                "Ù‡ÙˆØ§Ø¡", "Ù†ÙˆØ±", "Ø¸Ù„Ø§Ù…", "Ù„ÙŠÙ„", "Ù†Ù‡Ø§Ø±", "ÙØ¬Ø±", "ØµØ¨Ø­", "Ø¹ØµØ±", "Ø²Ù‡Ø±", "ÙˆØ±Ø¯",
                "Ø±Ø£Ø³", "ÙˆØ¬Ù‡", "Ø´Ø¹Ø±", "Ø¹ÙŠÙ†", "Ø£Ø°Ù†", "Ø£Ù†Ù", "ÙÙ…", "Ù„Ø³Ø§Ù†", "Ø³Ù†", "Ø¶Ø±Ø³",
                "Ø¹Ù†Ù‚", "ÙƒØªÙ", "ÙŠØ¯", "ÙƒÙ", "Ø¥ØµØ¨Ø¹", "Ø¸ÙØ±", "Ø¨Ø·Ù†", "Ø¸Ù‡Ø±", "Ù‚Ù„Ø¨", "Ø¯Ù…",
                "Ø¹Ø¸Ù…", "Ø¬Ù„Ø¯", "Ø±Ø¬Ù„", "Ù‚Ø¯Ù…", "Ø±ÙƒØ¨Ø©",
                "Ø®Ø¨Ø²", "Ù„Ø­Ù…", "Ø£Ø±Ø²", "Ø³Ù…Ùƒ", "Ø¨ÙŠØ¶", "Ø¬Ø¨Ù†", "Ø²Ø¨Ø¯", "Ø¹Ø³Ù„", "Ø³Ù…Ù†", "Ø²ÙŠØª",
                "Ù…Ù„Ø­", "Ø³ÙƒØ±", "Ù…Ø§Ø¡", "Ù„Ø¨Ù†", "Ø­Ù„ÙŠØ¨", "Ø´Ø§ÙŠ", "Ø¨Ù†", "ØªÙ…Ø±", "Ø±Ø·Ø¨", "Ø¹Ù†Ø¨",
                "ØªÙŠÙ†", "ØªÙˆØª", "ÙƒØ±Ø²", "Ù…ÙˆØ²", "ØªÙØ§Ø­", "Ø®ÙˆØ®", "Ù…Ø´Ù…Ø´", "Ø¬Ø²Ø±", "Ø¨ØµÙ„", "Ø«ÙˆÙ…",
                "ÙÙˆÙ„", "Ø¹Ø¯Ø³", "Ù‚Ù…Ø­", "Ø°Ø±Ø©", "ÙØ¬Ù„",
                "Ù‚Ù„Ù…", "ÙƒØªØ§Ø¨", "Ø¯ÙØªØ±", "ÙˆØ±Ù‚", "Ø´Ù†Ø·Ø©", "ÙØµÙ„", "ØµÙ", "Ù„ÙˆØ­", "Ø¯Ø±Ø³", "Ø¹Ù„Ù…",
                "Ø±Ø³Ù…", "Ù„ÙˆÙ†", "Ø­Ø¨Ø±", "Ù…Ø³Ø·Ø±Ø©", "Ù…Ù…Ø­Ø§Øª", "Ø¨Ø±Ø§ÙŠØ©", "Ù…Ù‚Ø¹Ø¯", "Ø·Ø§ÙˆÙ„Ø©", "ÙƒØ±Ø³ÙŠ", "Ø¬Ø±Ø³",
                "Ø³Ø§Ø­Ø©", "Ø·Ø§Ù„Ø¨", "Ù…Ø¹Ù„Ù…", "Ù…Ø¯ÙŠØ±", "Ø¹Ø¯Ø¯", "Ø±Ù‚Ù…", "Ø­Ø±Ù", "ÙƒÙ„Ù…Ø©", "Ø³Ø·Ø±", "Ù†Ø¬Ø§Ø­",
                "Ø¨ÙŠØª", "Ø¯Ø§Ø±", "Ø¨Ø§Ø¨", "Ø´Ø¨Ø§Ùƒ", "Ø¬Ø¯Ø§Ø±", "Ø³Ù‚Ù", "ØºØ±ÙØ©", "Ù…Ø·Ø¨Ø®", "Ø­Ù…Ø§Ù…", "Ø³Ø±ÙŠØ±",
                "ÙØ±Ø´", "Ù„Ø­Ø§Ù", "Ù…Ø®Ø¯Ø©", "ØµÙ†Ø¯ÙˆÙ‚", "ÙƒÙˆØ¨", "ØµØ­Ù†", "Ù…Ù„Ø¹Ù‚Ø©", "Ø´ÙˆÙƒØ©", "Ø³Ø§Ø¹Ø©", "Ù…ÙØªØ§Ø­",
                "Ù‚ÙÙ„", "Ø®ÙŠØ·", "Ø¥Ø¨Ø±Ø©", "Ø«ÙˆØ¨", "Ù‚Ù…ÙŠØµ",
                "Ø£Ø¨", "Ø£Ù…", "Ø£Ø®", "Ø£Ø®Øª", "Ø¬Ø¯", "Ø¬Ø¯Ø©", "Ø¹Ù…", "Ø®Ø§Ù„", "Ø·ÙÙ„", "ÙˆÙ„Ø¯",
                "Ø¨Ù†Øª", "Ø±Ø¬Ù„", "Ù…Ø³Ø¬Ø¯", "Ø³ÙˆÙ‚", "Ø´Ø§Ø±Ø¹"
            ];
            wordBank = [...new Set(defaults)].filter(w => w.length >= 3 && w.length <= 5);
            saveWords();
        }

        function setupSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechAPI();
                recognition.lang = 'ar-SA';
                recognition.continuous = true; 
                recognition.interimResults = true; 

                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('mic-icon').classList.add('mic-active');
                };
                recognition.onend = () => {
                    isListening = false;
                    document.getElementById('mic-icon').classList.remove('mic-active');
                    if (isGameRunning) recognition.start();
                };

                recognition.onresult = (event) => {
                    const resultIndex = event.results.length - 1;
                    const transcript = event.results[resultIndex][0].transcript;
                    document.getElementById('heard-text').innerText = transcript;
                    checkAnswer(transcript);
                };
                recognition.onerror = (e) => console.error("Mic Error", e);
            } else {
                alert("Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Chrome.");
            }
        }

        function startGame() {
            if (wordBank.length < 10) { alert("ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ 10 ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!"); return; }

            currentScore = 0;
            currentStreak = 0; // ØªØµÙÙŠØ± Ø§Ù„Ø³Ù„Ø³Ù„Ø©
            currentRoundIndex = 0;
            missedWords = [];
            
            updateScoreUI();
            updateStreakUI();
            updateProgressBar();
            
            const shuffled = [...wordBank].sort(() => 0.5 - Math.random());
            roundQueue = shuffled.slice(0, TOTAL_ROUNDS);

            document.getElementById('start-panel').style.display = 'none';
            document.getElementById('game-elements').style.display = 'flex';
            document.getElementById('timer-container').style.display = 'block';
            document.getElementById('end-modal').style.display = 'none';
            document.getElementById('heard-text').innerText = "...";
            
            isGameRunning = true;
            try { recognition.start(); } catch(e) {}

            nextRound();
        }

        function nextRound() {
            if (currentRoundIndex >= TOTAL_ROUNDS) { endGame(); return; }

            updateProgressBar();
            const wordDisplay = document.getElementById('word-display');
            const feedback = document.getElementById('feedback');
            
            feedback.innerText = "";
            // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ ÙØ¦Ø§Øª Ø§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
            wordDisplay.className = "target-word"; 
            wordDisplay.innerText = "";
            
            setTimeout(() => {
                currentTargetWord = roundQueue[currentRoundIndex];
                wordDisplay.innerText = currentTargetWord;
                
                // ØªÙ„ÙˆÙŠÙ† Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                wordDisplay.style.color = wordColors[Math.floor(Math.random() * wordColors.length)];

                wordDisplay.classList.add('visible');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ¶Ø¹ "ØµØ§Ø±ÙˆØ®" (3000ms)ØŒ Ø£Ø¶Ù ØªØ£Ø«ÙŠØ± Ø§Ù„ØªÙ„Ø§Ø´ÙŠ
                if (selectedTimeMs === 3000) {
                    wordDisplay.classList.add('fading-mode');
                }

                startTimer();
            }, 500);
        }

        function startTimer() {
            const timerBar = document.getElementById('timer-bar');
            timerBar.style.transition = 'none';
            timerBar.style.width = '100%';
            void timerBar.offsetWidth; 
            timerBar.style.transition = `width ${selectedTimeMs}ms linear`;
            timerBar.style.width = '0%';

            clearTimeout(timerInterval);
            timerInterval = setTimeout(() => {
                handleRoundResult(false);
            }, selectedTimeMs);
        }

        function checkAnswer(spokenText) {
            if (!isGameRunning || !currentTargetWord) return;

            const spoken = normalizeArabic(spokenText);
            const target = normalizeArabic(currentTargetWord);

            if (spoken.includes(target)) {
                clearTimeout(timerInterval);
                handleRoundResult(true);
            }
        }

        function handleRoundResult(isCorrect) {
            const currentWord = currentTargetWord;
            currentTargetWord = null; 
            const feedback = document.getElementById('feedback');
            const wordDisplay = document.getElementById('word-display');
            
            if (isCorrect) {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ù„Ø³Ù„Ø©: Ø¥Ø°Ø§ ÙˆØµÙ„Øª 3ØŒ Ø¶Ø§Ø¹Ù Ø§Ù„Ù†Ù‚Ø§Ø·
                currentStreak++;
                let pointsToAdd = 1;
                
                if (currentStreak >= 3) {
                    pointsToAdd = 2; // Ù…Ø¶Ø§Ø¹ÙØ©
                    feedback.innerHTML = "ğŸ”¥ğŸ”¥ Ø´Ø¹Ù„Ø©! (+2)";
                } else {
                    feedback.innerHTML = getRandomMotivation();
                }

                currentScore += pointsToAdd;
                
                feedback.className = "feedback-msg feedback-success";
                wordDisplay.classList.add('correct-anim');
                playSound('success');
            } else {
                currentStreak = 0; // Ø§Ù†Ù‚Ø·Ø¹Øª Ø§Ù„Ø³Ù„Ø³Ù„Ø©
                
                // Ù„Ø§ Ù†Ù†Ù‚Øµ Ù†Ù‚Ø§Ø· ÙˆÙ„ÙƒÙ† Ù„Ø§ Ù†Ø²ÙŠØ¯ØŒ ÙˆÙ†Ø¶ÙŠÙ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
                feedback.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
                feedback.className = "feedback-msg feedback-error";
                wordDisplay.classList.add('wrong-anim');
                missedWords.push(currentWord);
                playSound('fail');
            }

            updateScoreUI();
            updateStreakUI(); // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø´Ø¹Ù„Ø©
            
            currentRoundIndex++;
            updateProgressBar();
            
            setTimeout(() => {
                nextRound();
            }, 1200); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØ£Ø«ÙŠØ±
        }

        function endGame() {
            isGameRunning = false;
            recognition.stop();
            updateBestScore(); // Ø­ÙØ¸ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠ
            
            document.getElementById('game-elements').style.display = 'none';
            document.getElementById('start-panel').style.display = 'flex';
            document.getElementById('word-display').innerText = ""; 
            
            showEndModal();
        }

        // --- ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
        function updateScoreUI() {
            document.getElementById('score-display').innerText = currentScore;
        }

        function updateStreakUI() {
            const streakIcon = document.getElementById('streak-indicator');
            if (currentStreak >= 3) {
                streakIcon.classList.add('streak-active');
            } else {
                streakIcon.classList.remove('streak-active');
            }
        }

        function showEndModal() {
            const modal = document.getElementById('end-modal');
            const scoreVal = document.getElementById('final-score-val');
            const msg = document.getElementById('final-motivation');
            const titleBadge = document.getElementById('title-badge');
            const missedSection = document.getElementById('missed-words-section');
            const missedList = document.getElementById('missed-words-list');
            
            scoreVal.innerText = currentScore;

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨
            let titleText = "";
            let titleColor = "";
            
            if (currentScore >= 15) { // Ù„Ø£Ù† Ø§Ù„Ù†Ù‚Ø§Ø· Ù‚Ø¯ ØªØªØ¶Ø§Ø¹Ù
                titleText = "ğŸ‘‘ Ù…Ù„Ùƒ Ø§Ù„ÙƒÙ„Ù…Ø§Øª"; titleColor = "#8e44ad";
                msg.innerText = "Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ³ØªØ·ÙŠØ¹ Ù…Ø¬Ø§Ø±Ø§ØªÙƒ!";
            } else if (currentScore >= 8) {
                titleText = "ğŸš€ Ø¹Ø¨Ù‚Ø±ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø§Øª"; titleColor = "#27ae60";
                msg.innerText = "Ø£Ø¯Ø§Ø¡ Ù…Ø°Ù‡Ù„ ÙˆØ³Ø±Ø¹Ø© Ø®ÙŠØ§Ù„ÙŠØ©!";
            } else if (currentScore >= 5) {
                titleText = "âœˆï¸ Ù‚Ø§Ø±Ø¦ Ù†ÙØ§Ø«"; titleColor = "#2980b9";
                msg.innerText = "Ù…Ø³ØªÙˆØ§Ùƒ Ø±Ø§Ø¦Ø¹ØŒ Ø§Ø³ØªÙ…Ø±!";
            } else {
                titleText = "ğŸŒ± Ù…ØªØ¯Ø±Ø¨ ÙˆØ§Ø¹Ø¯"; titleColor = "#f39c12";
                msg.innerText = "Ø¨Ø¯Ø§ÙŠØ© Ø¬ÙŠØ¯Ø©ØŒ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙŠØµÙ†Ø¹ Ø§Ù„Ù…Ø¹Ø¬Ø²Ø§Øª!";
            }

            titleBadge.innerText = titleText;
            titleBadge.style.backgroundColor = titleColor;

            // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
            missedList.innerHTML = "";
            if (missedWords.length > 0) {
                missedSection.style.display = "block";
                missedWords.forEach(word => {
                    const tag = document.createElement("span");
                    tag.className = "missed-tag";
                    tag.innerText = word;
                    missedList.appendChild(tag);
                });
            } else {
                missedSection.style.display = "none";
                if(currentScore > 0) msg.innerText += " (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø£Ø®Ø·Ø§Ø¡! ğŸ‰)";
            }

            modal.style.display = 'flex';
        }

        // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ---
        function updateProgressBar() {
            const percent = (currentRoundIndex / TOTAL_ROUNDS) * 100;
            document.getElementById('rounds-progress').style.width = `${percent}%`;
        }

        function normalizeArabic(text) {
            if (!text) return "";
            text = text.trim();
            text = text.replace(/[Ø£Ø¥Ø¢]/g, 'Ø§');
            text = text.replace(/Ø©/g, 'Ù‡');
            text = text.replace(/Ù‰/g, 'ÙŠ');
            return text;
        }

        function getRandomMotivation() {
            const phrases = ["Ù…Ù…ØªØ§Ø²! ğŸŒŸ", "Ø±Ø§Ø¦Ø¹! ğŸš€", "Ù…Ø°Ù‡Ù„! âš¡", "Ø¨Ø·Ù„! ğŸ†", "Ø£Ø­Ø³Ù†Øª! ğŸ‘"];
            return phrases[Math.floor(Math.random() * phrases.length)];
        }

        function playSound(type) {
            const body = document.body;
            if(type === 'success') {
                body.style.backgroundColor = "#eafaf1";
                setTimeout(() => body.style.backgroundColor = "var(--bg-color)", 300);
            } else {
                body.style.backgroundColor = "#fdedec";
                setTimeout(() => body.style.backgroundColor = "var(--bg-color)", 300);
            }
        }

        function closeEndModal() { document.getElementById('end-modal').style.display = 'none'; }
        
        // Ø¥Ø¯Ø§Ø±Ø©
        function openAdmin() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('admin-pass-input').value = '';
            document.getElementById('pass-error').innerText = '';
            document.getElementById('admin-pass-input').focus();
        }
        function closePasswordModal() { document.getElementById('password-modal').style.display = 'none'; }
        function checkAdminPassword() {
            if (document.getElementById('admin-pass-input').value === "1234") {
                closePasswordModal(); renderAdminTable(); document.getElementById('admin-modal').style.display = 'flex';
            } else { document.getElementById('pass-error').innerText = "Ø®Ø·Ø£!"; }
        }
        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
        
        function renderAdminTable() {
            const table = document.getElementById('words-table'); table.innerHTML = "";
            wordBank.forEach((word, idx) => {
                table.innerHTML += `<tr><td><input type="text" value="${word}" onchange="editWord(${idx}, this.value)" maxlength="5"></td><td style="width:50px;"><button class="btn-mini bg-red" onclick="deleteWord(${idx})">Ø­Ø°Ù</button></td></tr>`;
            });
        }
        function addWord() {
            const val = document.getElementById('new-word-input').value.trim();
            if (val && val.length >= 3 && val.length <= 5) { wordBank.unshift(val); saveWords(); document.getElementById('new-word-input').value = ""; }
        }
        function editWord(idx, val) { if(val) { wordBank[idx] = val; saveWords(); } }
        function deleteWord(idx) { if(confirm("Ø­Ø°ÙØŸ")) { wordBank.splice(idx, 1); saveWords(); } }
        function resetDefaultWords() { if(confirm("Ø§Ø³ØªØ¹Ø§Ø¯Ø©ØŸ")) { generateDefaultWords(); renderAdminTable(); } }

        init();

    </script>
</body>
</html>

