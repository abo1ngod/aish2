<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ­Ø¯ÙŠ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠØ©</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #c0392b;
            --bg-color: #f0f3f6;
            --card-bg: #ffffff;
            --gold: #f1c40f;
            --silver: #bdc3c7;
            --bronze: #cd7f32;
            --highlight: #f1c40f;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
            user-select: none;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header-area {
            width: 100%;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: sticky;
            top: 0;
        }

        .app-title { font-size: 1.2rem; font-weight: 800; color: var(--primary); }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© --- */
        .dashboard-container {
            width: 100%;
            max-width: 800px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .player-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .player-card:hover { transform: translateY(-5px); border-color: var(--accent); }

        .player-rank {
            position: absolute; top: 5px; right: 5px; font-size: 0.8rem; font-weight: bold;
            width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; background: #95a5a6;
        }
        .rank-1 { background: var(--gold); box-shadow: 0 0 10px var(--gold); }
        .rank-2 { background: var(--silver); }
        .rank-3 { background: var(--bronze); }

        .player-name { font-size: 1.1rem; font-weight: bold; color: var(--primary); margin: 10px 0 5px 0; }
        .player-score { font-size: 1.8rem; font-weight: 800; color: var(--accent); }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© --- */
        .game-section {
            display: none; width: 100%; height: 100vh; position: fixed; top: 0; left: 0;
            background: var(--bg-color); z-index: 200; flex-direction: column; align-items: center;
        }

        .game-header {
            width: 100%; padding: 15px; background: white; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .back-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Øµ (Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ) */
        .text-display-area {
            width: 90%;
            max-width: 700px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 1.8rem;
            line-height: 2;
            text-align: justify;
            direction: rtl;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: 50vh;
            overflow-y: auto;
            position: relative;
        }

        .word-span {
            padding: 2px 5px;
            border-radius: 4px;
            transition: all 0.2s;
            display: inline-block;
        }

        .word-span.current {
            background-color: var(--highlight); /* Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© */
            transform: scale(1.1);
            font-weight: bold;
        }

        .word-span.correct {
            color: var(--success);
            /* text-decoration: underline; */
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙˆÙ‚ÙŠØª */
        .timer-container {
            width: 90%; max-width: 700px; height: 10px; background: #ddd; border-radius: 6px; margin: 20px 0; overflow: hidden;
        }
        .timer-bar { height: 100%; width: 100%; background: var(--accent); transition: width 1s linear; }
        .timer-text { font-weight: bold; color: var(--primary); margin-top: 5px; }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø© */
        .mode-selection {
            background: white; padding: 30px; border-radius: 20px; text-align: center; margin-top: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 400px;
        }
        .mode-btn {
            display: block; width: 100%; padding: 15px; margin: 10px 0; border: 2px solid #eee;
            background: white; border-radius: 10px; font-size: 1.1rem; cursor: pointer; text-align: left;
        }
        .mode-btn.active { border-color: var(--accent); background: #ebf5fb; }
        .mode-btn span { float: left; font-weight: bold; }
        .mode-btn small { float: right; color: #7f8c8d; }

        .start-btn-big {
            background: var(--primary); color: white; font-size: 1.5rem; padding: 15px 40px;
            border-radius: 50px; border: none; margin-top: 20px; width: 100%; cursor: pointer;
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 95%; max-width: 500px; border-radius: 15px; padding: 20px; text-align: center;
        }

        /* Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; margin-bottom: 10px;}
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        td, th { padding: 8px; border-bottom: 1px solid #eee; text-align: right; }

        .mic-status { position: absolute; top: 20px; left: 20px; font-size: 1.5rem; opacity: 0.2; }
        .mic-active { opacity: 1; color: var(--danger); animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .countdown-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center; align-items: center;
            z-index: 300;
        }
        .countdown-number { font-size: 8rem; color: var(--accent); font-weight: bold; animation: zoomIn 0.5s ease-out; }
        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }

    </style>
</head>
<body>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <div class="header-area">
        <div class="app-title">â±ï¸ Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠØ©</div>
        <button onclick="openAdmin()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âš™ï¸</button>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© -->
    <div class="dashboard-container" id="dashboard">
        <div style="background: #e8f6f3; padding: 15px; border-radius: 10px; border: 1px solid #d1f2eb; color: #0e6655; margin-bottom: 10px;">
            â„¹ï¸ Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±Ø¹Ø©. Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚Ø©.
        </div>
        <div class="players-grid" id="players-grid"></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div class="game-section" id="game-section">
        <div class="game-header">
            <button class="back-btn" onclick="exitGame()">âœ•</button>
            <div style="font-weight: bold;">Ø§Ù„Ù‚Ø§Ø±Ø¦: <span id="active-player-name" style="color:var(--accent);">...</span></div>
            <div style="font-weight: bold;">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: <span id="current-wpm" style="color:var(--success);">0</span></div>
        </div>

        <div id="mic-icon" class="mic-status">ğŸ™ï¸</div>

        <!-- Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ -->
        <div id="countdown-layer" class="countdown-overlay">
            <div id="countdown-num" class="countdown-number">3</div>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ø© -->
        <div id="mode-selector" class="mode-selection">
            <h3>Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
            <button class="mode-btn active" onclick="selectTime(60, this)">
                <span>â±ï¸ Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø© (Ù‚ÙŠØ§Ø³ÙŠ)</span> <small>60 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            <button class="mode-btn" onclick="selectTime(45, this)">
                <span>âš¡ Ø³Ø±ÙŠØ¹</span> <small>45 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            <button class="mode-btn" onclick="selectTime(30, this)">
                <span>ğŸš€ Ø®Ø§Ø·Ù</span> <small>30 Ø«Ø§Ù†ÙŠØ©</small>
            </button>
            
            <button class="start-btn-big" onclick="initGameSequence()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</button>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© -->
        <div id="active-game-area" style="display: none; width: 100%; flex-direction: column; align-items: center;">
            <div class="timer-container">
                <div class="timer-bar" id="timer-bar" style="width: 100%;"></div>
            </div>
            <div class="timer-text">Ø¨Ø§Ù‚ÙŠ Ù…Ù† Ø§Ù„ÙˆÙ‚Øª: <span id="time-remaining">60</span> Ø«Ø§Ù†ÙŠØ©</div>

            <div id="text-container" class="text-display-area">
                <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ -->
            </div>
            
            <div style="margin-top: 10px; color: #95a5a6; font-size: 0.9rem;">
                ÙŠØ³Ù…Ø¹: <span id="heard-text">...</span>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†Ù‡Ø§ÙŠØ© -->
    <div id="end-modal" class="modal-overlay">
        <div class="modal-content">
            <h1>ğŸ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª</h1>
            <p>Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:</p>
            <div style="font-size: 4rem; font-weight: bold; color: var(--accent);" id="final-wpm">0</div>
            <p style="color:#7f8c8d; font-weight:bold;">ÙƒÙ„Ù…Ø© / Ø¯Ù‚ÙŠÙ‚Ø©</p>
            <button class="start-btn-big" onclick="finishSession()">Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div id="pass-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 300px;">
            <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
            <input type="password" id="admin-pass" placeholder="1234" style="width: 100%; padding: 10px; text-align: center; margin-bottom: 10px; font-size: 1.2rem;">
            <button onclick="checkPass()" class="start-btn-big" style="margin-top:0; padding: 10px; font-size: 1rem;">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="document.getElementById('pass-modal').style.display='none'" style="margin-top: 10px; background: none; border: none; color: #999; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
                <button onclick="document.getElementById('admin-modal').style.display='none'" style="background:var(--danger); color:white; border:none; width:30px; height:30px; border-radius:50%; cursor:pointer;">âœ•</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('players')">Ø§Ù„Ø·Ù„Ø§Ø¨</button>
                <button class="tab-btn" onclick="switchTab('texts')">Ø§Ù„Ù†ØµÙˆØµ</button>
            </div>

            <div id="tab-players">
                <button onclick="resetAllScores()" style="width:100%; padding:8px; background:var(--danger); color:white; border:none; border-radius:8px; margin-bottom:10px;">ØªØµÙÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
                <div style="max-height: 300px; overflow-y: auto;">
                    <table id="admin-players-table"></table>
                </div>
            </div>

            <div id="tab-texts" style="display:none;">
                <textarea id="new-text-in" placeholder="Ø§Ù„ØµÙ‚ Ù†Øµ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù‡Ù†Ø§..."></textarea>
                <button onclick="addText()" style="width:100%; padding:8px; background:var(--success); color:white; border:none; border-radius:8px;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ</button>
                <div style="max-height: 200px; overflow-y: auto; margin-top:15px;">
                    <table id="admin-texts-table"></table>
                </div>
                <button onclick="resetTexts()" style="margin-top:10px; width:100%; padding:8px; background:#95a5a6; color:white; border:none; border-radius:4px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        const DEFAULT_PLAYERS = ["Ø¨Ø¯Ø±ÙŠØ©", "Ù†Ø¬ÙˆØ¯", "Ø£Ù…Ø¬Ø§Ø¯", "Ø£Ù†Ø³", "ÙŠØ§Ø³Ø±", "ÙˆØ¬Ø¯Ø§Ù†", "Ù…Ø§Ø¬Ø¯", "Ø¹Ø§Ø¦Ø´"];
        let players = [];
        let textBank = [];
        
        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø© ---
        let activePlayerIndex = null;
        let selectedTimeSec = 60;
        let timeRemaining = 60;
        let correctWordsCount = 0;
        let currentTextWords = []; // Ù…ØµÙÙˆÙØ© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø§Ù„ÙŠ
        let currentWordIndex = 0; // Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ Ø§Ù„Ø¢Ù†
        let timerInterval = null;
        let recognition;
        let isGameRunning = false;

        function init() {
            loadData();
            setupSpeech();
            renderDashboard();
        }

        function loadData() {
            const savedPlayers = localStorage.getItem('fluency_players');
            players = savedPlayers ? JSON.parse(savedPlayers) : DEFAULT_PLAYERS.map((n, i) => ({ id: i, name: n, topScore: 0 }));
            if(!savedPlayers) savePlayers();

            const savedTexts = localStorage.getItem('fluency_texts');
            textBank = savedTexts ? JSON.parse(savedTexts) : generateDefaultTexts();
            if(!savedTexts) saveTexts();
        }

        function savePlayers() { localStorage.setItem('fluency_players', JSON.stringify(players)); renderDashboard(); }
        function saveTexts() { localStorage.setItem('fluency_texts', JSON.stringify(textBank)); }

        function generateDefaultTexts() {
            return [
                "Ø°Ù‡Ø¨ Ø£Ø­Ù…Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø© Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ù‡ ÙÙŠ ÙŠÙˆÙ… Ù…Ø´Ù…Ø³ ÙˆØ¬Ù…ÙŠÙ„ØŒ Ù„Ø¹Ø¨ÙˆØ§ Ø¨Ø§Ù„ÙƒØ±Ø© ÙˆØ§Ø³ØªÙ…ØªØ¹ÙˆØ§ Ø¨Ø§Ù„Ù‡ÙˆØ§Ø¡ Ø§Ù„Ø¹Ù„ÙŠÙ„ØŒ Ø«Ù… Ø¬Ù„Ø³ÙˆØ§ Ù„ÙŠØªÙ†Ø§ÙˆÙ„ÙˆØ§ Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ù„Ø°ÙŠØ°.",
                "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ø±ÙØ©ØŒ ÙˆÙ‡ÙŠ ØªÙ†ÙŠØ± Ø§Ù„Ø¹Ù‚Ù„ ÙˆØªÙˆØ³Ø¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ùƒ. Ø§Ù„ÙƒØªØ§Ø¨ Ø®ÙŠØ± Ø¬Ù„ÙŠØ³ Ù„Ù„Ø¥Ù†Ø³Ø§Ù†ØŒ ÙŠØ¹Ù„Ù…Ù‡ Ù…Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù„Ù… ÙˆÙŠØ£Ø®Ø°Ù‡ ÙÙŠ Ø±Ø­Ù„Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†.",
                "ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø© Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ØªØ¹ÙŠØ´ Ø­ÙŠÙˆØ§Ù†Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ù…Ù†Ù‡Ø§ Ø§Ù„Ø£Ø³Ø¯ Ø§Ù„Ù‚ÙˆÙŠ ÙˆØ§Ù„ØºØ²Ø§Ù„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„Ø¹ØµÙÙˆØ± Ø§Ù„ØµØºÙŠØ±. ØªØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù„ØªØ¹ÙŠØ´ Ø¨Ø³Ù„Ø§Ù… ÙˆØ£Ù…Ø§Ù†."
            ];
        }

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ---
        function renderDashboard() {
            const grid = document.getElementById('players-grid');
            grid.innerHTML = "";
            const sorted = [...players].sort((a, b) => b.topScore - a.topScore);

            players.forEach((p, idx) => {
                const rank = sorted.findIndex(x => x.id === p.id) + 1;
                let rankClass = rank === 1 ? "rank-1" : (rank === 2 ? "rank-2" : (rank === 3 ? "rank-3" : ""));
                
                grid.innerHTML += `
                    <div class="player-card" onclick="selectPlayer(${idx})">
                        ${rank <= 3 ? `<div class="player-rank ${rankClass}">${rank}</div>` : ''}
                        <div style="font-size:2.5rem;">ğŸ‘¤</div>
                        <div class="player-name">${p.name}</div>
                        <div class="player-score">${p.topScore}</div>
                        <div style="font-size:0.8rem; color:#95a5a6;">ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©</div>
                    </div>
                `;
            });
        }

        function selectPlayer(idx) {
            activePlayerIndex = idx;
            document.getElementById('active-player-name').innerText = players[idx].name;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('game-section').style.display = 'flex';
            document.getElementById('mode-selector').style.display = 'block';
            document.getElementById('active-game-area').style.display = 'none';
        }

        function selectTime(sec, btn) {
            selectedTimeSec = sec;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ---
        function initGameSequence() {
            if(textBank.length === 0) { alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ!"); return; }
            
            document.getElementById('mode-selector').style.display = 'none';
            document.getElementById('active-game-area').style.display = 'flex';

            // Ø§Ø®ØªÙŠØ§Ø± Ù†Øµ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙˆØªØ¬Ù‡ÙŠØ²Ù‡
            const randomText = textBank[Math.floor(Math.random() * textBank.length)];
            prepareText(randomText);

            // Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
            const layer = document.getElementById('countdown-layer');
            const num = document.getElementById('countdown-num');
            layer.style.display = 'flex';
            let count = 3;
            num.innerText = count;
            
            const iv = setInterval(() => {
                count--;
                if(count > 0) {
                    num.innerText = count;
                    num.style.animation = 'none'; num.offsetHeight; num.style.animation = 'zoomIn 0.5s ease-out';
                } else {
                    clearInterval(iv);
                    layer.style.display = 'none';
                    startGame();
                }
            }, 1000);
        }

        function prepareText(text) {
            const container = document.getElementById('text-container');
            container.innerHTML = "";
            // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ù„ÙƒÙ„Ù…Ø§Øª (Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø²Ø§Ø¦Ø¯Ø©)
            currentTextWords = text.trim().split(/\s+/);
            
            currentTextWords.forEach((word, index) => {
                const span = document.createElement('span');
                span.id = `word-${index}`;
                span.className = 'word-span';
                span.innerText = word + " ";
                container.appendChild(span);
            });
            
            currentWordIndex = 0;
            updateWordHighlight();
        }

        function updateWordHighlight() {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ø§Ø¨Ù‚
            document.querySelectorAll('.word-span').forEach(el => el.classList.remove('current'));
            // ØªÙ…ÙŠÙŠØ² Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            const currEl = document.getElementById(`word-${currentWordIndex}`);
            if(currEl) {
                currEl.classList.add('current');
                // ØªÙ…Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ (Scroll) Ù„Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                currEl.scrollIntoView({behavior: "smooth", block: "center"});
            }
        }

        function startGame() {
            correctWordsCount = 0;
            timeRemaining = selectedTimeSec;
            document.getElementById('current-wpm').innerText = 0;
            document.getElementById('time-remaining').innerText = timeRemaining;
            
            isGameRunning = true;
            try { recognition.start(); } catch(e) {}
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('time-remaining').innerText = timeRemaining;
                
                const percent = (timeRemaining / selectedTimeSec) * 100;
                document.getElementById('timer-bar').style.width = `${percent}%`;

                if(timeRemaining <= 0) endGame();
            }, 1000);
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ø§Ù„Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø§Ø¨Ø¶) ---
        function checkVoiceInput(spokenText) {
            if(!isGameRunning) return;
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³Ù…ÙˆØ¹
            const spokenClean = normalizeArabic(spokenText);
            
            // Ù†Ø­Ù† Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù†Øµ
            if (currentWordIndex < currentTextWords.length) {
                const targetWordRaw = currentTextWords[currentWordIndex];
                // Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                const targetClean = normalizeArabic(targetWordRaw.replace(/[ØŒ.Ø›:!ØŸ]/g, ''));

                // Ù‡Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ¹Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©ØŸ
                // Ù†Ø³ØªØ®Ø¯Ù… Includes Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ÙŠÙ‚ÙˆÙ„ Ø¬Ù…Ù„Ø©
                if (spokenClean.includes(targetClean)) {
                    // Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!
                    const span = document.getElementById(`word-${currentWordIndex}`);
                    span.classList.add('correct');
                    span.classList.remove('current');
                    
                    correctWordsCount++;
                    currentWordIndex++;
                    
                    document.getElementById('current-wpm').innerText = correctWordsCount;
                    updateWordHighlight();

                    // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù†Øµ Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ‚Øª
                    if(currentWordIndex >= currentTextWords.length) {
                        endGame();
                    }
                }
            }
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            recognition.stop();
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø© (WPM)
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø£Ù‚Ù„ Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ù„ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø³Ø±Ø¹Ø© ÙÙŠ Ø¯Ù‚ÙŠÙ‚Ø©
            let wpm = Math.round(correctWordsCount * (60 / (selectedTimeSec - timeRemaining)));
            if (selectedTimeSec === 60 && timeRemaining <= 0) wpm = correctWordsCount; // Ø¯Ù‚ÙŠÙ‚Ø© ÙƒØ§Ù…Ù„Ø©

            document.getElementById('final-wpm').innerText = wpm;
            
            // ØªØ­Ø¯ÙŠØ« Ø£ÙØ¶Ù„ Ø±Ù‚Ù… Ù„Ù„Ø·Ø§Ù„Ø¨
            if(wpm > players[activePlayerIndex].topScore) {
                players[activePlayerIndex].topScore = wpm;
                savePlayers();
            }

            document.getElementById('end-modal').style.display = 'flex';
        }

        function finishSession() {
            document.getElementById('end-modal').style.display = 'none';
            exitGame();
        }

        function exitGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            try { recognition.stop(); } catch(e) {}
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            renderDashboard();
        }

        // --- Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ ---
        function setupSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechAPI();
                recognition.lang = 'ar-SA';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onstart = () => document.getElementById('mic-icon').classList.add('mic-active');
                recognition.onend = () => {
                    document.getElementById('mic-icon').classList.remove('mic-active');
                    if (isGameRunning) recognition.start();
                };
                recognition.onresult = (e) => {
                    const txt = e.results[e.results.length - 1][0].transcript;
                    document.getElementById('heard-text').innerText = txt;
                    checkVoiceInput(txt);
                };
            } else alert("Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
        }

        function normalizeArabic(text) {
            return text.trim()
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                .replace(/Ø©/g, 'Ù‡')
                .replace(/Ù‰/g, 'ÙŠ')
                .replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘]/g, ''); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ´ÙƒÙŠÙ„
        }

        // --- Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        function openAdmin() { document.getElementById('pass-modal').style.display = 'flex'; document.getElementById('admin-pass').value = ''; }
        function checkPass() {
            if(document.getElementById('admin-pass').value === "1234") {
                document.getElementById('pass-modal').style.display = 'none';
                renderAdminPlayers();
                document.getElementById('admin-modal').style.display = 'flex';
            } else alert("Ø®Ø·Ø£");
        }
        function switchTab(t) {
            document.querySelectorAll('[id^="tab-"]').forEach(d => d.style.display = 'none');
            document.getElementById('tab-'+t).style.display = 'block';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            if(t === 'players') renderAdminPlayers(); else renderAdminTexts();
        }

        function renderAdminPlayers() {
            const t = document.getElementById('admin-players-table'); t.innerHTML = "";
            players.forEach((p, i) => {
                t.innerHTML += `<tr><td><input value="${p.name}" onchange="players[${i}].name=this.value; savePlayers()"></td><td>${p.topScore}</td></tr>`;
            });
        }
        function renderAdminTexts() {
            const t = document.getElementById('admin-texts-table'); t.innerHTML = "";
            textBank.forEach((txt, i) => {
                t.innerHTML += `<tr><td style="font-size:0.8rem">${txt.substring(0,50)}...</td><td><button onclick="textBank.splice(${i},1); saveTexts(); renderAdminTexts()" style="color:red">âœ•</button></td></tr>`;
            });
        }
        function addText() {
            const v = document.getElementById('new-text-in').value;
            if(v) { textBank.push(v); saveTexts(); renderAdminTexts(); document.getElementById('new-text-in').value = ""; }
        }
        function resetAllScores() { if(confirm('ØªØ£ÙƒÙŠØ¯ØŸ')) { players.forEach(p => p.topScore=0); savePlayers(); renderAdminPlayers(); } }
        function resetTexts() { if(confirm('ØªØ£ÙƒÙŠØ¯ØŸ')) { textBank = generateDefaultTexts(); saveTexts(); renderAdminTexts(); } }

        init();
    </script>
</body>
</html>

