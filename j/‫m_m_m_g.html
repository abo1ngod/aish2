<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ù…Ù‡Ø§Ù…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f8fafc;
        }
        .tab-active {
            border-bottom: 3px solid #2563eb;
            color: #2563eb;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        #mainTitle {
            cursor: pointer;
            user-select: none;
        }
        .task-done {
            text-decoration: line-through;
            color: #94a3b8;
        }
        .no-select {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        /* Styles for Control Tab */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .style-btn-active {
            background-color: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 id="mainTitle" class="text-3xl font-bold text-slate-800">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ù…Ù‡Ø§Ù…</h1>
            <p id="adminStatus" class="text-slate-400 text-xs mt-1 h-4"></p>
        </header>

        <!-- Dynamic Form Card (Admin Only) -->
        <div id="formContainer" class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 mb-6 hidden">
            <!-- Expense Form -->
            <form id="expenseForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-slate-700 mb-1">Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù</label>
                        <input type="text" id="itemName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„Ø¨Ù‚Ø§Ù„Ø©" 
                            class="p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-slate-700 mb-1">Ø§Ù„Ø³Ø¹Ø±</label>
                        <input type="number" id="itemPrice" step="0.01" placeholder="0.00" 
                            class="p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                </div>
                <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <span id="submitText">Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</span>
                </button>
            </form>

            <!-- Task Form (Hidden by default, shown when task tab is active) -->
            <form id="taskForm" class="space-y-4 hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-slate-700 mb-1">Ø§Ù„Ù…Ù‡Ù…Ø©</label>
                        <input type="text" id="taskText" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø´Ø±Ø§Ø¡ Ø§Ù„Ø®Ø¶Ø§Ø±" 
                            class="p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-slate-700 mb-1">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label>
                        <input type="text" id="taskAssignee" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…Ø¯" 
                            class="p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all">
                    </div>
                </div>
                <button type="submit" id="taskSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                    <span id="taskSubmitText">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©</span>
                </button>
            </form>
            
            <button type="button" id="cancelEditBtn" class="hidden w-full text-slate-500 text-sm hover:underline mt-2">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            <div id="errorMessage" class="hidden mt-3 p-3 bg-red-50 text-red-600 text-sm rounded-lg text-center"></div>
        </div>

        <!-- Summary Card -->
        <div id="summaryCard" class="bg-blue-600 rounded-2xl p-6 mb-6 text-white flex justify-between items-center shadow-lg shadow-blue-200">
            <div>
                <p id="summaryLabel" class="text-blue-100 text-sm">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</p>
                <h2 id="totalDisplay" class="text-4xl font-bold mt-1">0.00</h2>
            </div>
            <div class="bg-blue-500/30 p-4 rounded-xl">
                <svg id="summaryIcon" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            </div>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex border-b border-slate-200 mb-4">
            <button id="tabExpenses" class="flex-1 py-3 font-bold text-center tab-active transition-all">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</button>
            <button id="tabTasks" class="flex-1 py-3 font-bold text-center text-slate-400 hover:text-slate-600 transition-all">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
            <button id="tabControl" class="flex-1 py-3 font-bold text-center text-slate-400 hover:text-slate-600 transition-all">Ø³ÙŠØ·Ø±Ø©</button>
        </div>

        <!-- List Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div id="listHeader" class="p-4 border-b border-slate-50 flex justify-between items-center">
                <h3 id="listTitle" class="font-bold text-slate-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h3>
                <button id="clearAll" class="text-xs text-red-500 hover:underline hidden text-nowrap">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
            </div>

            <!-- Style Selector (Only for Control) -->
            <div id="styleSelector" class="hidden px-4 py-2 bg-slate-50 border-b border-slate-100 overflow-x-auto whitespace-nowrap scrollbar-hide">
                <div class="flex gap-2">
                    <button onclick="setControlStyle(1)" class="style-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-200 bg-white" id="styleBtn1">Ø·Ø§ÙˆÙ„Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</button>
                    <button onclick="setControlStyle(2)" class="style-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-200 bg-white" id="styleBtn2">Ø´Ø¨ÙƒØ© Ø¨ÙŠÙ†ØªÙˆ</button>
                    <button onclick="setControlStyle(3)" class="style-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-200 bg-white" id="styleBtn3">Ù‚Ø§Ø¦Ù…Ø© Ø²Ø¬Ø§Ø¬ÙŠØ©</button>
                    <button onclick="setControlStyle(4)" class="style-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-200 bg-white" id="styleBtn4">Ù„ÙˆØ­Ø© ØªÙ‚ÙŠÙŠÙ…</button>
                    <button onclick="setControlStyle(5)" class="style-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-200 bg-white" id="styleBtn5">ØªØµÙ…ÙŠÙ… Ù†ÙŠÙˆÙ†</button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="mainTable" class="w-full text-right">
                    <thead id="tableHeader" class="bg-slate-50 text-slate-500 text-sm">
                        <!-- Dynamic Header -->
                    </thead>
                    <tbody id="mainList">
                        <!-- Content Injected Here -->
                    </tbody>
                </table>
                <!-- Alternate views for Control -->
                <div id="controlAltView" class="hidden p-4"></div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="p-12 text-center text-slate-400">
                <svg class="mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="deleteModal" class="modal-overlay">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl">
            <h3 class="text-lg font-bold text-slate-800 mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p class="text-slate-600 mb-6 text-sm">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±ØŸ</p>
            <div class="flex gap-3">
                <button id="confirmDeleteBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold">Ø­Ø°Ù</button>
                <button id="cancelDeleteBtn" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxPO6RKsQ1Cq-mqlCpFTrCuIyxnYdB37U",
            authDomain: "studentsystem-c1ab1.firebaseapp.com",
            databaseURL: "https://studentsystem-c1ab1-default-rtdb.firebaseio.com",
            projectId: "studentsystem-c1ab1",
            storageBucket: "studentsystem-c1ab1.firebasestorage.app",
            messagingSenderId: "112215023848",
            appId: "1:112215023848:web:0adba326a527ee7e37e95d"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const expenseRef = db.ref('msaref');
        const taskRef = db.ref('tasks');
        const controlRef = db.ref('control');

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ù„Ù„Ø³ÙŠØ·Ø±Ø©
        const controlPersons = [
            'Ø¹Ø§Ø¦Ø´ ÙØ±Ø§Ø¬',
            'Ø¨Ø¯Ø±ÙŠØ© Ù‡Ù„ÙŠÙ„',
            'Ù†Ø¬ÙˆØ¯ Ø¹Ø§Ø¦Ø´',
            'Ø£Ù…Ø¬Ø§Ø¯ Ø¹Ø§Ø¦Ø´',
            'Ø£Ù†Ø³ Ø¹Ø§Ø¦Ø´',
            'ÙŠØ§Ø³Ø± Ø¹Ø§Ø¦Ø´',
            'ÙˆØ¬Ø¯Ø§Ù† Ø¹Ø§Ø¦Ø´',
            'Ù…Ø§Ø¬Ø¯ Ø¹Ø§Ø¦Ø´',
            'Ø­ÙˆØ± Ø¹Ø§Ø¦Ø´'
        ];

        // --- Ø§Ù„Ø­Ø§Ù„Ø© (State) ---
        let expenses = [];
        let tasks = [];
        let controlData = {};
        let activeTab = 'expenses'; // 'expenses' or 'tasks' or 'control'
        let isAdminMode = false;
        let editId = null;
        let itemToDeleteId = null;
        let controlStyle = 1; // Style Selection for Control

        // --- DOM Elements ---
        const mainTitle = document.getElementById('mainTitle');
        const adminStatus = document.getElementById('adminStatus');
        const formContainer = document.getElementById('formContainer');
        const expenseForm = document.getElementById('expenseForm');
        const taskForm = document.getElementById('taskForm');
        const mainList = document.getElementById('mainList');
        const totalDisplay = document.getElementById('totalDisplay');
        const emptyState = document.getElementById('emptyState');
        const listTitle = document.getElementById('listTitle');
        const clearAllBtn = document.getElementById('clearAll');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const styleSelector = document.getElementById('styleSelector');
        const mainTable = document.getElementById('mainTable');
        const controlAltView = document.getElementById('controlAltView');

        // --- Tabs Logic ---
        document.getElementById('tabExpenses').onclick = () => switchTab('expenses');
        document.getElementById('tabTasks').onclick = () => switchTab('tasks');
        document.getElementById('tabControl').onclick = () => switchTab('control');

        function switchTab(tab) {
            activeTab = tab;
            editId = null;
            document.getElementById('tabExpenses').className = `flex-1 py-3 font-bold text-center transition-all ${tab === 'expenses' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('tabTasks').className = `flex-1 py-3 font-bold text-center transition-all ${tab === 'tasks' ? 'tab-active' : 'text-slate-400'}`;
            document.getElementById('tabControl').className = `flex-1 py-3 font-bold text-center transition-all ${tab === 'control' ? 'tab-active' : 'text-slate-400'}`;

            if (isAdminMode) {
                expenseForm.classList.toggle('hidden', tab !== 'expenses');
                taskForm.classList.toggle('hidden', tab !== 'tasks');
                cancelEditBtn.classList.add('hidden');
            }

            styleSelector.classList.toggle('hidden', tab !== 'control');
            render();
        }

        function setControlStyle(style) {
            controlStyle = style;
            // Update Buttons UI
            document.querySelectorAll('.style-btn').forEach(btn => btn.classList.remove('style-btn-active'));
            document.getElementById(`styleBtn${style}`).classList.add('style-btn-active');
            render();
        }

        // --- Data Fetching ---
        function syncData() {
            expenseRef.on('value', snap => {
                expenses = [];
                const data = snap.val();
                if (data) Object.keys(data).forEach(k => expenses.push({id: k, ...data[k]}));
                render();
            });

            taskRef.on('value', snap => {
                tasks = [];
                const data = snap.val();
                if (data) Object.keys(data).forEach(k => tasks.push({id: k, ...data[k]}));
                render();
            });

            controlRef.on('value', snap => {
                controlData = snap.val() || {};
                render();
            });
        }

        // --- UI Rendering ---
        function render() {
            const tableHeader = document.getElementById('tableHeader');
            mainList.innerHTML = '';
            controlAltView.innerHTML = '';
            mainTable.classList.remove('hidden');
            controlAltView.classList.add('hidden');

            if (activeTab === 'expenses') {
                renderExpenses(tableHeader);
            } else if (activeTab === 'tasks') {
                renderTasks(tableHeader);
            } else if (activeTab === 'control') {
                renderControl(tableHeader);
            }

            // Admin Visuals
            formContainer.classList.toggle('hidden', !isAdminMode || activeTab === 'control');
            clearAllBtn.classList.toggle('hidden', !isAdminMode || activeTab === 'control' || (activeTab === 'expenses' ? expenses.length === 0 : tasks.length === 0));
            adminStatus.innerText = isAdminMode ? "ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…ÙØ¹Ù„" : "";
        }

        function renderExpenses(header) {
            header.innerHTML = `<tr><th class="p-4 font-medium text-right">Ø§Ù„ØµÙ†Ù</th><th class="p-4 font-medium text-right">Ø§Ù„Ø³Ø¹Ø±</th>${isAdminMode ? '<th class="p-4 font-medium text-center">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr>`;
            listTitle.innerText = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª";
            
            const total = expenses.reduce((s, i) => s + parseFloat(i.price), 0);
            totalDisplay.innerText = total.toLocaleString('ar-SA', { minimumFractionDigits: 2 });
            document.getElementById('summaryLabel').innerText = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª";
            document.getElementById('summaryCard').className = "bg-blue-600 rounded-2xl p-6 mb-6 text-white flex justify-between items-center shadow-lg shadow-blue-200";

            if (expenses.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            expenses.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-50 hover:bg-slate-50/50';
                row.innerHTML = `
                    <td class="p-4 text-slate-700 font-medium">${item.name}</td>
                    <td class="p-4 text-slate-600">${parseFloat(item.price).toFixed(2)}</td>
                    ${isAdminMode ? `
                    <td class="p-4 text-center flex justify-center gap-2">
                        <button onclick="editItem('${item.id}')" class="text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button onclick="confirmDelete('${item.id}')" class="text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </td>` : ''}
                `;
                mainList.appendChild(row);
            });
        }

        function renderTasks(header) {
            header.innerHTML = `<tr><th class="p-4 font-medium text-right">Ø§Ù„Ù…Ù‡Ù…Ø©</th><th class="p-4 font-medium text-right">Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</th><th class="p-4 font-medium text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>${isAdminMode ? '<th class="p-4 font-medium text-center">Ø¥Ø¬Ø±Ø§Ø¡</th>' : ''}</tr>`;
            listTitle.innerText = "Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…";
            
            const doneCount = tasks.filter(t => t.done).length;
            totalDisplay.innerText = `${doneCount} / ${tasks.length}`;
            document.getElementById('summaryLabel').innerText = "Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†Ø¬Ø²Ø©";
            document.getElementById('summaryCard').className = "bg-indigo-600 rounded-2xl p-6 mb-6 text-white flex justify-between items-center shadow-lg shadow-indigo-200";

            if (tasks.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            tasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-50 hover:bg-slate-50/50';
                row.innerHTML = `
                    <td class="p-4 font-medium ${task.done ? 'task-done' : 'text-slate-700'}">${task.text}</td>
                    <td class="p-4 text-slate-500 text-sm">${task.assignee}</td>
                    <td class="p-4 text-center">
                        <button ${isAdminMode ? `onclick="toggleTask('${task.id}', ${task.done})"` : 'style="cursor: default;"'} class="p-1 rounded-full ${task.done ? 'text-green-500' : 'text-slate-300'}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                    </td>
                    ${isAdminMode ? `
                    <td class="p-4 text-center flex justify-center gap-2">
                        <button onclick="editItem('${task.id}')" class="text-blue-400"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button>
                        <button onclick="confirmDelete('${task.id}')" class="text-red-400"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>
                    </td>` : ''}
                `;
                mainList.appendChild(row);
            });
        }

        function renderControl(header) {
            listTitle.innerText = "Ø³ÙŠØ·Ø±Ø©";
            let totalPoints = 0;
            controlPersons.forEach(person => {
                const personData = controlData[person] || { shares: [], violations: [] };
                const sharesTotal = (personData.shares || []).reduce((sum, s) => sum + (s.points || 0), 0);
                const violationsTotal = (personData.violations || []).reduce((sum, v) => sum + Math.abs(v.points || 0), 0);
                totalPoints += (sharesTotal - violationsTotal);
            });

            totalDisplay.innerText = totalPoints;
            document.getElementById('summaryLabel').innerText = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·";
            const totalColor = totalPoints >= 0 ? 'bg-emerald-600 shadow-emerald-200' : 'bg-rose-600 shadow-rose-200';
            document.getElementById('summaryCard').className = `${totalColor} rounded-2xl p-6 mb-6 text-white flex justify-between items-center shadow-lg transition-all duration-500`;
            emptyState.classList.add('hidden');

            // --- Choice of New Modern Styles ---
            if (controlStyle === 1) {
                // Professional White Table
                header.innerHTML = `<tr><th class="p-4 font-bold text-slate-700 text-right">Ø§Ù„Ø§Ø³Ù…</th><th class="p-4 font-bold text-slate-700 text-center">Ø§Ù„Ø³Ø¬Ù„</th><th class="p-4 font-bold text-slate-700 text-center">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr>`;
                controlPersons.forEach(person => {
                    const pd = controlData[person] || { shares: [], violations: [] };
                    const sT = pd.shares?.reduce((s,i)=>s+i.points,0) || 0;
                    const vT = pd.violations?.reduce((s,i)=>s+Math.abs(i.points),0) || 0;
                    const net = sT - vT;

                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-50 hover:bg-slate-50/80 transition-colors';
                    row.innerHTML = `
                        <td class="p-4"><span class="font-bold text-slate-800 cursor-pointer" data-person="${person}">${person}</span></td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button class="share-btn no-select px-3 py-1 bg-emerald-50 text-emerald-600 rounded-md text-xs font-bold border border-emerald-100" data-person="${person}">+${pd.shares?.length || 0}</button>
                                <button class="violation-btn no-select px-3 py-1 bg-rose-50 text-rose-600 rounded-md text-xs font-bold border border-rose-100" data-person="${person}">-${pd.violations?.length || 0}</button>
                            </div>
                        </td>
                        <td class="p-4 text-center font-black text-xl ${net >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${net}</td>
                    `;
                    mainList.appendChild(row);
                });
            } else {
                mainTable.classList.add('hidden');
                controlAltView.classList.remove('hidden');
                
                if (controlStyle === 2) {
                    // Bento Grid Style
                    controlAltView.className = 'grid grid-cols-2 gap-3 p-3';
                    controlPersons.forEach(person => {
                        const pd = controlData[person] || { shares: [], violations: [] };
                        const sT = pd.shares?.reduce((s,i)=>s+i.points,0) || 0;
                        const vT = pd.violations?.reduce((s,i)=>s+Math.abs(i.points),0) || 0;
                        const net = sT - vT;
                        const card = document.createElement('div');
                        card.className = 'bg-slate-50 border border-slate-100 p-4 rounded-3xl flex flex-col items-center justify-between text-center gap-2';
                        card.innerHTML = `
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider">Ù†Ù‚Ø§Ø·</div>
                            <div class="text-3xl font-black ${net >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${net}</div>
                            <div class="font-bold text-slate-800 text-sm cursor-pointer line-clamp-1" data-person="${person}">${person}</div>
                            <div class="flex gap-2 w-full mt-2">
                                <button class="share-btn no-select flex-1 py-2 bg-emerald-600 text-white rounded-xl text-xs" data-person="${person}">+</button>
                                <button class="violation-btn no-select flex-1 py-2 bg-rose-600 text-white rounded-xl text-xs" data-person="${person}">-</button>
                            </div>
                        `;
                        controlAltView.appendChild(card);
                    });
                } else if (controlStyle === 3) {
                    // Glassmorphism List
                    controlAltView.className = 'space-y-4 p-4 bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl';
                    controlPersons.forEach(person => {
                        const pd = controlData[person] || { shares: [], violations: [] };
                        const sT = pd.shares?.reduce((s,i)=>s+i.points,0) || 0;
                        const vT = pd.violations?.reduce((s,i)=>s+Math.abs(i.points),0) || 0;
                        const net = sT - vT;
                        const row = document.createElement('div');
                        row.className = 'bg-white/60 backdrop-blur-md border border-white p-4 rounded-2xl shadow-sm flex items-center gap-4';
                        row.innerHTML = `
                            <div class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-lg shadow-md shadow-blue-100 no-select">${person.charAt(0)}</div>
                            <div class="flex-1">
                                <h4 class="font-bold text-slate-800 cursor-pointer" data-person="${person}">${person}</h4>
                                <div class="flex gap-2 text-[10px] font-bold mt-1">
                                    <span class="text-emerald-500">Ø¥ÙŠØ¬Ø§Ø¨ÙŠ: ${sT}</span>
                                    <span class="text-rose-400">Ø³Ù„Ø¨ÙŠ: ${vT}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="share-btn no-select p-2 bg-emerald-100 text-emerald-700 rounded-lg" data-person="${person}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12h14"/></svg></button>
                                <button class="violation-btn no-select p-2 bg-rose-100 text-rose-700 rounded-lg" data-person="${person}"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14"/></svg></button>
                                <div class="min-w-[40px] text-center font-black text-xl ${net >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${net}</div>
                            </div>
                        `;
                        controlAltView.appendChild(row);
                    });
                } else if (controlStyle === 4) {
                    // Modern Ranking Board
                    controlAltView.className = 'p-4 space-y-3';
                    const ranked = [...controlPersons].sort((a,b) => {
                         const nA = (controlData[a]?.shares?.reduce((s,i)=>s+i.points,0)||0) - (controlData[a]?.violations?.reduce((s,i)=>s+Math.abs(i.points),0)||0);
                         const nB = (controlData[b]?.shares?.reduce((s,i)=>s+i.points,0)||0) - (controlData[b]?.violations?.reduce((s,i)=>s+Math.abs(i.points),0)||0);
                         return nB - nA;
                    });
                    ranked.forEach((person, idx) => {
                        const pd = controlData[person] || {};
                        const sT = pd.shares?.reduce((s,i)=>s+i.points,0) || 0;
                        const vT = pd.violations?.reduce((s,i)=>s+Math.abs(i.points),0) || 0;
                        const net = sT - vT;
                        const medal = idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : (idx+1);
                        const row = document.createElement('div');
                        row.className = 'flex items-center p-3 bg-white border-2 border-slate-50 rounded-2xl hover:border-blue-100 transition-all shadow-sm';
                        row.innerHTML = `
                            <div class="w-10 text-center font-black text-slate-300 text-lg">${medal}</div>
                            <div class="flex-1 font-bold text-slate-700 cursor-pointer" data-person="${person}">${person}</div>
                            <div class="flex gap-2">
                                <button class="share-btn no-select px-4 py-1.5 bg-slate-800 text-white rounded-full text-xs font-bold" data-person="${person}">+ Ù…</button>
                                <button class="violation-btn no-select px-4 py-1.5 border-2 border-slate-800 text-slate-800 rounded-full text-xs font-bold" data-person="${person}">- Ø®</button>
                            </div>
                            <div class="w-16 text-left font-black text-2xl ${net >= 0 ? 'text-emerald-500' : 'text-rose-500'}">${net}</div>
                        `;
                        controlAltView.appendChild(row);
                    });
                } else if (controlStyle === 5) {
                    // Cyber Neon / Dark Mode Style
                    controlAltView.className = 'bg-slate-900 rounded-3xl p-6 space-y-4 shadow-2xl';
                    controlPersons.forEach(person => {
                        const pd = controlData[person] || {};
                        const sT = pd.shares?.reduce((s,i)=>s+i.points,0) || 0;
                        const vT = pd.violations?.reduce((s,i)=>s+Math.abs(i.points),0) || 0;
                        const net = sT - vT;
                        const row = document.createElement('div');
                        row.className = 'flex justify-between items-center border-b border-slate-800 pb-4 last:border-0';
                        row.innerHTML = `
                            <div class="cursor-pointer" data-person="${person}">
                                <div class="text-white font-bold tracking-wide">${person}</div>
                                <div class="text-[9px] text-slate-500 uppercase font-black">Status Analysis</div>
                            </div>
                            <div class="flex gap-4 items-center">
                                <div class="flex gap-1">
                                    <div class="share-btn no-select w-8 h-8 rounded bg-emerald-500/10 border border-emerald-500/50 flex items-center justify-center text-emerald-400 text-xl font-black cursor-pointer" data-person="${person}">+</div>
                                    <div class="violation-btn no-select w-8 h-8 rounded bg-rose-500/10 border border-rose-500/50 flex items-center justify-center text-rose-400 text-xl font-black cursor-pointer" data-person="${person}">-</div>
                                </div>
                                <div class="text-3xl font-black italic ${net >= 0 ? 'text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.4)]' : 'text-rose-400 drop-shadow-[0_0_8px_rgba(251,113,133,0.4)]'}">${net}</div>
                            </div>
                        `;
                        controlAltView.appendChild(row);
                    });
                }
            }
        }

        // --- Actions ---
        expenseForm.onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('itemName').value.trim();
            const price = document.getElementById('itemPrice').value;
            if (!name || price <= 0) return;
            
            if (editId) {
                expenseRef.child(editId).update({name, price});
                editId = null;
            } else {
                expenseRef.push({name, price: parseFloat(price)});
            }
            expenseForm.reset();
            cancelEditBtn.classList.add('hidden');
            document.getElementById('submitText').innerText = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ";
        };

        taskForm.onsubmit = (e) => {
            e.preventDefault();
            const text = document.getElementById('taskText').value.trim();
            const assignee = document.getElementById('taskAssignee').value.trim();
            if (!text || !assignee) return;

            if (editId) {
                taskRef.child(editId).update({text, assignee});
                editId = null;
            } else {
                taskRef.push({text, assignee, done: false});
            }
            taskForm.reset();
            cancelEditBtn.classList.add('hidden');
            document.getElementById('taskSubmitText').innerText = "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©";
        };

        window.toggleTask = (id, currentStatus) => {
            if (!isAdminMode) return;
            taskRef.child(id).update({done: !currentStatus});
        };

        window.editItem = (id) => {
            editId = id;
            cancelEditBtn.classList.remove('hidden');
            if (activeTab === 'expenses') {
                const item = expenses.find(i => i.id === id);
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemPrice').value = item.price;
                document.getElementById('submitText').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ù";
            } else {
                const task = tasks.find(t => t.id === id);
                document.getElementById('taskText').value = task.text;
                document.getElementById('taskAssignee').value = task.assignee;
                document.getElementById('taskSubmitText').innerText = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù‡Ù…Ø©";
            }
        };

        cancelEditBtn.onclick = () => {
            editId = null;
            expenseForm.reset();
            taskForm.reset();
            cancelEditBtn.classList.add('hidden');
            document.getElementById('submitText').innerText = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ";
            document.getElementById('taskSubmitText').innerText = "Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©";
        };

        window.confirmDelete = (id) => {
            itemToDeleteId = id;
            document.getElementById('deleteModal').style.display = 'flex';
        };

        document.getElementById('confirmDeleteBtn').onclick = () => {
            if (activeTab === 'expenses') expenseRef.child(itemToDeleteId).remove();
            else taskRef.child(itemToDeleteId).remove();
            document.getElementById('deleteModal').style.display = 'none';
        };

        document.getElementById('cancelDeleteBtn').onclick = () => {
            document.getElementById('deleteModal').style.display = 'none';
        };

        clearAllBtn.onclick = () => {
            showClearAllModal();
        };

        function showClearAllModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'clearAllModal';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl" id="clearAllModalContent">
                    <h3 class="text-lg font-bold text-slate-800 mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…Ø³Ø­</h3>
                    <p class="text-slate-600 mb-6 text-sm">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ</p>
                    <div class="flex gap-3">
                        <button id="confirmClearAllBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
                        <button id="cancelClearAllBtn" class="flex-1 bg-slate-100 text-slate-600 py-2 rounded-lg font-bold">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.getElementById('confirmClearAllBtn').onclick = () => {
                if (activeTab === 'expenses') expenseRef.remove();
                else if (activeTab === 'tasks') taskRef.remove();
                modal.remove();
            };
            document.getElementById('cancelClearAllBtn').onclick = () => modal.remove();
        }

        mainTitle.ondblclick = () => { isAdminMode = true; render(); switchTab(activeTab); };
        mainTitle.onclick = () => { if(isAdminMode) { isAdminMode = false; render(); switchTab(activeTab); } };

        // --- Control Logic (Long Press & Code) ---
        const CONTROL_CODE = 'A@1379';
        let longPressTimer = null;
        let currentControlPerson = null;
        let currentControlType = null;

        function playErrorSound() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.frequency.value = 200;
            oscillator.type = 'square';
            gainNode.gain.value = 0.3;
            oscillator.start();
            setTimeout(() => { oscillator.stop(); audioCtx.close(); }, 300);
        }

        function showCodeModal(person, type) {
            currentControlPerson = person;
            currentControlType = type;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'codeModal';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl" id="codeModalContent">
                    <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</h3>
                    <input type="password" id="codeInput" placeholder="Ø§Ù„ÙƒÙˆØ¯"
                        class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-center text-lg mb-4" style="font-size: 18px;">
                    <button id="verifyCodeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-colors">ØªØ­Ù‚Ù‚</button>
                </div>
            `;
            document.body.appendChild(modal);
            const codeInput = document.getElementById('codeInput');
            codeInput.focus();
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.getElementById('verifyCodeBtn').onclick = () => {
                const enteredCode = codeInput.value.trim();
                if (enteredCode === CONTROL_CODE) { modal.remove(); showEntryModal(currentControlPerson, currentControlType); }
                else { modal.remove(); showErrorModal(currentControlPerson, currentControlType); }
            };
            codeInput.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('verifyCodeBtn').click(); };
        }

        function showErrorModal(person, type) {
            playErrorSound();
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'errorModal';
            modal.innerHTML = `
                <div class="bg-red-50 border-2 border-red-400 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl text-center" id="errorModalContent">
                    <div class="text-5xl mb-4">âŒ</div>
                    <h3 class="text-xl font-bold text-red-600 mb-6">Ø§ØªØ±Ùƒ Ø§Ù„Ù„Ù‚Ø§ÙØ©</h3>
                    <button id="closeErrorBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition-colors">Ø®Ù„Ø§Øµ</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.getElementById('closeErrorBtn').onclick = () => { modal.remove(); showCodeModal(person, type); };
        }

        function showEntryModal(person, type) {
            const isShare = type === 'share';
            const bgColor = isShare ? 'bg-emerald-50 border-emerald-400' : 'bg-rose-50 border-rose-400';
            const titleColor = isShare ? 'text-emerald-700' : 'text-rose-700';
            const btnColor = isShare ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-rose-600 hover:bg-rose-700';
            const title = isShare ? 'ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ©' : 'ØªØ³Ø¬ÙŠÙ„ Ù…Ø®Ø§Ù„ÙØ©';
            const label = isShare ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©' : 'Ø§Ø³Ù… Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©';
            const icon = isShare ? 'ğŸ‰' : 'âš ï¸';

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'entryModal';
            modal.innerHTML = `
                <div class="${bgColor} border-2 p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl" id="entryModalContent">
                    <h3 class="text-lg font-bold ${titleColor} mb-2 text-center">${title}</h3>
                    <p class="text-slate-600 text-center mb-4">Ù„Ù€: <span class="font-bold">${person}</span></p>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-slate-700 mb-1 block">${label}</label>
                            <input type="text" id="entryName" placeholder="${label}"
                                class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" style="font-size: 16px;">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700 mb-1 block">Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                            <input type="number" id="entryPoints" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·" min="1"
                                class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" style="font-size: 16px;">
                        </div>
                        <button id="submitEntryBtn" class="w-full ${btnColor} text-white font-bold py-3 rounded-lg transition-colors">${icon} ÙŠØ³ØªØ§Ù‡Ù„</button>
                        <button id="cancelEntryBtn" class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 rounded-lg transition-colors text-sm">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.getElementById('entryName').focus();
            document.getElementById('submitEntryBtn').onclick = () => {
                const name = document.getElementById('entryName').value.trim();
                const points = parseInt(document.getElementById('entryPoints').value);
                if (!name || !points || points <= 0) return;
                const now = new Date();
                const entry = { name, points: isShare ? points : -Math.abs(points), timestamp: now.getTime(), date: now.toLocaleDateString('ar-SA'), time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) };
                const arrayKey = isShare ? 'shares' : 'violations';
                const personData = controlData[person] || {};
                const currentArray = personData[arrayKey] || [];
                currentArray.push(entry);
                controlRef.child(person).child(arrayKey).set(currentArray);
                modal.remove();
            };
            document.getElementById('cancelEntryBtn').onclick = () => modal.remove();
        }

        document.addEventListener('mousedown', handleLongPressStart);
        document.addEventListener('mouseup', handleLongPressEnd);
        document.addEventListener('touchstart', handleLongPressStart, { passive: true });
        document.addEventListener('touchend', handleLongPressEnd);

        function handleLongPressStart(e) {
            const target = e.target.closest('.share-btn, .violation-btn');
            if (!target) return;
            const person = target.dataset.person;
            const type = target.classList.contains('share-btn') ? 'share' : 'violation';
            longPressTimer = setTimeout(() => showCodeModal(person, type), 2000);
        }

        function handleLongPressEnd() { if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; } }

        function showPersonReport(person) {
            const personData = controlData[person] || {};
            const shares = (personData.shares || []).map((s, idx) => ({ ...s, type: 'share', index: idx }));
            const violations = (personData.violations || []).map((v, idx) => ({ ...v, type: 'violation', index: idx }));
            const allEntries = [...shares, ...violations].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            const sT = shares.reduce((sum, s) => sum + (s.points || 0), 0);
            const vT = violations.reduce((sum, v) => sum + Math.abs(v.points || 0), 0);
            const net = sT - vT;

            let entriesHTML = allEntries.length === 0 ? '<p class="text-center text-slate-400 py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</p>' : '';
            allEntries.forEach(entry => {
                const isShare = entry.type === 'share';
                const dateObj = new Date(entry.timestamp);
                entriesHTML += `
                    <div class="report-entry no-select ${isShare ? 'bg-emerald-50 border-emerald-200' : 'bg-rose-50 border-rose-200'} border rounded-lg p-3 mb-2 cursor-pointer" data-person="${person}" data-type="${entry.type}" data-index="${entry.index}">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2"><span>${isShare ? 'âœ…' : 'âŒ'}</span><span class="font-medium text-slate-700">${entry.name}</span></div>
                            <span class="font-bold ${isShare ? 'text-emerald-700' : 'text-rose-700'}">${isShare ? '+' + entry.points : entry.points}</span>
                        </div>
                        <div class="text-xs text-slate-400 mt-1">${dateObj.getDate()}/${dateObj.getMonth() + 1} ${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}</div>
                    </div>`;
            });

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.id = 'reportModal';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl max-w-md w-full mx-4 shadow-xl max-h-[80vh] flex flex-col" id="reportModalContent">
                    <h3 class="text-xl font-bold text-slate-800 mb-2 text-center">${person}</h3>
                    <div class="flex justify-center gap-4 mb-4 text-sm">
                        <span class="text-emerald-600">Ù…Ø´Ø§Ø±ÙƒØ§Øª: <b>${shares.length}</b> (${sT}+)</span>
                        <span class="text-rose-600">Ù…Ø®Ø§Ù„ÙØ§Øª: <b>${violations.length}</b> (${vT}-)</span>
                    </div>
                    <div class="text-center mb-4"><span class="text-lg">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b class="${net >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${net}</b></span></div>
                    <div class="overflow-y-auto flex-1 border-t border-slate-100 pt-4" id="reportEntriesContainer">${entriesHTML}</div>
                    <button id="closeReportBtn" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 rounded-lg transition-colors mt-4">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>`;
            document.body.appendChild(modal);
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.getElementById('closeReportBtn').onclick = () => modal.remove();

            const entriesContainer = document.getElementById('reportEntriesContainer');
            entriesContainer.addEventListener('mousedown', (e) => {
                const entry = e.target.closest('.report-entry');
                if (entry) longPressTimer = setTimeout(() => showDeleteCodeModal(entry.dataset.person, entry.dataset.type, parseInt(entry.dataset.index)), 2000);
            });
            entriesContainer.addEventListener('touchstart', (e) => {
                const entry = e.target.closest('.report-entry');
                if (entry) longPressTimer = setTimeout(() => showDeleteCodeModal(entry.dataset.person, entry.dataset.type, parseInt(entry.dataset.index)), 2000);
            }, { passive: true });
        }

        function showDeleteCodeModal(person, type, index) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl max-w-sm w-full mx-4 shadow-xl text-center">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ÙƒÙˆØ¯ Ø§Ù„Ø­Ø°Ù</h3>
                    <input type="password" id="deleteCodeInput" class="w-full p-3 border rounded-lg text-center mb-4">
                    <button id="verifyDeleteCodeBtn" class="w-full bg-rose-600 text-white font-bold py-3 rounded-lg">Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„</button>
                </div>`;
            document.body.appendChild(modal);
            const input = document.getElementById('deleteCodeInput'); input.focus();
            document.getElementById('verifyDeleteCodeBtn').onclick = () => {
                if (input.value === CONTROL_CODE) {
                    const arrayKey = type === 'share' ? 'shares' : 'violations';
                    const currentArray = controlData[person][arrayKey];
                    currentArray.splice(index, 1);
                    controlRef.child(person).child(arrayKey).set(currentArray);
                    modal.remove(); document.getElementById('reportModal').remove(); showPersonReport(person);
                } else { modal.remove(); playErrorSound(); }
            };
        }

        document.addEventListener('click', (e) => {
            const person = e.target.closest('[data-person]')?.dataset.person;
            if (person && activeTab === 'control' && !e.target.closest('.share-btn, .violation-btn')) showPersonReport(person);
        });

        window.onload = () => { setControlStyle(1); syncData(); };
    </script>
</body>
</html>