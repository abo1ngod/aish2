<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¦ÙŠØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --warning: #f1c40f;
            --danger: #e74c3c;
            --highlight: #ffe600;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --dim-color: #bdc3c7;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        .header-area {
            width: 100%;
            padding: 15px 20px;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            position: sticky;
            top: 0;
        }

        .app-title { font-size: 1.1rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 5px; }

        .best-score-badge {
            background: #fff3cd;
            color: #856404;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            border: 1px solid #ffeeba;
        }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØµÙˆØµ --- */
        .dashboard-container {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }
        
        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .texts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .text-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            height: 180px;
            position: relative;
        }
        .text-card:hover { transform: translateY(-3px); border-color: var(--accent); }

        .level-badge {
            position: absolute; top: 15px; left: 15px;
            padding: 4px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; color: white;
        }
        .level-easy { background-color: var(--success); }
        .level-medium { background-color: var(--warning); color: #856404; }
        .level-hard { background-color: var(--danger); }

        .text-title { font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; color: var(--primary); padding-left: 60px; } /* padding for badge */

        .text-preview {
            font-size: 0.95rem; color: #555; line-height: 1.5;
            overflow: hidden; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
            flex: 1;
        }

        .text-meta {
            margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;
            font-size: 0.85rem; color: #95a5a6; display: flex; justify-content: space-between; align-items: center;
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© --- */
        .game-section {
            display: none; width: 100%; height: 100vh; position: fixed; top: 0; left: 0;
            background: var(--bg-color); z-index: 200; flex-direction: column; align-items: center;
        }

        .game-header {
            width: 100%; padding: 10px 20px; background: white;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .game-controls { display: flex; gap: 10px; }
        .icon-btn { background: #f0f2f5; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: background 0.2s; }
        .icon-btn:hover { background: #e4e6eb; }
        .icon-btn.active { background: var(--primary); color: white; }

        .text-reader-container {
            flex: 1; width: 95%; max-width: 900px; background: white; margin: 15px 0;
            border-radius: 15px; padding: 30px;
            font-size: 1.8rem; line-height: 2.8; text-align: justify;
            overflow-y: auto; border: 1px solid #e0e0e0; position: relative;
            transition: background-color 0.3s;
        }

        /* ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ² */
        .focus-mode .word-span { opacity: 0.2; filter: blur(1px); transition: all 0.3s; }
        .focus-mode .word-current { opacity: 1; filter: blur(0); transform: scale(1.15); }
        .focus-mode .word-correct { opacity: 0.5; filter: blur(0); } /* Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø© ØªØ¸Ù‡Ø± Ø¨ÙˆØ¶ÙˆØ­ Ø£Ù‚Ù„ */

        .word-span {
            padding: 2px 4px; border-radius: 4px; margin: 0 1px; display: inline-block;
            border-bottom: 2px solid transparent; color: var(--text-color); transition: all 0.2s;
        }
        
        .word-current { background-color: var(--highlight); color: #000; border-bottom-color: #f39c12; }
        .word-correct { color: var(--success); font-weight: bold; }
        .word-missed { color: var(--danger); text-decoration: line-through; opacity: 0.6; } /* Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-bar {
            width: 100%; background: white; padding: 15px 20px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .timer-display { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .mic-indicator {
            width: 50px; height: 50px; background: #ecf0f1; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 1.5rem; transition: all 0.3s;
        }
        .mic-active { background: #ffebee; color: #c0392b; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(192, 57, 43, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(192, 57, 43, 0);} 100% {box-shadow: 0 0 0 0 rgba(192, 57, 43, 0);} }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */
        .result-summary-box {
            max-height: 200px; overflow-y: auto; background: #f9f9f9; padding: 15px;
            border-radius: 10px; border: 1px solid #eee; margin-top: 15px; text-align: justify;
            font-size: 0.9rem; line-height: 1.8;
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 500px; border-radius: 20px; padding: 30px; text-align: center; max-height: 90vh; overflow-y: auto; }
        .big-number { font-size: 4rem; font-weight: 800; color: var(--success); line-height: 1; }
        .btn-main { background: var(--accent); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-size: 1.1rem; cursor: pointer; margin-top: 15px; }
        
        /* Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; margin-bottom: 10px; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }

        .countdown-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; z-index: 50; }
        .count-num { font-size: 8rem; color: var(--accent); font-weight: bold; }

    </style>
</head>
<body>

    <div class="header-area">
        <div class="app-title">â±ï¸ Ù…Ù‚ÙŠØ§Ø³ Ø§Ù„Ø·Ù„Ø§Ù‚Ø© <span style="font-size:0.7em; background:var(--accent); color:white; padding:2px 6px; border-radius:4px; margin-right:5px;">Pro</span></div>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="best-score-badge">ğŸ† Ø§Ù„Ø£ÙØ¶Ù„: <span id="best-score-display">0</span></div>
            <button onclick="openAdmin()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âš™ï¸</button>
        </div>
    </div>

    <!-- 1. Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©: Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù†ØµÙˆØµ -->
    <div class="dashboard-container" id="dashboard">
        <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; color: #1565c0; font-size: 0.9rem; margin-bottom: 15px;">
            ğŸ“– Ø§Ø®ØªØ± Ù†ØµØ§Ù‹ ÙŠÙ†Ø§Ø³Ø¨ Ù…Ø³ØªÙˆØ§Ùƒ. Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø³Ø±Ø¹ØªÙƒ ÙˆØ¯Ù‚ØªÙƒ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©.
        </div>
        
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="filterTexts('all', this)">Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" onclick="filterTexts('easy', this)">ğŸŸ¢ Ø³Ù‡Ù„</button>
            <button class="filter-btn" onclick="filterTexts('medium', this)">ğŸŸ¡ Ù…ØªÙˆØ³Ø·</button>
            <button class="filter-btn" onclick="filterTexts('hard', this)">ğŸ”´ ØµØ¹Ø¨</button>
        </div>

        <div class="texts-grid" id="texts-grid"></div>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
    <div class="game-section" id="game-section">
        <div class="game-header">
            <button onclick="exitGame()" style="background:none; border:none; font-size:1.5rem;">âœ•</button>
            
            <div class="game-controls">
                <button id="focus-btn" class="icon-btn" onclick="toggleFocusMode()" title="ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²">ğŸ‘ï¸</button>
            </div>
            
            <div style="font-weight:bold; color:var(--success);">Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="live-wpm">0</span></div>
        </div>

        <div class="text-reader-container" id="text-display"></div>

        <div class="bottom-bar">
            <div class="timer-display"><span>â³</span> <span id="timer-val">60</span> Ø«</div>
            <div style="font-size:0.8rem; color:#95a5a6;">Ø³Ù…Ø¹Øª: <span id="debug-word">...</span></div>
            <div id="mic-indicator" class="mic-indicator">ğŸ™ï¸</div>
        </div>

        <div id="countdown-layer" class="countdown-layer">
            <div id="countdown-val" class="count-num">3</div>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <div id="result-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h2>
            
            <div style="display:flex; justify-content:space-around; margin: 20px 0;">
                <div>
                    <div class="big-number" id="final-wpm">0</div>
                    <div style="font-size:0.8rem; color:#7f8c8d;">ÙƒÙ„Ù…Ø©/Ø¯Ù‚ÙŠÙ‚Ø©</div>
                </div>
                <div>
                    <div class="big-number" id="final-accuracy" style="color:var(--accent);">0%</div>
                    <div style="font-size:0.8rem; color:#7f8c8d;">Ø§Ù„Ø¯Ù‚Ø©</div>
                </div>
            </div>

            <div style="text-align:right; font-weight:bold; font-size:0.9rem; margin-bottom:5px;">Ù…Ù„Ø®Øµ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:</div>
            <div class="result-summary-box" id="result-text-summary">
                <!-- Ø³ÙŠØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ Ù…Ø¹ ØªÙ„ÙˆÙŠÙ† Ø§Ù„ÙƒÙ„Ù…Ø§Øª -->
            </div>

            <button class="btn-main" onclick="closeResult()">Ù…ÙˆØ§ÙÙ‚</button>
        </div>
    </div>

    <!-- Ù†Ø§ÙØ°Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
    <div id="pass-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:300px;">
            <h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
            <input type="password" id="admin-pass" placeholder="1234" style="text-align:center; padding:10px; font-size:1.2rem; width:100%; margin:10px 0; border:1px solid #ddd; border-radius:8px;">
            <button class="btn-main" onclick="checkPass()" style="width:100%;">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="document.getElementById('pass-modal').style.display='none'" style="background:none; border:none; color:#7f8c8d; margin-top:10px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªØ·ÙˆØ±Ø© -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px; text-align:right;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3 style="margin:0">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰</h3>
                <button onclick="document.getElementById('admin-modal').style.display='none'" style="color:red; background:none; border:none; font-size:1.2rem; cursor:pointer;">âœ•</button>
            </div>

            <div>
                <input type="text" id="new-text-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Øµ (Ù…Ø«Ù„Ø§Ù‹: Ù‚ØµØ© Ø§Ù„Ù†Ù…Ù„Ø©)">
                <select id="new-text-level">
                    <option value="easy">ğŸŸ¢ Ù…Ø³ØªÙˆÙ‰ Ø³Ù‡Ù„</option>
                    <option value="medium">ğŸŸ¡ Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙˆØ³Ø·</option>
                    <option value="hard">ğŸ”´ Ù…Ø³ØªÙˆÙ‰ ØµØ¹Ø¨</option>
                </select>
                <textarea id="new-text-content" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§..."></textarea>
                <button onclick="addNewText()" class="btn-main" style="width:100%; margin-top:0; font-size:0.9rem;">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…ÙƒØªØ¨Ø©</button>
                
                <h4 style="margin-top:20px; border-bottom:1px solid #eee; padding-bottom:5px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h4>
                <div id="admin-texts-list" style="max-height:200px; overflow-y:auto;"></div>
                
                <div style="margin-top:15px; display:flex; gap:10px;">
                    <button onclick="restoreDefaultTexts()" style="flex:1; padding:8px; background:#95a5a6; color:white; border:none; border-radius:5px;">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</button>
                    <button onclick="resetBestScore()" style="flex:1; padding:8px; background:#e74c3c; color:white; border:none; border-radius:5px;">ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ù‚Ø§Ù…</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Ù‡ÙŠÙƒÙ„Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
        // Text Object: { id, title, content, level }
        let texts = [];
        let bestScore = 0;
        let currentFilter = 'all';

        // --- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨ ---
        let currentTextObj = null;
        let currentTextWords = []; 
        let currentWordIndex = 0;
        let correctWordsCount = 0;
        let timerSeconds = 60;
        let timerInterval = null;
        let recognition;
        let isRunning = false;
        let focusMode = false;

        function init() {
            loadData();
            setupSpeech();
        }

        function loadData() {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØªØ§Ø­ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ v3 Ù„ØªØ¬Ù†Ø¨ ØªØ¶Ø§Ø±Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
            const tData = localStorage.getItem('fluency_texts_pro_v3');
            if (tData) {
                texts = JSON.parse(tData);
            } else {
                texts = getDefaultTexts();
                saveTexts();
            }

            const bData = localStorage.getItem('fluency_best_score_single');
            bestScore = bData ? parseInt(bData) : 0;
            updateBestScoreUI();

            renderDashboard();
        }

        function saveTexts() { localStorage.setItem('fluency_texts_pro_v3', JSON.stringify(texts)); }
        
        function saveBestScore(score) {
            if(score > bestScore) {
                bestScore = score;
                localStorage.setItem('fluency_best_score_single', bestScore);
                updateBestScoreUI();
            }
        }
        
        function updateBestScoreUI() { document.getElementById('best-score-display').innerText = bestScore; }

        function getDefaultTexts() {
            return [
                {
                    id: 1,
                    title: "Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©",
                    level: "easy",
                    content: "Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¹Ø±ÙØ©ØŒ ÙˆÙ‡ÙŠ ØªÙ†ÙŠØ± Ø§Ù„Ø¹Ù‚Ù„ ÙˆØªÙˆØ³Ø¹ Ø§Ù„Ù…Ø¯Ø§Ø±Ùƒ. Ø§Ù„ÙƒØªØ§Ø¨ Ø®ÙŠØ± Ø¬Ù„ÙŠØ³ Ù„Ù„Ø¥Ù†Ø³Ø§Ù†ØŒ ÙŠØ¹Ù„Ù…Ù‡ Ù…Ø§ Ù„Ù… ÙŠÙƒÙ† ÙŠØ¹Ù„Ù… ÙˆÙŠØ£Ø®Ø°Ù‡ ÙÙŠ Ø±Ø­Ù„Ø§Øª Ù…Ù…ØªØ¹Ø© Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†."
                },
                {
                    id: 2,
                    title: "Ø§Ù„Ù†Ø²Ù‡Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„ÙŠØ©",
                    level: "medium",
                    content: "Ø®Ø±Ø¬Øª Ø§Ù„Ø£Ø³Ø±Ø© ÙÙŠ Ù†Ø²Ù‡Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©ØŒ ÙƒØ§Ù† Ø§Ù„Ø¬Ùˆ Ø¬Ù…ÙŠÙ„Ø§Ù‹ ÙˆØ§Ù„Ø´Ù…Ø³ Ù…Ø´Ø±Ù‚Ø©. Ù„Ø¹Ø¨ Ø§Ù„Ø£Ø·ÙØ§Ù„ Ø¨Ø§Ù„ÙƒØ±Ø© ÙˆØªÙ†Ø§ÙˆÙ„ÙˆØ§ Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„Ù„Ø°ÙŠØ° ØªØ­Øª Ø¸Ù„ Ø§Ù„Ø£Ø´Ø¬Ø§Ø±ØŒ ÙˆØ´Ø§Ù‡Ø¯ÙˆØ§ Ø§Ù„Ø¹ØµØ§ÙÙŠØ± ØªØºØ±Ø¯ ÙÙˆÙ‚ Ø§Ù„Ø£ØºØµØ§Ù† Ø¨Ø³Ø¹Ø§Ø¯Ø© ÙˆÙØ±Ø­."
                },
                {
                    id: 3,
                    title: "Ù‚ÙˆØ© Ø§Ù„ØªØ¹Ø§ÙˆÙ†",
                    level: "hard",
                    content: "Ø§Ù„ØªØ¹Ø§ÙˆÙ† ØµÙØ© Ø­Ù…ÙŠØ¯Ø©ØŒ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ Ø¨Ø¹Ø¶Ù‡Ù… Ø¨Ø¹Ø¶Ø§Ù‹ Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„ØµØ¹Ø¨Ø©. ÙÙŠ Ø§Ù„Ø§ØªØ­Ø§Ø¯ Ù‚ÙˆØ©ØŒ ÙˆØ¨Ø§Ù„ØªØ¹Ø§ÙˆÙ† ØªØ¨Ù†Ù‰ Ø§Ù„Ø£ÙˆØ·Ø§Ù† ÙˆØªØ²Ø¯Ù‡Ø± Ø§Ù„Ù…Ø¬ØªÙ…Ø¹Ø§ØªØŒ ÙˆÙŠØµØ¨Ø­ Ø§Ù„ØµØ¹Ø¨ Ø³Ù‡Ù„Ø§Ù‹ ÙˆØ§Ù„Ù…Ø³ØªØ­ÙŠÙ„ Ù…Ù…ÙƒÙ†Ø§Ù‹."
                }
            ];
        }

        // --- Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ---
        function filterTexts(level, btn) {
            currentFilter = level;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderDashboard();
        }

        function renderDashboard() {
            const grid = document.getElementById('texts-grid');
            grid.innerHTML = "";
            
            const filteredTexts = currentFilter === 'all' ? texts : texts.filter(t => t.level === currentFilter);
            
            if(filteredTexts.length === 0) {
                grid.innerHTML = `<div style="text-align:center; width:100%; grid-column:1/-1; color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµÙˆØµ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ.</div>`;
                return;
            }

            filteredTexts.forEach((txt, idx) => {
                const wordCount = txt.content.trim().split(/\s+/).length;
                const preview = txt.content.length > 70 ? txt.content.substring(0, 70) + "..." : txt.content;
                
                let badgeClass = "level-easy";
                let levelText = "Ø³Ù‡Ù„";
                if(txt.level === 'medium') { badgeClass = "level-medium"; levelText = "Ù…ØªÙˆØ³Ø·"; }
                if(txt.level === 'hard') { badgeClass = "level-hard"; levelText = "ØµØ¹Ø¨"; }

                // Ù†Ù…Ø±Ø± Ø§Ù„Ù€ ID Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€ Index Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
                grid.innerHTML += `
                    <div class="text-card" onclick="prepareGame(${txt.id})">
                        <div class="level-badge ${badgeClass}">${levelText}</div>
                        <div class="text-title">${txt.title}</div>
                        <div class="text-preview">"${preview}"</div>
                        <div class="text-meta">
                            <span>ğŸ“ ${wordCount} ÙƒÙ„Ù…Ø©</span>
                            <span class="play-icon">â–¶</span>
                        </div>
                    </div>
                `;
            });
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---
        function prepareGame(textId) {
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('game-section').style.display = 'flex';
            
            // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ
            currentTextObj = texts.find(t => t.id === textId);
            currentTextWords = currentTextObj.content.trim().split(/\s+/);
            
            const displayArea = document.getElementById('text-display');
            displayArea.innerHTML = "";
            displayArea.classList.remove('focus-mode'); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²
            document.getElementById('focus-btn').classList.remove('active');
            focusMode = false;

            currentTextWords.forEach((word, i) => {
                const span = document.createElement('span');
                span.innerText = word;
                span.className = "word-span word-pending";
                span.id = `word-${i}`;
                displayArea.appendChild(span);
            });

            currentWordIndex = 0;
            correctWordsCount = 0;
            timerSeconds = 60;
            
            document.getElementById('live-wpm').innerText = "0";
            document.getElementById('timer-val').innerText = "60";
            
            highlightCurrentWord();
            startCountdown();
        }

        function toggleFocusMode() {
            focusMode = !focusMode;
            const container = document.getElementById('text-display');
            const btn = document.getElementById('focus-btn');
            
            if (focusMode) {
                container.classList.add('focus-mode');
                btn.classList.add('active');
            } else {
                container.classList.remove('focus-mode');
                btn.classList.remove('active');
            }
        }

        function highlightCurrentWord() {
            document.querySelectorAll('.word-span').forEach(el => {
                if(!el.classList.contains('word-correct')) el.className = "word-span word-pending";
            });
            
            if(currentWordIndex < currentTextWords.length) {
                const el = document.getElementById(`word-${currentWordIndex}`);
                if(el) {
                    el.classList.remove('word-pending');
                    el.classList.add('word-current');
                    el.scrollIntoView({behavior: "smooth", block: "nearest"});
                }
            }
        }

        function startCountdown() {
            const layer = document.getElementById('countdown-layer');
            const num = document.getElementById('countdown-val');
            layer.style.display = 'flex';
            let count = 3;
            num.innerText = count;

            const iv = setInterval(() => {
                count--;
                if(count > 0) num.innerText = count;
                else {
                    clearInterval(iv);
                    layer.style.display = 'none';
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            isRunning = true;
            try { recognition.start(); } catch(e) {}
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                document.getElementById('timer-val').innerText = timerSeconds;
                if(timerSeconds <= 0) endGame();
            }, 1000);
        }

        function setupSpeech() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechAPI();
                recognition.lang = 'ar-SA';
                recognition.continuous = true;
                recognition.interimResults = true;

                recognition.onstart = () => document.getElementById('mic-indicator').classList.add('mic-active');
                recognition.onend = () => {
                    document.getElementById('mic-indicator').classList.remove('mic-active');
                    if (isRunning) recognition.start();
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[event.results.length - 1][0].transcript;
                    document.getElementById('debug-word').innerText = transcript;
                    processInput(transcript);
                };
            } else {
                alert("Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ¹Ø±Ù Ø§Ù„ØµÙˆØªÙŠ");
            }
        }

        function processInput(spoken) {
            if(!isRunning || currentWordIndex >= currentTextWords.length) return;

            const spokenClean = normalizeArabic(spoken);
            const targetRaw = currentTextWords[currentWordIndex];
            const targetClean = normalizeArabic(targetRaw.replace(/[ØŒ.Ø›:!ØŸ"()]/g, ''));

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø°ÙƒÙŠ (Tolerant Check)
            if (spokenClean.includes(targetClean)) {
                // Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                const el = document.getElementById(`word-${currentWordIndex}`);
                el.className = "word-span word-correct";
                
                currentWordIndex++;
                correctWordsCount++;
                document.getElementById('live-wpm').innerText = correctWordsCount;

                highlightCurrentWord();

                if(currentWordIndex >= currentTextWords.length) endGame();
            }
        }

        function normalizeArabic(text) {
            return text.trim()
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
                .replace(/Ø©/g, 'Ù‡')
                .replace(/Ù‰/g, 'ÙŠ')
                .replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘]/g, ''); 
        }

        function endGame() {
            isRunning = false;
            clearInterval(timerInterval);
            recognition.stop();

            const wpm = correctWordsCount;
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ù‚Ø©: Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù‚Ø³ÙˆÙ…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªÙŠ Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡ØªÙ‡Ø§ (ÙˆÙ„ÙŠØ³ ÙƒÙ„ Ø§Ù„Ù†Øµ)
            // Ø¥Ø°Ø§ Ù‚Ø±Ø£ 5 ÙƒÙ„Ù…Ø§Øª ÙˆÙˆØµÙ„ Ù„Ù„Ù…Ø¤Ø´Ø± Ø±Ù‚Ù… 5ØŒ Ø§Ù„Ø¯Ù‚Ø© 100%. 
            // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ø§ ÙŠØªÙ‚Ø¯Ù… Ø¥Ù„Ø§ Ø¨Ø§Ù„ØµØ­ÙŠØ­ØŒ Ù„Ø°Ø§ Ø§Ù„Ø¯Ù‚Ø© Ø³ØªÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ 100% Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù…Ø§ ØªÙ… ØªØ¬Ø§ÙˆØ²Ù‡
            // Ø§Ù„Ø£ÙØ¶Ù„: Ø¹Ø±Ø¶ Ù†Ø³Ø¨Ø© Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù†Øµ.
            const totalAttempted = currentWordIndex; // ÙˆØµÙ„Ù†Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ„Ù…Ø©
            // Ø¨Ù…Ø§ Ø£Ù† Ù†Ø¸Ø§Ù…Ù†Ø§ Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨ØªØ¬Ø§ÙˆØ² Ø§Ù„ÙƒÙ„Ù…Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµØ­ÙŠØ­Ø©ØŒ ÙØ§Ù„Ø¯Ù‚Ø© Ù‡Ù†Ø§ Ù‡ÙŠ "Ù†Ø³Ø¨Ø© Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù†Øµ"
            const completionRate = Math.round((correctWordsCount / currentTextWords.length) * 100);

            document.getElementById('final-wpm').innerText = wpm;
            document.getElementById('final-accuracy').innerText = completionRate + "%";
            
            // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø±Ø¦ÙŠ
            generateVisualSummary();

            document.getElementById('result-modal').style.display = 'flex';
            saveBestScore(wpm);
        }

        function generateVisualSummary() {
            const summaryBox = document.getElementById('result-text-summary');
            summaryBox.innerHTML = "";
            
            currentTextWords.forEach((word, i) => {
                const span = document.createElement('span');
                span.innerText = word + " ";
                if (i < currentWordIndex) {
                    span.style.color = "var(--success)";
                    span.style.fontWeight = "bold";
                } else {
                    span.style.color = "#bdc3c7"; // Ø¨Ø§Ù‡Øª
                }
                summaryBox.appendChild(span);
            });
        }

        function closeResult() {
            document.getElementById('result-modal').style.display = 'none';
            exitGame();
        }

        function exitGame() {
            isRunning = false;
            clearInterval(timerInterval);
            try { recognition.stop(); } catch(e) {}
            document.getElementById('game-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'flex';
            renderDashboard();
        }

        // --- Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ---
        function openAdmin() { document.getElementById('pass-modal').style.display = 'flex'; document.getElementById('admin-pass').value = ''; }
        function checkPass() {
            if(document.getElementById('admin-pass').value === "1234") {
                document.getElementById('pass-modal').style.display = 'none';
                renderAdminTexts();
                document.getElementById('admin-modal').style.display = 'block';
            } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù…Ø²");
        }

        function renderAdminTexts() {
            const list = document.getElementById('admin-texts-list');
            list.innerHTML = "";
            texts.forEach((t, i) => {
                let badge = t.level === 'easy' ? 'ğŸŸ¢' : (t.level === 'medium' ? 'ğŸŸ¡' : 'ğŸ”´');
                list.innerHTML += `
                    <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; align-items:center;">
                        <div style="font-size:0.8rem; width:85%;">
                            <span style="font-weight:bold;">${badge} ${t.title}</span><br>
                            <span style="color:#777;">${t.content.substring(0,40)}...</span>
                        </div>
                        <button onclick="deleteText(${t.id})" style="color:red; background:none; border:none; cursor:pointer;">âœ•</button>
                    </div>`;
            });
        }
        
        function addNewText() {
            const title = document.getElementById('new-text-title').value.trim();
            const content = document.getElementById('new-text-content').value.trim();
            const level = document.getElementById('new-text-level').value;

            if(title && content) {
                const newId = Date.now();
                texts.push({ id: newId, title: title, content: content, level: level });
                saveTexts(); 
                renderAdminTexts(); 
                
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('new-text-title').value = "";
                document.getElementById('new-text-content').value = "";
                renderDashboard();
            } else {
                alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ");
            }
        }

        function deleteText(id) {
            if(confirm("Ø­Ø°Ù Ø§Ù„Ù†ØµØŸ")) {
                texts = texts.filter(t => t.id !== id);
                saveTexts(); renderAdminTexts(); renderDashboard();
            }
        }
        
        function restoreDefaultTexts() { 
            if(confirm("Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©ØŸ")) { 
                texts = getDefaultTexts(); saveTexts(); renderAdminTexts(); renderDashboard(); 
            } 
        }
        
        function resetBestScore() { 
            if(confirm("ØªØµÙÙŠØ± Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù‚ÙŠØ§Ø³ÙŠØŸ")) { 
                bestScore = 0; localStorage.setItem('fluency_best_score_single', 0); updateBestScoreUI(); 
            } 
        }

        init();

    </script>
</body>
</html>

